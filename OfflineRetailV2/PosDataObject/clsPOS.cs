/*
 purpose : Data for All Transactions in POS
*/
using System;
using System.Data.SqlClient;
using System.Data.OleDb;
using System.Data;
using OfflineRetailV2.Data;

namespace PosDataObject                                                      
{
    public class POS
    {
        #region definining private variables

        private SqlConnection sqlConn;
        private int intParentReturnInvNo;
        private int             intPaymentGateway;
        private int             intID;
        private int             intNewID;
        private int             intLoginUserID;
        private string          strErrorMsg;
        public SqlTransaction   SaveTran;
        public SqlCommand       SaveComm;
        public SqlConnection    SaveCon;
        private DataTable       dtblItemDataTable;
        private DataTable       dtblTenderDataTable;
        private DataTable       dtblMercuryGiftCardDataTable;
        private DataTable       dtblKitDataTable;

        private DataTable       dtblWorkOrder;
        private DataTable       dtblWorkOrder1;


        private string strGiftAid;
        private int             intTransactionNo;
        private int             intTransType;
        private int             intEmployeeID;
        private int             intRegisterID;
        private int             intStoreID;
        private int             intCustomerID;
        private int             intCloseoutID;
        private int             intTransNoteNo;
        private string          strTerminalName;
        private int             intSuspendInvoiceNo;
        private string          strNotes;
        private double          dblPaidOutAmount;
        private int             intStatus;
        private int             intReceiptCnt;
        private int             intLayawayNo;
        private int             intTransMSeconds;
        private double          dblTax;
        private double          dblDiscount;
        private double          dblCoupon;
        private double          dblTotalSale;
        private string          strDiscountReason;
        private int             intTaxID1;
        private int             intTaxID2;
        private int             intTaxID3;
        private double          dblTax1;
        private double          dblTax2;
        private double          dblTax3;

        private double  dblChangeAmount;

        private int iQtyDecimalLength = 0;

        private DataTable dtblGCInsertID = null;

        private int     intReturnItemID;
        private int     intItemID;
        private double  dblItemQty;
        private double  dblItemCost;
        private double  dblItemPrice;
        private double  dblItemNPrice;

        private int     intTenderID;
        private double  dblTenderAmount;

        private int     intItemDepartmentID;
        private int     intItemCategoryID;
        private string  strItemSKU;
        private string  strItemDescription;
        private string  strItemProductType;

        private int     intItemTaxID1;
        private int     intItemTaxID2;
        private int     intItemTaxID3;
        private string  strItemTaxable1;
        private string  strItemTaxable2;
        private string  strItemTaxable3;
        private double  dblItemTaxRate1;
        private double  dblItemTaxRate2;
        private double  dblItemTaxRate3;
        private int     intItemTaxType1;
        private int     intItemTaxType2;
        private int     intItemTaxType3;
        private double  dblItemTaxTotal1;
        private double  dblItemTaxTotal2;
        private double  dblItemTaxTotal3;
        private double  dblItemUOMCount;
        private double  dblItemUOMPrice;
        private string  strItemUOMDesc;
        private int     intMatrixOptionID;
        private string  strMatrixOptionValue1;
        private string  strMatrixOptionValue2;
        private string  strMatrixOptionValue3;

        private double  dblItemDiscount;
        private double  dblItemDiscValue;
        private int     intItemIndex;
        private int     intItemDiscountID;
        private string  strItemDiscLogic;
        private string  strItemDiscountText;

        private double dblItemGRate;
        private double dblItemGPrice;

        private int     intDecimalPlace;

        private int     intGCID;

        private string  strGCStore;
        private string  strGCNo;
        private double  dblGCAmount;
        private int     intReturnTenderID;

        private DateTime dtTransDate;

        private bool blPaidOut;
        private bool blPaidIn;
        private bool blSafeDrop;

        private bool    blAccountPay;
        private bool    blReturn;
        private bool    blNewLayaway;
        private bool    blLayaway;
        private bool    blLayawayRefund;
        private bool    blRentReturn;
        private bool    blMGCIssue;

        private double dblTotalLayawaySale;

        private double dblItemPriceA;
        private double dblItemPriceB;
        private double dblItemPriceC;
        private double dblItemPriceOverride;
        private double dblItemNewPrice;

        private string strItemDiscountLevel;
        private string strItemOnSale;

        private string intItemGiftCertID;

        private int intPreviousItemID;
        private int intNewItemID;

        private int         intLayawayID;
        private DateTime    dtLayawayDateDue;

        private double      dblLayawayBalance;
        private double      dblLayawayDeposit;

        private int     intCardTranID;
        private string  strAuthCode;
        private string  strReference;
        private string  strIsDebit;
        private string  strCardType;
        private double  dblCardAmount;

        private int     intChangedByAdmin;
        private bool    blFunctionButtonAccess;

        private int     intKitItemID;
        private int     intKitItemCount;
        private double  dblKitItemCost;

        private string      strInvNotes;
        private DateTime    dtWorkOrder;

        private string      strSaleTranNo;
        private string      strAuthorisedTranNo;
        private string      strTagged;

        private DataTable   dtblApptDataTable;
        private DataTable   dtblCardID;
        private DataTable   dtblMGCCardID;

        private string      strAcqRefData;
        private string      strTokenData;
        private string      strMercuryProcessData;
        private string      strMercuryTranCode;
        private double      dblMercuryPurchaseAmount;

        private string strMercuryResponseOrigin;
        private string strMercuryRecordNo;
        private string strMercuryResponseReturnCode;
        private string strMercuryTextResponse;

        private string strRefCardAct;
        private string strRefCardMerchID;
        private string strRefCardLogo;
        private string strRefCardEntry;
        private string strRefCardAuthID;
        private string strRefCardTranID;
        private double dblRefCardAuthAmount;
        private double dblRefCardBalAmount;
        private string strCardTranType;

        private string strAdjustFlag;

        private int intMercuryGCIssueCardID;

        private string strLogFileName;

        private string strPrintXml;
        

        // Appointment

        private DateTime    dtScheduleTime;
        private int         intApptServiceTime;
        private string      strApptStatus;
        private string      strApptRemarks;

       

        // Rental Service

        private string strServiceType;
        private double dblRentalSecurityDeposit;
        private double dblRentDuration;
        private double dblRentDeposit;
        private string strRentType;
        private double dblRentAmount;
        private string strIsRentCalculated ;

        private int intIssueRentInvNo;

        private double dblRepairAdvanceAmount;
        private double dblRepairAmount;
        private string strRepairProblem;
        private string strRepairNotes;
        private string strRepairRemarks;

        private DateTime dtRepairDateIn;
        private DateTime dtRepairDeliveryDate;
        private DateTime dtRepairNotifiedDate;
        private double dblRepairTenderAmount;

        private int intIssueRepairInvNo;

        private DateTime dtRepairItemPurchaseDate;
        private string strRepairItemTag;
        private string strRepairItemSLNO;
        private string strMercuryInvNo;

        private bool blRepairIssueNClosed;

        private string strRepairFindUs;
        private string strRepairItemName;
        private string strRepairItemSL;

        private bool blRepairDepositTransaction;
        private int intRepairDepositLinkID;
        // Repair Service

        private string strGCOPStore;
        private string strGCCentralFlag;

        private string strOperateStore;
        private string strCustomerIssueStore = "";

        private double dblCouponPerc;

        private double dblStoreCreditPointEquivalent;
        
        // Mix n Match
        
        private int intMixMatchID;
        private int intMixMatchUnique;
        private int intMixMatchQty;
        private double dblMixMatchValue;
        private string strMixMatchFlag;
        private string strMixMatchLast;
        private string strMixMatchType;
        
        // Fees & Charges

        private int intFeesID;
        private double dblFeesValue;
        private double dblFees;
        private double dblFeesTaxRate;
        private double dblFeesTax;
        private string strFeesLogic = "";
        private string strFeesText = "";
        private string strFeesQty = "N";
        private double dblTotalFees;
        private double dblTotalFeesTax;

        private double dblTotalFeesCoupon;
        private double dblTotalFeesCouponTax;
        
        // sale price

        private int intSalePriceID;

        // Destination Tax
        private int     intDTxID;
        private int     intDTxType;
        private double  dblDTxRate;
        private double  dblDTx;
        private int     iDTaxID;
        private double  dDTax;
        private string sEditFlag;

        private string sPromptPrice;

        // Customer Ordering

        private int intCustomerOrderNo;
        private bool blCustomerOrdering;


        // Buy N Get Free
        private int iBuyGetFreeHeader;
        private string sBuyGetFreeCat;
        private string sBuyGetFreePromotionTxt;

        // Customer Date of Birth
        private DateTime dtCustomerDOB;

        // Age varified for item on sale
        private int iAge;

        private string strItemUOM;


        #endregion

        #region definining public variables

        
        public int ParentReturnInvNo
        {
            get { return intParentReturnInvNo; }
            set { intParentReturnInvNo = value; }
        }

        public string GiftAid
        {
            get { return strGiftAid; }
            set { strGiftAid = value; }
        }

        private string strBookingExpFlag;

        public string BookingExpFlag
        {
            get { return strBookingExpFlag; }
            set { strBookingExpFlag = value; }
        }

        public double StoreCreditPointEquivalent
        {
            get { return dblStoreCreditPointEquivalent; }
            set { dblStoreCreditPointEquivalent = value; }
        }

        public DateTime CustomerDOB
        {
            get { return dtCustomerDOB; }
            set { dtCustomerDOB = value; }
        }

        public string PrintXml
        {
            get { return strPrintXml; }
            set { strPrintXml = value; }
        }

        public string LogFileName
        {
            get { return strLogFileName; }
            set { strLogFileName = value; }
        }

        public bool CustomerOrdering
        {
            get { return blCustomerOrdering; }
            set { blCustomerOrdering = value; }
        }

        public int CustomerOrderNo
        {
            get { return intCustomerOrderNo; }
            set { intCustomerOrderNo = value; }
        }

        public bool RepairDepositTransaction
        {
            get { return blRepairDepositTransaction; }
            set { blRepairDepositTransaction = value; }
        }

        public int RepairDepositLinkID
        {
            get { return intRepairDepositLinkID; }
            set { intRepairDepositLinkID = value; }
        }

        public string RepairItemName
        {
            get { return strRepairItemName; }
            set { strRepairItemName = value; }
        }

        public string RepairItemSL
        {
            get { return strRepairItemSL; }
            set { strRepairItemSL = value; }
        }

        public int DTaxID
        {
            get { return iDTaxID; }
            set { iDTaxID = value; }
        }

        public double DTax
        {
            get { return dDTax; }
            set { dDTax = value; }
        }


        public double TotalFees
        {
            get { return dblTotalFees; }
            set { dblTotalFees = value; }
        }

        public double TotalFeesTax
        {
            get { return dblTotalFeesTax; }
            set { dblTotalFeesTax = value; }
        }

        public double TotalFeesCoupon
        {
            get { return dblTotalFeesCoupon; }
            set { dblTotalFeesCoupon = value; }
        }

        public double TotalFeesCouponTax
        {
            get { return dblTotalFeesCouponTax; }
            set { dblTotalFeesCouponTax = value; }
        }


        public bool RepairIssueNClosed
        {
            get { return blRepairIssueNClosed; }
            set { blRepairIssueNClosed = value; }
        }
        
        public string AdjustFlag
        {
            get { return strAdjustFlag; }
            set { strAdjustFlag = value; }
        }

        public string OperateStore
        {
            get { return strOperateStore; }
            set { strOperateStore = value; }
        }

        public string GCOPStore
        {
            get { return strGCOPStore; }
            set { strGCOPStore = value; }
        }

        public string GCCentralFlag
        {
            get { return strGCCentralFlag; }
            set { strGCCentralFlag = value; }
        }

        public DataTable tblCardID
        {
            get { return dtblCardID; }
            set { dtblCardID = value; }
        }

        public DataTable tblMGCCardID
        {
            get { return dtblMGCCardID; }
            set { dtblMGCCardID = value; }
        }

        public string MercuryResponseOrigin
        {
            get { return strMercuryResponseOrigin; }
            set { strMercuryResponseOrigin = value; }
        }

        public string MercuryRecordNo
        {
            get { return strMercuryRecordNo; }
            set { strMercuryRecordNo = value; }
        }

        public string MercuryResponseReturnCode
        {
            get { return strMercuryResponseReturnCode; }
            set { strMercuryResponseReturnCode = value; }
        }

        public string MercuryTextResponse
        {
            get { return strMercuryTextResponse; }
            set { strMercuryTextResponse = value; }
        }

        public string RefCardAct
        {
            get { return strRefCardAct; }
            set { strRefCardAct = value; }
        }

        public string RefCardLogo
        {
            get { return strRefCardLogo; }
            set { strRefCardLogo = value; }
        }

        public string RefCardMerchID
        {
            get { return strRefCardMerchID; }
            set { strRefCardMerchID = value; }
        }

        public string RefCardEntry
        {
            get { return strRefCardEntry; }
            set { strRefCardEntry = value; }
        }

        public string RefCardAuthID
        {
            get { return strRefCardAuthID; }
            set { strRefCardAuthID = value; }
        }

        public string RefCardTranID
        {
            get { return strRefCardTranID; }
            set { strRefCardTranID = value; }
        }

        public double RefCardAuthAmount
        {
            get { return dblRefCardAuthAmount; }
            set { dblRefCardAuthAmount = value; }
        }

        public double RefCardBalAmount
        {
            get { return dblRefCardBalAmount; }
            set { dblRefCardBalAmount = value; }
        }

        public string CardTranType
        {
            get { return strCardTranType; }
            set { strCardTranType = value; }
        }

        public string IsDebit
        {
            get { return strIsDebit; }
            set { strIsDebit = value; }
        }

        public string MercuryProcessData
        {
            get { return strMercuryProcessData; }
            set { strMercuryProcessData = value; }
        }

        public string MercuryTranCode
        {
            get { return strMercuryTranCode; }
            set { strMercuryTranCode = value; }
        }

        public double MercuryPurchaseAmount
        {
            get { return dblMercuryPurchaseAmount; }
            set { dblMercuryPurchaseAmount = value; }
        }

        public string MercuryInvNo
        {
            get { return strMercuryInvNo; }
            set { strMercuryInvNo = value; }
        }

        public string AcqRefData
        {
            get { return strAcqRefData; }
            set { strAcqRefData = value; }
        }

        public string TokenData
        {
            get { return strTokenData; }
            set { strTokenData = value; }
        }

        public double RepairTenderAmount
        {
            get { return dblRepairTenderAmount; }
            set { dblRepairTenderAmount = value; }
        }

        public int IssueRepairInvNo
        {
            get { return intIssueRepairInvNo; }
            set { intIssueRepairInvNo = value; }
        }

        public int IssueRentInvNo
        {
            get { return intIssueRentInvNo; }
            set { intIssueRentInvNo = value; }
        }

        public string SaleTranNo
        {
            get { return strSaleTranNo; }
            set { strSaleTranNo = value; }
        }

        public string AuthorisedTranNo
        {
            get { return strAuthorisedTranNo; }
            set { strAuthorisedTranNo = value; }
        }

        public SqlConnection Connection
        {
            get { return sqlConn; }
            set { sqlConn = value; }
        }

        public DataTable ItemDataTable
        {
            get { return dtblItemDataTable; }
            set { dtblItemDataTable = value; }
        }

        public DataTable WorkOrder1
        {
            get { return dtblWorkOrder1; }
            set { dtblWorkOrder1 = value; }
        }

        public DataTable TenderDataTable
        {
            get { return dtblTenderDataTable; }
            set { dtblTenderDataTable = value; }
        }

        public DateTime LayawayDateDue
        {
            get { return dtLayawayDateDue; }
            set { dtLayawayDateDue = value; }
        }

        public DataTable ApptDataTable
        {
            get { return dtblApptDataTable; }
            set { dtblApptDataTable = value; }
        }

        public DataTable MercuryGiftCardDataTable
        {
            get { return dtblMercuryGiftCardDataTable; }
            set { dtblMercuryGiftCardDataTable = value; }
        }

        public string ServiceType
        {
            get { return strServiceType; }
            set { strServiceType = value; }
        }

        public string RepairProblem
        {
            get { return strRepairProblem; }
            set { strRepairProblem = value; }
        }

        public string RepairNotes
        {
            get { return strRepairNotes; }
            set { strRepairNotes = value; }
        }

        public string RepairRemarks
        {
            get { return strRepairRemarks; }
            set { strRepairRemarks = value; }
        }

        public double RepairAdvanceAmount
        {
            get { return dblRepairAdvanceAmount; }
            set { dblRepairAdvanceAmount = value; }
        }

        public double RepairAmount
        {
            get { return dblRepairAmount; }
            set { dblRepairAmount = value; }
        }

        public DateTime RepairDateIn
        {
            get { return dtRepairDateIn; }
            set { dtRepairDateIn = value; }
        }

        public DateTime RepairDeliveryDate
        {
            get { return dtRepairDeliveryDate; }
            set { dtRepairDeliveryDate = value; }
        }

        public DateTime RepairNotifiedDate
        {
            get { return dtRepairNotifiedDate; }
            set { dtRepairNotifiedDate = value; }
        }

        public double RentalSecurityDeposit
        {
            get { return dblRentalSecurityDeposit; }
            set { dblRentalSecurityDeposit = value; }
        }

        public string ErrorMsg
        {
            get { return strErrorMsg; }
            set { strErrorMsg = value; }
        }

        public bool PaidOutF
        {
            get { return blPaidOut; }
            set { blPaidOut = value; }
        }

        public bool PaidInF
        {
            get { return blPaidIn; }
            set { blPaidIn = value; }
        }

        public bool SafeDropF
        {
            get { return blSafeDrop; }
            set { blSafeDrop = value; }
        }

        public bool RentReturn
        {
            get { return blRentReturn; }
            set { blRentReturn = value; }
        }

        public bool Return
        {
            get { return blReturn; }
            set { blReturn = value; }
        }

        public bool NewLayaway
        {
            get { return blNewLayaway; }
            set { blNewLayaway = value; }
        }

        public string AuthCode
        {
            get { return strAuthCode; }
            set { strAuthCode = value; }
        }

        public string Reference
        {
            get { return strReference; }
            set { strReference = value; }
        }

        public bool Layaway
        {
            get { return blLayaway; }
            set { blLayaway = value; }
        }

        public bool LayawayRefund
        {
            get { return blLayawayRefund; }
            set { blLayawayRefund = value; }
        }

        public bool MGCIssue
        {
            get { return blMGCIssue; }
            set { blMGCIssue = value; }
        }

        public int PaymentGateway
        {
            get { return intPaymentGateway; }
            set { intPaymentGateway = value; }
        }

        public int DecimalPlace
        {
            get { return intDecimalPlace; }
            set { intDecimalPlace = value; }
        }

        public int LoginUserID
        {
            get { return intLoginUserID; }
            set { intLoginUserID = value; }
        }

        public int ID
        {
            get { return intID; }
            set { intID = value; }
        }

        public int NewID
        {
            get { return intNewID; }
            set { intNewID = value; }
        }

        public int SuspendInvoiceNo
        {
            get { return intSuspendInvoiceNo; }
            set { intSuspendInvoiceNo = value; }
        }

        public string TerminalName
        {
            get { return strTerminalName; }
            set { strTerminalName = value; }
        }

        public int TransactionNo
        {
            get { return intTransactionNo; }
            set { intTransactionNo = value; }
        }

        public int TransType
        {
            get { return intTransType; }
            set { intTransType = value; }
        }

        public int EmployeeID
        {
            get { return intEmployeeID; }
            set { intEmployeeID = value; }
        }

        public int RegisterID
        {
            get { return intRegisterID; }
            set { intRegisterID = value; }
        }

        public int StoreID
        {
            get { return intStoreID; }
            set { intStoreID = value; }
        }

        public int CustomerID
        {
            get { return intCustomerID; }
            set { intCustomerID = value; }
        }

        public int CloseoutID
        {
            get { return intCloseoutID; }
            set { intCloseoutID = value; }
        }

        public int LayawayID
        {
            get { return intLayawayID; }
            set { intLayawayID = value; }
        }

        public int TransNoteNo
        {
            get { return intTransNoteNo; }
            set { intTransNoteNo = value; }
        }

        public int Status
        {
            get { return intStatus; }
            set { intStatus = value; }
        }

        public int ReceiptCnt
        {
            get { return intReceiptCnt; }
            set { intReceiptCnt = value; }
        }

        public int LayawayNo
        {
            get { return intLayawayNo; }
            set { intLayawayNo = value; }
        }

        public int TransMSeconds
        {
            get { return intTransMSeconds; }
            set { intTransMSeconds = value; }
        }

        public double Tax
        {
            get { return dblTax; }
            set { dblTax = value; }
        }

        public double Discount
        {
            get { return dblDiscount; }
            set { dblDiscount = value; }
        }

        public double Coupon
        {
            get { return dblCoupon; }
            set { dblCoupon = value; }
        }

        public double TotalSale
        {
            get { return dblTotalSale; }
            set { dblTotalSale = value; }
        }

        public string DiscountReason
        {
            get { return strDiscountReason; }
            set { strDiscountReason = value; }
        }

        public double ChangeAmount
        {
            get { return dblChangeAmount; }
            set { dblChangeAmount = value; }
        }

        public int TaxID1
        {
            get { return intTaxID1; }
            set { intTaxID1 = value; }
        }

        public int TaxID2
        {
            get { return intTaxID2; }
            set { intTaxID2 = value; }
        }

        public int TaxID3
        {
            get { return intTaxID3; }
            set { intTaxID3 = value; }
        }

        public double Tax1
        {
            get { return dblTax1; }
            set { dblTax1 = value; }
        }

        public double Tax2
        {
            get { return dblTax2; }
            set { dblTax2 = value; }
        }

        public double Tax3
        {
            get { return dblTax3; }
            set { dblTax3 = value; }
        }

        public string Notes
        {
            get { return strNotes; }
            set { strNotes = value; }
        }

        public double PaidOutAmount
        {
            get { return dblPaidOutAmount; }
            set { dblPaidOutAmount = value; }
        }

        public int CardTranID
        {
            get { return intCardTranID; }
            set { intCardTranID = value; }
        }

        public string CardType
        {
            get { return strCardType; }
            set { strCardType = value; }
        }

        public double CardAmount
        {
            get { return dblCardAmount; }
            set { dblCardAmount = value; }
        }

        public int ChangedByAdmin
        {
            get { return intChangedByAdmin; }
            set { intChangedByAdmin = value; }
        }

        public bool FunctionButtonAccess
        {
            get { return blFunctionButtonAccess; }
            set { blFunctionButtonAccess = value; }
        }

        public DateTime ScheduleTime
        {
            get { return dtScheduleTime; }
            set { dtScheduleTime = value; }
        }

        public int ApptServiceTime
        {
            get { return intApptServiceTime; }
            set { intApptServiceTime = value; }
        }

        public string ApptStatus
        {
            get { return strApptStatus; }
            set { strApptStatus = value; }
        }

        public string ApptRemarks
        {
            get { return strApptRemarks; }
            set { strApptRemarks = value; }
        }

        public int MercuryGCIssueCardID
        {
            get { return intMercuryGCIssueCardID; }
            set { intMercuryGCIssueCardID = value; }
        }

        public string IsRentCalculated
        {
            get { return strIsRentCalculated; }
            set { strIsRentCalculated = value; }
        }

        public double CouponPerc
        {
            get { return dblCouponPerc; }
            set { dblCouponPerc = value; }
        }

        public string RepairFindUs
        {
            get { return strRepairFindUs; }
            set { strRepairFindUs = value; }
        }

        #endregion

        public int GetParentCategoryID(int cat)
        {
            int val = 0;

            string strSQLComm = " select ParentCategory from category where ID = @prm1 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@prm1", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@prm1"].Value = cat;


            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["ParentCategory"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public string GetParentCategoryName(int cat)
        {
            string val = "";

            string strSQLComm = " select Description from category where ID = @prm1 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@prm1", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@prm1"].Value = cat;


            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    val = objSQLReader["Description"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return "";
            }
        }


        #region Fetch POS Functions

        public DataTable FetchPOSFunctionData()
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select ID,FunctionName,DisplayOrder,IsVisible, FunctionDescription "
                                + " from POSFunctionSetup where FunctionType = 'FunctionButton' order by DisplayOrder ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayOrder", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVisible", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionDescription", System.Type.GetType("System.String"));

                string strVisible = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["IsVisible"].ToString() == "Y")
                    {
                        strVisible = "Yes";
                    }
                    else
                    {
                        strVisible = "No";
                    }

                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
												   objSQLReader["FunctionName"].ToString(),
												   objSQLReader["DisplayOrder"].ToString(),
                                                   strVisible,objSQLReader["FunctionDescription"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchVisiblePOSFunction(bool flag, int UserID)
        {
            DataTable dtbl = new DataTable();
            string strFilter = "";
            string strFilterUser = "";
            if (!flag) strFilter = " and FunctionName not in ('Revert CARD Tran.','Mercury Gift Card','EBT/ Mercury Gift Card Balance' ) ";
            if (UserID == 0)
            {
                strFilterUser = " and FunctionName != 'Check In/Out' ";
            }
            string strSQLComm =    " select ID,FunctionName,DisplayOrder,IsVisible from POSFunctionSetup where FunctionType = "
                                 + " 'FunctionButton' and Isvisible = 'Y' " + strFilter + strFilterUser + " order by DisplayOrder ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayOrder", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVisible", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
												   objSQLReader["FunctionName"].ToString(),
												   objSQLReader["DisplayOrder"].ToString(),
                                                   objSQLReader["IsVisible"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchInvisiblePOSFunction()
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select ID,FunctionName,DisplayOrder,IsVisible "
                                + " from POSFunctionSetup where FunctionType = 'FunctionButton' and Isvisible = 'N'  ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayOrder", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVisible", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
												   objSQLReader["FunctionName"].ToString(),
												   objSQLReader["DisplayOrder"].ToString(),
                                                   objSQLReader["IsVisible"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchScaleFunctionData()
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select ID,FunctionName,DisplayOrder,IsVisible, FunctionDescription "
                                + " from POSFunctionSetup where FunctionType = 'ScaleFunctionButton' order by DisplayOrder ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayOrder", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVisible", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionDescription", System.Type.GetType("System.String"));

                string strVisible = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["IsVisible"].ToString() == "Y")
                    {
                        strVisible = "Yes";
                    }
                    else
                    {
                        strVisible = "No";
                    }

                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
												   objSQLReader["FunctionName"].ToString(),
												   objSQLReader["DisplayOrder"].ToString(),
                                                   strVisible,objSQLReader["FunctionDescription"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchVisibleScaleFunction(string HostEnabled)
        {
            DataTable dtbl = new DataTable();
            string strFilter = "";
            string strSQLComm = " select ID,FunctionName,DisplayOrder,IsVisible from POSFunctionSetup where FunctionType = "
                              + " 'ScaleFunctionButton' and Isvisible = 'Y' " + strFilter + " order by DisplayOrder ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FunctionName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayOrder", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVisible", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if ((HostEnabled == "N") && (objSQLReader["FunctionName"].ToString() == "Host")) continue;
                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
												   objSQLReader["FunctionName"].ToString(),
												   objSQLReader["DisplayOrder"].ToString(),
                                                   objSQLReader["IsVisible"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        #region POS Main Button Interface

        public DataTable FetchPOSCategories(int parentcat, int level)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select * from category where maxitemsforpos > 0 and addtoposscreen = 'Y' and ParentCategory = @prm1 and ParentCategoryLevel = @prm2 order by posdisplayorder asc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@prm1", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@prm1"].Value = parentcat;

            objSQlComm.Parameters.Add(new SqlParameter("@prm2", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@prm2"].Value = level;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("DESCRIPTION", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MAXITEMSFORPOS", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("POSBACKGROUND", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENSTYLE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSDISPLAYORDER", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("POSFONTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTSIZE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISBOLD", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISITALICS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PARENTCATEGORY", System.Type.GetType("System.Int32"));

                int intCatID = 0;
                int intCatMaxItems = 0;
                int intCatOrder = 0;


                while (objSQLReader.Read())
                {
                    intCatID = 0;
                    intCatMaxItems = 0;
                    //intCatOrder = 0;

                    if (objSQLReader["ID"].ToString() != "")
                        intCatID = Functions.fnInt32(objSQLReader["ID"].ToString());

                    if (objSQLReader["MAXITEMSFORPOS"].ToString() != "")
                        intCatMaxItems = Functions.fnInt32(objSQLReader["MAXITEMSFORPOS"].ToString());

                    if (objSQLReader["POSDISPLAYORDER"].ToString() != "")
                        intCatOrder++;// = Functions.fnInt32(objSQLReader["POSDISPLAYORDER"].ToString());

                    dtbl.Rows.Add(new object[] {intCatID,
                                                objSQLReader["DESCRIPTION"].ToString(),
                                                intCatMaxItems,
                                                objSQLReader["POSBACKGROUND"].ToString(),
                                                objSQLReader["POSSCREENCOLOR"].ToString(),
                                                objSQLReader["POSSCREENSTYLE"].ToString(),
                                                intCatOrder,
                                                objSQLReader["POSFONTTYPE"].ToString(),
                                                objSQLReader["POSFONTSIZE"].ToString(),
                                                objSQLReader["POSFONTCOLOR"].ToString(),
                                                objSQLReader["ISBOLD"].ToString(),
                                                objSQLReader["ISITALICS"].ToString(),
                                                Functions.fnInt32(objSQLReader["PARENTCATEGORY"].ToString())});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        // 03-12-2013    Reorder Items in POS – Retail 

        public DataTable FetchPOSItemsforCategory(int CatID, bool AllItems)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";
            if (AllItems)
            {
                strSQLComm = " select ID,SKU,Description,ProductType,DisplayStockinPOS,AllowZeroStock, "
                           + " QtyOnHand,POSBackground,POSScreenColor,POSScreenStyle,POSFontType, "
                           + " POSFontSize,POSFontColor,IsBold,IsItalics,LinkSKU,BreakPackRatio,CaseQty,POSDisplayOrder,ExpiryDate "
                           + " from Product where CategoryID = @CategoryID and ProductStatus = 'Y' and POSVisible = 'Y' "
                           + " and LinkSKU >= 0 order by POSDisplayOrder ";
            }
            else
            {
                strSQLComm =  " select ID,SKU,Description,ProductType,DisplayStockinPOS,AllowZeroStock, "
                            + " QtyOnHand,POSBackground,POSScreenColor,POSScreenStyle,POSFontType, "
                            + " POSFontSize,POSFontColor,IsBold,IsItalics,LinkSKU,BreakPackRatio,CaseQty,POSDisplayOrder,ExpiryDate "
                            + " from Product where CategoryID = @CategoryID and ProductStatus = 'Y' and LinkSKU >= 0 "
                            + " and AddtoPOSScreen = 'Y' order by POSDisplayOrder desc";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@CategoryID"].Value = CatID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DESCRIPTION", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PRODUCTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DISPLAYSTOCKINPOS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ALLOWZEROSTOCK", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QTYONHAND", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("POSBACKGROUND", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENSTYLE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTSIZE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISBOLD", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISITALICS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LINKSKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BREAKPACKRATIO", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PACKQTY", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSDISPLAYORDER", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EXPIRYDATE", System.Type.GetType("System.String"));
                int intItemID = 0;
                int intItemQty = 0;
                double dbQty = 0;
                
                while (objSQLReader.Read())
                {
                    intItemID = 0;
                    intItemQty = 0;
                    dbQty = 0;

                    if (objSQLReader["ID"].ToString() != "")
                        intItemID = Functions.fnInt32(objSQLReader["ID"].ToString());

                    if (objSQLReader["QTYONHAND"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["QTYONHAND"].ToString());

                    intItemQty = Functions.fnInt32(dbQty);
                    dtbl.Rows.Add(new object[] {intItemID,
                                                objSQLReader["SKU"].ToString(),
												objSQLReader["DESCRIPTION"].ToString(),
                                                objSQLReader["PRODUCTTYPE"].ToString(),
                                                objSQLReader["DISPLAYSTOCKINPOS"].ToString(),
                                                objSQLReader["ALLOWZEROSTOCK"].ToString(),
                                                intItemQty,
                                                objSQLReader["POSBACKGROUND"].ToString(),
                                                objSQLReader["POSSCREENCOLOR"].ToString(),
                                                objSQLReader["POSSCREENSTYLE"].ToString(),
                                                objSQLReader["POSFONTTYPE"].ToString(),
                                                objSQLReader["POSFONTSIZE"].ToString(),
                                                objSQLReader["POSFONTCOLOR"].ToString(),
                                                objSQLReader["ISBOLD"].ToString(),
                                                objSQLReader["ISITALICS"].ToString(),
                                                objSQLReader["LINKSKU"].ToString(),
                                                objSQLReader["BREAKPACKRATIO"].ToString(),
                                                objSQLReader["CASEQTY"].ToString(),
                                                objSQLReader["POSDISPLAYORDER"].ToString(),
                                                objSQLReader["ExpiryDate"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int GetChildOfAParentGroup(int parentcat)
        {
            int val = 0;

            string strSQLComm = " select count(*) as rcnt from category where maxitemsforpos > 0 and addtoposscreen = 'Y' and Enabled = 'Y' and ParentCategory = @prm1 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@prm1", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@prm1"].Value = parentcat;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable FetchPOSItemsforCategory1(int CatID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";
            strSQLComm = " select ID,SKU,Description,ProductType,DisplayStockinPOS,AllowZeroStock, "
                            + " QtyOnHand,POSBackground,POSScreenColor,POSScreenStyle,POSFontType, "
                            + " POSFontSize,POSFontColor,IsBold,IsItalics,LinkSKU,BreakPackRatio,CaseQty,POSDisplayOrder, ExpiryDate "
                            + " from Product where CategoryID = @CategoryID and ProductStatus = 'Y' and LinkSKU >= 0 "
                            + " and AddtoPOSCategoryScreen = 'Y' order by POSDisplayOrder desc"; //and AddtoPOSScreen = 'Y'

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@CategoryID"].Value = CatID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DESCRIPTION", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PRODUCTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DISPLAYSTOCKINPOS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ALLOWZEROSTOCK", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QTYONHAND", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("POSBACKGROUND", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENSTYLE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTSIZE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISBOLD", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISITALICS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LINKSKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BREAKPACKRATIO", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PACKQTY", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSDISPLAYORDER", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EXPIRYDATE", System.Type.GetType("System.String"));
                int intItemID = 0;
                int intItemQty = 0;
                double dbQty = 0;

                while (objSQLReader.Read())
                {
                    intItemID = 0;
                    intItemQty = 0;
                    dbQty = 0;

                    if (objSQLReader["ID"].ToString() != "")
                        intItemID = Functions.fnInt32(objSQLReader["ID"].ToString());

                    if (objSQLReader["QTYONHAND"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["QTYONHAND"].ToString());

                    intItemQty = Functions.fnInt32(dbQty);
                    dtbl.Rows.Add(new object[] {intItemID,
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["DESCRIPTION"].ToString(),
                                                objSQLReader["PRODUCTTYPE"].ToString(),
                                                objSQLReader["DISPLAYSTOCKINPOS"].ToString(),
                                                objSQLReader["ALLOWZEROSTOCK"].ToString(),
                                                intItemQty,
                                                objSQLReader["POSBACKGROUND"].ToString(),
                                                objSQLReader["POSSCREENCOLOR"].ToString(),
                                                objSQLReader["POSSCREENSTYLE"].ToString(),
                                                objSQLReader["POSFONTTYPE"].ToString(),
                                                objSQLReader["POSFONTSIZE"].ToString(),
                                                objSQLReader["POSFONTCOLOR"].ToString(),
                                                objSQLReader["ISBOLD"].ToString(),
                                                objSQLReader["ISITALICS"].ToString(),
                                                objSQLReader["LINKSKU"].ToString(),
                                                objSQLReader["BREAKPACKRATIO"].ToString(),
                                                objSQLReader["CASEQTY"].ToString(),
                                                objSQLReader["POSDISPLAYORDER"].ToString(),
                                                objSQLReader["ExpiryDate"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchPOSItems(int ItemID, bool AllItems)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";
            if (AllItems)
            {
                strSQLComm = " select ID,SKU,Description, ProductType, DisplayStockinPOS, AllowZeroStock, "
                           + " QtyOnHand,POSBackground,POSScreenColor,POSScreenStyle, "
                           + " POSFontType,POSFontSize,POSFontColor,IsBold,IsItalics, ExpiryDate "
                           + " from Product where ID = @ID and ProductStatus = 'Y' ";
            }
            else
            {
                strSQLComm = " select ID,SKU,Description, ProductType, DisplayStockinPOS, AllowZeroStock, "
                           + " QtyOnHand,POSBackground,POSScreenColor,POSScreenStyle, "
                           + " POSFontType,POSFontSize,POSFontColor,IsBold,IsItalics, ExpiryDate "
                           + " from Product where ID = @ID and AddtoPOSScreen = 'Y' and ProductStatus = 'Y' ";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = ItemID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DESCRIPTION", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PRODUCTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DISPLAYSTOCKINPOS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ALLOWZEROSTOCK", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QTYONHAND", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("POSBACKGROUND", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSSCREENSTYLE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTSIZE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSFONTCOLOR", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISBOLD", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ISITALICS", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EXPIRYDATE", System.Type.GetType("System.String"));

                int intItemID = 0;
                int intItemQty = 0;
                double dbQty = 0;


                while (objSQLReader.Read())
                {
                    intItemID = 0;
                    intItemQty = 0;
                    dbQty = 0;

                    if (objSQLReader["ID"].ToString() != "")
                        intItemID = Functions.fnInt32(objSQLReader["ID"].ToString());

                    if (objSQLReader["QTYONHAND"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["QTYONHAND"].ToString());

                    intItemQty = Functions.fnInt32(dbQty);
                    dtbl.Rows.Add(new object[] {intItemID,
                                                objSQLReader["SKU"].ToString(),
												objSQLReader["DESCRIPTION"].ToString(),
                                                objSQLReader["PRODUCTTYPE"].ToString(),
                                                objSQLReader["DISPLAYSTOCKINPOS"].ToString(),
                                                objSQLReader["ALLOWZEROSTOCK"].ToString(),
                                                intItemQty,
                                                objSQLReader["POSBACKGROUND"].ToString(),
                                                objSQLReader["POSSCREENCOLOR"].ToString(),
                                                objSQLReader["POSSCREENSTYLE"].ToString(),
                                                objSQLReader["POSFONTTYPE"].ToString(),
                                                objSQLReader["POSFONTSIZE"].ToString(),
                                                objSQLReader["POSFONTCOLOR"].ToString(),
                                                objSQLReader["ISBOLD"].ToString(),
                                                objSQLReader["ISITALICS"].ToString(),
                                                objSQLReader["ExpiryDate"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public string GetReorderLevelProductName(int Itemid)
        {
            string val = "";
            string strSQLComm = "";
            strSQLComm = "select description from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    val = objSQLReader["description"].ToString();

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return val;
            }
        }

        public string GetReorderLevelCheckProductType(int Itemid)
        {
            string val = "";
            string strSQLComm = "";
            strSQLComm = "select ProductType from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                
                while (objSQLReader.Read())
                {
                    val = objSQLReader["ProductType"].ToString();
                    
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return val;
            }
        }

        public int GetReorderLevelCheckLinkID(int Itemid)
        {
            int intval = 0;
            string strSQLComm = "";
            strSQLComm = "select LinkSKU from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                
                while (objSQLReader.Read())
                {
                    intval = Functions.fnInt32(objSQLReader["LinkSKU"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intval;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double GetReorderLevelCheckBreakpackRatio(int Itemid)
        {
            double intval = 0;
            string strSQLComm = "";
            strSQLComm = "select BreakPackRatio from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    intval = Functions.fnDouble(objSQLReader["BreakPackRatio"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intval;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }


        public double GetReorderLevelCheckOnHandQty(int Itemid)
        {
            double dbQty = 0;
            string strSQLComm = "";
            strSQLComm = "select QtyOnHand from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                
                while (objSQLReader.Read())
                {
                    
                    dbQty = 0;

                    if (objSQLReader["QtyOnHand"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["QtyOnHand"].ToString());

                    
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dbQty;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double GetReorderLevelCheckReorderQty(int Itemid)
        {
            double dbQty = 0;
            string strSQLComm = "";
            strSQLComm = "select ReorderQty from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {

                    dbQty = 0;

                    if (objSQLReader["ReorderQty"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["ReorderQty"].ToString());


                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dbQty;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }


        public double GetOnHandQty(int Itemid)
        {
            int intItemQty = 0;
            string strSQLComm = "";
            strSQLComm = "select QtyOnHand from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                double dbQty = 0;
                while (objSQLReader.Read())
                {
                    intItemQty = 0;
                    dbQty = 0;

                    if (objSQLReader["QtyOnHand"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["QtyOnHand"].ToString());

                    intItemQty = Functions.fnInt32(dbQty);
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intItemQty;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return intItemQty;
            }
        }


       

        public int GetStockforItem(int Itemid)
        {
            int intItemQty = 0;
            string strSQLComm = "";
            strSQLComm = "select QtyOnHand from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                double dbQty = 0;
                while (objSQLReader.Read())
                {
                    intItemQty = 0;
                    dbQty = 0;

                    if (objSQLReader["QTYONHAND"].ToString() != "")
                        dbQty = Functions.fnDouble(objSQLReader["QTYONHAND"].ToString());

                    intItemQty = Functions.fnInt32(dbQty);
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intItemQty;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return intItemQty;
            }
        }

        public bool IsNonDiscountableItem(int Itemid)
        {
            string strval = "";
            string strSQLComm = "";
            strSQLComm = "select NonDiscountable from Product where ID = @ID";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = Itemid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                double dbQty = 0;
                while (objSQLReader.Read())
                {
                    strval = objSQLReader["NonDiscountable"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return strval == "Y";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IsCustomerDiscountApplicable(int CID)
        {
            int val = 0;
            string strSQLComm = "";
            strSQLComm = " select isnull(c.discountid,0) as did from customer c "
                       + " left outer join discountmaster d on d.ID = c.discountid "
                       + " where d.DiscountStatus = 'Y' and c.ID = @ID ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = CID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                double dbQty = 0;
                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["did"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val > 0;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        #endregion

        #region Fetch Customer Data based on Customer ID

        public DataTable FetchCustomerRecord(int intRecID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select * from Customer where ID = @ID";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intRecID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FirstName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LastName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AccountNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Spouse", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Salutation", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Address1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Address2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("City", System.Type.GetType("System.String"));
                dtbl.Columns.Add("State", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Country", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Zip", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShipAddress1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShipAddress2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShipCity", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShipState", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShipCountry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShipZip", System.Type.GetType("System.String"));
                dtbl.Columns.Add("WorkPhone", System.Type.GetType("System.String"));
                dtbl.Columns.Add("HomePhone", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MobilePhone", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EMail", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxExempt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountLevel", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StoreCredit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateLastPurchase", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AmountLastPurchase", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPurchases", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ARCreditLimit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateOfBirth", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateOfMarriage", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ClosingBalance", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Points", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerPhoto", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StoreCreditCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParamValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParamValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParamValue3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParamValue4", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParamValue5", System.Type.GetType("System.String"));
                dtbl.Columns.Add("POSNotes", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["CustomerID"].ToString(),
                                                objSQLReader["FirstName"].ToString(),
												objSQLReader["LastName"].ToString(),
                                                objSQLReader["Company"].ToString(),
                                                objSQLReader["AccountNo"].ToString(),
                                                objSQLReader["Spouse"].ToString(),
                                                objSQLReader["Salutation"].ToString(),
                                                objSQLReader["Address1"].ToString(),
                                                objSQLReader["Address2"].ToString(),
                                                objSQLReader["City"].ToString(),
                                                objSQLReader["State"].ToString(),
                                                objSQLReader["Country"].ToString(),
                                                objSQLReader["Zip"].ToString(),
                                                objSQLReader["ShipAddress1"].ToString(),
                                                objSQLReader["ShipAddress2"].ToString(),
                                                objSQLReader["ShipCity"].ToString(),
                                                objSQLReader["ShipState"].ToString(),
                                                objSQLReader["ShipCountry"].ToString(),
                                                objSQLReader["ShipZip"].ToString(),
                                                objSQLReader["WorkPhone"].ToString(),
                                                objSQLReader["HomePhone"].ToString(),
                                                objSQLReader["Fax"].ToString(),
                                                objSQLReader["MobilePhone"].ToString(),
                                                objSQLReader["EMail"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["TaxExempt"].ToString(),
                                                objSQLReader["TaxID"].ToString(),
                                                objSQLReader["DTaxID"].ToString(),
                                                objSQLReader["DiscountLevel"].ToString(),
                                                objSQLReader["StoreCredit"].ToString(),
                                                objSQLReader["DateLastPurchase"].ToString(),
                                                objSQLReader["AmountLastPurchase"].ToString(),
                                                objSQLReader["TotalPurchases"].ToString(),
                                                objSQLReader["ARCreditLimit"].ToString(),
                                                objSQLReader["DateOfBirth"].ToString(),
                                                objSQLReader["DateOfMarriage"].ToString(),
                                                objSQLReader["ClosingBalance"].ToString(),
                                                objSQLReader["Points"].ToString(),
                                                objSQLReader["CustomerPhoto"].ToString(),
                                                objSQLReader["StoreCreditCard"].ToString(),
                                                objSQLReader["ParamValue1"].ToString(),
                                                objSQLReader["ParamValue2"].ToString(),
                                                objSQLReader["ParamValue3"].ToString(),
                                                objSQLReader["ParamValue4"].ToString(),
                                                objSQLReader["ParamValue5"].ToString(),
                                                objSQLReader["POSNotes"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        #region Fetch Product Data based on Product ID

        public void GetTare(int intRecID, ref double T1, ref double T2)
        {
            double val = 0;

            string strSQLComm = " select Tare,Tare2 from product where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intRecID;
            objSQlComm.CommandTimeout = 500;
            SqlDataReader objSQLReader = null;

            string pPrice = "";

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                
                while (objSQLReader.Read())
                {
                    T1 = Functions.fnDouble(objSQLReader["Tare"].ToString());
                    T2 = Functions.fnDouble(objSQLReader["Tare2"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return;
            }
        }

        public DataTable FetchProductRecord(int intRecID, string strPriceLevel, int UsePOSPriceLevel)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select * from product where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intRecID;
            objSQlComm.CommandTimeout = 500;
            SqlDataReader objSQLReader = null;

            string pPrice = "";

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BinLocation", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceA", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceB", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceC", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptForPrice", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("AddtoPOSScreen", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AddToPOSCategoryScreen", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ScaleBarCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LastCost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyOnHand", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyOnLayaway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReorderQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NormalQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PrimaryVendorID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DepartmentID", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("CategoryID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Points", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PrintBarCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NoPriceOnLabel", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyToPrint", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LabelType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FoodStampEligible", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductNotes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MinimumAge", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("DecimalPlace", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerMinute", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerHour", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerHalfDay", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerDay", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerWeek", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerMonth", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalMinHour", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalMinAmount", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("RentalPrompt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairCharge", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairPromptForCharge", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairPromptForTag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOM", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ExpiryDate", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if (UsePOSPriceLevel == 0)
                    {
                        if (strPriceLevel.Trim() == "") strPriceLevel = "A";
                        if (strPriceLevel == "A") pPrice = objSQLReader["PriceA"].ToString();
                        if (strPriceLevel == "B") pPrice = objSQLReader["PriceB"].ToString();
                        if (strPriceLevel == "C") pPrice = objSQLReader["PriceC"].ToString();
                    }
                    if (UsePOSPriceLevel == 1) pPrice = objSQLReader["PriceA"].ToString();
                    if (UsePOSPriceLevel == 2) pPrice = objSQLReader["PriceB"].ToString();
                    if (UsePOSPriceLevel == 3) pPrice = objSQLReader["PriceC"].ToString();

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["SKU"].ToString(),
                                                objSQLReader["SKU2"].ToString(),
												objSQLReader["Description"].ToString(),
                                                objSQLReader["BinLocation"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["PriceA"].ToString(),
                                                objSQLReader["PriceB"].ToString(),
                                                objSQLReader["PriceC"].ToString(),
                                                objSQLReader["PromptForPrice"].ToString(),
                                                
                                                objSQLReader["AddtoPOSScreen"].ToString(),
                                                objSQLReader["AddToPOSCategoryScreen"].ToString(),
                                                objSQLReader["ScaleBarCode"].ToString(),
                                                objSQLReader["LastCost"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                objSQLReader["QtyOnHand"].ToString(),
                                                objSQLReader["QtyOnLayaway"].ToString(),
                                                objSQLReader["ReorderQty"].ToString(),
                                                objSQLReader["NormalQty"].ToString(),
                                                objSQLReader["PrimaryVendorID"].ToString(),
                                                objSQLReader["DepartmentID"].ToString(),
                                                
                                                objSQLReader["CategoryID"].ToString(),
                                                objSQLReader["Points"].ToString(),
                                                objSQLReader["PrintBarCode"].ToString(),
                                                objSQLReader["NoPriceOnLabel"].ToString(),
                                                objSQLReader["QtyToPrint"].ToString(),
                                                objSQLReader["LabelType"].ToString(),
                                                objSQLReader["FoodStampEligible"].ToString(),
                                                objSQLReader["ProductNotes"].ToString(),
                                                objSQLReader["MinimumAge"].ToString(), 
                                                pPrice,
                                                
                                                objSQLReader["DecimalPlace"].ToString(),
                                                objSQLReader["RentalPerMinute"].ToString(),
                                                objSQLReader["RentalPerHour"].ToString(),
                                                objSQLReader["RentalPerHalfDay"].ToString(),
                                                objSQLReader["RentalPerDay"].ToString(),
                                                objSQLReader["RentalPerWeek"].ToString(),
                                                objSQLReader["RentalPerMonth"].ToString(),
                                                objSQLReader["RentalDeposit"].ToString(),
                                                objSQLReader["RentalMinHour"].ToString(),
                                                objSQLReader["RentalMinAmount"].ToString(),
                                                objSQLReader["RentalPrompt"].ToString(),
                                                
                                                objSQLReader["RepairCharge"].ToString(),
                                                objSQLReader["RepairPromptForCharge"].ToString(),
                                                objSQLReader["RepairPromptForTag"].ToString(),
                                                objSQLReader["UOM"].ToString(),
                                                objSQLReader["ExpiryDate"].ToString()

                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchProductRentalData(int intRecID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select * from product where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intRecID;
            objSQlComm.CommandTimeout = 500;
            SqlDataReader objSQLReader = null;

            string pPrice = "";

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerMinute", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerHour", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerHalfDay", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerDay", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerWeek", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalPerMonth", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalMinHour", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentalMinAmount", System.Type.GetType("System.String"));
                

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["SKU"].ToString(),
												objSQLReader["Description"].ToString(),
                                                objSQLReader["RentalPerMinute"].ToString(),
                                                objSQLReader["RentalPerHour"].ToString(),
                                                objSQLReader["RentalPerHalfDay"].ToString(),
                                                objSQLReader["RentalPerDay"].ToString(),
                                                objSQLReader["RentalPerWeek"].ToString(),
                                                objSQLReader["RentalPerMonth"].ToString(),
                                                objSQLReader["RentalDeposit"].ToString(),
                                                objSQLReader["RentalMinHour"].ToString(),
                                                objSQLReader["RentalMinAmount"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        #region Check if Gift Certificate Exists

        public int IfExistGiftCert(string pGC)
        {
            int intresult = 0;
            string strSQLComm = " select count(*) as rcnt from GiftCert where GiftCertID = @GiftCert ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@GiftCert", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@GiftCert"].Value = pGC;
                
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    intresult = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public int IfExistGiftCert1(string pGC)
        {
            int intresult = 0;
            string strSQLComm = " select count(*) as rcnt from GiftCert where GiftCertID = @GiftCert";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@GiftCert", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@GiftCert"].Value = pGC;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    intresult = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public int IfExistGiftCert2(string pGC)
        {
            int intresult = 0;
            string strSQLComm = " select count(*) as rcnt from GiftCert where GiftCertID = @GiftCert ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@GiftCert", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@GiftCert"].Value = pGC;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    intresult = Functions.fnInt32(objSQLReader["RECCOUNT"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public int IfExistGiftCert(string pGC,string pStore,string CentralFlag)
        {
            int intresult = 0;
            string strSQLComm = "";

            if (CentralFlag == "Y")
                strSQLComm = " select count(*) as rcnt from GiftCert where GiftCertID = @GiftCert and IssueStore = @StoreCode ";
            if (CentralFlag == "N")
                strSQLComm = " select count(*) as rcnt from GiftCert where GiftCertID = @GiftCert";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@GiftCert", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@GiftCert"].Value = pGC;
                if (CentralFlag == "Y")
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@StoreCode", System.Data.SqlDbType.NVarChar));
                    objSQlComm.Parameters["@StoreCode"].Value = pStore;
                }

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    intresult = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #endregion

        #region Check if Gift Certificate Not Redeemed

        public int IfNotRedeemGiftCert(string pGC,string pGCStore,string CentralFlag)
        {
            SaveTran = null;
            SaveCon = this.sqlConn;
            if (SaveCon.State == System.Data.ConnectionState.Open) SaveCon.Close();
            SaveCon.Open();
            SaveTran = SaveCon.BeginTransaction();
            SaveComm = new SqlCommand("", this.Connection);
            SaveComm.Transaction = this.SaveTran;
            int intresult = 0;
            
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                double IssueAmount = 0;
                double TranAmount = 0;

                IssueAmount = GetGiftCertAmount(SaveComm, pGC, pGCStore, CentralFlag);
                TranAmount = GetGiftCertTranAmount(SaveComm, pGC, pGCStore, CentralFlag);

                if ((IssueAmount - TranAmount) > 0)
                    intresult = 1;

                SaveTran.Commit();
                SaveTran.Dispose();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                SaveTran.Commit();
                SaveTran.Dispose();
                return 0;
            }
        }

        #endregion

        #region Fetch Gift Certificate Amount

        public double FetchGiftCertAmount(string pGC, string pGCStore, string CentralFlag)
        {
            SaveTran = null;
            SaveCon = this.sqlConn;
            if (SaveCon.State == System.Data.ConnectionState.Open) SaveCon.Close();
            SaveCon.Open();
            SaveTran = SaveCon.BeginTransaction();
            SaveComm = new SqlCommand("", this.Connection);
            SaveComm.Transaction = this.SaveTran;
            double dblresult = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                double IssueAmount = GetGiftCertAmount(SaveComm, pGC, pGCStore, CentralFlag);
                double TranAmount = GetGiftCertTranAmount(SaveComm, pGC, pGCStore, CentralFlag);

                dblresult = IssueAmount - TranAmount;

                SaveTran.Commit();
                SaveTran.Dispose();
                return dblresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                SaveTran.Commit();
                SaveTran.Dispose();
                return 0;
            }
        }

        #endregion

        public string FetchCustomerIssueStore(int pCust)
        {
            string dblResult = "";
            string strSQLComm = " select IssueStore from Customer where ID = @CustomerID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CustomerID"].Value = pCust;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dblResult = objSQLReader["IssueStore"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblResult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return "";
            }
        }

        #region Fetch Customer Account Pay Balance

        public double FetchCustomerAcctPayBalance(int pCust)
        {
            double dblResult = 0;
            string strSQLComm = " select isnull(sum(Amount),0) as Balance from AcctRecv where CustomerID = @CustomerID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CustomerID"].Value = pCust;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dblResult = Functions.fnDouble(objSQLReader["Balance"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblResult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #endregion

        public bool InsertCardAuthorisation(SqlCommand objSQlComm, string strtype, double dblAmt)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            try
            {
                strSQLComm = " Insert Into CardAuthorisation ( CardType,InvoiceNo,InvoiceAmount,SaleTranNo,SaleOn,SaleBy,"
                           + " AuthorisedTranNo,AuthorisedOn,AuthorisedBy) Values ( @CardType,@InvoiceNo,@InvoiceAmount,"
                           + " @SaleTranNo,@SaleOn,@SaleBy,@AuthorisedTranNo,@AuthorisedOn,@AuthorisedBy)";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@CardType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@SaleTranNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@SaleBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@SaleOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@AuthorisedTranNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@AuthorisedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@AuthorisedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@CardType"].Value = strtype;
                objSQlComm.Parameters["@InvoiceNo"].Value = intID;
                objSQlComm.Parameters["@InvoiceAmount"].Value = dblAmt;

                objSQlComm.Parameters["@SaleTranNo"].Value = strSaleTranNo;
                objSQlComm.Parameters["@SaleBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@SaleOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@AuthorisedTranNo"].Value = strAuthorisedTranNo;
                objSQlComm.Parameters["@AuthorisedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@AuthorisedOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool UpdateCardAuthBatchFlag(SqlCommand objSQlComm, int INVNO)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            try
            {
                strSQLComm = " update cardauthorisation set batchflag='Y' where invoiceno = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = INVNO;

                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public DataTable FetchCustomerLastAcctPay(int CustID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select isnull(date,'') as date, isnull(amount,0) as amount from acctrecv "
                              + " where invoiceno in ( select max(invoiceno) from acctrecv  "
                              + " where customerid = @custid and TranType = 3 ) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@custid", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@custid"].Value = CustID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Date", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {   
                                                   - Functions.fnDouble(objSQLReader["amount"].ToString()), objSQLReader["date"].ToString()
                                               });

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchAcctPayDateRange(int CustID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select Max(date) as maxdate, Min(date) as mindate from acctrecv where customerid = @custid  ";


            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@custid", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@custid"].Value = CustID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("MinDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MaxDate", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {   objSQLReader["mindate"].ToString(),
                                                   objSQLReader["maxdate"].ToString(),
                                                   });

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public void BeginTransaction()
        {
            //SaveComm = new SqlCommand(); 
            SaveTran = null;
            SaveCon = this.sqlConn;
            if (SaveCon.State == System.Data.ConnectionState.Open) SaveCon.Close();
            SaveCon.Open();
            SaveTran = SaveCon.BeginTransaction();
        }

        public void EndTransaction()
        {
            SaveTran.Commit();
            SaveTran.Dispose();
        }

        public bool CreateInvoice()
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                dtblGCInsertID = new DataTable();
                dtblGCInsertID.Columns.Add("SL", System.Type.GetType("System.Int32"));
                dtblGCInsertID.Columns.Add("GCID", System.Type.GetType("System.Int32"));
                if (intCustomerID > 0)
                {
                    strCustomerIssueStore = GetCustomerIssueStore(SaveComm);
                }
                if (intTransType == 1) // Sale
                {
                    //AdjustGCGridRecords(SaveComm, "Insert Description");
                    AdjustGCGridRecords(SaveComm, "Insert GC");
                    InsertTransaction(SaveComm,1);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertInvoiceHeader(SaveComm);
                    if (strGiftAid == "Y")
                    {
                        UpdateInvoiceTagForGiftAid(SaveComm);
                    }
                    if (intCustomerOrderNo > 0)
                    {
                        UpdateInvoiceReferenceForCustomerOrder(SaveComm);
                        UpdateOrderingHeader(SaveComm, GetCustomerOrderTotalItems());
                        DeleteOrderingDetails(SaveComm);
                    }
                    AdjustMercuryGiftCardTranRecords(SaveComm);

                    IsAccountPay(SaveComm);
                    
                    double dACPayment = 0;
                    dACPayment = GetAccountPayment();

                    if (intCustomerID > 0)
                    {
                        if (dblTotalSale - dACPayment != 0)
                            Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalSale - dACPayment, dtTransDate, intLoginUserID, strOperateStore);
                    }

                    if (blReturn)
                    {
                        double pTax = 0;
                        double pTax1 = 0;
                        double pTax2 = 0;
                        double pTax3 = 0;
                        double pDiscount = 0;
                        double pCoupon = 0;
                        double pTotalSale = 0;
                        double pFees = 0;
                        double pFeesTax = 0;
                        double pFeesCoupon = 0;
                        double pFeesCouponTax = 0;

                        GetReturnInvoiceData(SaveComm, ref pTax, ref pTax1, ref pTax2, ref pTax3,
                        ref pDiscount, ref pCoupon, ref pTotalSale, ref pFees, ref pFeesTax,
                        ref pFeesCoupon, ref pFeesCouponTax);

                        UpdateReturnInvoiceData(SaveComm, pTax, pTax1, pTax2, pTax3,
                        pDiscount, pCoupon, pTotalSale, pFees, pFeesTax,
                        pFeesCoupon, pFeesCouponTax);
                    }
                    
                    AdjustItemGridRecords(SaveComm);


                    AdjustGCTenderGridRecords(SaveComm);
                    AdjustTenderGridRecords(SaveComm);
                    AdjustApptGridRecords(SaveComm);
                    UpdateCloseoutTransaction(SaveComm); 
                }

                if (intTransType == 2) // Layaway
                {
                    if (blNewLayaway)
                    {
                        AdjustGCGridRecords(SaveComm, "Insert GC");
                        InsertTransaction(SaveComm, 2);
                        dtTransDate = GetTranDate(SaveComm);
                        IsAccountPay(SaveComm);
                        InsertLayaway(SaveComm);
                        AdjustNewLayawayGridRecords(SaveComm);
                        double dACPayment = 0;
                        dACPayment = GetAccountPayment();
                        if (intCustomerID > 0)
                        {
                            if (dblTotalLayawaySale - dACPayment != 0)
                                Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalLayawaySale - dACPayment, dtTransDate, intLoginUserID, strOperateStore);
                        }
                        AdjustGCTenderGridRecords(SaveComm);
                        AdjustTenderGridRecords(SaveComm);
                        UpdateCloseoutTransaction(SaveComm);
                    }

                    if (blLayaway) 
                    {
                        InsertTransaction(SaveComm,4);
                        dtTransDate = GetTranDate(SaveComm);
                        IsAccountPay(SaveComm);
                        AdjustLayawayGridRecords(SaveComm);
                        AdjustTenderGridRecords(SaveComm);
                        UpdateCloseoutTransaction(SaveComm);
                    }

                    if (blLayawayRefund)
                    {
                        InsertTransaction(SaveComm,3);
                        dtTransDate = GetTranDate(SaveComm);
                        IsAccountPay(SaveComm);
                        AdjustLayawayGridRecords(SaveComm);
                        AdjustTenderGridRecords(SaveComm);
                        UpdateCloseoutTransaction(SaveComm);
                    }
                }

                if (intTransType == 6) // Paid Out
                {
                    InsertTransaction(SaveComm,6);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertPaidOutExplanation(SaveComm);

                    AdjustTenderGridRecords(SaveComm);

                    //intTenderID = FetchCashID(SaveComm);
                    //dblTenderAmount = dblPaidOutAmount;
                    //InsertTenderDetails(SaveComm);



                    UpdateTrans(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 66) // Paid In
                {
                    InsertTransaction(SaveComm, 66);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertPaidInExplanation(SaveComm);

                    AdjustTenderGridRecords(SaveComm);

                    //intTenderID = FetchCashID(SaveComm);
                    //dblTenderAmount = dblPaidOutAmount;
                    //InsertTenderDetails(SaveComm);
                    UpdateTrans(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 67) // Safe Drop
                {
                    InsertTransaction(SaveComm, 67);
                    dtTransDate = GetTranDate(SaveComm);

                    AdjustTenderGridRecords(SaveComm);
                    //intTenderID = FetchCashID(SaveComm);
                    //dblTenderAmount = dblPaidOutAmount;
                    //InsertTenderDetails(SaveComm);
                    UpdateTrans(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 91) // Cash In
                {
                    InsertTransaction(SaveComm, 91);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertCashInExplanation(SaveComm);
                    intTenderID = FetchCashID(SaveComm);
                    dblTenderAmount = dblPaidOutAmount;
                    InsertTenderDetails(SaveComm);
                    UpdateTrans(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }


                if (intTransType == 92) // Cash Out
                {
                    InsertTransaction(SaveComm, 92);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertCashOutExplanation(SaveComm);
                    intTenderID = FetchCashID(SaveComm);
                    dblTenderAmount = dblPaidOutAmount;
                    InsertTenderDetails(SaveComm);
                    UpdateTrans(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 60) // Lotto Payout
                {
                    InsertTransaction(SaveComm, 60);
                    dtTransDate = GetTranDate(SaveComm);
                    intTenderID = FetchCashID(SaveComm);
                    dblTenderAmount = dblPaidOutAmount;
                    InsertTenderDetails(SaveComm);
                    UpdateTrans(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 5) // No Sale
                {
                    InsertTransaction(SaveComm,5);
                    dtTransDate = GetTranDate(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 9) // Suspend
                {
                    if (intSuspendInvoiceNo > 0)
                    {
                        UpdateInvoiceHeader(SaveComm, intSuspendInvoiceNo);
                        UpdateSerialisedItemTagForSuspend(SaveComm, intSuspendInvoiceNo);
                    }
                    if (intSuspendInvoiceNo == 0)
                    {
                        InsertSuspendInvoiceHeader(SaveComm);
                        intSuspendInvoiceNo = intID;
                    }
                    DeleteSuspendItemDetails(SaveComm, intSuspendInvoiceNo);
                    AdjustItemGridRecordsForSuspend(SaveComm);
                }

                if (intTransType == 3) // Resume
                {
                    AdjustGCGridRecords(SaveComm, "Insert GC");
                    InsertTransaction(SaveComm,1);
                    dtTransDate = GetTranDate(SaveComm);
                    intID = intSuspendInvoiceNo;
                    UpdateInvoiceHeader(SaveComm, intSuspendInvoiceNo);
                    UpdateSerialisedItemTagForSuspend(SaveComm, intSuspendInvoiceNo);
                    IsAccountPay(SaveComm);
                    double dACPayment = 0;
                    dACPayment = GetAccountPayment();
                    if (intCustomerID > 0)
                    {
                        if (dblTotalSale - dACPayment != 0)
                        Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalSale - dACPayment, dtTransDate, intLoginUserID,strOperateStore);
                    }
                    AdjustItemGridRecords(SaveComm);
                    AdjustGCTenderGridRecords(SaveComm);
                    AdjustTenderGridRecords(SaveComm);
                    DeleteSuspendItemDetails(SaveComm, intSuspendInvoiceNo);
                }

                if (intTransType == 11) // New Work Order
                {
                    if (intSuspendInvoiceNo > 0)
                    {
                        dtblWorkOrder = FetchWorkOrderPreviousRecord(SaveComm, intSuspendInvoiceNo);
                        AdjustItemGridRecordsForWorkOrderBeforeDelete(SaveComm);
                        dtWorkOrder = GetWorkOrderDate(SaveComm, intSuspendInvoiceNo);
                        UpdateSerialisedItemTagForWorkorder(SaveComm, intSuspendInvoiceNo);
                    }
                    if (intSuspendInvoiceNo == 0)
                    {
                        intSuspendInvoiceNo = GetWorkOrderNo(SaveComm);
                    }
                    
                    DeleteWorkOrderItemDetails(SaveComm, intSuspendInvoiceNo);
                    AdjustItemGridRecordsForWorkOrder(SaveComm);
                }


                if (intTransType == 12) // Work Order Payment
                {
                    dtblWorkOrder = FetchWorkOrderPreviousRecord(SaveComm, intSuspendInvoiceNo);
                    AdjustItemGridRecordsForWorkOrderBeforeDelete(SaveComm);
                    dtWorkOrder = GetWorkOrderDate(SaveComm, intSuspendInvoiceNo);
                    UpdateSerialisedItemTagForWorkorder(SaveComm, intSuspendInvoiceNo);
                    DeleteWorkOrderItemDetails(SaveComm, intSuspendInvoiceNo);
                    AdjustItemGridRecordsForWorkOrderPayment(SaveComm);
                    //if (!blReturn) AdjustGCGridRecords(SaveComm, "Insert GC");
                    InsertTransaction(SaveComm, 1);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertInvoiceHeader(SaveComm);
                    IsAccountPay(SaveComm);
                    double dACPayment = 0;
                    dACPayment = GetAccountPayment();

                    if (intCustomerID > 0)
                    {
                        if (dblTotalSale - dACPayment != 0)
                            Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalSale - dACPayment, dtTransDate, intLoginUserID, strOperateStore);
                    }
                    AdjustWOItemGridRecords(SaveComm);
                    //AdjustGCTenderGridRecords(SaveComm);
                    AdjustTenderGridRecords(SaveComm);
                    UpdateWorkOrderPayment(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 15) // Rent Issued
                {
                    InsertTransaction(SaveComm, 15);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertRentInvoiceHeader(SaveComm,0,15);
                    //if (intCustomerID > 0) Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalSale, dtTransDate, intLoginUserID);
                    IsAccountPay(SaveComm);
                    AdjustRentItemGridRecords(SaveComm);
                    AdjustTenderGridRecords(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 16) // Rent Return
                {
                    
                    InsertTransaction(SaveComm, 16);
                    dtTransDate = GetTranDate(SaveComm);
                    InsertRentInvoiceHeader(SaveComm,intIssueRentInvNo,16);
                    //if (intCustomerID > 0) Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalSale, dtTransDate, intLoginUserID);
                    IsAccountPay(SaveComm);
                    AdjustRentItemGridRecords(SaveComm);
                    int cnt1 = 0;
                    int cnt2 = 0;
                    cnt1 = RentItemCount(SaveComm, intIssueRentInvNo);
                    cnt2 = RentItemReturnCount(SaveComm, intIssueRentInvNo);
                    string vl = "N";
                    if (cnt1 == cnt2) vl = "Y";
                    UpdateInvoiceHeaderForRentReturn(SaveComm, intIssueRentInvNo, vl);
                    AdjustTenderGridRecords(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 17) // Repair In
                {
                    if (!blRepairDepositTransaction)
                    {
                        if (intIssueRepairInvNo == 0)
                        {
                            InsertTransaction(SaveComm, 17);
                            dtTransDate = GetTranDate(SaveComm);
                            InsertRepairInvoiceHeader(SaveComm, "In", 0, 17);
                        }
                        else
                        {
                            intID = intIssueRepairInvNo;
                            dtblWorkOrder = FetchRepairPreviousRecord(SaveComm, intIssueRepairInvNo);
                            AdjustItemGridRecordsForRepairBeforeDelete(SaveComm);
                            UpdateSerialisedItemTagForRepair(SaveComm, intIssueRepairInvNo);
                            DeleteRepairItemDetails(SaveComm, intIssueRepairInvNo);
                            UpdateInvoiceHeaderForRepairIssue(SaveComm, intIssueRepairInvNo);
                            intTransactionNo = GetTransactionID(SaveComm, intIssueRepairInvNo);
                            dtTransDate = GetTranDate(SaveComm);
                        }
                        
                        AdjustRepairItemGridRecords(SaveComm);

                        if (blRepairIssueNClosed)
                        {
                            InsertTransaction(SaveComm, 18);
                            dtTransDate = GetTranDate(SaveComm);
                            UpdateInvoiceHeaderForRepairDeliver(SaveComm, intID, "Delivered");
                            InsertRepairInvoiceHeader(SaveComm, "Delivered", intID, 18);

                            AdjustTenderGridRecords(SaveComm);
                            UpdateCloseoutTransaction(SaveComm);
                        }
                    }
                    else
                    {
                        if (intRepairDepositLinkID == 0)
                        {
                            InsertTransaction(SaveComm, 17);
                            dtTransDate = GetTranDate(SaveComm);
                            InsertRepairInvoiceHeader(SaveComm, "In", 0, 17);
                            AdjustRepairItemGridRecords(SaveComm);
                            intRepairDepositLinkID = intID;
                        }
                        intID = intRepairDepositLinkID;
                        intTransactionNo = GetTransactionID(SaveComm, intRepairDepositLinkID);
                        dtTransDate = GetTranDate(SaveComm);

                        AdjustTenderGridRecords(SaveComm);
                        UpdateCloseoutTransaction(SaveComm);
                    }
                    //AdjustTenderGridRecords(SaveComm);
                    //UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 18) // Repair Delivered
                {
                    if (intIssueRepairInvNo == 0)
                    {
                        InsertTransaction(SaveComm, 17);
                        dtTransDate = GetTranDate(SaveComm);
                        InsertRepairInvoiceHeader(SaveComm, "In", 0,17);
                        intIssueRepairInvNo = intID;
                    }
                    else
                    {
                        intID = intIssueRepairInvNo;
                        dtblWorkOrder = FetchRepairPreviousRecord(SaveComm, intIssueRepairInvNo);
                        AdjustItemGridRecordsForRepairBeforeDelete(SaveComm);
                        UpdateSerialisedItemTagForRepair(SaveComm, intIssueRepairInvNo);
                        DeleteRepairItemDetails(SaveComm, intIssueRepairInvNo);
                        UpdateInvoiceHeaderForRepairIssue(SaveComm, intIssueRepairInvNo);
                        intTransactionNo = GetTransactionID(SaveComm, intIssueRepairInvNo);
                        dtTransDate = GetTranDate(SaveComm);
                    }
                    
                    AdjustRepairItemGridRecords(SaveComm);

                    InsertTransaction(SaveComm, 18);
                    dtTransDate = GetTranDate(SaveComm);
                    GetRepairHeaderFieldValues(SaveComm, intIssueRepairInvNo);
                    InsertRepairInvoiceHeader(SaveComm, "Delivered", intIssueRepairInvNo,18);
                    
                    //IsAccountPay(SaveComm);
                    //AdjustRepairItemDeliverGridRecords(SaveComm);
                    int cnt1 = 0;
                    int cnt2 = 0;
                    //cnt1 = RepairNotDeliveredCount(SaveComm, intIssueRepairInvNo);
                    //cnt2 = dtblItemDataTable.Rows.Count;
                    string vl = "";
                    if (cnt1 == 0) vl = "Delivered";
                    //if (cnt1 > 0) vl = "Partly Delivered";
                    UpdateInvoiceHeaderForRepairDeliver(SaveComm, intIssueRepairInvNo, vl);

                    if (intCustomerID > 0)
                    {
                        Functions.UpdateCustomerPurchaseRecord(SaveComm, intCustomerID, dblTotalSale, dtTransDate, intLoginUserID, strOperateStore);
                    }

                    AdjustTenderGridRecords(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 50) // Store Credit Issue
                {
                    InsertTransaction(SaveComm, 50);
                    strCustomerIssueStore = GetCustomerIssueStore(SaveComm);
                    dtTransDate = GetTranDate(SaveComm);
                    //intTenderID = GetStoreCreditTenderID(SaveComm);
                    //dblTenderAmount = dblStoreCreditPointEquivalent;
                    //InsertTenderDetails(SaveComm);
                    UpdateStoreCreditTransaction(SaveComm, dblStoreCreditPointEquivalent);
                    AddStoreCreditTransaction(SaveComm, "Add Credit", dtTransDate, dblStoreCreditPointEquivalent, 0);
                    UpdateStoreCreditInCustomerRecord(SaveComm, dblStoreCreditPointEquivalent);
                    UpdateCloseoutTransaction(SaveComm);
                }

                if (intTransType == 51) // Point to Store Credit
                {
                    InsertTransaction(SaveComm, 51);
                    strCustomerIssueStore = GetCustomerIssueStore(SaveComm);
                    dtTransDate = GetTranDate(SaveComm);
                    //intTenderID = GetStoreCreditTenderID(SaveComm);
                    //dblTenderAmount = dblStoreCreditPointEquivalent;
                    //InsertTenderDetails(SaveComm);
                    UpdateStoreCreditTransaction(SaveComm, dblStoreCreditPointEquivalent);
                    AddStoreCreditTransaction(SaveComm, "Point Conversion", dtTransDate, dblStoreCreditPointEquivalent,0);
                    UpdateStoreCreditInCustomerRecord(SaveComm, dblStoreCreditPointEquivalent);
                    ResetCustomerPoints(SaveComm);
                    UpdateCloseoutTransaction(SaveComm);
                }

                return true;
            }
            catch (SqlException SQLDBException)
            {
                string sss = SQLDBException.ToString();
                return false;
            }
        }

        public bool InsertPaidInExplanation(SqlCommand objSQlComm)
        {

            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Notes ( RefID, RefType, Note, CreatedBy, CreatedOn, LastChangedBy, LastChangedOn) "
                                    + " values (@RefID, @RefType, @Note, @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn) "
                                    + " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@RefID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RefType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Note", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@RefID"].Value = 0;
                objSQlComm.Parameters["@RefType"].Value = "Paid In";
                objSQlComm.Parameters["@Note"].Value = strNotes;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intTransNoteNo = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertCashOutExplanation(SqlCommand objSQlComm)
        {

            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Notes ( RefID,RefType,Note,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn) "
                    + " values (@RefID,@RefType,@Note,@CreatedBy,@CreatedOn,@LastChangedBy, @LastChangedOn) "
                    + " SELECT @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@RefID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RefType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Note", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@RefID"].Value = 0;
                objSQlComm.Parameters["@RefType"].Value = "Cash Out";
                objSQlComm.Parameters["@Note"].Value = strNotes;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intTransNoteNo = Functions.fnInt32(sqlDataReader["ID"].ToString());
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertCashInExplanation(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Notes (RefID,RefType,Note,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn) "
                    + " values (@RefID,@RefType,@Note,@CreatedBy,@CreatedOn,@LastChangedBy, @LastChangedOn) "
                    + " SELECT @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@RefID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RefType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Note", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@RefID"].Value = 0;
                objSQlComm.Parameters["@RefType"].Value = "Cash In";
                objSQlComm.Parameters["@Note"].Value = strNotes;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intTransNoteNo = Functions.fnInt32(sqlDataReader["ID"].ToString());
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public string UpdateStoreCreditTransaction(SqlCommand objSQlComm, double pTranAmount)
        {
            objSQlComm.Parameters.Clear();

            try
            {
                string strSQLComm = " update trans set StoreCreditAmount = StoreCreditAmount + @TranAmount where ID = @TranID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@TranID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TranAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@TranID"].Value = intTransactionNo;
                objSQlComm.Parameters["@TranAmount"].Value = pTranAmount;

                objSQlComm.ExecuteNonQuery();

                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.ToString();
                return strErrMsg;
            }
        }

        public string AddStoreCreditTransaction(SqlCommand objSQlComm,string pTranType, DateTime pTranDate, double pTranAmount, int pInvoice)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader objsqlReader = null;
            try
            {
                string strSQLComm = " insert into StoreCreditTransaction (RefCustomer,TranType,TranDate,TranAmount,IssueStore,OperateStore,"
                                  + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,RefInvoice) values (@RefCustomer,@TranType,@TranDate,@TranAmount,"
                                  + " @IssueStore,@OperateStore,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@RefInvoice) select @@IDENTITY as ID";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@RefCustomer", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RefInvoice", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TranAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TranType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@TranDate", System.Data.SqlDbType.DateTime));


                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@IssueStore", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OperateStore", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters["@RefCustomer"].Value = intCustomerID;
                objSQlComm.Parameters["@RefInvoice"].Value = pInvoice;
                objSQlComm.Parameters["@TranType"].Value = pTranType;
                objSQlComm.Parameters["@TranAmount"].Value = pTranAmount;
                objSQlComm.Parameters["@TranDate"].Value = pTranDate;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@IssueStore"].Value = strCustomerIssueStore;
                objSQlComm.Parameters["@OperateStore"].Value = strOperateStore;

                objsqlReader = objSQlComm.ExecuteReader();
                int ptempID = 0;
                if (objsqlReader.Read())
                {
                    ptempID = Functions.fnInt32(objsqlReader["ID"]);
                }
                objsqlReader.Close();
                objsqlReader.Dispose();

                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.ToString();
                objsqlReader.Close();
                objsqlReader.Dispose();

                return strErrMsg;
            }
        }

        public string UpdateStoreCreditInCustomerRecord(SqlCommand objSQlComm,double pTranAmount)
        {
            objSQlComm.Parameters.Clear();

            try
            {
                string strSQLComm = " update customer set StoreCredit = StoreCredit + @TranAmount, LastChangedBy=@LastChangedBy, "
                                  + " LastChangedOn = @LastChangedOn where ID = @RefCustomer";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@RefCustomer", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TranAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@RefCustomer"].Value = intCustomerID;
                objSQlComm.Parameters["@TranAmount"].Value = pTranAmount;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();

                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.ToString();
                return strErrMsg;
            }
        }

        public string ResetCustomerPoints(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();

            try
            {
                string strSQLComm = " update customer set Points = 0, LastChangedBy=@LastChangedBy, "
                                  + " LastChangedOn = @LastChangedOn where ID = @RefCustomer";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@RefCustomer", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@RefCustomer"].Value = intCustomerID;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();

                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.ToString();
                return strErrMsg;
            }
        }

        public bool UpdateInvoiceTagForGiftAid(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update Invoice set GiftAidFlag = 'Y' where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = intID;
                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();

                return false;
            }
        }

        public bool UpdateInvoiceReferenceForCustomerOrder(SqlCommand objSQlComm )
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update Invoice set CustomerOrderRef = @Ref where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Ref", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = intID;
                objSQlComm.Parameters["@Ref"].Value = intCustomerOrderNo;
                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();

                return false;
            }
        }

        public bool DeleteOrderingDetails(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " Delete from OrderDetails where RefID = @ID ";

                objSQlComm.CommandText = strSQLComm;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = intCustomerOrderNo;

                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                return false;
            }
        }

        public bool UpdateOrderingHeader(SqlCommand objSQlComm, int pTotalItem)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update OrderHeader set OrderStatus = 'C', OrderItems=@OrderItems, OrderGross=@OrderGross, "
                                  + " OrderDiscount=@OrderDiscount, OrderTax=@OrderTax, OrderNet=@OrderNet, LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@OrderItems", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@OrderGross", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@OrderDiscount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@OrderTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@OrderNet", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intCustomerOrderNo;
                objSQlComm.Parameters["@OrderItems"].Value = pTotalItem;
                objSQlComm.Parameters["@OrderGross"].Value = dblTotalSale - Tax + Discount;
                objSQlComm.Parameters["@OrderDiscount"].Value = dblDiscount;
                objSQlComm.Parameters["@OrderTax"].Value = dblTax;
                objSQlComm.Parameters["@OrderNet"].Value = dblTotalSale;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();

                return false;
            }
        }



        public bool InsertOrderingDetail(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            
            try
            {
                string strSQLComm = " insert into OrderDetails ( RefID, ProductID, Description, SKU, Qty, ItemRate, Notes, "
                                  + " TaxID1,TaxID2,TaxID3,Taxable1,Taxable2,Taxable3,TaxRate1,TaxRate2,TaxRate3, "
                                  + " TaxType1,TaxType2,TaxType3,TaxTotal1,TaxTotal2,TaxTotal3, "
                                  + " Discount,DiscountID,DiscountText,DiscLogic,DiscValue ) "
                                  + " values ( @RefID, @ProductID,  @Description, @SKU, @Qty, @ItemRate, @Notes, "
                                  + " @TaxID1,@TaxID2,@TaxID3,@Taxable1,@Taxable2,@Taxable3,@TaxRate1,@TaxRate2,@TaxRate3, "
                                  + " @TaxType1,@TaxType2,@TaxType3,@TaxTotal1,@TaxTotal2,@TaxTotal3, "
                                  + " @Discount,@DiscountID,@DiscountText,@DiscLogic,@DiscValue ) ";

                objSQlComm.CommandText = strSQLComm;

                objSQlComm.Parameters.Add(new SqlParameter("@RefID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@SKU", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Qty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Notes", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ItemRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable1", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable2", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable3", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscValue", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@RefID"].Value = intCustomerOrderNo;
                objSQlComm.Parameters["@ProductID"].Value = intItemID;
                objSQlComm.Parameters["@SKU"].Value = strItemSKU;
                objSQlComm.Parameters["@Description"].Value = strItemDescription;
                objSQlComm.Parameters["@Qty"].Value = dblItemQty;
                objSQlComm.Parameters["@Notes"].Value = strInvNotes;
                objSQlComm.Parameters["@ItemRate"].Value = dblItemPrice;
                objSQlComm.Parameters["@TaxID1"].Value = intItemTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intItemTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intItemTaxID3;
                objSQlComm.Parameters["@Taxable1"].Value = strItemTaxable1;
                objSQlComm.Parameters["@Taxable2"].Value = strItemTaxable2;
                objSQlComm.Parameters["@Taxable3"].Value = strItemTaxable3;
                objSQlComm.Parameters["@TaxRate1"].Value = dblItemTaxRate1;
                objSQlComm.Parameters["@TaxRate2"].Value = dblItemTaxRate2;
                objSQlComm.Parameters["@TaxRate3"].Value = dblItemTaxRate3;
                objSQlComm.Parameters["@TaxType1"].Value = intItemTaxType1;
                objSQlComm.Parameters["@TaxType2"].Value = intItemTaxType2;
                objSQlComm.Parameters["@TaxType3"].Value = intItemTaxType3;
                objSQlComm.Parameters["@TaxTotal1"].Value = dblItemTaxTotal1;
                objSQlComm.Parameters["@TaxTotal2"].Value = dblItemTaxTotal2;
                objSQlComm.Parameters["@TaxTotal3"].Value = dblItemTaxTotal3;
                objSQlComm.Parameters["@DiscountID"].Value = intItemDiscountID;
                objSQlComm.Parameters["@DiscountText"].Value = strItemDiscountText;
                objSQlComm.Parameters["@DiscLogic"].Value = strItemDiscLogic;
                objSQlComm.Parameters["@Discount"].Value = dblItemDiscount;
                objSQlComm.Parameters["@DiscValue"].Value = dblItemDiscValue;

                objSQlComm.ExecuteNonQuery();
                
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();

                return false;
            }
        }

        public int FetchCashID(SqlCommand objSQlComm)
        {
            int val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select ID from TenderTypes where Name= 'Cash' and Enabled = 'Y' ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = intTransactionNo;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    val = Functions.fnInt32(sqlDataReader["ID"]);
                }
                sqlDataReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return 0;
            }
        }

        public bool UpdateRepairItemAfterDelivery(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update item set repairitemdeliverydate = @param,LastChangedBy=@LastChangedBy,"
                           + " LastChangedOn=@LastChangedOn where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@param", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@param"].Value = dtTransDate;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool CancelSuspendedTran()
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                DeleteSuspendInvoiceDetails(SaveComm, intSuspendInvoiceNo);
                UpdateSerialisedItemTagForSuspend(SaveComm, intSuspendInvoiceNo);
                DeleteSuspendItemDetails(SaveComm, intSuspendInvoiceNo);
                return true;
            }
            catch (SqlException SQLDBException)
            {
                string sss = SQLDBException.ToString();
                return false;
            }
        }

        public bool CancelWorkOrderTran()
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                dtblWorkOrder = FetchWorkOrderPreviousRecord(SaveComm, intSuspendInvoiceNo);
                AdjustItemGridRecordsForWorkOrderBeforeDelete(SaveComm);
                UpdateSerialisedItemTagForWorkorder(SaveComm, intSuspendInvoiceNo);
                DeleteWorkOrderItemDetails(SaveComm, intSuspendInvoiceNo);
                return true;
            }
            catch (SqlException SQLDBException)
            {
                string sss = SQLDBException.ToString();
                return false;
            }
        }

        #region Insert Transaction Data

        public bool InsertTransaction(SqlCommand objSQlComm , int TT)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " Insert Into Trans ( TransType,EmployeeID,RegisterID,StoreID,"
                               + " CustomerID, TransDate, CloseoutID, TransNoteNo, "
                               + " CreatedBy, CreatedOn, LastChangedBy, LastChangedOn, TerminalName)"
                               + " Values ( @TransType,@EmployeeID,@RegisterID,@StoreID, "
                               + " @CustomerID, @TransDate, @CloseoutID, @TransNoteNo, "
                               + " @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn,@TerminalName )"
                               + " select @@IDENTITY AS ID";
                }
                else
                {
                    strSQLComm = " Insert Into Trans ( TransType,EmployeeID,RegisterID,StoreID,"
                               + " CustomerID, TransDate, CloseoutID, TransNoteNo, "
                               + " CreatedBy, CreatedOn, LastChangedBy, LastChangedOn, "
                               + " ChangedByAdmin,ChangedOnAdmin,TerminalName )"
                               + " Values ( @TransType,@EmployeeID,@RegisterID,@StoreID, "
                               + " @CustomerID, @TransDate, @CloseoutID, @TransNoteNo, "
                               + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,"
                               + " @ChangedByAdmin,@ChangedOnAdmin,@TerminalName )"
                               + " select @@IDENTITY AS ID";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@TransType", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RegisterID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@StoreID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransDate", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@CloseoutID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransNoteNo", System.Data.SqlDbType.Int));
                
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters["@TransType"].Value = TT;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@RegisterID"].Value = intRegisterID;
                objSQlComm.Parameters["@StoreID"].Value = intStoreID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                dtTransDate = DateTime.Now;
                objSQlComm.Parameters["@TransDate"].Value = dtTransDate;
                objSQlComm.Parameters["@CloseoutID"].Value = intCloseoutID;
                objSQlComm.Parameters["@TransNoteNo"].Value = intTransNoteNo;
                
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@TerminalName"].Value = strTerminalName;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read())
                {
                    intTransactionNo = Functions.fnInt32(sqlDataReader["ID"]);
                }
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        #endregion

        #region Insert Invoice Header Data

        public bool InsertRepairInvoiceHeader(SqlCommand objSQlComm, string pstatus, int parentid, int pstsid)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            SqlDataReader sqlDataReader = null;
            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " Insert Into Invoice ( ServiceType,CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt,"
                               + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason,TaxID1,TaxID2,TaxID3,"
                               + " Tax1,Tax2,Tax3,Coupon,RepairDeliveryDate,RepairNotifiedDate,RepairProblem,RepairNotes,"
                               + " RepairRemarks,RepairAdvanceAmount,RepairAmount,RepairDueAmount,RepairStatus,RepairParentID,"
                               + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,Fees,FeesTax,FeesCoupon,FeesCouponTax,"
                               + " RepairItemName,RepairItemSlNo,RepairDateIn,RepairFindUs)"
                               + " Values ( @ServiceType,@CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                               + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason,@TaxID1,@TaxID2,@TaxID3,"
                               + " @Tax1,@Tax2,@Tax3,@Coupon,@RepairDeliveryDate,@RepairNotifiedDate,@RepairProblem,@RepairNotes,"
                               + " @RepairRemarks,@RepairAdvanceAmount,@RepairAmount,@RepairDueAmount,@RepairStatus,@RepairParentID,"
                               + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax,"
                               + " @RepairItemName,@RepairItemSlNo,@RepairDateIn,@RepairFindUs)"
                               + " select @@IDENTITY AS ID ";
                }
                else
                {
                    strSQLComm =   " Insert Into Invoice (ServiceType,CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt,"
                                 + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason,TaxID1,TaxID2,TaxID3,"
                                 + " Tax1,Tax2,Tax3,Coupon,RepairAdvanceAmount,RepairAmount,RepairProblem,RepairNotes,"
                                 + " RepairRemarks,RepairAdvanceAmount,RepairAmount,RepairDueAmount,RepairStatus,RepairParentID,"
                                 + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,ChangedByAdmin,ChangedOnAdmin,Fees,FeesTax,"
                                 + " FeesCoupon,FeesCouponTax,RepairItemName,RepairItemSlNo,RepairDateIn,RepairFindUs)"
                                 + " Values ( @ServiceType,@CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt,"
                                 + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason,@TaxID1,@TaxID2,@TaxID3,"
                                 + " @Tax1,@Tax2,@Tax3,@Coupon,@RepairDeliveryDate,@RepairNotifiedDate,@RepairProblem,@RepairNotes,"
                                 + " @RepairRemarks,@RepairAdvanceAmount,@RepairAmount,@RepairDueAmount,@RepairStatus,@RepairParentID,"
                                 + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@ChangedByAdmin,@ChangedOnAdmin,@Fees,@FeesTax,"
                                 + " @FeesCoupon,@FeesCouponTax,@RepairItemName,@RepairItemSlNo,@RepairDateIn,@RepairFindUs)"
                                 + " select @@IDENTITY AS ID ";
                }
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReceiptCnt", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransMSeconds", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountReason", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairAdvanceAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairDueAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairProblem", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairNotes", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairRemarks", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemSlNo", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairStatus", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairDateIn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairDeliveryDate", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairNotifiedDate", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairParentID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesCoupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCouponTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairFindUs", System.Data.SqlDbType.NVarChar));


                objSQlComm.Parameters["@Fees"].Value = dblTotalFees;
                objSQlComm.Parameters["@FeesTax"].Value = dblTotalFeesTax;

                objSQlComm.Parameters["@FeesCoupon"].Value = dblTotalFeesCoupon;
                objSQlComm.Parameters["@FeesCouponTax"].Value = dblTotalFeesCouponTax;
                

                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = pstsid;
                objSQlComm.Parameters["@ReceiptCnt"].Value = intReceiptCnt;
                objSQlComm.Parameters["@LayawayNo"].Value = intLayawayID;
                objSQlComm.Parameters["@TransMSeconds"].Value = intTransMSeconds;
                objSQlComm.Parameters["@Tax"].Value = dblTax;
                objSQlComm.Parameters["@Discount"].Value = dblDiscount;
                objSQlComm.Parameters["@TotalSale"].Value = dblTotalSale;
                objSQlComm.Parameters["@DiscountReason"].Value = strDiscountReason;

                objSQlComm.Parameters["@TaxID1"].Value = intTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intTaxID3;

                objSQlComm.Parameters["@Tax1"].Value = dblTax1;
                objSQlComm.Parameters["@Tax2"].Value = dblTax2;
                objSQlComm.Parameters["@Tax3"].Value = dblTax3;
                objSQlComm.Parameters["@Coupon"].Value = dblCoupon;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ServiceType"].Value = strServiceType;

                objSQlComm.Parameters["@RepairProblem"].Value = strRepairProblem;
                objSQlComm.Parameters["@RepairNotes"].Value = strRepairNotes;
                objSQlComm.Parameters["@RepairRemarks"].Value = strRepairRemarks;
                objSQlComm.Parameters["@RepairAmount"].Value = dblRepairAmount;
                objSQlComm.Parameters["@RepairAdvanceAmount"].Value = dblRepairAdvanceAmount;
                objSQlComm.Parameters["@RepairDueAmount"].Value = dblRepairAmount - dblRepairAdvanceAmount;

                objSQlComm.Parameters["@RepairDateIn"].Value = dtRepairDateIn;

                if (dtRepairDeliveryDate == Convert.ToDateTime(null)) objSQlComm.Parameters["@RepairDeliveryDate"].Value = Convert.DBNull;
                else objSQlComm.Parameters["@RepairDeliveryDate"].Value = dtRepairDeliveryDate;

                if (dtRepairNotifiedDate == Convert.ToDateTime(null)) objSQlComm.Parameters["@RepairNotifiedDate"].Value = Convert.DBNull;
                else objSQlComm.Parameters["@RepairNotifiedDate"].Value = dtRepairNotifiedDate;

                objSQlComm.Parameters["@RepairStatus"].Value = pstatus;
                objSQlComm.Parameters["@RepairParentID"].Value = parentid;

                objSQlComm.Parameters["@RepairItemName"].Value = strRepairItemName;
                objSQlComm.Parameters["@RepairItemSlNo"].Value = strRepairItemSL;

                objSQlComm.Parameters["@RepairFindUs"].Value = strRepairFindUs;
                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertRentInvoiceHeader(SqlCommand objSQlComm, int parentid,int stsid)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            SqlDataReader sqlDataReader = null;
            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " Insert Into Invoice ( ServiceType,CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt,"
                               + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason,"
                               + " TaxID1,TaxID2,TaxID3,Tax1,Tax2,Tax3,Coupon,RentDeposit,RentParentID, "
                               + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,IsRentCalculated,Fees,FeesTax,FeesCoupon,FeesCouponTax )"
                               + " Values ( @ServiceType,@CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                               + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason, "
                               + " @TaxID1,@TaxID2,@TaxID3,@Tax1,@Tax2,@Tax3,@Coupon,@RentDeposit,@RentParentID, "
                               + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@IsRentCalculated,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax )"
                               + " select @@IDENTITY as ID ";
                }
                else
                {
                    strSQLComm = " Insert Into Invoice (ServiceType,CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt,"
                                 + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason,TaxID1,TaxID2,TaxID3, "
                                 + " Tax1,Tax2,Tax3,Coupon,RentDeposit,RentParentID,CreatedBy,CreatedOn,LastChangedBy, "
                                 + " LastChangedOn,ChangedByAdmin,ChangedOnAdmin,IsRentCalculated,Fees,FeesTax,FeesCoupon,FeesCouponTax )"
                                 + " Values ( @ServiceType,@CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                                 + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason, "
                                 + " @TaxID1,@TaxID2,@TaxID3,@Tax1,@Tax2,@Tax3,@Coupon,@RentDeposit,@RentParentID, "
                                 + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@ChangedByAdmin,@ChangedOnAdmin,"
                                 + " @IsRentCalculated,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax )"
                                 + " select @@IDENTITY as ID ";
                }


                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReceiptCnt", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransMSeconds", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountReason", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RentDeposit", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@RentParentID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@IsRentCalculated", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesCoupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCouponTax", System.Data.SqlDbType.Float));


                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = stsid;
                objSQlComm.Parameters["@ReceiptCnt"].Value = intReceiptCnt;
                objSQlComm.Parameters["@LayawayNo"].Value = intLayawayID;
                objSQlComm.Parameters["@TransMSeconds"].Value = intTransMSeconds;
                objSQlComm.Parameters["@Tax"].Value = dblTax;
                objSQlComm.Parameters["@Discount"].Value = dblDiscount;
                objSQlComm.Parameters["@TotalSale"].Value = dblTotalSale;
                objSQlComm.Parameters["@DiscountReason"].Value = strDiscountReason;

                objSQlComm.Parameters["@TaxID1"].Value = intTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intTaxID3;

                objSQlComm.Parameters["@Tax1"].Value = dblTax1;
                objSQlComm.Parameters["@Tax2"].Value = dblTax2;
                objSQlComm.Parameters["@Tax3"].Value = dblTax3;
                objSQlComm.Parameters["@Coupon"].Value = dblCoupon;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ServiceType"].Value = strServiceType;
                objSQlComm.Parameters["@RentDeposit"].Value = dblRentalSecurityDeposit;

                objSQlComm.Parameters["@RentParentID"].Value = parentid;
                objSQlComm.Parameters["@IsRentCalculated"].Value = strIsRentCalculated;

                objSQlComm.Parameters["@Fees"].Value = dblTotalFees;
                objSQlComm.Parameters["@FeesTax"].Value = dblTotalFeesTax;

                objSQlComm.Parameters["@FeesCoupon"].Value = dblTotalFeesCoupon;
                objSQlComm.Parameters["@FeesCouponTax"].Value = dblTotalFeesCouponTax;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertInvoiceHeader(SqlCommand objSQlComm)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            SqlDataReader sqlDataReader = null;
            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " Insert Into Invoice ( ServiceType,CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt, "
                               + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason, "
                               + " TaxID1,TaxID2,TaxID3,Tax1,Tax2,Tax3,Coupon,RentDeposit,CouponPerc,Fees,FeesTax,FeesCoupon,FeesCouponTax, "
                               + " DTaxID,DTax,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,CustomerDOB ) "
                               + " Values ( @ServiceType,@CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                               + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason, "
                               + " @TaxID1,@TaxID2,@TaxID3,@Tax1,@Tax2,@Tax3,@Coupon,@RentDeposit,@CouponPerc,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax, "
                               + " @DTaxID,@DTax,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@CustomerDOB ) "
                               + " select @@IDENTITY AS ID ";
                }
                else
                {
                    strSQLComm =   " Insert Into Invoice (ServiceType,CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt, "
                                 + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason, "
                                 + " TaxID1,TaxID2,TaxID3,Tax1,Tax2,Tax3,Coupon,RentDeposit,CouponPerc,Fees,FeesTax,FeesCoupon,FeesCouponTax, "
                                 + " DTaxID,DTax,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,ChangedByAdmin,ChangedOnAdmin,CustomerDOB) "
                                 + " values ( @ServiceType,@CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                                 + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason, "
                                 + " @TaxID1,@TaxID2,@TaxID3,@Tax1,@Tax2,@Tax3,@Coupon,@RentDeposit,@CouponPerc,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax, "
                                 + " @DTaxID,@DTax,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@ChangedByAdmin,@ChangedOnAdmin,@CustomerDOB ) "
                                 + " select @@IDENTITY AS ID ";
                }
                

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReceiptCnt", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransMSeconds", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountReason", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RentDeposit", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CouponPerc", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesCoupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCouponTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@DTaxID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = intStatus;
                objSQlComm.Parameters["@ReceiptCnt"].Value = intReceiptCnt;
                objSQlComm.Parameters["@LayawayNo"].Value = intLayawayID;
                objSQlComm.Parameters["@TransMSeconds"].Value = intTransMSeconds;
                objSQlComm.Parameters["@Tax"].Value = dblTax;
                objSQlComm.Parameters["@Discount"].Value = dblDiscount;
                objSQlComm.Parameters["@TotalSale"].Value = dblTotalSale;
                objSQlComm.Parameters["@DiscountReason"].Value = strDiscountReason;

                objSQlComm.Parameters["@TaxID1"].Value = intTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intTaxID3;

                objSQlComm.Parameters["@Tax1"].Value = dblTax1;
                objSQlComm.Parameters["@Tax2"].Value = dblTax2;
                objSQlComm.Parameters["@Tax3"].Value = dblTax3;
                objSQlComm.Parameters["@Coupon"].Value = dblCoupon;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ServiceType"].Value = strServiceType;
                objSQlComm.Parameters["@RentDeposit"].Value = dblRentalSecurityDeposit;
                objSQlComm.Parameters["@CouponPerc"].Value = dblCouponPerc;

                objSQlComm.Parameters["@Fees"].Value = dblTotalFees;
                objSQlComm.Parameters["@FeesTax"].Value = dblTotalFeesTax;

                objSQlComm.Parameters["@FeesCoupon"].Value = dblTotalFeesCoupon;
                objSQlComm.Parameters["@FeesCouponTax"].Value = dblTotalFeesCouponTax;

                objSQlComm.Parameters["@DTaxID"].Value = iDTaxID;
                objSQlComm.Parameters["@DTax"].Value = dDTax;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerDOB", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@CustomerDOB"].Value = dtCustomerDOB == Convert.ToDateTime(null) ? Convert.DBNull : dtCustomerDOB;

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        #endregion

        #region Insert Suspend Invoice Header Data

        public bool InsertSuspendInvoiceHeader(SqlCommand objSQlComm)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " insert into Invoice( CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt,"
                               + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason, "
                               + " TaxID1,TaxID2,TaxID3,Tax1,Tax2,Tax3,Coupon,CouponPerc,Fees,FeesTax,FeesCoupon,FeesCouponTax, "
                               + " DTaxID,DTax,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,CustomerDOB)"
                               + " Values ( @CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                               + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason, "
                               + " @TaxID1,@TaxID2,@TaxID3,@Tax1,@Tax2,@Tax3,@Coupon,@CouponPerc,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax, "
                               + " @DTaxID,@DTax,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@CustomerDOB )"
                               + " select @@IDENTITY AS ID ";
                }
                else
                {
                    strSQLComm = " insert into Invoice( CustomerID,EmployeeID,TransactionNo,Status,ReceiptCnt,"
                               + " LayawayNo,TransMSeconds,Tax,Discount,TotalSale,DiscountReason, "
                               + " TaxID1,TaxID2,TaxID3,Tax1,Tax2,Tax3,Coupon,CouponPerc,Fees,FeesTax,FeesCoupon,FeesCouponTax, "
                               + " DTaxID,DTax,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,ChangedByAdmin,ChangedOnAdmin,CustomerDOB)"
                               + " Values ( @CustomerID,@EmployeeID,@TransactionNo,@Status,@ReceiptCnt, "
                               + " @LayawayNo,@TransMSeconds,@Tax,@Discount,@TotalSale,@DiscountReason, "
                               + " @TaxID1,@TaxID2,@TaxID3,@Tax1,@Tax2,@Tax3,@Coupon,@CouponPerc,@Fees,@FeesTax,@FeesCoupon,@FeesCouponTax, "
                               + " @DTaxID,@DTax,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@ChangedByAdmin,@ChangedOnAdmin,@CustomerDOB )"
                               + " select @@IDENTITY AS ID ";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReceiptCnt", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransMSeconds", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountReason", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CouponPerc", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesCoupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCouponTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@DTaxID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = intStatus;
                objSQlComm.Parameters["@ReceiptCnt"].Value = intReceiptCnt;
                objSQlComm.Parameters["@LayawayNo"].Value = intLayawayNo;
                objSQlComm.Parameters["@TransMSeconds"].Value = intTransMSeconds;
                objSQlComm.Parameters["@Tax"].Value = dblTax;
                objSQlComm.Parameters["@Discount"].Value = dblDiscount;
                objSQlComm.Parameters["@TotalSale"].Value = dblTotalSale;
                objSQlComm.Parameters["@DiscountReason"].Value = strDiscountReason;
                objSQlComm.Parameters["@Coupon"].Value = dblCoupon;
                objSQlComm.Parameters["@CouponPerc"].Value = dblCouponPerc;

                objSQlComm.Parameters["@TaxID1"].Value = intTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intTaxID3;

                objSQlComm.Parameters["@Tax1"].Value = dblTax1;
                objSQlComm.Parameters["@Tax2"].Value = dblTax2;
                objSQlComm.Parameters["@Tax3"].Value = dblTax3;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@DTaxID"].Value = iDTaxID;
                objSQlComm.Parameters["@DTax"].Value = dDTax;

                objSQlComm.Parameters["@Fees"].Value = dblTotalFees;
                objSQlComm.Parameters["@FeesTax"].Value = dblTotalFeesTax;

                objSQlComm.Parameters["@FeesCoupon"].Value = dblTotalFeesCoupon;
                objSQlComm.Parameters["@FeesCouponTax"].Value = dblTotalFeesCouponTax;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerDOB", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@CustomerDOB"].Value = dtCustomerDOB == Convert.ToDateTime(null) ? Convert.DBNull : dtCustomerDOB;

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        #endregion

        #region Update Invoice Header Data

        public bool UpdateInvoiceHeaderForRentReturn(SqlCommand objSQlComm, int INVNO,string strv)
        {
            string strSQLComm = "";

            objSQlComm.Parameters.Clear();

            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " update Invoice set RentReturnDeposit = RentReturnDeposit + @VAL1,RentReturnFlag = @VAL2, "
                               + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn where ID = @ID";
                }
                else
                {
                    strSQLComm = " update Invoice set RentReturnDeposit = RentReturnDeposit + @VAL1,RentReturnFlag = @VAL2, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn, "
                               + " ChangedByAdmin=@ChangedByAdmin,ChangedOnAdmin=@ChangedOnAdmin where ID = @ID";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@VAL1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@VAL2", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = INVNO;
                objSQlComm.Parameters["@VAL1"].Value = -dblRentalSecurityDeposit;
                objSQlComm.Parameters["@VAL2"].Value = strv;

                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool UpdateInvoiceHeaderForRepairDeliver(SqlCommand objSQlComm, int INVNO, string strv)
        {
            string strSQLComm = "";

            objSQlComm.Parameters.Clear();

            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " update Invoice set RepairDueAmount = RepairDueAmount - @VAL1,RepairStatus = @VAL2, "
                               + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn where ID = @ID";
                }
                else
                {
                    strSQLComm = " update Invoice set RepairDueAmount = RepairDueAmount - @VAL1,RepairStatus = @VAL2,"
                               + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn,"
                               + " ChangedByAdmin=@ChangedByAdmin,ChangedOnAdmin=@ChangedOnAdmin where ID = @ID";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@VAL1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@VAL2", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = INVNO;
                objSQlComm.Parameters["@VAL1"].Value = dblRepairTenderAmount;
                objSQlComm.Parameters["@VAL2"].Value = strv;

                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }
        
        public bool UpdateInvoiceHeaderForRepairIssue(SqlCommand objSQlComm, int INVNO)
        {
            string strSQLComm = "";

            objSQlComm.Parameters.Clear();

            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " update Invoice set CustomerID=@CustomerID,EmployeeID=@EmployeeID,"
                               + " Tax=@Tax,Discount=@Discount,TotalSale=@TotalSale,DiscountReason=@DiscountReason,"
                               + " TaxID1=@TaxID1,TaxID2=@TaxID2,TaxID3=@TaxID3,Tax1=@Tax1,Tax2=@Tax2,Tax3=@Tax3,"
                               + " RepairAmount=@RepairAmount,RepairDueAmount=@RepairDueAmount,CouponPerc=@CouponPerc," 
                               + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn,Coupon=@Coupon where ID = @ID";
                }
                else
                {
                    strSQLComm = " update Invoice set CustomerID=@CustomerID,EmployeeID=@EmployeeID, "
                               + " Tax=@Tax,Discount=@Discount,TotalSale=@TotalSale,DiscountReason=@DiscountReason,"
                               + " TaxID1=@TaxID1,TaxID2=@TaxID2,TaxID3=@TaxID3,Tax1=@Tax1,Tax2=@Tax2,Tax3=@Tax3,"
                               + " RepairAmount=@RepairAmount,RepairDueAmount=@RepairDueAmount,CouponPerc=@CouponPerc," 
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn,"
                               + " ChangedByAdmin=@ChangedByAdmin,ChangedOnAdmin=@ChangedOnAdmin,Coupon=@Coupon where ID = @ID";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransMSeconds", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountReason", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairDueAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CouponPerc", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = INVNO;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = intStatus;

                objSQlComm.Parameters["@LayawayNo"].Value = intLayawayID;
                objSQlComm.Parameters["@TransMSeconds"].Value = intTransMSeconds;
                objSQlComm.Parameters["@Tax"].Value = dblTax;
                objSQlComm.Parameters["@Discount"].Value = dblDiscount;
                objSQlComm.Parameters["@TotalSale"].Value = dblTotalSale;
                objSQlComm.Parameters["@DiscountReason"].Value = strDiscountReason;

                objSQlComm.Parameters["@TaxID1"].Value = intTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intTaxID3;

                objSQlComm.Parameters["@Tax1"].Value = dblTax1;
                objSQlComm.Parameters["@Tax2"].Value = dblTax2;
                objSQlComm.Parameters["@Tax3"].Value = dblTax3;
                objSQlComm.Parameters["@Coupon"].Value = dblCoupon;
                objSQlComm.Parameters["@CouponPerc"].Value = dblCouponPerc;
                objSQlComm.Parameters["@RepairAmount"].Value = dblRepairAmount;
                objSQlComm.Parameters["@RepairDueAmount"].Value = dblRepairAmount - dblRepairAdvanceAmount;

                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }


                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool UpdateInvoiceHeader(SqlCommand objSQlComm, int INVNO)
        {
            string strSQLComm = "";

            objSQlComm.Parameters.Clear();
            
            try
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " update Invoice set CustomerID=@CustomerID,EmployeeID=@EmployeeID,TransactionNo=@TransactionNo, "
                               + " Status=@Status,LayawayNo=@LayawayNo,TransMSeconds=@TransMSeconds,Tax=@Tax,Discount=@Discount, "
                               + " TotalSale=@TotalSale,DiscountReason=@DiscountReason,TaxID1=@TaxID1,TaxID2=@TaxID2, "
                               + " TaxID3=@TaxID3,Tax1=@Tax1,Tax2=@Tax2,Tax3=@Tax3,LastChangedBy=@LastChangedBy, "
                               + " LastChangedOn=@LastChangedOn,Coupon=@Coupon,CouponPerc=@CouponPerc, "
                               + " Fees=@Fees,FeesTax=@FeesTax,FeesCoupon=@FeesCoupon,FeesCouponTax=@FeesCouponTax,DTaxID=@DTaxID, "
                               + " DTax=@DTax, CustomerDOB = @CustomerDOB where ID = @ID ";
                }
                else
                {
                    strSQLComm = " update Invoice set CustomerID=@CustomerID,EmployeeID=@EmployeeID, "
                               + " TransactionNo=@TransactionNo,Status=@Status,LayawayNo=@LayawayNo,TransMSeconds=@TransMSeconds,"
                               + " Tax=@Tax,Discount=@Discount,TotalSale=@TotalSale,DiscountReason=@DiscountReason, "
                               + " TaxID1=@TaxID1,TaxID2=@TaxID2,TaxID3=@TaxID3,Tax1=@Tax1,Tax2=@Tax2,Tax3=@Tax3, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn, "
                               + " ChangedByAdmin=@ChangedByAdmin,ChangedOnAdmin=@ChangedOnAdmin,Coupon=@Coupon,"
                               + " CouponPerc=@CouponPerc,Fees=@Fees,FeesTax=@FeesTax,FeesCoupon=@FeesCoupon, "
                               + " FeesCouponTax=@FeesCouponTax,DTaxID=@DTaxID,DTax=@DTax, CustomerDOB = @CustomerDOB where ID = @ID";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));
                
                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransMSeconds", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountReason", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CouponPerc", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesCoupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCouponTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@DTaxID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@ID"].Value = INVNO;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = intStatus;

                objSQlComm.Parameters["@LayawayNo"].Value = intLayawayID;
                objSQlComm.Parameters["@TransMSeconds"].Value = intTransMSeconds;
                objSQlComm.Parameters["@Tax"].Value = dblTax;
                objSQlComm.Parameters["@Discount"].Value = dblDiscount;
                objSQlComm.Parameters["@TotalSale"].Value = dblTotalSale;
                objSQlComm.Parameters["@DiscountReason"].Value = strDiscountReason;

                objSQlComm.Parameters["@TaxID1"].Value = intTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intTaxID3;

                objSQlComm.Parameters["@Tax1"].Value = dblTax1;
                objSQlComm.Parameters["@Tax2"].Value = dblTax2;
                objSQlComm.Parameters["@Tax3"].Value = dblTax3;
                objSQlComm.Parameters["@Coupon"].Value = dblCoupon;
                objSQlComm.Parameters["@CouponPerc"].Value = dblCouponPerc;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@DTaxID"].Value = iDTaxID;
                objSQlComm.Parameters["@DTax"].Value = dDTax;

                objSQlComm.Parameters["@Fees"].Value = dblTotalFees;
                objSQlComm.Parameters["@FeesTax"].Value = dblTotalFeesTax;

                objSQlComm.Parameters["@FeesCoupon"].Value = dblTotalFeesCoupon;
                objSQlComm.Parameters["@FeesCouponTax"].Value = dblTotalFeesCouponTax;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerDOB", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@CustomerDOB"].Value = dtCustomerDOB == Convert.ToDateTime(null) ? Convert.DBNull : dtCustomerDOB;

                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        #endregion

        #region Update Invoice Header Data For Layaway

        public bool UpdateInvoiceHeaderForLayaway(SqlCommand objSQlComm, int INVNO, int STS)
        {
            objSQlComm.Parameters.Clear();

            try
            {
                string strSQLComm = " Update Invoice set CustomerID=@CustomerID,EmployeeID=@EmployeeID, "
                                    + " TransactionNo=@TransactionNo,Status=@Status,"
                                    + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn where ID = @ID ";


                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Status", System.Data.SqlDbType.Int));


                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = INVNO;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Status"].Value = STS;

                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;


                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        #endregion

        private void AdjustApptGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblApptDataTable == null) return;

                foreach (DataRow dr in dtblApptDataTable.Rows)
                {
                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        updateappt(objSQlComm,Functions.fnInt32(dr["ID"].ToString()));
                    }
                }
            }
            catch
            {
            }

        }

        public bool updateappt(SqlCommand objSQlComm, int apptid)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update appointments set apptstatus = 'Closed',InvoiceNo = @InvNo, "
                           + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@InvNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@ID"].Value = apptid;
                objSQlComm.Parameters["@InvNo"].Value = intID;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        private void AdjustRepairItemDeliverGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    string colID = "";
                    string coRATE = "";
                    string colNRATE = "";
                    string colCOST = "";
                    string colQTY = "";
                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";
                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";
                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";
                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";
                    string colITEMID = "";
                    string colNOTES = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colREPAIRITEMTAG = "";
                    string colREPAIRITEMSLNO = "";
                    string colREPAIRITEMPURCHASEDATE = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["REPAIRITEMTAG"].ToString() != "")
                    {
                        colREPAIRITEMTAG = dr["REPAIRITEMTAG"].ToString();
                    }
                    else
                    {
                        colREPAIRITEMTAG = "";
                    }

                    if (dr["REPAIRITEMSLNO"].ToString() != "")
                    {
                        colREPAIRITEMSLNO = dr["REPAIRITEMSLNO"].ToString();
                    }
                    else
                    {
                        colREPAIRITEMSLNO = "";
                    }

                    if (dr["REPAIRITEMPURCHASEDATE"].ToString() != "")
                    {
                        colREPAIRITEMPURCHASEDATE = dr["REPAIRITEMPURCHASEDATE"].ToString();
                    }
                    else
                    {
                        colREPAIRITEMPURCHASEDATE = "";
                    }

                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    if (dr["NRATE"].ToString() != "")
                    {
                        colNRATE = dr["NRATE"].ToString();
                    }
                    else
                    {
                        colNRATE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["ITEMID"].ToString() != "")
                    {
                        colITEMID = dr["ITEMID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    string colGRATE = "";
                    string colGPRICE = "";



                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }

                    strItemUOM = dr["UOM"].ToString();

                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colNOTES = dr["NOTES"].ToString();

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemNPrice = Functions.fnDouble(colNRATE);
                    dblItemPrice = Functions.fnDouble(coRATE);
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();

                    strInvNotes = colNOTES;

                    strRepairItemTag = colREPAIRITEMTAG;
                    strRepairItemSLNO = colREPAIRITEMSLNO;
                    if (colREPAIRITEMPURCHASEDATE == "") dtRepairItemPurchaseDate = Convert.ToDateTime(null);
                    else dtRepairItemPurchaseDate = Functions.fnDate(colREPAIRITEMPURCHASEDATE);

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    int intJ = 0;

                    intPreviousItemID = Functions.fnInt32(colITEMID);

                    int intDescID = 0;

                    sEditFlag = dr["EDITF"].ToString();

                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    InsertRepairItemDetails(objSQlComm, intID, intDescID);

                    UpdateRepairItemAfterDelivery(objSQlComm);

                    if (colPRODUCTTYPE == "A")
                    {
                        if (blAccountPay) InsertAcctRecv(objSQlComm, 3, -dblItemPrice);
                        else InsertAcctRecv(objSQlComm, 5, -dblItemPrice);
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustRepairItemGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    string colID = "";
                    string coRATE = "";
                    string colNRATE = "";
                    string colCOST = "";
                    string colQTY = "";
                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";
                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";
                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";
                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";
                    string colITEMID = "";
                    string colNOTES = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colREPAIRITEMTAG = "";
                    string colREPAIRITEMSLNO = "";
                    string colREPAIRITEMPURCHASEDATE = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    string colGRATE = "";
                    string colGPRICE = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["REPAIRITEMTAG"].ToString() != "")
                    {
                        colREPAIRITEMTAG = dr["REPAIRITEMTAG"].ToString();
                    }
                    else
                    {
                        colREPAIRITEMTAG = "";
                    }

                    if (dr["REPAIRITEMSLNO"].ToString() != "")
                    {
                        colREPAIRITEMSLNO = dr["REPAIRITEMSLNO"].ToString();
                    }
                    else
                    {
                        colREPAIRITEMSLNO = "";
                    }

                    if (dr["REPAIRITEMPURCHASEDATE"].ToString() != "")
                    {
                        colREPAIRITEMPURCHASEDATE = dr["REPAIRITEMPURCHASEDATE"].ToString();
                    }
                    else
                    {
                        colREPAIRITEMPURCHASEDATE = "";
                    }

                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    if (dr["NRATE"].ToString() != "")
                    {
                        colNRATE = dr["NRATE"].ToString();
                    }
                    else
                    {
                        colNRATE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["ITEMID"].ToString() != "")
                    {
                        colITEMID = dr["ITEMID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }


                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }

                    strItemUOM = dr["UOM"].ToString();

                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colNOTES = dr["NOTES"].ToString();

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemNPrice = Functions.fnDouble(colNRATE);
                    dblItemPrice = Functions.fnDouble(coRATE);
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strInvNotes = colNOTES;

                    strRepairItemTag = colREPAIRITEMTAG;
                    strRepairItemSLNO = colREPAIRITEMSLNO;
                    if (colREPAIRITEMPURCHASEDATE == "") dtRepairItemPurchaseDate = Convert.ToDateTime(null);
                    else dtRepairItemPurchaseDate = Functions.fnDate(colREPAIRITEMPURCHASEDATE);

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    int intJ = 0;

                    intPreviousItemID = Functions.fnInt32(colITEMID);


                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "H")))
                    {
                        if (!NewLayaway)
                        {
                            if (colPRODUCTTYPE != "U")
                            {
                                Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Repair", "N", intItemID, intLoginUserID,
                                        dblItemQty, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                if (intCustomerID > 0)
                                {
                                    int p = GetProductPoints(objSQlComm, intItemID);
                                    Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID,strOperateStore);
                                }
                                if (colPRODUCTTYPE == "K") // kit product
                                {
                                    dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                    AdjustKitGridRecords(objSQlComm, dblItemQty);
                                }
                            }
                            else
                            {
                                Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Repair", "N", intItemID, intLoginUserID,
                                        dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                if (intCustomerID > 0)
                                {
                                    int p = GetProductPoints(objSQlComm, intItemID);
                                    Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                }
                            }
                        }
                    }

                    int intDescID = 0;

                    InsertRepairItemDetails(objSQlComm, intID, intDescID);

                    if (colPRODUCTTYPE == "M")
                    {
                        Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                            strMatrixOptionValue3, -dblItemQty, intLoginUserID);
                        InsertMatrixOption(objSQlComm);

                    }

                    if (colPRODUCTTYPE == "E")
                        UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intReturnItemID, "R", "0");


                    if (colPRODUCTTYPE == "A")
                    {
                        if (blAccountPay) InsertAcctRecv(objSQlComm, 3, -dblItemPrice);
                        else InsertAcctRecv(objSQlComm, 5, -dblItemPrice);
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustRentItemGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                int sl = 0;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    sl++;
                    string colID = "";
                    string coRATE = "";
                    string colNRATE = "";
                    string colCOST = "";
                    string colQTY = "";
                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";
                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";
                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";
                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";
                    string colITEMID = "";
                    string colNOTES = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colRENTTYPE = "NA";
                    string colRENTDURATION = "";
                    string colRENTDEPOSIT = "";
                    string colRENTAMOUNT = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["RENTTYPE"].ToString() != "")
                    {
                        colRENTTYPE = dr["RENTTYPE"].ToString();
                    }
                    else
                    {
                        colRENTTYPE = "NA";
                    }

                    if (dr["RENTDURATION"].ToString() != "")
                    {
                        colRENTDURATION = dr["RENTDURATION"].ToString();
                    }
                    else
                    {
                        colRENTDURATION = "0.00";
                    }

                    if (dr["RENTDEPOSIT"].ToString() != "")
                    {
                        colRENTDEPOSIT = dr["RENTDEPOSIT"].ToString();
                    }
                    else
                    {
                        colRENTDEPOSIT = "0.00";
                    }


                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    if (dr["NRATE"].ToString() != "")
                    {
                        colNRATE = dr["NRATE"].ToString();
                    }
                    else
                    {
                        colNRATE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["ITEMID"].ToString() != "")
                    {
                        colITEMID = dr["ITEMID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    if (dr["RENTAMOUNT"].ToString() != "")
                    {
                        colRENTAMOUNT = dr["RENTAMOUNT"].ToString();
                    }
                    else
                    {
                        colRENTAMOUNT = "0";
                    }

                    string colGRATE = "";
                    string colGPRICE = "";



                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }

                    strItemUOM = dr["UOM"].ToString();

                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colNOTES = dr["NOTES"].ToString();

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemNPrice = Functions.fnDouble(colNRATE);
                    dblItemPrice = Functions.fnDouble(coRATE);
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);
                    dblRentAmount = Functions.fnDouble(colRENTAMOUNT);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strInvNotes = colNOTES;

                    strRentType = colRENTTYPE;
                    dblRentDuration = Functions.fnDouble(colRENTDURATION);
                    dblRentDeposit = Functions.fnDouble(colRENTDEPOSIT);

                    strTagged = "N";

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    int intJ = 0;

                    intPreviousItemID = Functions.fnInt32(colITEMID);

                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    if (blRentReturn)
                    {
                        dblItemQty = -dblItemQty;
                        dblItemPrice = dblRentAmount;
                    }
                    
                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "H")))
                    {
                        if (colPRODUCTTYPE != "U")
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                            if (!blRentReturn)
                            {
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Rent", "N", intItemID, intLoginUserID,
                                    dblItemQty, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                if (intCustomerID > 0)
                                {
                                    int p = GetProductPoints(objSQlComm, intItemID);
                                    Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                }
                                if (colPRODUCTTYPE == "K") // kit product
                                {
                                    dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                    AdjustKitGridRecords(objSQlComm, dblItemQty);
                                }
                            }
                            else
                            {
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intItemID, intLoginUserID,
                                    -dblItemQty, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                if (intCustomerID > 0)
                                {
                                    int p = GetProductPoints(objSQlComm, intItemID);
                                    Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                }
                                if (colPRODUCTTYPE == "K") // kit product
                                {
                                    dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                    AdjustKitGridRecords(objSQlComm, dblItemQty);
                                }
                            }
                        }
                        else
                        {

                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);
                            if (!blRentReturn)
                            {
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Rent", "N", intItemID, intLoginUserID,
                                    dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                if (intCustomerID > 0)
                                {
                                    int p = GetProductPoints(objSQlComm, intItemID);
                                    Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                }

                            }
                            else
                            {
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intItemID, intLoginUserID,
                                    -dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                if (intCustomerID > 0)
                                {
                                    int p = GetProductPoints(objSQlComm, intItemID);
                                    Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                }
                            }
                        }
                    }

                    int intDescID = 0;

                    InsertRentItemDetails(objSQlComm, intID, intDescID);

                    if (colPRODUCTTYPE == "M")
                    {
                        Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                            strMatrixOptionValue3, -dblItemQty, intLoginUserID);
                        InsertMatrixOption(objSQlComm);

                    }
                    
                    if (blRentReturn)
                    {
                        UpdateReturnItem(objSQlComm, -dblItemQty);
                        if (blRentReturn)
                        {
                            if (GetReturnItemCount(objSQlComm, intPreviousItemID) == 0)
                            {
                                UpdateReturnRentItemFlag(objSQlComm);
                            }
                        }

                        if (colPRODUCTTYPE == "T")
                        {
                            DataTable dtblnew = new DataTable();
                            int pinv = GetInvoiceFormItem(objSQlComm, intPreviousItemID);
                            dtblnew = FetchTaggedItemInInvoice(objSQlComm, pinv, intPreviousItemID);
                            foreach (DataRow drn in dtblnew.Rows)
                            {
                                UpdateReturnItem2(objSQlComm, -dblItemQty, Functions.fnInt32(drn["ID"].ToString()));
                            }
                            dtblnew.Dispose();
                        }

                        if (colPRODUCTTYPE == "M")
                        {
                            Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, -dblItemQty, intLoginUserID);

                        }
                        if (colPRODUCTTYPE == "E")
                        {
                            if (GetReturnItemCount(objSQlComm, intPreviousItemID) == 0)
                                UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), 0, "I", "1");
                        }
                    }


                    if (!blRentReturn)
                    {
                        if (colPRODUCTTYPE == "E")
                            UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intReturnItemID, "I", "0");
                    }

                    if (colPRODUCTTYPE == "G")
                    {
                        foreach (DataRow drGC in dtblGCInsertID.Rows)
                        {
                            if (sl == Functions.fnInt32(drGC["SL"].ToString()))
                            {
                                intGCID = Functions.fnInt32(drGC["GCID"].ToString());
                                break;
                            }
                        }
                        UpdateGCDetails(objSQlComm, Functions.fnInt32(colID), intReturnItemID, "Item");
                    }

                    if (colPRODUCTTYPE == "A")
                    {
                        if (blAccountPay) InsertAcctRecv(objSQlComm, 3, -dblItemPrice);
                        else InsertAcctRecv(objSQlComm, 5, -dblItemPrice);
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private int GetCustomerOrderTotalItems()
        {
            int val = 0;
            try
            {
                DataTable dtblH = dtblItemDataTable.DefaultView.ToTable(true, new String[] { "ID" });
                val = dtblH.Rows.Count;
            }
            catch
            {
            }
            return val;
        }

        private void AdjustItemGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                int sl = 0;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    sl++;
                    string colID = "";
                    string coRATE = "";
                    string colNRATE = "";
                    string colCOST = "";
                    string colQTY = "";
                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";
                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";
                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";
                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";
                    string colITEMID = "";
                    string colNOTES = "";
                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";
                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";
                    string colPRICE = "";

                    string colGRATE = "";
                    string colGPRICE = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    if (dr["NRATE"].ToString() != "")
                    {
                        colNRATE = dr["NRATE"].ToString();
                    }
                    else
                    {
                        colNRATE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["ITEMID"].ToString() != "")
                    {
                        colITEMID = dr["ITEMID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    if (dr["PRICE"].ToString() != "")
                    {
                        colPRICE = dr["PRICE"].ToString();
                    }
                    else
                    {
                        colPRICE = "0.00";
                    }

                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }

                    strItemUOM = dr["UOM"].ToString();

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();
                    
                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();
                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();

                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colNOTES = dr["NOTES"].ToString();

                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemNPrice = Functions.fnDouble(colNRATE);
                    dblItemPrice = Functions.fnDouble(coRATE);
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strInvNotes = colNOTES;
                    
                    strTagged = "N";

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    intMixMatchID = Functions.fnInt32(dr["MIXMATCHID"].ToString());


                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();

                    intSalePriceID  = Functions.fnInt32(dr["SALEPRICEID"].ToString());

                    intDTxID = Functions.fnInt32(dr["DTXID"].ToString());
                    intDTxType = Functions.fnInt32(dr["DTXTYPE"].ToString());
                    dblDTxRate = Functions.fnDouble(dr["DTXRATE"].ToString());
                    dblDTx = Functions.fnDouble(dr["DTX"].ToString());

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    iQtyDecimalLength = Functions.GetDecimalLength(colQTY);


                    iBuyGetFreeHeader = Functions.fnInt32(dr["BUYNGETFREEHEADERID"].ToString());
                    sBuyGetFreeCat = dr["BUYNGETFREECATEGORY"].ToString();
                    sBuyGetFreePromotionTxt = dr["BUYNGETFREENAME"].ToString();

                    iAge = Functions.fnInt32(dr["AGE"].ToString());

                    int intJ = 0;

                    intPreviousItemID = Functions.fnInt32(colITEMID);

                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "H")))
                    {
                        if (intCustomerOrderNo > 0)
                        {
                            InsertOrderingDetail(objSQlComm);
                        }
                        if (!NewLayaway)
                        {
                            if (colPRODUCTTYPE != "U")
                            {
                                Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                                if (!blReturn)
                                {
                                    if (dblItemQty >= 0)
                                    {
                                        intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Sale", "N", intItemID, intLoginUserID,
                                            dblItemQty, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                    }
                                    else
                                    {
                                        intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intItemID, intLoginUserID,
                                            -dblItemQty, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                    }
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                    }
                                    if (colPRODUCTTYPE == "K") // kit product
                                    {
                                        dtblKitDataTable = FetchKitRecord(objSQlComm,intItemID);
                                        AdjustKitGridRecords(objSQlComm, dblItemQty);
                                    }
                                }
                                else
                                {
                                    intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intItemID, intLoginUserID,
                                        -dblItemQty, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                    }
                                    if (colPRODUCTTYPE == "K") // kit product
                                    {
                                        dtblKitDataTable = FetchKitRecord(objSQlComm,intItemID);
                                        AdjustKitGridRecords(objSQlComm, dblItemQty);
                                    }
                                }
                            }
                            else
                            {
                                Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);
                                if (!blReturn)
                                {
                                    if (dblItemQty >= 0)
                                    {
                                        intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Sale", "N", intItemID, intLoginUserID,
                                            dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                    }
                                    else
                                    {
                                        intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intItemID, intLoginUserID,
                                            -dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                    }
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                    }
                                    
                                }
                                else
                                {
                                    intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intItemID, intLoginUserID,
                                        -dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                    }
                                }
                            }
                        }
                    }

                    int intDescID = 0;

                    InsertItemDetails(objSQlComm, intID,intDescID );
                    
                    if (!blNewLayaway)
                    {
                        if (colPRODUCTTYPE == "M")
                        {
                            Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, -dblItemQty, intLoginUserID);
                            InsertMatrixOption(objSQlComm);
                        }
                    }
                    if (blNewLayaway)
                    {
                        UpdateLayawayQtyOnHand(objSQlComm, intItemID, dblItemQty);
                        if (colPRODUCTTYPE == "K")
                        {
                            dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                            AdjustKitGridRecordsForLayaway(objSQlComm, dblItemQty);
                        }
                    }
                    if (blReturn)
                    {
                        if (IsTaggedItem(objSQlComm, intItemID))
                        {
                            UpdateTag(objSQlComm);
                            UpdateReturnItem1(objSQlComm, -dblItemQty);
                        }
                        else
                        {
                            UpdateReturnItem(objSQlComm, -dblItemQty);
                            if (blRentReturn)
                            {
                                if (GetReturnItemCount(objSQlComm, intPreviousItemID) == 0)
                                {
                                    UpdateReturnRentItemFlag(objSQlComm);
                                }
                            }
                        }
                        if (colPRODUCTTYPE == "T")
                        {
                            DataTable dtblnew = new DataTable();
                            int pinv = GetInvoiceFormItem(objSQlComm,intPreviousItemID);
                            dtblnew = FetchTaggedItemInInvoice(objSQlComm, pinv, intPreviousItemID);
                            foreach (DataRow drn in dtblnew.Rows)
                            {
                                UpdateReturnItem2(objSQlComm, -dblItemQty, Functions.fnInt32(drn["ID"].ToString()));
                            }
                            dtblnew.Dispose();
                        }

                        if (colPRODUCTTYPE == "M")
                        {
                            Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, -dblItemQty, intLoginUserID);

                        }
                        if (colPRODUCTTYPE == "E")
                        {
                            if (GetReturnItemCount(objSQlComm, intPreviousItemID) == 0)
                                UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), 0, "I", "1");
                        }
                    }

                    
                    if (!blReturn)
                    {
                        if (colPRODUCTTYPE == "E")
                            UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intReturnItemID, "I","0");

                        if (colPRODUCTTYPE == "T")
                        {
                            DataTable dtbl1 = new DataTable();
                            dtbl1 = FetchTaggedItem(objSQlComm, intItemID);
                            int tagval = intReturnItemID;
                            foreach (DataRow dr1 in dtbl1.Rows)
                            {

                                colID = "";
                                coRATE = "";
                                colNRATE = "";
                                colCOST = "";
                                colQTY = "";

                                colPRODUCT = "";
                                colPRODUCTTYPE = "";
                                colSKU = "";
                                colDEPT = "";
                                colCAT = "";

                                if (dr1["TID"].ToString() == "") continue;

                                if (dr1["TID"].ToString() != "")
                                {
                                    colID = dr1["TID"].ToString();
                                }

                                if (dr1["TPRICE"].ToString() != "")
                                {
                                    coRATE = dr1["TPRICE"].ToString();
                                }
                                else
                                {
                                    coRATE = "0.00";
                                }

                                if (dr1["TPRICE"].ToString() != "")
                                {
                                    colNRATE = dr1["TPRICE"].ToString();
                                }
                                else
                                {
                                    colNRATE = "0.00";
                                }

                                if (dr1["TQTY"].ToString() != "")
                                {
                                    colQTY = dr1["TQTY"].ToString();
                                }
                                else
                                {
                                    colQTY = "0.00";
                                }

                                if (dr1["TDEPT"].ToString() != "")
                                {
                                    colDEPT = dr1["TDEPT"].ToString();
                                }
                                else
                                {
                                    colDEPT = "0";
                                }

                                if (dr1["TCAT"].ToString() != "")
                                {
                                    colCAT = dr1["TCAT"].ToString();
                                }
                                else
                                {
                                    colCAT = "0";
                                }

                                colPRODUCT = dr1["TDESC"].ToString();
                                colPRODUCTTYPE = dr1["TTYPE"].ToString();
                                colSKU = dr1["TSKU"].ToString();

                               
                                dblItemNPrice = Functions.fnDouble(colNRATE);
                                dblItemPrice = Functions.fnDouble(coRATE);
                                intItemID = Functions.fnInt32(colID);
                                dblItemQty = Functions.fnDouble(colQTY) * dblItemQty;

                                strItemDescription = colPRODUCT;
                                strItemProductType = colPRODUCTTYPE;
                                strItemSKU = colSKU;
                                intItemDepartmentID = Functions.fnInt32(colDEPT);
                                intItemCategoryID = Functions.fnInt32(colCAT);

                                intItemTaxID1 = Functions.fnInt32(colTAXID1);
                                intItemTaxID2 = Functions.fnInt32(colTAXID2);
                                intItemTaxID3 = Functions.fnInt32(colTAXID3);

                                strItemTaxable1 = colTAXABLE1;
                                strItemTaxable2 = colTAXABLE2;
                                strItemTaxable3 = colTAXABLE3;

                                dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                                dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                                dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                                strItemUOMDesc = colUOMDESC;
                                dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                                dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                                intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                                strMatrixOptionValue1 = colMATRIXOV1;
                                strMatrixOptionValue2 = colMATRIXOV2;
                                strMatrixOptionValue3 = colMATRIXOV3;

                                strInvNotes = colNOTES;
                                strTagged = "X";

                                strItemDiscLogic = "";
                                strItemDiscountText = "";
                                dblItemDiscount = 0;
                                dblItemDiscValue = 0;
                                intItemIndex = 1;
                                intItemDiscountID = 0;
                                intMixMatchID = 0;
                                iBuyGetFreeHeader = 0;
                                sBuyGetFreeCat = "X";
                                sBuyGetFreePromotionTxt = "";
                                iAge = 0;
                                dblItemGRate = 0;
                                dblItemGPrice = 0;
                                strItemUOM = "";
                                InsertItemDetails(objSQlComm, intID, tagval);
                            }
                            dtbl1.Dispose();
                        }
                    }

                    if (colPRODUCTTYPE == "G")
                    {
                        foreach (DataRow drGC in dtblGCInsertID.Rows)
                        {
                            if (sl == Functions.fnInt32(drGC["SL"].ToString()))
                            {
                                intGCID = Functions.fnInt32(drGC["GCID"].ToString());
                                break;
                            }
                        }

                        if (colID == "AUTO") UpdateItemRecordForAutoGC(objSQlComm, intGCID, intReturnItemID);

                        if (!blReturn)
                        {
                            if (colID == "AUTO")
                            {
                                UpdateGCDetails(objSQlComm, intGCID, intReturnItemID, "Item");
                            }
                            else
                            {
                                UpdateGCDetails(objSQlComm, Functions.fnInt32(colID), intReturnItemID, "Item");
                            }
                        }
                        else UpdateGCDetails(objSQlComm, intReturnItemID, intReturnItemID, "Return");
                    }

                    if (colPRODUCTTYPE == "A")
                    {
                        if (blAccountPay) InsertAcctRecv(objSQlComm, 3, -(dblItemPrice * dblItemQty));
                        else InsertAcctRecv(objSQlComm, 5, -(dblItemPrice * dblItemQty));
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }
        
        private void AdjustNewLayawayGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                int sl = 0;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    sl++;
                    string colID = "";
                    string coRATE = "";
                    string colNRATE = "";
                    string colCOST = "";
                    string colQTY = "";

                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";

                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";

                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";

                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";

                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";
                    string colITEMID = "";
                    string colTAX1 = "";
                    string colTAX2 = "";
                    string colTAX3 = "";
                    string colTAX = "";
                    string colDISCOUNT = "";
                    string colTOTALSALE = "";
                    string colDISCOUNTREASON = "";
                    string colLAYAWAYAMOUNT = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    if (dr["NRATE"].ToString() != "")
                    {
                        colNRATE = dr["NRATE"].ToString();
                    }
                    else
                    {
                        colNRATE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["ITEMID"].ToString() != "")
                    {
                        colITEMID = dr["ITEMID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["TAX1"].ToString() != "")
                    {
                        colTAX1 = dr["TAX1"].ToString();
                    }
                    else
                    {
                        colTAX1 = "0";
                    }

                    if (dr["TAX2"].ToString() != "")
                    {
                        colTAX2 = dr["TAX2"].ToString();
                    }
                    else
                    {
                        colTAX2 = "0";
                    }

                    if (dr["TAX3"].ToString() != "")
                    {
                        colTAX3 = dr["TAX3"].ToString();
                    }
                    else
                    {
                        colTAX3 = "0";
                    }

                    if (dr["TAX"].ToString() != "")
                    {
                        colTAX = dr["TAX"].ToString();
                    }
                    else
                    {
                        colTAX = "0";
                    }

                    if (dr["DISCOUNT"].ToString() != "")
                    {
                        colDISCOUNT = dr["DISCOUNT"].ToString();
                    }
                    else
                    {
                        colDISCOUNT = "0";
                    }

                    if (dr["TOTALSALE"].ToString() != "")
                    {
                        colTOTALSALE = dr["TOTALSALE"].ToString();
                    }
                    else
                    {
                        colTOTALSALE = "0";
                    }


                    if (dr["DISCOUNTREASON"].ToString() != "")
                    {
                        colDISCOUNTREASON = dr["DISCOUNTREASON"].ToString();
                    }
                    else
                    {
                        colDISCOUNTREASON = "0";
                    }

                    if (dr["LAYAWAYAMOUNT"].ToString() != "")
                    {
                        colLAYAWAYAMOUNT = dr["LAYAWAYAMOUNT"].ToString();
                    }
                    else
                    {
                        colLAYAWAYAMOUNT = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }


                    string colGRATE = "";
                    string colGPRICE = "";



                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }
                    strItemUOM = dr["UOM"].ToString();

                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);


                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemNPrice = Functions.fnDouble(colNRATE);
                    dblItemPrice = Functions.fnDouble(coRATE);
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    intPreviousItemID = Functions.fnInt32(colITEMID);


                    dblTax = Functions.fnDouble(colTAX);
                    dblDiscount = Functions.fnDouble(colDISCOUNT);
                    dblTotalSale = Functions.fnDouble(colTOTALSALE);
                    strDiscountReason = colDISCOUNTREASON;

                    intTaxID1 = Functions.fnInt32(colTAXID1);
                    intTaxID2 = Functions.fnInt32(colTAXID2);
                    intTaxID3 = Functions.fnInt32(colTAXID3); 

                    dblTax1 = Functions.fnDouble(colTAX1);
                    dblTax2 = Functions.fnDouble(colTAX2);
                    dblTax3 = Functions.fnDouble(colTAX3);

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    strInvNotes = "";

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    intMixMatchID = Functions.fnInt32(dr["MIXMATCHID"].ToString());

                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();

                    intSalePriceID =  Functions.fnInt32(dr["SALEPRICEID"].ToString());
                    
                    dblTotalFees = dblFees;
                    dblTotalFeesTax = dblFeesTax;

                    if (strItemProductType == "H")
                    {
                        dblTotalFeesCoupon = dblFees;
                        dblTotalFeesCouponTax = dblFeesTax;
                    }
                    else
                    {
                        dblTotalFeesCoupon = 0;
                        dblTotalFeesCouponTax = 0;
                    }

                    dblTotalLayawaySale = dblTotalLayawaySale + dblTotalSale;

                    intDTxID = Functions.fnInt32(dr["DTXID"].ToString());
                    intDTxType = Functions.fnInt32(dr["DTXTYPE"].ToString());
                    dblDTxRate = Functions.fnDouble(dr["DTXRATE"].ToString());
                    dblDTx = Functions.fnDouble(dr["DTX"].ToString());

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    iBuyGetFreeHeader = Functions.fnInt32(dr["BUYNGETFREEHEADERID"].ToString());
                    sBuyGetFreeCat = dr["BUYNGETFREECATEGORY"].ToString();
                    sBuyGetFreePromotionTxt = dr["BUYNGETFREENAME"].ToString();

                    iAge = Functions.fnInt32(dr["AGE"].ToString());

                    dDTax = dblDTx;
                    dblTotalSale = dblTotalSale + dblFeesTax + dblFees;

                    InsertInvoiceHeader(objSQlComm);

                    if (((colPRODUCTTYPE != "G") || (colPRODUCTTYPE != "A") || (colPRODUCTTYPE != "X")) && (!NewLayaway))
                    {
                        if (colPRODUCTTYPE != "U")
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                        else
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);
                    }

                    strTagged = "N";

                    int intDescID = 0;

                    InsertItemDetails(objSQlComm, intID, intDescID);

                    if (blNewLayaway)
                    {
                        UpdateLayawayQtyOnHand(objSQlComm, intItemID, dblItemQty);
                        if (colPRODUCTTYPE == "K")
                        {
                            dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                            AdjustKitGridRecordsForLayaway(objSQlComm, dblItemQty);
                        }
                    }

                    if (colPRODUCTTYPE == "M")
                    {
                        InsertMatrixOption(objSQlComm);

                    }

                    if (colPRODUCTTYPE == "G")
                    {
                        foreach (DataRow drGC in dtblGCInsertID.Rows)
                        {
                            if (sl == Functions.fnInt32(drGC["SL"].ToString()))
                            {
                                intGCID = Functions.fnInt32(drGC["GCID"].ToString());
                                break;
                            }
                        }
                        if (colID == "AUTO") UpdateItemRecordForAutoGC(objSQlComm, intGCID, intReturnItemID);

                        if (colID == "AUTO")
                        {
                            UpdateGCDetails(objSQlComm, intGCID, intReturnItemID, "Item");
                        }
                        else
                        {
                            UpdateGCDetails(objSQlComm, Functions.fnInt32(colID), intReturnItemID, "Item");
                        }

                        //UpdateGCDetails(objSQlComm, Functions.fnInt32(colID), intReturnItemID, "Item");
                    }

                    if (colPRODUCTTYPE == "A")
                    {
                        if (blAccountPay) InsertAcctRecv(objSQlComm, 3, -dblItemPrice);
                        else InsertAcctRecv(objSQlComm, 5, -dblItemPrice);
                    }

                    if (blNewLayaway) InsertLayawayPayment(objSQlComm, Functions.fnDouble(colLAYAWAYAMOUNT) - dblChangeAmount,intID);

                    if (blNewLayaway)
                    {
                        if (colPRODUCTTYPE == "E")
                        UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intReturnItemID,"L","0");
                    }



                    if (blNewLayaway)
                    {
                        if (colPRODUCTTYPE == "T")
                        {
                            DataTable dtbl1 = new DataTable();
                            dtbl1 = FetchTaggedItem(objSQlComm, intItemID);
                            int tagval = intReturnItemID;
                            foreach (DataRow dr1 in dtbl1.Rows)
                            {

                                colID = "";
                                coRATE = "";
                                colNRATE = "";
                                colCOST = "";
                                colQTY = "";

                                colPRODUCT = "";
                                colPRODUCTTYPE = "";
                                colSKU = "";
                                colDEPT = "";
                                colCAT = "";

                                if (dr1["TID"].ToString() == "") continue;

                                if (dr1["TID"].ToString() != "")
                                {
                                    colID = dr1["TID"].ToString();
                                }

                                if (dr1["TPRICE"].ToString() != "")
                                {
                                    coRATE = dr1["TPRICE"].ToString();
                                }
                                else
                                {
                                    coRATE = "0.00";
                                }

                                if (dr1["TPRICE"].ToString() != "")
                                {
                                    colNRATE = dr1["TPRICE"].ToString();
                                }
                                else
                                {
                                    colNRATE = "0.00";
                                }

                                if (dr1["TQTY"].ToString() != "")
                                {
                                    colQTY = dr1["TQTY"].ToString();
                                }
                                else
                                {
                                    colQTY = "0.00";
                                }

                                if (dr1["TDEPT"].ToString() != "")
                                {
                                    colDEPT = dr1["TDEPT"].ToString();
                                }
                                else
                                {
                                    colDEPT = "0";
                                }

                                if (dr1["TCAT"].ToString() != "")
                                {
                                    colCAT = dr1["TCAT"].ToString();
                                }
                                else
                                {
                                    colCAT = "0";
                                }

                                colPRODUCT = dr1["TDESC"].ToString();
                                colPRODUCTTYPE = dr1["TTYPE"].ToString();
                                colSKU = dr1["TSKU"].ToString();


                                dblItemNPrice = Functions.fnDouble(colNRATE);
                                dblItemPrice = Functions.fnDouble(coRATE);
                                intItemID = Functions.fnInt32(colID);
                                dblItemQty = Functions.fnDouble(colQTY) * dblItemQty;

                                strItemDescription = colPRODUCT;
                                strItemProductType = colPRODUCTTYPE;
                                strItemSKU = colSKU;
                                intItemDepartmentID = Functions.fnInt32(colDEPT);
                                intItemCategoryID = Functions.fnInt32(colCAT);

                                intItemTaxID1 = Functions.fnInt32(colTAXID1);
                                intItemTaxID2 = Functions.fnInt32(colTAXID2);
                                intItemTaxID3 = Functions.fnInt32(colTAXID3);

                                strItemTaxable1 = colTAXABLE1;
                                strItemTaxable2 = colTAXABLE2;
                                strItemTaxable3 = colTAXABLE3;

                                dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                                dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                                dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                                strItemUOMDesc = colUOMDESC;
                                dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                                dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                                intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                                strMatrixOptionValue1 = colMATRIXOV1;
                                strMatrixOptionValue2 = colMATRIXOV2;
                                strMatrixOptionValue3 = colMATRIXOV3;

                                strInvNotes = "";
                                strTagged = "X";

                                strItemDiscLogic = "";
                                strItemDiscountText = "";
                                dblItemDiscount = 0;
                                dblItemDiscValue = 0;
                                intItemIndex = 1;
                                intItemDiscountID = 0;
                                intMixMatchID = 0;
                                iBuyGetFreeHeader = 0;
                                sBuyGetFreeCat = "X";
                                sBuyGetFreePromotionTxt = "";
                                iAge = 0;
                                dblItemGRate = 0;
                                dblItemGPrice = 0;
                                strItemUOM = "";
                                InsertItemDetails(objSQlComm, intID, tagval);

                            }
                            dtbl1.Dispose();
                        }
                    }
                    
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustLayawayGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                int sl = 0;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    sl++;
                    string colID = "";
                    string colQTY = "";
                    string colCOST = "";
                    string colPRODUCTID = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colITEMID = "";
                    string colDESCRIPTION = "";
                    string colINV = "";
                    string colLAY = "";
                    string colBalance = "";
                    string colDeposit = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["Qty"].ToString() != "")
                    {
                        colQTY = dr["Qty"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }
                    if (dr["Cost"].ToString() != "")
                    {
                        colCOST = dr["Cost"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["ProductID"].ToString() != "")
                    {
                        colPRODUCTID = dr["ProductID"].ToString();
                    }
                    else
                    {
                        colPRODUCTID = "0";
                    }

                    if (dr["ItemID"].ToString() != "")
                    {
                        colITEMID = dr["ItemID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["Balance"].ToString() != "")
                    {
                        colBalance = dr["Balance"].ToString();
                    }
                    else
                    {
                        colBalance = "0";
                    }

                    if (dr["Deposit"].ToString() != "")
                    {
                        colDeposit = dr["Deposit"].ToString();
                    }
                    else
                    {
                        colDeposit = "0";
                    }

                    if (dr["MatrixOptionID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MatrixOptionID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    colMATRIXOV1 = dr["OptionValue1"].ToString();
                    colMATRIXOV2 = dr["OptionValue2"].ToString();
                    colMATRIXOV3 = dr["OptionValue3"].ToString();
                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);

                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;


                    colPRODUCTTYPE = dr["ProductType"].ToString();
                    colSKU = dr["SKU"].ToString();
                    colDESCRIPTION = dr["Description"].ToString();
                    colINV = dr["InvoiceNo"].ToString();

                    intItemID = Functions.fnInt32(colPRODUCTID);
                    dblItemQty = Functions.fnDouble(colQTY);
                    dblItemCost = Functions.fnDouble(colCOST);
                    strItemDescription = colDESCRIPTION;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intPreviousItemID = Functions.fnInt32(colITEMID);
                    
                    dblLayawayBalance = Functions.fnDouble(colBalance);
                    dblLayawayDeposit = Functions.fnDouble(colDeposit);

                    int intJ = 0;
                    if ((colPRODUCTTYPE != "G") || (colPRODUCTTYPE != "A") || (colPRODUCTTYPE != "B") || (colPRODUCTTYPE != "X"))
                    {
                        if (dblLayawayBalance == dblLayawayDeposit)
                        {
                            if (blLayaway)
                            {
                                if (colPRODUCTTYPE != "U")
                                {
                                    Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                                    intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Sale", "N", intItemID, intLoginUserID,
                                    dblItemQty, dblItemCost, colINV, strTerminalName, dtTransDate, DateTime.Now, "");

                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                    }
                                    if (colPRODUCTTYPE == "K") // kit product
                                    {
                                        dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                        AdjustKitGridRecords(objSQlComm, dblItemQty);
                                    }
                                }
                                else
                                {
                                    Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);

                                    intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Sale", "N", intItemID, intLoginUserID,
                                    dblItemQty * dblItemUOMCount, dblItemCost, colINV, strTerminalName, dtTransDate, DateTime.Now, "");

                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, p * Functions.fnInt32(dblItemQty) * Functions.fnInt32(dblItemUOMCount), intLoginUserID, strOperateStore);
                                    }
                                    
                                }
                                UpdateLayawayQtyOnHand(objSQlComm, intItemID, -dblItemQty);
                                if (colPRODUCTTYPE == "K")
                                {
                                    dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                    AdjustKitGridRecordsForLayaway(objSQlComm, -dblItemQty);
                                }

                                if (colPRODUCTTYPE == "M")
                                {
                                    Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                        strMatrixOptionValue3, -dblItemQty, intLoginUserID);
                                    InsertMatrixOption(objSQlComm);

                                }
                            }
                        }
                        if (blLayawayRefund)
                        {
                            UpdateLayawayQtyOnHand(objSQlComm, intItemID, -dblItemQty);
                            if (colPRODUCTTYPE == "K")
                            {
                                dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                AdjustKitGridRecordsForLayaway(objSQlComm, -dblItemQty);
                            }
                        }
                    }

                    if (colPRODUCTTYPE == "G")
                    {
                        foreach (DataRow drGC in dtblGCInsertID.Rows)
                        {
                            if (sl == Functions.fnInt32(drGC["SL"].ToString()))
                            {
                                intGCID = Functions.fnInt32(drGC["GCID"].ToString());
                                break;
                            }
                        }

                        if (colID == "AUTO") UpdateItemRecordForAutoGC(objSQlComm, intGCID, intReturnItemID);

                        if (colID == "AUTO")
                        {
                            UpdateGCDetails(objSQlComm, intGCID, intReturnItemID, "Item");
                        }
                        else
                        {
                            UpdateGCDetails(objSQlComm, Functions.fnInt32(colID), intReturnItemID, "Item");
                        }

                        //UpdateGCDetails(objSQlComm, Functions.fnInt32(colID), intReturnItemID, "Item");
                    }

                    if (colPRODUCTTYPE == "A")
                    {
                        if (blAccountPay) InsertAcctRecv(objSQlComm, 3, -(dblItemPrice * dblItemQty));
                        else InsertAcctRecv(objSQlComm, 5, -(dblItemPrice * dblItemQty));
                    }
                    if (dblLayawayDeposit != 0)
                        InsertLayawayPayment(objSQlComm, dblLayawayDeposit - dblChangeAmount, Functions.fnInt32(colINV));

                    if ((dblLayawayBalance == dblLayawayDeposit) && (blLayaway))
                        UpdateInvoiceHeaderForLayaway(objSQlComm, Functions.fnInt32(colINV), 3 );
                    if ((dblLayawayBalance != dblLayawayDeposit) && (blLayaway)) 
                        UpdateInvoiceHeaderForLayaway(objSQlComm, Functions.fnInt32(colINV), 1);
                    if (blLayawayRefund)
                        UpdateInvoiceHeaderForLayaway(objSQlComm, Functions.fnInt32(colINV), 5);

                    if (blLayawayRefund)
                    {
                        if (colPRODUCTTYPE == "E")
                            UpdateSerializedSoldOnLayawayRefund(objSQlComm, intPreviousItemID,"L");
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void IsAccountPay(SqlCommand objSQlComm)
        {
            try
            {
                int TotalCount = 0;
                int AcctPayCount = 0;
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    
                    if (dr["ID"].ToString() == "") continue;
                    TotalCount++;
                    if (dr["PRODUCTTYPE"].ToString() == "A") AcctPayCount++;

                }
                dtblItemDataTable.Dispose();
                if (TotalCount == AcctPayCount) blAccountPay = true;
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private double GetAccountPayment()
        {
            double val = 0;
            try
            {
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    if (dr["PRODUCTTYPE"].ToString() == "A")
                    {
                        val = val + Functions.fnDouble(dr["PRICE"].ToString())* Functions.fnDouble(dr["QTY"].ToString()) ;
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
            return val;
        }

        public bool InsertAcctRecv(SqlCommand objSQlComm, int pType, double pAmount)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into AcctRecv (CustomerID,InvoiceNo,Amount,TranType,Date, "
                                  + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,IssueStore,OperateStore ) "
                                  + " values (@CustomerID,@InvoiceNo,@Amount,@TranType,@Date, "
                                  + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@IssueStore,@OperateStore ) ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Amount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TranType", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Date", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@IssueStore", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OperateStore", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@Amount"].Value = pAmount;
                objSQlComm.Parameters["@InvoiceNo"].Value = intID;
                objSQlComm.Parameters["@TranType"].Value = pType;
                objSQlComm.Parameters["@Date"].Value = dtTransDate;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@IssueStore"].Value = strCustomerIssueStore;
                objSQlComm.Parameters["@OperateStore"].Value = strOperateStore;

                sqlDataReader = objSQlComm.ExecuteReader();
                //if (sqlDataReader.Read()) intRecvDetailID = System.Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertRepairItemDetails(SqlCommand objSQlComm, int intRefID, int pDesc)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Item (ServiceType,InvoiceNo,ProductID,Price,NormalPrice,Cost,Qty,"
                                  + " SKU,Description,ProductType,DepartmentID,CategoryID,"
                                  + " TaxID1,TaxID2,TaxID3,Taxable1,Taxable2,Taxable3,TaxRate1,TaxRate2,TaxRate3,"
                                  + " UOMCount,UOMPrice,UOMDesc,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,"
                                  + " DescID,ReturnedItemID, Notes,ItemIndex,Discount,DiscountID,DiscountText,"
                                  + " DiscLogic,DiscValue,RepairItemTag,RepairItemSLNO,RepairItemPurchaseDate,"
                                  + " TaxType1,TaxType2,TaxType3,TaxTotal1,TaxTotal2,TaxTotal3, "
                                  + " FeesID,FeesLogic,FeesValue,Fees,FeesTaxRate,FeesTax,FeesText,FeesQty,EditFlag,PromptPrice,TaxIncludeRate,TaxIncludePrice,UOM ) "

                                  + " values (@ServiceType,@InvoiceNo,@ProductID,@Price,@NormalPrice,@Cost,@Qty, "
                                  + " @SKU,@Description,@ProductType,@DepartmentID,@CategoryID,"
                                  + " @TaxID1,@TaxID2,@TaxID3,@Taxable1,@Taxable2,@Taxable3,@TaxRate1,@TaxRate2,@TaxRate3,"
                                  + " @UOMCount,@UOMPrice,@UOMDesc,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,"
                                  + " @DescID,@ReturnedItemID,@Notes,@ItemIndex,@Discount, "
                                  + " @DiscountID,@DiscountText,@DiscLogic,@DiscValue,"
                                  + " @RepairItemTag,@RepairItemSLNO,@RepairItemPurchaseDate,"
                                  + " @TaxType1,@TaxType2,@TaxType3,@TaxTotal1,@TaxTotal2,@TaxTotal3, "
                                  + " @FeesID,@FeesLogic,@FeesValue,@Fees,@FeesTaxRate,@FeesTax,@FeesText,@FeesQty,@EditFlag,@PromptPrice,@TaxIncludeRate,@TaxIncludePrice,@UOM ) "
                                  + " select @@IDENTITY as ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Price", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@NormalPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Cost", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Qty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@SKU", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DepartmentID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable1", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable2", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable3", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DescID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@UOMCount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMDesc", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Notes", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ItemIndex", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscValue", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemTag", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemSLNO", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemPurchaseDate", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxType1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal3", System.Data.SqlDbType.Float));
                
                objSQlComm.Parameters.Add(new SqlParameter("@FeesID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesQty", System.Data.SqlDbType.Char));
                
                objSQlComm.Parameters["@FeesID"].Value = intFeesID;
                objSQlComm.Parameters["@FeesLogic"].Value = strFeesLogic;
                objSQlComm.Parameters["@FeesValue"].Value = dblFeesValue;
                objSQlComm.Parameters["@Fees"].Value = dblFees;
                objSQlComm.Parameters["@FeesTaxRate"].Value = dblFeesTaxRate;
                objSQlComm.Parameters["@FeesTax"].Value = dblFeesTax;
                objSQlComm.Parameters["@FeesText"].Value = strFeesText;
                objSQlComm.Parameters["@FeesQty"].Value = strFeesQty;

                objSQlComm.Parameters["@ServiceType"].Value = strServiceType;
                objSQlComm.Parameters["@RepairItemTag"].Value = strRepairItemTag;
                objSQlComm.Parameters["@RepairItemSLNO"].Value = strRepairItemSLNO;
                if (dtRepairItemPurchaseDate == Convert.ToDateTime(null))
                {
                    objSQlComm.Parameters["@RepairItemPurchaseDate"].Value = Convert.DBNull;
                }
                else
                {
                    objSQlComm.Parameters["@RepairItemPurchaseDate"].Value = dtRepairItemPurchaseDate;
                }

                objSQlComm.Parameters["@InvoiceNo"].Value = intRefID;
                objSQlComm.Parameters["@ProductID"].Value = intItemID;
                objSQlComm.Parameters["@Price"].Value = dblItemPrice;
                objSQlComm.Parameters["@NormalPrice"].Value = dblItemNPrice;
                objSQlComm.Parameters["@Cost"].Value = dblItemCost;
                objSQlComm.Parameters["@Qty"].Value = dblItemQty;

                objSQlComm.Parameters["@SKU"].Value = strItemSKU;
                objSQlComm.Parameters["@Description"].Value = strItemDescription.Replace("\n","");
                objSQlComm.Parameters["@ProductType"].Value = strItemProductType;
                objSQlComm.Parameters["@DepartmentID"].Value = intItemDepartmentID;
                objSQlComm.Parameters["@CategoryID"].Value = intItemCategoryID;

                objSQlComm.Parameters["@TaxID1"].Value = intItemTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intItemTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intItemTaxID3;
                objSQlComm.Parameters["@Taxable1"].Value = strItemTaxable1;
                objSQlComm.Parameters["@Taxable2"].Value = strItemTaxable2;
                objSQlComm.Parameters["@Taxable3"].Value = strItemTaxable3;
                objSQlComm.Parameters["@TaxRate1"].Value = dblItemTaxRate1;
                objSQlComm.Parameters["@TaxRate2"].Value = dblItemTaxRate2;
                objSQlComm.Parameters["@TaxRate3"].Value = dblItemTaxRate3;
                objSQlComm.Parameters["@DescID"].Value = pDesc;

                objSQlComm.Parameters["@UOMCount"].Value = dblItemUOMCount;
                objSQlComm.Parameters["@UOMPrice"].Value = dblItemUOMPrice;
                objSQlComm.Parameters["@UOMDesc"].Value = strItemUOMDesc;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ReturnedItemID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@Notes"].Value = strInvNotes;
                
                objSQlComm.Parameters["@ItemIndex"].Value = intItemIndex;
                objSQlComm.Parameters["@DiscountID"].Value = intItemDiscountID;
                objSQlComm.Parameters["@DiscountText"].Value = strItemDiscountText;
                objSQlComm.Parameters["@DiscLogic"].Value = strItemDiscLogic;
                objSQlComm.Parameters["@Discount"].Value = dblItemDiscount;
                objSQlComm.Parameters["@DiscValue"].Value = dblItemDiscValue;

                objSQlComm.Parameters["@TaxType1"].Value = intItemTaxType1;
                objSQlComm.Parameters["@TaxType2"].Value = intItemTaxType2;
                objSQlComm.Parameters["@TaxType3"].Value = intItemTaxType3;

                objSQlComm.Parameters["@TaxTotal1"].Value = dblItemTaxTotal1;
                objSQlComm.Parameters["@TaxTotal2"].Value = dblItemTaxTotal2;
                objSQlComm.Parameters["@TaxTotal3"].Value = dblItemTaxTotal3;

                objSQlComm.Parameters.Add(new SqlParameter("@EditFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@EditFlag"].Value = sEditFlag;

                objSQlComm.Parameters.Add(new SqlParameter("@PromptPrice", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@PromptPrice"].Value = sPromptPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludeRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludeRate"].Value = dblItemGRate;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludePrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludePrice"].Value = dblItemGPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@UOM", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@UOM"].Value = strItemUOM;


                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intReturnItemID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertRentItemDetails(SqlCommand objSQlComm, int intRefID, int pDesc)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Item (ServiceType,InvoiceNo,ProductID,Price,NormalPrice,Cost,Qty, "
                                  + " SKU,Description,ProductType,DepartmentID,CategoryID,"
                                  + " TaxID1,TaxID2,TaxID3,Taxable1,Taxable2,Taxable3,TaxRate1,TaxRate2,TaxRate3,"
                                  + " UOMCount,UOMPrice,UOMDesc,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,"
                                  + " DescID,ReturnedItemID, Notes,Tagged,ItemIndex,Discount,DiscountID,DiscountText,"
                                  + " DiscLogic,DiscValue,RentApplicable,RentEffectiveFrom,RentDuration,RentDeposit,"
                                  + " TaxType1,TaxType2,TaxType3,TaxTotal1,TaxTotal2,TaxTotal3, "
                                  + " FeesID,FeesLogic,FeesValue,Fees,FeesTaxRate,FeesTax,FeesText,FeesQty,EditFlag,PromptPrice,TaxIncludeRate,TaxIncludePrice,UOM ) "
                                  + " values (@ServiceType,@InvoiceNo,@ProductID,@Price,@NormalPrice,@Cost,@Qty, "
                                  + " @SKU,@Description,@ProductType,@DepartmentID,@CategoryID,"
                                  + " @TaxID1,@TaxID2,@TaxID3,@Taxable1,@Taxable2,@Taxable3,@TaxRate1,@TaxRate2,@TaxRate3,"
                                  + " @UOMCount,@UOMPrice,@UOMDesc,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,"
                                  + " @DescID,@ReturnedItemID,@Notes,@Tagged,@ItemIndex,@Discount, "
                                  + " @DiscountID,@DiscountText,@DiscLogic,@DiscValue, "
                                  + " @RentApplicable,@RentEffectiveFrom,@RentDuration,@RentDeposit,"
                                  + " @TaxType1,@TaxType2,@TaxType3,@TaxTotal1,@TaxTotal2,@TaxTotal3, "
                                  + " @FeesID,@FeesLogic,@FeesValue,@Fees,@FeesTaxRate,@FeesTax,@FeesText,@FeesQty,@EditFlag,@PromptPrice,@TaxIncludeRate,@TaxIncludePrice,@UOM ) "
                                  + " select @@IDENTITY as ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Price", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@NormalPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Cost", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Qty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@SKU", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DepartmentID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable1", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable2", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable3", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DescID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@UOMCount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMDesc", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Notes", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Tagged", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ItemIndex", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscValue", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RentApplicable", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RentEffectiveFrom", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@RentDuration", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@RentDeposit", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxType1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesQty", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@EditFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@EditFlag"].Value = sEditFlag;

                objSQlComm.Parameters.Add(new SqlParameter("@PromptPrice", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@PromptPrice"].Value = sPromptPrice;

                objSQlComm.Parameters["@FeesID"].Value = intFeesID;
                objSQlComm.Parameters["@FeesLogic"].Value = strFeesLogic;
                objSQlComm.Parameters["@FeesValue"].Value = dblFeesValue;
                objSQlComm.Parameters["@Fees"].Value = dblFees;
                objSQlComm.Parameters["@FeesTaxRate"].Value = dblFeesTaxRate;
                objSQlComm.Parameters["@FeesTax"].Value = dblFeesTax;
                objSQlComm.Parameters["@FeesText"].Value = strFeesText;
                objSQlComm.Parameters["@FeesQty"].Value = strFeesQty;

                objSQlComm.Parameters["@ServiceType"].Value = strServiceType;
                objSQlComm.Parameters["@RentEffectiveFrom"].Value = dtTransDate;
                objSQlComm.Parameters["@RentApplicable"].Value = strRentType;
                objSQlComm.Parameters["@RentDuration"].Value = dblRentDuration;
                objSQlComm.Parameters["@RentDeposit"].Value = dblRentDeposit;

                objSQlComm.Parameters["@InvoiceNo"].Value = intRefID;
                objSQlComm.Parameters["@ProductID"].Value = intItemID;
                objSQlComm.Parameters["@Price"].Value = dblItemPrice;
                objSQlComm.Parameters["@NormalPrice"].Value = dblItemNPrice;
                objSQlComm.Parameters["@Cost"].Value = dblItemCost;
                objSQlComm.Parameters["@Qty"].Value = dblItemQty;

                objSQlComm.Parameters["@SKU"].Value = strItemSKU;
                objSQlComm.Parameters["@Description"].Value = strItemDescription.Replace("\n", "");
                objSQlComm.Parameters["@ProductType"].Value = strItemProductType;
                objSQlComm.Parameters["@DepartmentID"].Value = intItemDepartmentID;
                objSQlComm.Parameters["@CategoryID"].Value = intItemCategoryID;

                objSQlComm.Parameters["@TaxID1"].Value = intItemTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intItemTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intItemTaxID3;
                objSQlComm.Parameters["@Taxable1"].Value = strItemTaxable1;
                objSQlComm.Parameters["@Taxable2"].Value = strItemTaxable2;
                objSQlComm.Parameters["@Taxable3"].Value = strItemTaxable3;
                objSQlComm.Parameters["@TaxRate1"].Value = dblItemTaxRate1;
                objSQlComm.Parameters["@TaxRate2"].Value = dblItemTaxRate2;
                objSQlComm.Parameters["@TaxRate3"].Value = dblItemTaxRate3;
                objSQlComm.Parameters["@DescID"].Value = pDesc;

                objSQlComm.Parameters["@UOMCount"].Value = dblItemUOMCount;
                objSQlComm.Parameters["@UOMPrice"].Value = dblItemUOMPrice;
                objSQlComm.Parameters["@UOMDesc"].Value = strItemUOMDesc;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ReturnedItemID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@Notes"].Value = strInvNotes;
                objSQlComm.Parameters["@Tagged"].Value = strTagged;

                objSQlComm.Parameters["@ItemIndex"].Value = intItemIndex;
                objSQlComm.Parameters["@DiscountID"].Value = intItemDiscountID;
                objSQlComm.Parameters["@DiscountText"].Value = strItemDiscountText;
                objSQlComm.Parameters["@DiscLogic"].Value = strItemDiscLogic;
                objSQlComm.Parameters["@Discount"].Value = dblItemDiscount;
                objSQlComm.Parameters["@DiscValue"].Value = dblItemDiscValue;

                objSQlComm.Parameters["@TaxType1"].Value = intItemTaxType1;
                objSQlComm.Parameters["@TaxType2"].Value = intItemTaxType2;
                objSQlComm.Parameters["@TaxType3"].Value = intItemTaxType3;

                objSQlComm.Parameters["@TaxTotal1"].Value = dblItemTaxTotal1;
                objSQlComm.Parameters["@TaxTotal2"].Value = dblItemTaxTotal2;
                objSQlComm.Parameters["@TaxTotal3"].Value = dblItemTaxTotal3;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludeRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludeRate"].Value = dblItemGRate;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludePrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludePrice"].Value = dblItemGPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@UOM", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@UOM"].Value = strItemUOM;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intReturnItemID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertItemDetails(SqlCommand objSQlComm, int intRefID, int pDesc)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Item (ServiceType,InvoiceNo,ProductID,Price,NormalPrice,Cost,Qty, "
                                  + " SKU,Description,ProductType,DepartmentID,CategoryID,"
                                  + " TaxID1,TaxID2,TaxID3,Taxable1,Taxable2,Taxable3,TaxRate1,TaxRate2,TaxRate3,"
                                  + " UOMCount,UOMPrice,UOMDesc,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,"
                                  + " DescID,ReturnedItemID, Notes,Tagged,ItemIndex,Discount,DiscountID,DiscountText,"
                                  + " DiscLogic,DiscValue,TaxType1,TaxType2,TaxType3,TaxTotal1,TaxTotal2,TaxTotal3,MixMatchID,"
                                  + " FeesID,FeesLogic,FeesValue,Fees,FeesTaxRate,FeesTax,FeesText,FeesQty,SalePriceID,DTaxID,DTaxType,"
                                  + " DTaxRate,DTax,EditFlag,QtyDecimal,PromptPrice,BuyNGetFreeHeaderID,BuyNGetFreeCategory,BuyNGetFreeName,Age,TaxIncludeRate, TaxIncludePrice,UOM ) "
                                  + " values (@ServiceType,@InvoiceNo,@ProductID,@Price,@NormalPrice,@Cost,@Qty, "
                                  + " @SKU,@Description,@ProductType,@DepartmentID,@CategoryID,"
                                  + " @TaxID1,@TaxID2,@TaxID3,@Taxable1,@Taxable2,@Taxable3,@TaxRate1,@TaxRate2,@TaxRate3,"
                                  + " @UOMCount,@UOMPrice,@UOMDesc,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,"
                                  + " @DescID,@ReturnedItemID,@Notes,@Tagged,@ItemIndex,@Discount, "
                                  + " @DiscountID,@DiscountText,@DiscLogic,@DiscValue,@TaxType1,@TaxType2,@TaxType3,"
                                  + " @TaxTotal1,@TaxTotal2,@TaxTotal3,@MixMatchID, "
                                  + " @FeesID,@FeesLogic,@FeesValue,@Fees,@FeesTaxRate,@FeesTax,@FeesText,@FeesQty,@SalePriceID, "
                                  + " @DTaxID,@DTaxType,@DTaxRate,@DTax,@EditFlag,@QtyDecimal,@PromptPrice,@BuyNGetFreeHeaderID,@BuyNGetFreeCategory,@BuyNGetFreeName,@Age,@TaxIncludeRate, @TaxIncludePrice,@UOM )"
                                  + " select @@IDENTITY as ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Price", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@NormalPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Cost", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Qty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@SKU", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DepartmentID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable1", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable2", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable3", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DescID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@UOMCount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMDesc", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Notes", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Tagged", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ItemIndex", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscValue", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxType1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesQty", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@SalePriceID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@DTaxID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTaxType", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@EditFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@QtyDecimal", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@PromptPrice", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@PromptPrice"].Value = sPromptPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeHeaderID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@BuyNGetFreeHeaderID"].Value = iBuyGetFreeHeader;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeCategory", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@BuyNGetFreeCategory"].Value = sBuyGetFreeCat;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@BuyNGetFreeName"].Value = sBuyGetFreePromotionTxt;

                objSQlComm.Parameters.Add(new SqlParameter("@Age", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@Age"].Value = iAge;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludeRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludeRate"].Value = dblItemGRate;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludePrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludePrice"].Value = dblItemGPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@UOM", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@UOM"].Value = strItemUOM;

                objSQlComm.Parameters["@DTaxID"].Value = intDTxID;
                objSQlComm.Parameters["@DTaxType"].Value = intDTxType;
                objSQlComm.Parameters["@DTaxRate"].Value = dblDTxRate;
                objSQlComm.Parameters["@DTax"].Value = dblDTx;


                objSQlComm.Parameters["@FeesID"].Value = intFeesID;
                objSQlComm.Parameters["@FeesLogic"].Value = strFeesLogic;
                objSQlComm.Parameters["@FeesValue"].Value = dblFeesValue;
                objSQlComm.Parameters["@Fees"].Value = dblFees;
                objSQlComm.Parameters["@FeesTaxRate"].Value = dblFeesTaxRate;
                objSQlComm.Parameters["@FeesTax"].Value = dblFeesTax;
                objSQlComm.Parameters["@FeesText"].Value = strFeesText;
                objSQlComm.Parameters["@FeesQty"].Value = strFeesQty;

                objSQlComm.Parameters["@ServiceType"].Value = strServiceType;
                objSQlComm.Parameters["@InvoiceNo"].Value = intRefID;
                objSQlComm.Parameters["@ProductID"].Value = intItemID;
                objSQlComm.Parameters["@Price"].Value = dblItemPrice;
                objSQlComm.Parameters["@NormalPrice"].Value = dblItemNPrice;
                objSQlComm.Parameters["@Cost"].Value = dblItemCost;
                objSQlComm.Parameters["@Qty"].Value = dblItemQty;
                
                objSQlComm.Parameters["@SKU"].Value = strItemSKU;
                objSQlComm.Parameters["@Description"].Value = strItemDescription.Replace("\n", "");
                objSQlComm.Parameters["@ProductType"].Value = strItemProductType;
                objSQlComm.Parameters["@DepartmentID"].Value = intItemDepartmentID;
                objSQlComm.Parameters["@CategoryID"].Value = intItemCategoryID;

                objSQlComm.Parameters["@TaxID1"].Value = intItemTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intItemTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intItemTaxID3;
                objSQlComm.Parameters["@Taxable1"].Value = strItemTaxable1;
                objSQlComm.Parameters["@Taxable2"].Value = strItemTaxable2;
                objSQlComm.Parameters["@Taxable3"].Value = strItemTaxable3;
                objSQlComm.Parameters["@TaxRate1"].Value = dblItemTaxRate1;
                objSQlComm.Parameters["@TaxRate2"].Value = dblItemTaxRate2;
                objSQlComm.Parameters["@TaxRate3"].Value = dblItemTaxRate3;
                objSQlComm.Parameters["@DescID"].Value = pDesc;

                objSQlComm.Parameters["@UOMCount"].Value = dblItemUOMCount;
                objSQlComm.Parameters["@UOMPrice"].Value = dblItemUOMPrice;
                objSQlComm.Parameters["@UOMDesc"].Value = strItemUOMDesc;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ReturnedItemID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@Notes"].Value = strInvNotes;
                objSQlComm.Parameters["@Tagged"].Value = strTagged;

                objSQlComm.Parameters["@ItemIndex"].Value = intItemIndex;
                objSQlComm.Parameters["@DiscountID"].Value = intItemDiscountID;
                objSQlComm.Parameters["@DiscountText"].Value = strItemDiscountText;
                objSQlComm.Parameters["@DiscLogic"].Value = strItemDiscLogic;
                objSQlComm.Parameters["@Discount"].Value = dblItemDiscount;
                objSQlComm.Parameters["@DiscValue"].Value = dblItemDiscValue;

                objSQlComm.Parameters["@TaxType1"].Value = intItemTaxType1;
                objSQlComm.Parameters["@TaxType2"].Value = intItemTaxType2;
                objSQlComm.Parameters["@TaxType3"].Value = intItemTaxType3;

                objSQlComm.Parameters["@TaxTotal1"].Value = dblItemTaxTotal1;
                objSQlComm.Parameters["@TaxTotal2"].Value = dblItemTaxTotal2;
                objSQlComm.Parameters["@TaxTotal3"].Value = dblItemTaxTotal3;

                objSQlComm.Parameters["@MixMatchID"].Value = intMixMatchID;
                objSQlComm.Parameters["@SalePriceID"].Value = intSalePriceID;

                objSQlComm.Parameters["@EditFlag"].Value = sEditFlag;

                objSQlComm.Parameters["@QtyDecimal"].Value = iQtyDecimalLength;

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intReturnItemID = Functions.fnInt32(sqlDataReader["ID"]);

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertLayaway(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Layaway ( DateDue,CreatedBy, CreatedOn, LastChangedBy, LastChangedOn ) "
                                    + " values (@DateDue,@CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn ) "
                                    + " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@DateDue", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@DateDue"].Value = dtLayawayDateDue;
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;


                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intLayawayID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertLayawayPayment(SqlCommand objSQlComm , double dblamt, int INV)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Laypmts ( InvoiceNo,TransactionNo,Payment,CreatedBy, CreatedOn, LastChangedBy, LastChangedOn ) "
                                    + " values (@InvoiceNo,@TransactionNo,@Payment,@CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn ) ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Payment", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@InvoiceNo"].Value = INV;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@Payment"].Value = dblamt;
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;


                sqlDataReader = objSQlComm.ExecuteReader();
                
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool IsTaggedItem(SqlCommand objSQlComm, int PID)
        {
            int val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select count(*) as reccount from attachtag Where ItemID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    val = Functions.fnInt32(sqlDataReader["reccount"].ToString());
                }
                sqlDataReader.Close();
                if (val > 0) return true; else return false;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public int RentItemReturnCount(SqlCommand objSQlComm, int PID)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select count(ID) as rcnt from item where InvoiceNo=@ID and RentReturnFlag = 'Y' ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["rcnt"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public int RepairNotDeliveredCount(SqlCommand objSQlComm, int PID)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select count(ID) as rcnt from item where InvoiceNo=@ID and repairitemdeliverydate is null ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["rcnt"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public int RentItemCount(SqlCommand objSQlComm, int PID)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select count(ID) as rcnt from item where InvoiceNo=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["rcnt"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public double GetReturnItemCount(SqlCommand objSQlComm, int PID)
        {
            double intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select Qty - ReturnedItemCnt as CNT from item Where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnDouble(sqlDataReader["CNT"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public bool UpdateReturnRentItemFlag(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update Item set RentReturnFlag = 'Y',LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateReturnItem(SqlCommand objSQlComm, double dblQty)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update Item set ReturnedItemID = @ReturnedItemID, ReturnedItemCnt = ReturnedItemCnt +  @ReturnedItemCnt, "
                           + " LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemCnt", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@ID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@ReturnedItemID"].Value = intReturnItemID;
                objSQlComm.Parameters["@ReturnedItemCnt"].Value = dblQty;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateReturnItem1(SqlCommand objSQlComm, double dblQty)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " Update Item set ReturnedItemCnt = ReturnedItemCnt +  @ReturnedItemCnt, "
                                       + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn "
                                       + " Where ID=@ID ";


                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemCnt", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@ID"].Value = intPreviousItemID;
                objSQlComm.Parameters["@ReturnedItemCnt"].Value = dblQty;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateReturnItem2(SqlCommand objSQlComm, double dblQty, int pID)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " Update Item set ReturnedItemCnt = ReturnedItemCnt +  @ReturnedItemCnt, "
                                       + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn "
                                       + " Where ID=@ID ";


                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ReturnedItemCnt", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@ID"].Value = pID;
                objSQlComm.Parameters["@ReturnedItemCnt"].Value = dblQty;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateTag(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " Update Item set Tagged = 'Y',LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn Where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@ID"].Value = intReturnItemID;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateLayawayQtyOnHand(SqlCommand objSQlComm, int PID, double dblQty)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update product set QtyOnLayaway = QtyOnLayaway + @dblQty,LastChangedBy=@LastChangedBy,LastChangedOn=LastChangedOn, "
                           + " expflag = 'N' Where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@dblQty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = PID;
                objSQlComm.Parameters["@dblQty"].Value = dblQty;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateSerializedSold(SqlCommand objSQlComm, int PID, int itmID, string strType, string pflag)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                if (pflag == "0")
                {
                    strSQLComm = " Update SerialDetail set ItemID = @ItemID , soldtype = @Type, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                               + " Where ID=@ID ";
                }
                if (pflag == "1")
                {
                    strSQLComm = " Update SerialDetail set ItemID = @ItemID , "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                               + " Where ID=@ID and soldtype = @Type ";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ItemID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@Type", System.Data.SqlDbType.Char));

                objSQlComm.Parameters["@ID"].Value = PID;
                objSQlComm.Parameters["@ItemID"].Value = itmID;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@Type"].Value = strType;
                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateSerializedSoldOnLayawayRefund(SqlCommand objSQlComm, int PID, string strType)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " Update SerialDetail set ItemID = 0 , "
                           + " LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                           + " Where ItemID=@ID and soldtype = @Type ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@Type", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@ID"].Value = PID;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@Type"].Value = strType;
                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        private void AdjustGCGridRecords(SqlCommand objSQlComm , string strDirection)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                int islno = 0;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    islno++;
                    string colID = "";
                    string coRATE = "";
                    
                    if (dr["ID"].ToString() == "") continue;

                    if (dr["PRODUCTTYPE"].ToString() != "G") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    strGCNo = colID;
                    dblGCAmount = Functions.fnDouble(coRATE);

                    if (strDirection == "Insert GC")
                    {
                        if (strGCNo == "AUTO")
                        {
                            InsertGCDetails(objSQlComm, "", dblGCAmount, 0, strGCOPStore);
                            UpdateAutoGC(objSQlComm);
                        }
                        else
                        {
                            InsertGCDetails(objSQlComm, strGCNo, dblGCAmount, 0, strGCOPStore);
                        }
                        dtblGCInsertID.Rows.Add(new object[] { islno, intGCID });
                    }
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        public bool InsertGCDetails(SqlCommand objSQlComm,string pGCDesc,double pAmount,int pTender,string gcstore )
        {
            
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into GiftCert ( GiftCertID,Amount,TenderNo,RegisterID, "
                                  + " CreatedBy,CreatedOn,LastChangedBy, LastChangedOn,CustomerID,IssueStore,OperateStore) "
                                  + " values (@GiftCertID,@Amount,@TenderNo,@RegisterID, "
                                  + " @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn,@CustomerID,@IssueStore,@OperateStore ) "
                                  + " select @@IDENTITY as ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@GiftCertID", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Amount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TenderNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RegisterID", System.Data.SqlDbType.Int));
                
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@IssueStore", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OperateStore", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters["@GiftCertID"].Value = pGCDesc;
                objSQlComm.Parameters["@Amount"].Value = pAmount;
                objSQlComm.Parameters["@TenderNo"].Value = pTender;
                objSQlComm.Parameters["@RegisterID"].Value = intRegisterID;
                
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@IssueStore"].Value = gcstore;
                objSQlComm.Parameters["@OperateStore"].Value = strGCOPStore;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intGCID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }


        public bool UpdateAutoGC(SqlCommand objSQlComm)
        {
            
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update GiftCert set GiftCertID = @GCID where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@GCID", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@GCID"].Value = intGCID.ToString();
                objSQlComm.Parameters["@ID"].Value = intGCID;

                

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateItemRecordForAutoGC(SqlCommand objSQlComm, int pGCID, int pUpdtID)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update Item set ProductID = @param1,Description=@param2 where ID = @id ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@param1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@param2", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
                
                objSQlComm.Parameters["@param1"].Value = pGCID;
                objSQlComm.Parameters["@param2"].Value = "GC#:" + pGCID.ToString();
                objSQlComm.Parameters["@id"].Value = pUpdtID;

               

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateGCDetails(SqlCommand objSQlComm, int pGCID, int pUpdtID, string pType)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                if (pType == "Item")
                {

                    strSQLComm = " update GiftCert set ItemID = @ItemID,LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                               + " where ID = @GiftCertID ";
                }
                if (pType == "Tender")
                {

                    strSQLComm = " update GiftCert set TenderNo = @TenderNo,LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                               + " where GiftCertID = @GiftCertID ";
                }

                if (pType == "Return")
                {

                    strSQLComm = " update GiftCert set TenderNo = @TenderNo,LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                               + " where ID = @GiftCertID ";
                }

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@GiftCertID", System.Data.SqlDbType.Int));
                
                
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@GiftCertID"].Value = intGCID;

                if (pType == "Item")
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ItemID", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@ItemID"].Value = pUpdtID;
                }
                if (pType == "Tender")
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@TenderNo", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@TenderNo"].Value = pUpdtID;
                }

                if (pType == "Return")
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@TenderNo", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@TenderNo"].Value = pUpdtID;
                }
                
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertDesc(SqlCommand objSQlComm, string pGCDesc)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Descript (Description) values (@Description) ";
                                    
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@Description"].Value = "GC#:" + pGCDesc;
                
                sqlDataReader = objSQlComm.ExecuteReader();
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        private void AdjustMercuryGiftCardTranRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblMercuryGiftCardDataTable == null) return;
                foreach (DataRow dr in dtblMercuryGiftCardDataTable.Rows)
                {
                    if (dr["CardID"].ToString() == "") continue;

                    intMercuryGCIssueCardID = Functions.fnInt32(dr["CardID"].ToString());

                    UpdateCardTransForMercuryGC(objSQlComm);
                }
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustTenderGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                double tottenderamt = 0;
                if (dtblTenderDataTable == null) return;
                foreach (DataRow dr in dtblTenderDataTable.Rows)
                {
                    string colID = "";
                    string colAMOUNT = "";
                    string colGIFTCERTIFICATE = "";
                    string colGCNEW = "";
                    string colTender = "";
                    string colGCStore = "";
                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["AMOUNT"].ToString() != "")
                    {
                        colAMOUNT = dr["AMOUNT"].ToString();
                    }
                    else
                    {
                        colAMOUNT = "0.00";
                    }
                    colGCStore = dr["GCSTORE"].ToString();
                    colTender = dr["TENDER"].ToString();
                    colGIFTCERTIFICATE = dr["GIFTCERTIFICATE"].ToString();
                    colGCNEW = dr["NEWGC"].ToString();
                    dblTenderAmount = Functions.fnDouble(colAMOUNT);
                    intTenderID = Functions.fnInt32(colID);

                    InsertTenderDetails(objSQlComm);

                    if (colTender == "Store Credit") Functions.UpdateStoreCreditBalance(objSQlComm, intCustomerID,
                                                        -dblTenderAmount, intLoginUserID);


                    if ((colTender == "Visa") || (colTender == "MasterCard") || (colTender == "American Express") || (colTender == "Discover") ||
                        (colTender == "Diner") || (colTender == "Debit Card") || (colTender == "Credit Card")
                        || (colTender == "Credit Card - Voice Auth") || (colTender == "Credit Card (STAND-IN)")
                        || (colTender == "Credit Card - Voice Auth (STAND-IN)")
                        || (colTender == "Mercury Gift Card") || (colTender == "Precidia Gift Card") 
                        || (colTender == "Datacap Gift Card") || (colTender == "POSLink Gift Card") || (colTender == "Food Stamps")
                        || (colTender == "EBT Cash") || (colTender == "EBT Voucher"))
                    {
                        UpdateCardTrans(objSQlComm);
                        InsertCardAuthorisation(objSQlComm, colTender, dblTenderAmount);
                    }

                    if (colGIFTCERTIFICATE != "")
                    {
                        //UpdateGCDetails(objSQlComm, Functions.fnInt32(colGIFTCERTIFICATE), intReturnTenderID, "Tender");
                        InsertGCDetails(objSQlComm, colGIFTCERTIFICATE, dblTenderAmount, intReturnTenderID, colGCStore);
                    }
                    if (colTender == "House Account")
                    {
                        InsertAcctRecv(objSQlComm, 2, dblTenderAmount);
                    }

                    if (colTender == "Store Credit")
                    {
                        AddStoreCreditTransaction(objSQlComm, blReturn ? "Reverse Redemption" : "Redemption", dtTransDate, -dblTenderAmount, intID);
                    }


                    if (colTender == "Food Stamps")
                    {
                        UpdateFSTender(objSQlComm);
                    }

                    tottenderamt = tottenderamt + dblTenderAmount;
                }
                dtblTenderDataTable.Dispose();

                if (dblChangeAmount > 0)
                {
                    intTenderID = GetCashTenderID(objSQlComm);
                    dblTenderAmount = -dblChangeAmount;
                    InsertTenderDetails(objSQlComm);
                }

                
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustGCTenderGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblTenderDataTable == null) return;
                foreach (DataRow dr in dtblTenderDataTable.Rows)
                {
                    string colID = "";
                    string colAMOUNT = "";
                    string colGIFTCERTIFICATE = "";
                    string colGCNEW = "";
                    string colOLDAMOUNT = "";
                    string colOLD = "";
                    string colGCSTORE = "";
                    if (dr["ID"].ToString() == "") continue;
                    if (dr["GIFTCERTIFICATE"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["AMOUNT"].ToString() != "")
                    {
                        colAMOUNT = dr["AMOUNT"].ToString();
                    }
                    else
                    {
                        colAMOUNT = "0.00";
                    }

                    if (dr["OLDGCAMT"].ToString() != "")
                    {
                        colOLDAMOUNT = dr["OLDGCAMT"].ToString();
                    }
                    else
                    {
                        colOLDAMOUNT = "0.00";
                    }
                    colGCSTORE = dr["GCSTORE"].ToString();
                    colGIFTCERTIFICATE  = dr["GIFTCERTIFICATE"].ToString();
                    colGCNEW = dr["NEWGC"].ToString();
                    colOLD = dr["OLDGC"].ToString();
                    dblGCAmount = Functions.fnDouble(colAMOUNT);
                    if (colGCNEW == "Y")
                    {
                        //InsertDesc(objSQlComm, "GC#:" + colGIFTCERTIFICATE);
                        if (colOLD == "N") InsertGCDetails(objSQlComm, colGIFTCERTIFICATE, dblGCAmount, 0, colGCSTORE);
                        if (colOLD == "Y") InsertGCDetails(objSQlComm, colGIFTCERTIFICATE, Functions.fnDouble(colOLDAMOUNT), 0, colGCSTORE);
                    }

                }
                dtblTenderDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        public bool InsertTenderDetails(SqlCommand objSQlComm)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = "insert into Tender ( TransactionNo,TenderType,TenderAmount, "
                    + " CreatedBy, CreatedOn, LastChangedBy, LastChangedOn) "
                    + " values (@TransactionNo,@TenderType,@TenderAmount, "
                    + " @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn) "
                    + " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TenderType", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TenderAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@TenderType"].Value = intTenderID;
                objSQlComm.Parameters["@TenderAmount"].Value = dblTenderAmount;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intReturnTenderID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool InsertMatrixOption(SqlCommand objSQlComm)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into ItemMatrixOptions ( ItemID,MatrixOptionID,"
                                    + " OptionValue1,OptionValue2,OptionValue3, "
                                    + " CreatedBy, CreatedOn, LastChangedBy, LastChangedOn) "
                                    + " values (@ItemID,@MatrixOptionID,@OptionValue1,@OptionValue2,@OptionValue3, "
                                    + " @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn) ";
                //+ " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;


                objSQlComm.Parameters.Add(new SqlParameter("@ItemID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MatrixOptionID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue1", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue2", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue3", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ItemID"].Value = intReturnItemID;
                objSQlComm.Parameters["@MatrixOptionID"].Value = intMatrixOptionID;
                objSQlComm.Parameters["@OptionValue1"].Value = strMatrixOptionValue1;
                objSQlComm.Parameters["@OptionValue2"].Value = strMatrixOptionValue2;
                objSQlComm.Parameters["@OptionValue3"].Value = strMatrixOptionValue3;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                //if (sqlDataReader.Read()) intRecvDetailID = System.Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        #region Check if Gift Certificate Exists
        public int GetDescID(SqlCommand objSQlComm, string pStr)
        {
            int intresult = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            
            try
            {
                string strSQLComm = " select ID from Descript where Description = @Description ";
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@Description"].Value = pStr;

                sqlDataReader = objSQlComm.ExecuteReader();

                while (sqlDataReader.Read())
                {
                    intresult = Functions.fnInt32(sqlDataReader["ID"].ToString());
                }
                sqlDataReader.Close();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                
                return 0;
            }
        }

        #endregion

        #region Insertt Paid Out Explanation

        public bool InsertPaidOutExplanation(SqlCommand objSQlComm)
        {
            
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm =   " insert into Notes ( RefID, RefType, Note, CreatedBy, CreatedOn, LastChangedBy, LastChangedOn) "
                                    + " values (@RefID, @RefType, @Note, @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn) "
                                    + " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@RefID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RefType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Note", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@RefID"].Value = 0;
                objSQlComm.Parameters["@RefType"].Value = "Paid Out";
                objSQlComm.Parameters["@Note"].Value = strNotes;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intTransNoteNo = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        #endregion

        public bool UpdateTrans(SqlCommand objSQlComm)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " Update Trans set TransNoteNo = @TransNoteNo, "
                                        + " LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn "
                                        + " Where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransNoteNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intTransactionNo;
                objSQlComm.Parameters["@TransNoteNo"].Value = intTransNoteNo;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public DataTable FetchTaggedItem(SqlCommand objSQlComm, int pItemID)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select t.itemid, t.itemqty,t.itemprice, "
                           + " p.producttype,p.sku,p.description,p.departmentid,p.categoryid  "
                           + " from attachtag t left outer join product p on p.id = t.itemid where t.tagid = @tag ";
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@tag", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@tag"].Value = pItemID;
                
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TQTY", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TPRICE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TSKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TDESC", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TDEPT", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TCAT", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["itemid"].ToString(),
												objSQLReader["itemqty"].ToString(),
                                                objSQLReader["itemprice"].ToString(),
                                                objSQLReader["producttype"].ToString(),
                                                objSQLReader["sku"].ToString(),
                                                objSQLReader["description"].ToString(),
                                                objSQLReader["departmentid"].ToString(),
                                                objSQLReader["categoryid"].ToString()});
                }
                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchTaggedItemInInvoice(SqlCommand objSQlComm, int pInv, int pDid)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select id from item where invoiceno = @INV and tagged = 'X' and returneditemid = 0 and DescID = @DID ";
                           
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@INV", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@INV"].Value = pInv;
                objSQlComm.Parameters.Add(new SqlParameter("@DID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@DID"].Value = pDid;


                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["id"].ToString()});
                }
                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchAvailableTagItem(int pparam1, int pparam2, int pparam3)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select id, productid, sku, Description, ProductType,(qty-returneditemcnt) as availqty, "
                                + " price, invoiceno from item where tagged = 'X' and invoiceno = @INV and descid = @DESC and productid in  "
                                + " ( select itemid from attachtag where tagid = @TAG) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@INV", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@INV"].Value = pparam1;
            objSQlComm.Parameters.Add(new SqlParameter("@TAG", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@TAG"].Value = pparam2;
            objSQlComm.Parameters.Add(new SqlParameter("@DESC", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@DESC"].Value = pparam3;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("INV", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PNAME", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PTYPE", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QTY", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("PRICE", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("TAG", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    if (Functions.fnDouble(objSQLReader["availqty"].ToString()) == 0) continue;

                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["invoiceno"].ToString(),
                                                objSQLReader["id"].ToString(),
												objSQLReader["productid"].ToString(),
                                                objSQLReader["sku"].ToString(),
												objSQLReader["Description"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                Functions.fnDouble(objSQLReader["availqty"].ToString()),
                                                Functions.fnDouble(objSQLReader["price"].ToString()),
                                                "Y"});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchPaidOut(int intPaidOut)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select ID, StoreID, RegisterID,TerminalName, TransDate, EmployeeID"
                              + " from trans where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intPaidOut;
            SqlDataReader objSQLReader = null;

            string pName = "";

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TranNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StoreID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RegisterID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmpID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Terminal", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["StoreID"].ToString(),
                                                objSQLReader["RegisterID"].ToString(),
												objSQLReader["TransDate"].ToString(),
                                                objSQLReader["EmployeeID"].ToString(),
                                                objSQLReader["TerminalName"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #region Fetch Invoice Record Header

        public DataTable FetchInvoiceHeader(int intInvID,string thisstore)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select a.ID, a.StoreID,a.RegisterID,a.TerminalName,a.TransDate,isnull(c.ID,0) as CID,isnull(c.CustomerID,'') as CustID,"
                              + " isnull(c.LastName,'') as CustLast,isnull(c.FirstName,'') as CustFirst,isnull(c.Company,'') as CustCom,"
                              + " isnull(c.Address1,'') as CustAddress1,isnull(c.Address2,'') as CustAddress2,isnull(c.City,'') as CustCity,"
                              + " isnull(c.State,'') as CustState,isnull(c.Zip,'') as CustZip,isnull(c.MobilePhone,'') as CustMobile,"
                              + " isnull(c.issuestore,'') as CustStore,isnull(e.EmployeeID,0) as EmpID,i.Tax,i.Tax1,i.Tax2,i.Tax3,"
                              + " isnull(tx1.TaxName,'') as TaxNM1,isnull(tx2.TaxName,'') as TaxNM2,isnull(tx3.TaxName,'') as TaxNM3,"
                              + " i.Discount,i.TotalSale,i.Coupon,i.DiscountReason,i.ReceiptCnt,i.Status,i.ServiceType,i.RentDeposit,"
                              + " i.RentReturnDeposit,i.RentReturnFlag, i.RepairDeliveryDate,i.RepairNotifiedDate,i.RepairAmount,"
                              + " i.RepairAdvanceAmount,i.RepairDueAmount,i.RepairProblem,i.RepairNotes,i.RepairRemarks,i.RepairStatus,"
                              + " i.RentParentID,i.RepairParentID,i.IsRentCalculated,i.Fees,i.FeesTax,i.FeesCoupon,i.FeesCouponTax,i.RepairItemName,i.RepairItemSlNo,"
                              + " isnull(dtx.TaxName,'') as DTaxNM,i.DTax,i.RepairDateIn, isnull(i.CustomerOrderRef,0) as OrderRef,i.CustomerDOB as CustDOB from Invoice i left outer join Trans a "
                              + " on a.ID = i.TransactionNo left outer join Customer c on a.CustomerID = c.ID "
                              + " left outer join Employee e on a.EmployeeID = e.ID left outer join TaxHeader tx1 on i.TaxID1=tx1.ID "
                              + " left outer join TaxHeader tx2 on i.TaxID2=tx2.ID left outer join TaxHeader tx3 on i.TaxID3=tx3.ID "
                              + " left outer join TaxHeader dtx on i.DTaxID=dtx.ID where i.ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            string cshortinfo = "";
            string pCity = "";
            string pZip = "";
            string cinfo = "";
            string pCom = "";
            string pName = "";
            string pAdr1 = "";
            string pAdr2 = "";
            string pAdr3 = "";
            string pCID = "";
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TranNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StoreID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RegisterID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Terminal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustCompany", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustDetails", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustStore", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustMobile", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmpID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalSale", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountReason", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReceiptCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Coupon", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Status", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ServiceType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentReturnDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentReturnFlag", System.Type.GetType("System.String"));

                dtbl.Columns.Add("RepairDeliveryDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairNotifiedDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairProblem", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairNotes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairRemarks", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAdvanceAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairDueAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentParentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairParentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsRentCalculated", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesCoupon", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesCouponTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTax", System.Type.GetType("System.String"));

                dtbl.Columns.Add("RepairItemName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSlNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairDateIn", System.Type.GetType("System.String"));

                dtbl.Columns.Add("CustomerOrderRef", System.Type.GetType("System.String"));

                dtbl.Columns.Add("CustomerDOB", System.Type.GetType("System.String"));

                dtbl.Columns.Add("CustomerShortAddress", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Logo", typeof(byte[]));

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustID"].ToString() != "")
                    {
                        pCID = objSQLReader["CustID"].ToString();
                        if ((thisstore != "") && (objSQLReader["CustStore"].ToString() != "") && (thisstore != objSQLReader["CustStore"].ToString()))
                            pCID = objSQLReader["CustStore"].ToString() + " - " + objSQLReader["CustID"].ToString();
                        pName = objSQLReader["CustLast"].ToString() + ", " + objSQLReader["CustFirst"].ToString();

                        pCom = objSQLReader["CustCom"].ToString();
                        pAdr1 = objSQLReader["CustAddress1"].ToString();
                        pAdr2 = objSQLReader["CustAddress2"].ToString();
                        pCity = objSQLReader["CustCity"].ToString();
                        pZip = objSQLReader["CustZip"].ToString();
                        if (objSQLReader["CustCity"].ToString() != "") pAdr3 = objSQLReader["CustCity"].ToString() + ", ";
                        if (objSQLReader["CustState"].ToString() != "") pAdr3 = pAdr3 + objSQLReader["CustState"].ToString();
                        if (objSQLReader["CustZip"].ToString() != "") pAdr3 = pAdr3 + " " + objSQLReader["CustZip"].ToString();
                        if (pCom != "") cinfo = pCom;
                        if (cinfo != "") cinfo = cinfo + "\r\n" + pName; else cinfo = pName;
                        if (pAdr1 != "") cinfo = cinfo + "\r\n" + pAdr1;
                        if (pAdr2 != "") cinfo = cinfo + "\r\n" + pAdr2;
                        if (pAdr3 != "") cinfo = cinfo + "\r\n" + pAdr3;

                        if (pAdr1 != "")
                        {
                            cshortinfo = pAdr1;
                        }
                        if (pCity != "")
                        {
                            cshortinfo = cshortinfo == "" ? pCity : cshortinfo + "  " + pCity;
                        }

                        if (pZip != "")
                        {
                            cshortinfo = cshortinfo == "" ? pZip : cshortinfo + "  " + pZip;
                        }


                    }

                    string cdob = "";
                    if ((objSQLReader["CustDOB"].ToString().StartsWith("01/01/1900")) || (objSQLReader["CustDOB"].ToString().StartsWith("1/1/1900")) || (objSQLReader["CustDOB"].ToString() == DateTime.MinValue.ToString()))
                    {

                    }
                    else
                    {
                        cdob = objSQLReader["CustDOB"].ToString();
                    }

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["StoreID"].ToString(),
                                                objSQLReader["RegisterID"].ToString(),
                                                 objSQLReader["TerminalName"].ToString(),
												objSQLReader["TransDate"].ToString(),
                                                objSQLReader["CID"].ToString(),
                                                pCID,
                                                pName,
                                                objSQLReader["CustCom"].ToString(),
                                                cinfo,
                                                objSQLReader["CustStore"].ToString(),
                                                objSQLReader["CustMobile"].ToString(),
                                                objSQLReader["EmpID"].ToString(),
                                                objSQLReader["Tax"].ToString(),
                                                objSQLReader["Tax1"].ToString(),
                                                objSQLReader["Tax2"].ToString(),
                                                objSQLReader["Tax3"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["TotalSale"].ToString(),
                                                objSQLReader["DiscountReason"].ToString(),
                                                objSQLReader["TaxNM1"].ToString(),
                                                objSQLReader["TaxNM2"].ToString(),
                                                objSQLReader["TaxNM3"].ToString(),
                                                objSQLReader["ReceiptCnt"].ToString(),
                                                objSQLReader["Coupon"].ToString(),
                                                objSQLReader["Status"].ToString(),
                                                objSQLReader["ServiceType"].ToString(),
                                                objSQLReader["RentDeposit"].ToString(),
                                                objSQLReader["RentReturnDeposit"].ToString(),
                                                objSQLReader["RentReturnFlag"].ToString(),
                                                objSQLReader["RepairDeliveryDate"].ToString(),
                                                objSQLReader["RepairNotifiedDate"].ToString(),
                                                objSQLReader["RepairProblem"].ToString(),
                                                objSQLReader["RepairNotes"].ToString(),
                                                objSQLReader["RepairRemarks"].ToString(),
                                                objSQLReader["RepairAdvanceAmount"].ToString(),
                                                objSQLReader["RepairAmount"].ToString(),
                                                objSQLReader["RepairDueAmount"].ToString(),
                                                objSQLReader["RepairStatus"].ToString(),
                                                objSQLReader["RentParentID"].ToString(),
                                                objSQLReader["RepairParentID"].ToString(),
                                                objSQLReader["IsRentCalculated"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesCoupon"].ToString(),
                                                objSQLReader["FeesCouponTax"].ToString(),
                                                objSQLReader["DTaxNM"].ToString(),
                                                objSQLReader["DTax"].ToString(),
                                                objSQLReader["RepairItemName"].ToString(),
                                                objSQLReader["RepairItemSlNo"].ToString(),
                                                objSQLReader["RepairDateIn"].ToString(),
                                                objSQLReader["OrderRef"].ToString(),
                                                cdob,
                                                cshortinfo,null});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRepairParentHeaderData(int intInvID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select RepairAmount,RepairAdvanceAmount,RepairDueAmount,RepairProblem,RepairNotes,RepairRemarks,RepairItemName,RepairItemSlNo "
                              + " from invoice where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                
                dtbl.Columns.Add("RepairAdvanceAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairDueAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairProblem", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairNotes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairRemarks", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSlNo", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {    objSQLReader["RepairAdvanceAmount"].ToString(),
                                                    objSQLReader["RepairAmount"].ToString(),
                                                    objSQLReader["RepairDueAmount"].ToString(),
                                                    objSQLReader["RepairProblem"].ToString(),
                                                    objSQLReader["RepairNotes"].ToString(),
                                                    objSQLReader["RepairRemarks"].ToString(),
                                                    objSQLReader["RepairItemName"].ToString(),
                                                    objSQLReader["RepairItemSlNo"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRentParentHeaderData(int intInvID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select rentdeposit,rentreturndeposit,rentdeposit - rentreturndeposit as dueamt from invoice where ID = @ID ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("RentDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentReturnDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DueAmount", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["rentdeposit"].ToString(),
                                                objSQLReader["rentreturndeposit"].ToString(),
                                                objSQLReader["dueamt"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchCustomerInfoForPreviewInvoice(int intCustomerID, string thisstore)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select isnull(c.ID,0) as CID,isnull(c.CustomerID,'') as CustID,"
                              + " isnull(c.LastName,'') as CustLast,isnull(c.FirstName,'') as CustFirst,isnull(c.Company,'') as CustCom,"
                              + " isnull(c.Address1,'') as CustAddress1,isnull(c.Address2,'') as CustAddress2,isnull(c.City,'') as CustCity,"
                              + " isnull(c.State,'') as CustState,isnull(c.Zip,'') as CustZip,isnull(c.MobilePhone,'') as CustMobile,"
                              + " isnull(c.issuestore,'') as CustStore "
                              + " from  Customer c where c.ID  = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intCustomerID;
            SqlDataReader objSQLReader = null;

            string cshortinfo = "";
            string pCity = "";
            string pZip = "";
            string cinfo = "";
            string pCom = "";
            string pName = "";
            string pAdr1 = "";
            string pAdr2 = "";
            string pAdr3 = "";
            string pCID = "";
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustCompany", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustDetails", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustStore", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustMobile", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerShortAddress", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustID"].ToString() != "")
                    {
                        pCID = objSQLReader["CustID"].ToString();
                        if ((thisstore != "") && (objSQLReader["CustStore"].ToString() != "") && (thisstore != objSQLReader["CustStore"].ToString()))
                            pCID = objSQLReader["CustStore"].ToString() + " - " + objSQLReader["CustID"].ToString();
                        pName = objSQLReader["CustLast"].ToString() + ", " + objSQLReader["CustFirst"].ToString();

                        pCom = objSQLReader["CustCom"].ToString();
                        pAdr1 = objSQLReader["CustAddress1"].ToString();
                        pAdr2 = objSQLReader["CustAddress2"].ToString();
                        pCity = objSQLReader["CustCity"].ToString();
                        pZip = objSQLReader["CustZip"].ToString();
                        if (objSQLReader["CustCity"].ToString() != "") pAdr3 = objSQLReader["CustCity"].ToString() + ", ";
                        if (objSQLReader["CustState"].ToString() != "") pAdr3 = pAdr3 + objSQLReader["CustState"].ToString();
                        if (objSQLReader["CustZip"].ToString() != "") pAdr3 = pAdr3 + " " + objSQLReader["CustZip"].ToString();
                        if (pCom != "") cinfo = pCom;
                        if (cinfo != "") cinfo = cinfo + "\r\n" + pName; else cinfo = pName;
                        if (pAdr1 != "") cinfo = cinfo + "\r\n" + pAdr1;
                        if (pAdr2 != "") cinfo = cinfo + "\r\n" + pAdr2;
                        if (pAdr3 != "") cinfo = cinfo + "\r\n" + pAdr3;

                        if (pAdr1 != "")
                        {
                            cshortinfo = pAdr1;
                        }
                        if (pCity != "")
                        {
                            cshortinfo = cshortinfo == "" ? pCity : cshortinfo + "  " + pCity;
                        }

                        if (pZip != "")
                        {
                            cshortinfo = cshortinfo == "" ? pZip : cshortinfo + "  " + pZip;
                        }


                    }

                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["CID"].ToString(),
                                                pCID,
                                                pName,
                                                objSQLReader["CustCom"].ToString(),
                                                cinfo,
                                                objSQLReader["CustStore"].ToString(),
                                                objSQLReader["CustMobile"].ToString(),
                                                cshortinfo});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        #region Fetch Layaway Invoice

        public DataTable FetchLayawayHeaderForPreprint(DataTable refdtbl, int intTran, bool blReprint, string thisstore)
        {
            DataTable dtbl = new DataTable();

            string strSQL1 = "";
            string strSQL2 = "";
            string getdtblID = "";

            foreach (DataRow dr in refdtbl.Rows)
            {
                if (getdtblID == "")
                {
                    getdtblID = dr["LayawayNo"].ToString();
                }
                else
                {
                    getdtblID = getdtblID + "," + dr["LayawayNo"].ToString();
                }
            }
            if (getdtblID != "")
            {
                strSQL1 = " and i.LayawayNo in ( " + getdtblID + " )";
            }

            if (!blReprint) strSQL2 = " and a.ID = @TRNO ";

            string strSQLComm =   " select a.ID, a.StoreID, a.RegisterID, a.TransDate,a.TerminalName, "
                                + " isnull(c.CustomerID,'') as CustID, isnull(c.Company,'') as CustCom, isnull(c.LastName,'') as CustLast,  "
                                + " isnull(c.FirstName,'') as CustFirst, isnull(c.IssueStore,'') as CustStore,isnull(e.EmployeeID,0) as EmpID, "
                                + " isnull(c.Address1,'') as CustAddress1,isnull(c.Address2,'') as CustAddress2,isnull(c.City,'') as CustCity,"
                                + " isnull(c.State,'') as CustState,isnull(c.Zip,'') as CustZip,"
                                + " it.ProductType,it.SKU, it.Description, it.Qty, it.Price,it.NormalPrice,it.UOMPrice,it.Discount,it.DiscountText, l.DateDue, "
                                + " i.ID as InvoiceNo, i.Discount, i.TotalSale, i.DiscountReason,i.ReceiptCnt,i.Status as LayawayStatus, i.LayawayNo, l.DateDue  "
                                + " from Invoice i left outer join Trans a on a.ID = i.TransactionNo "
                                + " left outer join item it on it.invoiceno = i.ID "
                                + " left outer join Customer c on a.CustomerID = c.ID "
                                + " left outer join Employee e on a.EmployeeID = e.ID "
                                + " Left outer join Layaway l on i.LayawayNo=l.ID where (1 = 1) " + strSQL1
                                + strSQL2
                                + " order by i.LayawayNo, i.ID, i.Status ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (!blReprint)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@TRNO", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@TRNO"].Value = intTran;
            }

            SqlDataReader objSQLReader = null;
            
            string cinfo = "";
            string pCom = "";
            string pName = "";
            string pAdr1 = "";
            string pAdr2 = "";
            string pAdr3 = "";
            string pCID = "";
            double dbldisc1 = 0;
            double dbldisc = 0;
            double dblpr = 0;
            double dblnpr = 0;
            string discinfo = "";
            double TP = 0;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TranNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StoreID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RegisterID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Terminal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustCompany", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustStore", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustDetails", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmpID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalSale", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountReason", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReceiptCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LayawayNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LayawayStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateDue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountInfo", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    discinfo = "";
                    dbldisc1 = 0;
                    dbldisc = 0;
                    dblpr = 0;
                    dblnpr = 0;


                    if (objSQLReader["CustID"].ToString() != "")
                    {
                        pCID = objSQLReader["CustID"].ToString();
                        if ((thisstore != "") && (objSQLReader["CustStore"].ToString() != "") && (thisstore != objSQLReader["CustStore"].ToString()))
                            pCID = objSQLReader["CustStore"].ToString() + " - " + objSQLReader["CustID"].ToString();
                        pName = objSQLReader["CustLast"].ToString() + ", " + objSQLReader["CustFirst"].ToString();
                    }


                    pCom = objSQLReader["CustCom"].ToString();
                    pAdr1 = objSQLReader["CustAddress1"].ToString();
                    pAdr2 = objSQLReader["CustAddress2"].ToString();
                    if (objSQLReader["CustCity"].ToString() != "") pAdr3 = objSQLReader["CustCity"].ToString() + ", ";
                    if (objSQLReader["CustState"].ToString() != "") pAdr3 = pAdr3 + objSQLReader["CustState"].ToString();
                    if (objSQLReader["CustZip"].ToString() != "") pAdr3 = pAdr3 + " " + objSQLReader["CustZip"].ToString();
                    if (pCom != "") cinfo = pCom;
                    if (cinfo != "") cinfo = cinfo + "\r\n" + pName; else cinfo = pName;
                    if (pAdr1 != "") cinfo = cinfo + "\r\n" + pAdr1;
                    if (pAdr2 != "") cinfo = cinfo + "\r\n" + pAdr2;
                    if (pAdr3 != "") cinfo = cinfo + "\r\n" + pAdr3;

                    if ((objSQLReader["ProductType"].ToString() == "G") || (objSQLReader["ProductType"].ToString() == "B")
                        || (objSQLReader["ProductType"].ToString() == "A") || (objSQLReader["ProductType"].ToString() == "C")
                        || (objSQLReader["ProductType"].ToString() == "X") || (objSQLReader["ProductType"].ToString() == "Z")
                        || (objSQLReader["ProductType"].ToString() == "O")
                        || (objSQLReader["ProductType"].ToString() == "H"))
                    {
                        dblnpr = Functions.fnDouble(objSQLReader["Price"].ToString());
                        dbldisc = 0;
                    }
                    else
                    {
                        if (objSQLReader["ProductType"].ToString() == "U")
                        {
                            dblnpr = Functions.fnDouble(objSQLReader["UOMPrice"].ToString());
                            dbldisc = Functions.fnDouble(objSQLReader["UOMPrice"].ToString()) - Functions.fnDouble(objSQLReader["Price"].ToString());
                        }
                        else
                        {
                            dblnpr = Functions.fnDouble(objSQLReader["NormalPrice"].ToString());
                            dbldisc = Functions.fnDouble(objSQLReader["NormalPrice"].ToString()) - Functions.fnDouble(objSQLReader["Price"].ToString());
                        }
                    }

                    TP = 0;
                    TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["Price"].ToString()) - Functions.fnDouble(objSQLReader["Discount"].ToString());

                    dbldisc1 = Functions.fnDouble(objSQLReader["Discount"].ToString());
                    if (dbldisc1 > 0)
                    {
                        discinfo = objSQLReader["DiscountText"].ToString();
                    }
                    else
                    {
                        if (dbldisc > 0)
                        {
                            discinfo = "Normal Price " + dblnpr.ToString("f") + "    Discount " + dbldisc.ToString("f");
                        }
                    }
                    
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["StoreID"].ToString(),
                                                objSQLReader["RegisterID"].ToString(),
												objSQLReader["TransDate"].ToString(),
                                                objSQLReader["TerminalName"].ToString(),
                                                pCID,
                                                pName,
                                                objSQLReader["CustCom"].ToString(),
                                                objSQLReader["CustStore"].ToString(),
                                                cinfo,
                                                objSQLReader["EmpID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["TotalSale"].ToString(),
                                                objSQLReader["DiscountReason"].ToString(),
                                                objSQLReader["ReceiptCnt"].ToString(),
                                                objSQLReader["LayawayNo"].ToString(),
                                                objSQLReader["LayawayStatus"].ToString(),
                                                objSQLReader["DateDue"].ToString(),
                                                objSQLReader["InvoiceNo"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                TP.ToString(),
                                                discinfo});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchLayawayPaymentPreprint(DataTable refdtbl, int intLayID)
        {
            string strSQL1 = "";
            string getdtblID = "";

            foreach (DataRow dr in refdtbl.Rows)
            {
                if (getdtblID == "")
                {
                    getdtblID = dr["LayawayNo"].ToString();
                }
                else
                {
                    getdtblID = getdtblID + "," + dr["LayawayNo"].ToString();
                }
            }
            if (getdtblID != "")
            {
                strSQL1 = " and i.LayawayNo in ( " + getdtblID + " )";
            }

            DataTable dtbl = new DataTable();
            string strSQLComm = " select lp.InvoiceNo,lp.TransactionNo,lp.Payment, t.TransType,t.Transdate from laypmts lp"
                                + " left outer join Invoice i on lp.InvoiceNo = i.ID "
                                + " left outer join trans t on t.ID = lp.TransactionNo "
                                + " left outer join Layaway l on i.LayawayNo = l.ID "
                                + " where i.LayawayNo > 0 " + strSQL1
                                + " order by t.Transdate ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;


            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Payment", System.Type.GetType("System.String"));

                string strPType = "";
                while (objSQLReader.Read())
                {
                    strPType = "";
                    string strDateTime = "";
                    if (objSQLReader["Transdate"].ToString() != "")
                    {
                        strDateTime = objSQLReader["Transdate"].ToString();
                        int inIndex = strDateTime.IndexOf(" ");
                        if (inIndex > 0)
                        {
                            strDateTime = strDateTime.Substring(0, inIndex).Trim();
                        }
                    }
                    else
                    {
                        strDateTime = objSQLReader["Transdate"].ToString();
                    }

                    if (objSQLReader["TransType"].ToString() == "2") strPType = "Layaway Deposit";
                    if (objSQLReader["TransType"].ToString() == "4") strPType = "Layaway Payment";
                    if (objSQLReader["TransType"].ToString() == "3") strPType = "Layaway Refund";

                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["InvoiceNo"].ToString(),
												objSQLReader["TransactionNo"].ToString(),
                                                strDateTime,
												strPType,
                                                objSQLReader["Payment"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchLayawayInvoiceHeader(DataTable refdtbl, int intTran, bool blReprint, string thisstore)
        {
            DataTable dtbl = new DataTable();
            
            string strSQL1 = "";
            string strSQL2 = "";
            string getdtblID = "";

            foreach (DataRow dr in refdtbl.Rows)
            {
                if (getdtblID == "")
                {
                    getdtblID = dr["LayawayNo"].ToString();
                }
                else
                {
                    getdtblID = getdtblID + "," + dr["LayawayNo"].ToString();
                }
            }
            if (getdtblID != "")
            {
                strSQL1 = " and i.LayawayNo in ( " + getdtblID + " )";
            }

            if (!blReprint) strSQL2 = " and a.ID = @TRNO ";

            string strSQLComm = " select a.ID, a.StoreID, a.RegisterID, a.TransDate, a.TerminalName, isnull(c.ID,0) as CID, "
                                + " isnull(c.CustomerID,'') as CustID, isnull(c.Company,'') as CustCom, isnull(c.LastName,'') as CustLast,  "
                                + " isnull(c.FirstName,'') as CustFirst, isnull(c.IssueStore,'') as CustStore,isnull(e.EmployeeID,0) as EmpID, "
                                + " i.Tax, i.Tax1, i.Tax2, i.Tax3, isnull(tx1.TaxName,'') as TaxNM1, "
                                + " isnull(tx2.TaxName,'') as TaxNM2,isnull(tx3.TaxName,'') as TaxNM3, "
                                + " i.ID as InvoiceNo, i.Discount, i.TotalSale, i.DiscountReason,i.ReceiptCnt,i.Status as LayawayStatus,"
                                + " i.LayawayNo, l.DateDue,i.Fees,i.FeesTax,i.DTax,i.FeesCoupon,i.FeesCouponTax  "
                                + " from Invoice i left outer join Trans a on a.ID = i.TransactionNo "
                                + " left outer join Customer c on a.CustomerID = c.ID "
                                + " left outer join Employee e on a.EmployeeID = e.ID "
                                + " Left outer join TaxHeader tx1 on i.TaxID1=tx1.ID "
                                + " Left outer join TaxHeader tx2 on i.TaxID2=tx2.ID "
                                + " Left outer join TaxHeader tx3 on i.TaxID3=tx3.ID "
                                + " Left outer join Layaway l on i.LayawayNo=l.ID where (1 = 1) " + strSQL1
                                + strSQL2
                                + " order by i.LayawayNo, i.ID, i.Status ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (!blReprint)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@TRNO", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@TRNO"].Value = intTran;
            }

            SqlDataReader objSQLReader = null;

            string pName = "";
            string pCID = "";
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TranNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StoreID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RegisterID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Terminal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustCompany", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustStore", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmpID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalSale", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountReason", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReceiptCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LayawayNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LayawayStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateDue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));

                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));

                dtbl.Columns.Add("DTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesCoupon", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesCouponTax", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustID"].ToString() != "")
                    {
                        pCID = objSQLReader["CustID"].ToString();
                        if ((thisstore != "") && (objSQLReader["CustStore"].ToString() != "") && (thisstore != objSQLReader["CustStore"].ToString()))
                            pCID = objSQLReader["CustStore"].ToString() + " - " + objSQLReader["CustID"].ToString();
                        pName = objSQLReader["CustLast"].ToString() + ", " + objSQLReader["CustFirst"].ToString();
                    }

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["StoreID"].ToString(),
                                                objSQLReader["RegisterID"].ToString(),
												objSQLReader["TransDate"].ToString(),
                                                objSQLReader["TerminalName"].ToString(),
                                                objSQLReader["CID"].ToString(),
                                                pCID,
                                                pName,
                                                objSQLReader["CustCom"].ToString(),
                                                objSQLReader["CustStore"].ToString(),
                                                objSQLReader["EmpID"].ToString(),
                                                objSQLReader["Tax"].ToString(),
                                                objSQLReader["Tax1"].ToString(),
                                                objSQLReader["Tax2"].ToString(),
                                                objSQLReader["Tax3"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["TotalSale"].ToString(),
                                                objSQLReader["DiscountReason"].ToString(),
                                                objSQLReader["TaxNM1"].ToString(),
                                                objSQLReader["TaxNM2"].ToString(),
                                                objSQLReader["TaxNM3"].ToString(),
                                                objSQLReader["ReceiptCnt"].ToString(),
                                                objSQLReader["LayawayNo"].ToString(),
                                                objSQLReader["LayawayStatus"].ToString(),
                                                objSQLReader["DateDue"].ToString(),
                                                objSQLReader["InvoiceNo"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["DTax"].ToString(),
                                                objSQLReader["FeesCoupon"].ToString(),
                                                objSQLReader["FeesCouponTax"].ToString()
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }
        
        public DataTable FetchLayawayInvoicePayment(int intLayID, int intInvNo)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm =   " select lp.Payment, t.TransType, t.Transdate from laypmts lp"
                                + " left outer join Invoice i on lp.InvoiceNo = i.ID "
                                + " left outer join trans t on t.ID = lp.TransactionNo "
                                + " left outer join Layaway l on i.LayawayNo = l.ID "
                                + " where i.LayawayNo > 0 and i.LayawayNo = @LNO and i.ID = @ID "  
                                + " order by t.Transdate ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvNo;
            objSQlComm.Parameters.Add(new SqlParameter("@LNO", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@LNO"].Value = intLayID;
            SqlDataReader objSQLReader = null;


            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("PaymentDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentAmt", System.Type.GetType("System.String"));

                string strPType = "";
                while (objSQLReader.Read())
                {
                    strPType = "";
                    string strDateTime = "";
                    if (objSQLReader["Transdate"].ToString() != "")
                    {
                        strDateTime = objSQLReader["Transdate"].ToString();
                        int inIndex = strDateTime.IndexOf(" ");
                        if (inIndex > 0)
                        {
                            strDateTime = strDateTime.Substring(0, inIndex).Trim();
                        }
                    }
                    else
                    {
                        strDateTime = objSQLReader["Transdate"].ToString();
                    }

                    if (objSQLReader["TransType"].ToString() == "2") strPType = "Deposit";
                    if (objSQLReader["TransType"].ToString() == "4") strPType = "Payment";
                    if (objSQLReader["TransType"].ToString() == "3") strPType = "Refund";

                    dtbl.Rows.Add(new object[] {strDateTime,
												strPType,
                                                objSQLReader["Payment"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int FetchLayawayMaxTranNo(int intLayID)
        {
            int intMaxID = 0;
            string strSQLComm = " select max(t.ID) as MaxTranNo "
                                + " from laypmts lp "
                                + " left outer join Invoice i on lp.InvoiceNo = i.ID "
                                + " left outer join trans t on t.ID = lp.TransactionNo "
                                + " left outer join Layaway l on i.LayawayNo = l.ID "
                                + " where i.LayawayNo > 0 and i.LayawayNo = @LNO ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            
            objSQlComm.Parameters.Add(new SqlParameter("@LNO", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@LNO"].Value = intLayID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                
                while (objSQLReader.Read())
                {
                    intMaxID = Functions.fnInt32(objSQLReader["MaxTranNo"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intMaxID;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #endregion

        #region Fetch Invoice Record Details

        public DataTable FetchRepairInvoiceDetails(int intInvID, string TaxIncludeFlag)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm =   " select a.ID,a.ProductID, a.ProductType, a.Description,a.SKU,a.Price,a.Qty,isnull(a.Notes,'') as Notes,"
                                + " isnull(im.MatrixOptionID,'') as MOID,isnull(im.OptionValue1,'') as OV1, isnull(im.OptionValue2,'') as OV2, "
                                + " isnull(im.OptionValue3,'') as OV3, isnull(m.Option1Name,'') as ON1, "
                                + " isnull(m.Option2Name,'') as ON2, isnull(m.Option3Name,'') as ON3, "
                                + " isnull(p.DecimalPlace,'2') as DP, a.NormalPrice, a.UOMPrice,a.UOMCount,a.UOMDesc,p.TaggedInInvoice, "
                                + " a.Discount,a.DiscountText,a.DiscountID,a.ServiceType,a.DiscLogic,a.DiscValue,a.ItemIndex,"
                                + " a.TaxID1,a.TaxID2,a.TaxID3,a.Taxable1,a.Taxable2,a.Taxable3,a.TaxRate1,a.TaxRate2,a.TaxRate3, "
                                + " a.RentApplicable,a.RentEffectiveFrom,a.RentDuration,a.RentReturnFlag, "
                                + " a.RepairItemTag,a.RepairItemSLNO,a.RepairItemPurchaseDate,a.RepairItemDeliveryDate, "
                                + " a.TaxType1,a.TaxType2,a.TaxType3,a.TaxTotal1,a.TaxTotal2,a.TaxTotal3, "
                                + " a.FeesID,a.FeesLogic,a.FeesValue,a.FeesTaxRate,a.Fees,a.FeesTax,a.FeesText,a.FeesQty,a.EditFlag,a.PromptPrice,a.TaxIncludeRate, a.TaxIncludePrice "
                                + " from Item a left outer join ItemMatrixOptions im on a.ID = im.ItemID "
                                + " left outer join product p on a.ProductID = p.ID "
                                + " left outer join MatrixOptions m on im.MatrixOptionID = m.ID "
                                + " where a.InvoiceNo = @ID and a.Tagged <> 'X' and a.ProductType not in ('C','Z','H') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOV1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOV2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOV3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DP", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NormalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Notes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaggedInInvoice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemIndex", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("ServiceType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentEffectFrom", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDuration", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentReturnFlag", System.Type.GetType("System.String"));

                dtbl.Columns.Add("RepairItemTag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSLNO", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemPurchaseDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemDeliveryDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));

                dtbl.Columns.Add("EditFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptPrice", System.Type.GetType("System.String"));

                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));

                string sM1 = "";
                string sM2 = "";
                string sM3 = "";
                double renttime = 0;
                while (objSQLReader.Read())
                {
                    if (objSQLReader["ProductType"].ToString() == "M")
                    {
                        if ((objSQLReader["ON1"].ToString() != "") || (objSQLReader["OV1"].ToString() != ""))
                            sM1 = objSQLReader["ON1"].ToString() + ": " + objSQLReader["OV1"].ToString();
                        if ((objSQLReader["ON2"].ToString() != "") || (objSQLReader["OV2"].ToString() != ""))
                            sM2 = objSQLReader["ON2"].ToString() + ": " + objSQLReader["OV2"].ToString();
                        if ((objSQLReader["ON3"].ToString() != "") || (objSQLReader["OV3"].ToString() != ""))
                            sM3 = objSQLReader["ON3"].ToString() + ": " + objSQLReader["OV3"].ToString();
                    }
                    if (objSQLReader["ServiceType"].ToString() == "Rent")
                        renttime = Functions.fnDouble(objSQLReader["RentDuration"].ToString());
                    else
                        renttime = 1;

                    TP = 0;
                    TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["Price"].ToString()) * renttime - (TaxIncludeFlag == "N" ? Functions.fnDouble(objSQLReader["Discount"].ToString()) : 0);

                    dtbl.Rows.Add(new object[] {    objSQLReader["ID"].ToString(),
                                                    objSQLReader["ProductID"].ToString(),
												    objSQLReader["ProductType"].ToString(),
                                                    objSQLReader["Description"].ToString(),
												    objSQLReader["SKU"].ToString(),
                                                    objSQLReader["Price"].ToString(),
                                                    objSQLReader["Qty"].ToString(),
                                                    TP.ToString(),
                                                    objSQLReader["MOID"].ToString(),
                                                    objSQLReader["OV1"].ToString(),
                                                    objSQLReader["OV2"].ToString(),
                                                    objSQLReader["OV3"].ToString(),
                                                    sM1,sM2,sM3,objSQLReader["DP"].ToString(),
                                                    objSQLReader["NormalPrice"].ToString(),
                                                    objSQLReader["UOMPrice"].ToString(),
                                                    objSQLReader["UOMCount"].ToString(),
                                                    objSQLReader["UOMDesc"].ToString(),
                                                    objSQLReader["Notes"].ToString(),
                                                    objSQLReader["TaggedInInvoice"].ToString(),
                                                    objSQLReader["Discount"].ToString(),
                                                    objSQLReader["DiscountText"].ToString(),
                                                    objSQLReader["DiscountID"].ToString(),
                                                    objSQLReader["DiscLogic"].ToString(),
                                                    objSQLReader["DiscValue"].ToString(),
                                                    objSQLReader["ItemIndex"].ToString(),

                                                    objSQLReader["TaxID1"].ToString(),
                                                    objSQLReader["TaxID2"].ToString(),
                                                    objSQLReader["TaxID3"].ToString(),

                                                    objSQLReader["Taxable1"].ToString(),
                                                    objSQLReader["Taxable2"].ToString(),
                                                    objSQLReader["Taxable3"].ToString(),

                                                    objSQLReader["TaxRate1"].ToString(),
                                                    objSQLReader["TaxRate2"].ToString(),
                                                    objSQLReader["TaxRate3"].ToString(),

                                                    objSQLReader["ServiceType"].ToString(),
                                                    objSQLReader["RentApplicable"].ToString(),
                                                    objSQLReader["RentEffectiveFrom"].ToString(),
                                                    objSQLReader["RentDuration"].ToString(),
                                                    objSQLReader["RentReturnFlag"].ToString(),
                                                    objSQLReader["RepairItemTag"].ToString(),
                                                    objSQLReader["RepairItemSLNO"].ToString(),
                                                    objSQLReader["RepairItemPurchaseDate"].ToString(),
                                                    objSQLReader["RepairItemDeliveryDate"].ToString(),
                                                    objSQLReader["TaxType1"].ToString(),
                                                    objSQLReader["TaxType2"].ToString(),
                                                    objSQLReader["TaxType3"].ToString(),
                                                    objSQLReader["TaxTotal1"].ToString(),
                                                    objSQLReader["TaxTotal2"].ToString(),
                                                    objSQLReader["TaxTotal3"].ToString(),
                                                    objSQLReader["FeesID"].ToString(),
                                                    objSQLReader["FeesLogic"].ToString(),
                                                    objSQLReader["FeesValue"].ToString(),
                                                    objSQLReader["FeesTaxRate"].ToString(),
                                                    objSQLReader["Fees"].ToString(),
                                                    objSQLReader["FeesTax"].ToString(),
                                                    objSQLReader["FeesText"].ToString(),
                                                    objSQLReader["FeesQty"].ToString(),
                                                    objSQLReader["EditFlag"].ToString(),
                                                    objSQLReader["PromptPrice"].ToString(),
                                                    objSQLReader["TaxIncludeRate"].ToString(),
                                                    objSQLReader["TaxIncludePrice"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchGiftAidDetails(int intInvID, string TaxIncludeFlag, bool IncludeReturnItem)
        {
            DataTable dtbl = new DataTable();

            string sqlfilter = "";
            if (!IncludeReturnItem)
            {
                sqlfilter = " and a.ReturnedItemID = 0 ";
            }

            string strSQLComm = " select a.ID,a.ProductID, a.ProductType, a.Description,a.SKU,a.Price,a.Qty,isnull(a.Notes,'') as Notes,"
                                + " isnull(im.OptionValue1,'') as OV1, isnull(im.OptionValue2,'') as OV2, "
                                + " isnull(im.OptionValue3,'') as OV3, isnull(m.Option1Name,'') as ON1, "
                                + " isnull(m.Option2Name,'') as ON2, isnull(m.Option3Name,'') as ON3, "
                                + " isnull(p.DecimalPlace,'2') as DP, a.NormalPrice, a.UOMPrice,a.UOMCount,a.UOMDesc,p.TaggedInInvoice, "
                                + " a.Discount,a.DiscountText,a.DiscountID,a.ServiceType,a.DiscLogic,a.DiscValue,a.ItemIndex,"
                                + " a.RentApplicable,a.RentEffectiveFrom,a.RentDuration,a.RentReturnFlag, "
                                + " a.RepairItemTag,a.RepairItemSLNO,a.RepairItemPurchaseDate,a.RepairItemDeliveryDate, "
                                + " a.Taxable1, a.Taxable2, a.Taxable3, a.TaxRate1, a.TaxRate2, a.TaxRate3,a.TaxType1,a.TaxType2,a.TaxType3, "
                                + " a.TaxTotal1,a.TaxTotal2,a.TaxTotal3,a.FeesValue,a.FeesID,a.FeesText,a.Fees,a.FeesTax,a.FeesQty,a.SalePriceID,"
                                + " a.EditFlag,a.DTaxID,a.DTax, a.QtyDecimal,a.PromptPrice,a.BuyNGetFreeHeaderID,a.BuyNGetFreeCategory,a.BuyNGetFreeName,"
                                + " a.TaxIncludeRate, a.TaxIncludePrice, a.UOM from Item a left outer join ItemMatrixOptions im on a.ID = im.ItemID "
                                + " left outer join product p on a.ProductID = p.ID "
                                + " left outer join MatrixOptions m on im.MatrixOptionID = m.ID "
                                + " where a.InvoiceNo = @ID " + sqlfilter + " and a.Tagged <> 'X' and a.ProductType not in ('C','Z','H') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Notes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DP", System.Type.GetType("System.String"));
                double renttime = 0;
                while (objSQLReader.Read())
                {
                    
                    renttime = 1;

                    TP = 0;
                    TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(TaxIncludeFlag == "N" ? objSQLReader["Price"].ToString() : objSQLReader["TaxIncludeRate"].ToString()) * renttime - (TaxIncludeFlag == "N" ? Functions.fnDouble(objSQLReader["Discount"].ToString()) : 0);

                    dtbl.Rows.Add(new object[] {   
                                                    objSQLReader["Description"].ToString(),
                                                    TP.ToString(),
                                                    objSQLReader["Notes"].ToString(),
                                                    objSQLReader["DiscountText"].ToString(),
                                                    objSQLReader["DP"].ToString()
                                                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchInvoiceDetails(int intInvID, string TaxIncludeFlag, bool IncludeReturnItem)
        {
            DataTable dtbl = new DataTable();

            string sqlfilter = "";
            if (!IncludeReturnItem)
            {
                sqlfilter = " and a.ReturnedItemID = 0 ";
            }

            string strSQLComm =   " select a.ID,a.ProductID, a.ProductType, a.Description,a.SKU,a.Price,a.Qty,isnull(a.Notes,'') as Notes,"
                                + " isnull(im.OptionValue1,'') as OV1, isnull(im.OptionValue2,'') as OV2, "
                                + " isnull(im.OptionValue3,'') as OV3, isnull(m.Option1Name,'') as ON1, "
                                + " isnull(m.Option2Name,'') as ON2, isnull(m.Option3Name,'') as ON3, "
                                + " isnull(p.DecimalPlace,'2') as DP, a.NormalPrice, a.UOMPrice,a.UOMCount,a.UOMDesc,p.TaggedInInvoice, "
                                + " a.Discount,a.DiscountText,a.DiscountID,a.ServiceType,a.DiscLogic,a.DiscValue,a.ItemIndex,"
                                + " a.RentApplicable,a.RentEffectiveFrom,a.RentDuration,a.RentReturnFlag, "
                                + " a.RepairItemTag,a.RepairItemSLNO,a.RepairItemPurchaseDate,a.RepairItemDeliveryDate, "
                                + " a.Taxable1, a.Taxable2, a.Taxable3, a.TaxRate1, a.TaxRate2, a.TaxRate3,a.TaxType1,a.TaxType2,a.TaxType3, "
                                + " a.TaxTotal1,a.TaxTotal2,a.TaxTotal3,a.FeesValue,a.FeesID,a.FeesText,a.Fees,a.FeesTax,a.FeesQty,a.SalePriceID,"
                                + " a.EditFlag,a.DTaxID,a.DTax, a.QtyDecimal,a.PromptPrice,a.BuyNGetFreeHeaderID,a.BuyNGetFreeCategory,a.BuyNGetFreeName,"
                                + " a.TaxIncludeRate, a.TaxIncludePrice, a.UOM from Item a left outer join ItemMatrixOptions im on a.ID = im.ItemID "
                                + " left outer join product p on a.ProductID = p.ID "
                                + " left outer join MatrixOptions m on im.MatrixOptionID = m.ID "
                                + " where a.InvoiceNo = @ID " + sqlfilter + " and a.Tagged <> 'X' and a.ProductType not in ('C','Z','H') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DP", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NormalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Notes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaggedInInvoice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemIndex", System.Type.GetType("System.String"));

                dtbl.Columns.Add("ServiceType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentEffectFrom", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDuration", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentReturnFlag", System.Type.GetType("System.String"));

                dtbl.Columns.Add("RepairItemTag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSLNO", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemPurchaseDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemDeliveryDate", System.Type.GetType("System.String"));

                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));

                dtbl.Columns.Add("SalePriceID", System.Type.GetType("System.String"));

                dtbl.Columns.Add("DTaxID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyDecimal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptPrice", System.Type.GetType("System.String"));

                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));

                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOM", System.Type.GetType("System.String"));

                string sM1 = "";
                string sM2 = "";
                string sM3 = "";
                double renttime = 0;
                while (objSQLReader.Read())
                {
                    if (objSQLReader["ProductType"].ToString() == "M")
                    {
                        if ((objSQLReader["ON1"].ToString() != "") || (objSQLReader["OV1"].ToString() != ""))
                            sM1 = objSQLReader["ON1"].ToString() + ": " + objSQLReader["OV1"].ToString();
                        if ((objSQLReader["ON2"].ToString() != "") || (objSQLReader["OV2"].ToString() != ""))
                            sM2 = objSQLReader["ON2"].ToString() + ": " + objSQLReader["OV2"].ToString();
                        if ((objSQLReader["ON3"].ToString() != "") || (objSQLReader["OV3"].ToString() != ""))
                            sM3 = objSQLReader["ON3"].ToString() + ": " + objSQLReader["OV3"].ToString();
                    }
                    if (objSQLReader["ServiceType"].ToString() == "Rent") 
                        renttime = Functions.fnDouble(objSQLReader["RentDuration"].ToString());
                    else 
                        renttime = 1;

                    TP = 0;
                    TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(TaxIncludeFlag == "N" ? objSQLReader["Price"].ToString() : objSQLReader["TaxIncludeRate"].ToString()) * renttime - (TaxIncludeFlag == "N" ? Functions.fnDouble(objSQLReader["Discount"].ToString()) : 0);

                    dtbl.Rows.Add(new object[] {    objSQLReader["ID"].ToString(),
                                                    objSQLReader["ProductID"].ToString(),
												    objSQLReader["ProductType"].ToString(),
                                                    objSQLReader["Description"].ToString(),
												    objSQLReader["SKU"].ToString(),
                                                    TaxIncludeFlag == "N" ? objSQLReader["Price"].ToString() : objSQLReader["TaxIncludeRate"].ToString(),
                                                    objSQLReader["Qty"].ToString(),
                                                    TP.ToString(),sM1,sM2,sM3,objSQLReader["DP"].ToString(),
                                                    objSQLReader["NormalPrice"].ToString(),
                                                    objSQLReader["UOMPrice"].ToString(),
                                                    objSQLReader["UOMCount"].ToString(),
                                                    objSQLReader["UOMDesc"].ToString(),
                                                    objSQLReader["Notes"].ToString(),
                                                    objSQLReader["TaggedInInvoice"].ToString(),
                                                    objSQLReader["Discount"].ToString(),
                                                    objSQLReader["DiscountText"].ToString(),
                                                    objSQLReader["DiscountID"].ToString(),
                                                    objSQLReader["DiscLogic"].ToString(),
                                                    objSQLReader["DiscValue"].ToString(),
                                                    objSQLReader["ItemIndex"].ToString(),
                                                    objSQLReader["ServiceType"].ToString(),
                                                    objSQLReader["RentApplicable"].ToString(),
                                                    objSQLReader["RentEffectiveFrom"].ToString(),
                                                    objSQLReader["RentDuration"].ToString(),
                                                    objSQLReader["RentReturnFlag"].ToString(),
                                                    objSQLReader["RepairItemTag"].ToString(),
                                                    objSQLReader["RepairItemSLNO"].ToString(),
                                                    objSQLReader["RepairItemPurchaseDate"].ToString(),
                                                    objSQLReader["RepairItemDeliveryDate"].ToString(),
                                                    objSQLReader["Taxable1"].ToString(),
                                                    objSQLReader["Taxable2"].ToString(),
                                                    objSQLReader["Taxable3"].ToString(),
                                                    objSQLReader["TaxRate1"].ToString(),
                                                    objSQLReader["TaxRate2"].ToString(),
                                                    objSQLReader["TaxRate3"].ToString(),
                                                    objSQLReader["TaxType1"].ToString(),
                                                    objSQLReader["TaxType2"].ToString(),
                                                    objSQLReader["TaxType3"].ToString(),
                                                    objSQLReader["TaxTotal1"].ToString(),
                                                    objSQLReader["TaxTotal2"].ToString(),
                                                    objSQLReader["TaxTotal3"].ToString(),
                                                    objSQLReader["FeesID"].ToString(),
                                                    objSQLReader["FeesText"].ToString(),
                                                    objSQLReader["Fees"].ToString(),
                                                    objSQLReader["FeesTax"].ToString(),
                                                    objSQLReader["FeesValue"].ToString(),
                                                    objSQLReader["FeesQty"].ToString(),
                                                    objSQLReader["SalePriceID"].ToString(),
                                                    objSQLReader["DTaxID"].ToString(),
                                                    objSQLReader["DTax"].ToString(),
                                                    objSQLReader["EditFlag"].ToString(),
                                                    objSQLReader["QtyDecimal"].ToString(),
                                                    objSQLReader["PromptPrice"].ToString(),

                                                    objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                    objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                    objSQLReader["BuyNGetFreeName"].ToString(),
                                                    objSQLReader["TaxIncludeRate"].ToString(),
                                                    objSQLReader["TaxIncludePrice"].ToString(),
                                                    objSQLReader["UOM"].ToString()
                                                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchInvoiceDetails1(int intInvID, bool IncludeReturnItem, string TaxFlag = "")
        {
            DataTable dtbl = new DataTable();
            string sqlfilter = "";
            if (!IncludeReturnItem)
            {
                sqlfilter = " and a.ReturnedItemID = 0 ";
            }
            string strSQLComm =   " select a.ID,a.ProductID, a.ProductType, a.Description,a.SKU,a.Price,a.Qty,isnull(a.Notes,'') as Notes, "
                                + " isnull(im.OptionValue1,'') as OV1, isnull(im.OptionValue2,'') as OV2, "
                                + " isnull(im.OptionValue3,'') as OV3, isnull(m.Option1Name,'') as ON1, "
                                + " isnull(m.Option2Name,'') as ON2, isnull(m.Option3Name,'') as ON3, "
                                + " isnull(p.DecimalPlace,'2') as DP,a.NormalPrice,a.UOMPrice,p.TaggedInInvoice,"
                                + " a.Discount,a.DiscountText,a.DiscountID,a.ServiceType, "
                                + " a.RentApplicable,a.RentEffectiveFrom,a.RentDuration,a.RentReturnFlag, "
                                + " a.RepairItemSLNO,a.RepairItemTag,a.RepairItemPurchaseDate,a.FeesID,a.FeesText,a.FeesQty,a.SalePriceID,"
                                + " a.QtyDecimal,a.BuyNGetFreeHeaderID,a.BuyNGetFreeCategory,a.BuyNGetFreeName,a.TaxIncludeRate,a.TaxIncludePrice,a.UOM "
                                + " from Item a left outer join ItemMatrixOptions im on a.ID = im.ItemID "
                                + " left outer join product p on a.ProductID = p.ID "
                                + " left outer join MatrixOptions m on im.MatrixOptionID = m.ID "
                                + " where a.InvoiceNo = @ID " + sqlfilter + " and a.Tagged <> 'X' and a.producttype not in ('C','Z','H') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DP", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NormalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Notes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Disc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaggedInInvoice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));

                dtbl.Columns.Add("ServiceType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentEffectFrom", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDuration", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentReturnFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountInfo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));

                dtbl.Columns.Add("SalePriceID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyDecimal", System.Type.GetType("System.String"));

                dtbl.Columns.Add("ExtraValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOM", System.Type.GetType("System.String"));

                string sM1 = "";
                string sM2 = "";
                string sM3 = "";
                double dbldisc1 = 0;
                double dbldisc = 0;
                double dblpr = 0;
                double dblnpr = 0;
                string strproduct = "";
                double renttime = 0;
                string discinfo = "";
                while (objSQLReader.Read())
                {
                    discinfo = "";
                    dbldisc1 = 0;
                    dbldisc = 0;
                    dblpr = 0;
                    dblnpr = 0;
                    strproduct = "";

                    strproduct = objSQLReader["Description"].ToString();

                    if (objSQLReader["ProductType"].ToString() == "M")
                    {
                        if ((objSQLReader["ON1"].ToString() != "") || (objSQLReader["OV1"].ToString() != ""))
                            sM1 = objSQLReader["ON1"].ToString() + ": " + objSQLReader["OV1"].ToString();
                        if ((objSQLReader["ON2"].ToString() != "") || (objSQLReader["OV2"].ToString() != ""))
                            sM2 = objSQLReader["ON2"].ToString() + ": " + objSQLReader["OV2"].ToString();
                        if ((objSQLReader["ON3"].ToString() != "") || (objSQLReader["OV3"].ToString() != ""))
                            sM3 = objSQLReader["ON3"].ToString() + ": " + objSQLReader["OV3"].ToString();

                        if (sM1 != "") strproduct = strproduct + "   " + sM1;
                        if (sM2 != "") strproduct = strproduct + " " + sM2;
                        if (sM3 != "") strproduct = strproduct + " " + sM3;
                    }
                    if ((objSQLReader["ProductType"].ToString() == "G") || (objSQLReader["ProductType"].ToString() == "B")
                        || (objSQLReader["ProductType"].ToString() == "A") || (objSQLReader["ProductType"].ToString() == "C")
                        || (objSQLReader["ProductType"].ToString() == "X") || (objSQLReader["ProductType"].ToString() == "O")
                        || (objSQLReader["ProductType"].ToString() == "Z")
                        || (objSQLReader["ProductType"].ToString() == "H"))
                    {
                        dblnpr = Functions.fnDouble(objSQLReader["Price"].ToString());
                        dbldisc = 0;
                    }
                    else
                    {
                        if (objSQLReader["ProductType"].ToString() == "U")
                        {
                            if (TaxFlag == "N")
                            {
                                dblnpr = Functions.fnDouble(objSQLReader["UOMPrice"].ToString());
                                dbldisc = Functions.fnDouble(objSQLReader["UOMPrice"].ToString()) - Functions.fnDouble(objSQLReader["Price"].ToString());
                            }
                            else
                            {
                                dblnpr = Functions.fnDouble(objSQLReader["UOMPrice"].ToString());
                                dbldisc = Functions.fnDouble(objSQLReader["UOMPrice"].ToString()) - Functions.fnDouble(objSQLReader["TaxIncludePrice"].ToString());
                            }
                        }
                        else
                        {
                            dblnpr = Functions.fnDouble(objSQLReader["NormalPrice"].ToString());
                            dbldisc = Functions.fnDouble(objSQLReader["NormalPrice"].ToString()) - Functions.fnDouble(objSQLReader["TaxIncludePrice"].ToString());
                        }
                    }

                    if (objSQLReader["ServiceType"].ToString() == "Rent")
                        renttime = Functions.fnDouble(objSQLReader["RentDuration"].ToString());
                    else
                        renttime = 1;

                    TP = 0;

                    if (objSQLReader["ProductType"].ToString() != "O")
                    {
                        if (TaxFlag == "N")
                        {
                            TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["Price"].ToString()) * renttime - Functions.fnDouble(objSQLReader["Discount"].ToString());
                        }
                        else
                        {
                            TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["TaxIncludeRate"].ToString()) * renttime;
                        }
                    }
                    else
                    {
                        if (TaxFlag == "N")
                        {
                            TP = -(Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["Price"].ToString()));
                        }
                        else
                        {
                            TP = -(Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["TaxIncludeRate"].ToString()));
                        }
                    }

                    int rnt = 0;
                    string srnt = "";
                    if (int.TryParse(Functions.fnDouble(objSQLReader["RentDuration"].ToString()).ToString(), out rnt))
                        srnt = rnt.ToString();
                    else srnt = Functions.fnDouble(objSQLReader["RentDuration"].ToString()).ToString();

                    if (objSQLReader["ServiceType"].ToString() == "Rent")
                    {
                        if (objSQLReader["RentApplicable"].ToString() == "MI")
                        {
                            if (rnt != 0) strproduct = strproduct + "  - " + srnt + " min.";
                            else strproduct = strproduct + "  -  minute basis";
                        }
                        else if (objSQLReader["RentApplicable"].ToString() == "HR")
                        {
                            if (rnt != 0) strproduct = strproduct + "  - " + srnt + " hr.";
                            else strproduct = strproduct + "  -  hourly";
                        }
                        else if (objSQLReader["RentApplicable"].ToString() == "HD")
                        {
                            if (rnt != 0)
                            {
                                if (Functions.fnDouble(objSQLReader["RentDuration"].ToString()) == 1)
                                    strproduct = strproduct + "  - " + srnt + " half day";
                                else
                                    strproduct = strproduct + "  - " + srnt + " half days";
                            }
                            else strproduct = strproduct + "  -  half day";
                        }
                        else if (objSQLReader["RentApplicable"].ToString() == "DY")
                        {
                            if (rnt != 0)
                            {
                                if (Functions.fnDouble(objSQLReader["RentDuration"].ToString()) == 1)
                                    strproduct = strproduct + "  - " + srnt + " day";
                                else
                                    strproduct = strproduct + "  - " + srnt + " days";
                            }
                            else strproduct = strproduct + "  -  daily";
                        }
                        else if (objSQLReader["RentApplicable"].ToString() == "WK")
                        {
                            if (rnt != 0)
                            {
                                if (Functions.fnDouble(objSQLReader["RentDuration"].ToString()) == 1)
                                    strproduct = strproduct + "  - " + srnt + " week";
                                else
                                    strproduct = strproduct + "  - " + srnt + " weeks";
                            }
                            else strproduct = strproduct + "  -  weekly";
                        }
                        else
                        {
                            if (rnt != 0)
                            {
                                if (Functions.fnDouble(objSQLReader["RentDuration"].ToString()) == 1)
                                    strproduct = strproduct + "  - " + srnt + " month";
                                else
                                    strproduct = strproduct + "  - " + srnt + " months";
                            }
                            else strproduct = strproduct + "  -  weekly";
                        }
                    }


                    if (objSQLReader["ServiceType"].ToString() == "Repair")
                    {
                        if (objSQLReader["RepairItemSLNO"].ToString() != "")
                            strproduct = strproduct + "\n" + "    sl. # " + objSQLReader["RepairItemSLNO"].ToString();
                        if (objSQLReader["RepairItemPurchaseDate"].ToString() != "")
                            strproduct = strproduct + "\n" + "    purchase " + Functions.fnDate(objSQLReader["RepairItemPurchaseDate"].ToString()).ToShortDateString();
                        if (objSQLReader["RepairItemTag"].ToString() != "")
                            strproduct = strproduct + "\n" + "    tag # " + objSQLReader["RepairItemTag"].ToString();

                    }

                    dbldisc1 = Functions.fnDouble(objSQLReader["Discount"].ToString());
                    if (dbldisc1 > 0)
                    {
                        discinfo = objSQLReader["DiscountText"].ToString();
                    }
                    else
                    {
                        if (dbldisc > 0)
                        {
                            discinfo = "Normal Price " + dblnpr.ToString("f") + "    Discount " + dbldisc.ToString("f");
                        }
                    }

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["ProductType"].ToString(),
                                                strproduct,
												objSQLReader["SKU"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                TP.ToString(),
                                                sM1,sM2,sM3,
                                                objSQLReader["DP"].ToString(),
                                                dblnpr.ToString(),
                                                objSQLReader["UOMPrice"].ToString(),
                                                objSQLReader["Notes"].ToString(),dbldisc.ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["TaggedInInvoice"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["ServiceType"].ToString(),
                                                objSQLReader["RentApplicable"].ToString(),
                                                objSQLReader["RentEffectiveFrom"].ToString(),
                                                objSQLReader["RentDuration"].ToString(),
                                                objSQLReader["RentReturnFlag"].ToString(),
                                                discinfo,
                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),
                                                objSQLReader["SalePriceID"].ToString(),
                                                objSQLReader["QtyDecimal"].ToString(),
                                                "",
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString(),
                                                objSQLReader["TaxIncludeRate"].ToString(),
                                                objSQLReader["TaxIncludePrice"].ToString(),
                                                objSQLReader["UOM"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchGCReceiptData(int intInvID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select SKU,Description,Qty,isnull(Notes,'') as Notes from Item where ID = @ID";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Notes", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {    objSQLReader["SKU"].ToString(),
                                                    objSQLReader["Description"].ToString(),
                                                    objSQLReader["Qty"].ToString(),
                                                    objSQLReader["Notes"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchInvoiceInfoFromLayAwayNum(int layAwayNo)
        {
            DataTable dtbl = new DataTable();
            //            string strSQLComm = @" select  xe.TransactionId, i.ID,pay.Payment as TotalSale, i.TotalSale as InvTotalSale,i.LayawayNo 
            //                                    from Invoice AS i 
            //                                    inner join Laypmts pay 
            //                                    on pay.InvoiceNo = i.id
            //									Inner Join XeConnectTransactions xe on xe.InvoiceNumber =i.id
            //                                    where i.ServiceType = 'Sales'  and i.LayawayNo =  @LayawayNo  and TransType <> 'Refund' and TransType <> ''
            //                                    and  pay.Payment >0.0
            //";

            string strSQLComm = @" 
select  xe.TransactionId, i.ID,xe.Amount as TotalSale, i.TotalSale as InvTotalSale,i.LayawayNo 
                                    from Invoice AS i  
									Inner Join XeConnectTransactions xe on xe.InvoiceNumber =i.id   
                                    where i.ServiceType = 'Sales'  and i.LayawayNo =   @LayawayNo   and TransType <> 'Refund' and TransType <> ''
                                    and  xe.Amount > 0.0
";


            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@LayawayNo"].Value = layAwayNo;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalSale", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionId", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {    objSQLReader["ID"].ToString(),
                                                    objSQLReader["TotalSale"].ToString(),
                     objSQLReader["TransactionId"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }


        #endregion

        #region Fetch Invoice Tender Records

        public bool IsCardPayment(int intTranNo)
        {
            bool blresult = false;
            int cnt = 0;
            string strSQLComm = " select count(a.TenderType) as RecCount from Tender a left outer join TenderTypes b on a.TenderType = b.ID "
                              + " where TransactionNo = @ID and b.Name in ('Visa','MasterCard','American Express','Discover','Diner', "
                              + " 'Credit Card','Credit Card - Voice Auth','Credit Card (STAND-IN)', 'Credit Card - Voice Auth (STAND-IN)', "
                              + " 'Mercury Gift Card','Food Stamps','EBT Cash','Precidia Gift Card' , 'Datacap Gift Card', 'POSLink Gift Card') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt > 0)
                    return true;
                else
                    return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IsDatacapManualTendering(int intTranNo)
        {
            
            int cnt = 0;
            string strSQLComm = " select count(RefCardEntry) as RecCount from cardtrans "
                              + " where TransactionNo = @ID and RefCardEntry = 'Manual' and PaymentGateway = 5 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt > 0)
                    return true;
                else
                    return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IsHouseAccountPayment(int intTranNo)
        {
            bool blresult = false;
            int cnt = 0;
            string strSQLComm = " select count(a.TenderType) as RecCount from Tender a left outer join TenderTypes b on a.TenderType = b.ID "
                              + " where TransactionNo = @ID and b.Name = 'House Account' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt > 0)
                    return true;
                else
                    return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public DataTable FetchInvoiceTender(int intTranNo)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm =   " select a.TenderAmount, b.Name,b.DisplayAs from Tender a left outer join TenderTypes b on a.TenderType = b.ID "
                                + " where TransactionNo = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayAs", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    bool f = false;
                    foreach (DataRow dr in dtbl.Rows)
                    {
                        if ((objSQLReader["Name"].ToString() == dr["Name"].ToString()) && ((objSQLReader["Name"].ToString() == "Cash") || 
                            (objSQLReader["Name"].ToString() == "Cheque")))
                        {
                            f = true;
                            break;
                        }
                    }
                    if (!f)
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["Name"].ToString(),
												objSQLReader["TenderAmount"].ToString(),
                                                objSQLReader["DisplayAs"].ToString()});
                    }
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();





                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchInvoiceTenderForHouseAccount(int intTranNo)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select a.TenderAmount, b.Name,b.DisplayAs from Tender a left outer join TenderTypes b on a.TenderType = b.ID "
                                + " where TransactionNo = @ID and b.Name = 'House Account' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DisplayAs", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    bool f = false;
                    foreach (DataRow dr in dtbl.Rows)
                    {
                        if (objSQLReader["Name"].ToString() == dr["Name"].ToString())
                        {
                            f = true;
                            break;
                        }
                    }
                    if (!f)
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["Name"].ToString(),
												objSQLReader["TenderAmount"].ToString(),
                                                objSQLReader["DisplayAs"].ToString()});
                    }
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();





                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public bool IsFSTender(int intTranNo)
        {
            bool blresult = false;
            int cnt = 0;
            string strSQLComm = " select count(a.TenderType) as RecCount from Tender a left outer join TenderTypes b on a.TenderType = b.ID "
                              + " where TransactionNo = @ID and b.Name in ( 'Food Stamps','EBT Cash', 'EBT Voucher' ) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt > 0)
                    return true;
                else
                    return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        #endregion

        public DataTable FetchGeneralStockData(int PID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select ProductType,QtyOnHand,AllowZeroStock from product where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = PID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyOnHand", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AllowZeroStock", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {objSQLReader["ProductType"].ToString(),
                                                objSQLReader["QtyOnHand"].ToString(),
                                                objSQLReader["AllowZeroStock"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public double FetchMatrixAvailableStock(int MOID, string OV1, string OV2, string OV3)
        {
            double  dbQty = 0;

            string strSQLComm = " select QtyOnHand from Matrix where MatrixOptionID = @MatrixOptionID and OptionValue1=@OptionValue1 "
                              + " and OptionValue2=@OptionValue2 and OptionValue3=@OptionValue3 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@MatrixOptionID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@MatrixOptionID"].Value = MOID;

            objSQlComm.Parameters.Add(new SqlParameter("@OptionValue1", System.Data.SqlDbType.NVarChar));
            objSQlComm.Parameters["@OptionValue1"].Value = OV1;
            objSQlComm.Parameters.Add(new SqlParameter("@OptionValue2", System.Data.SqlDbType.NVarChar));
            objSQlComm.Parameters["@OptionValue2"].Value = OV2;
            objSQlComm.Parameters.Add(new SqlParameter("@OptionValue3", System.Data.SqlDbType.NVarChar));
            objSQlComm.Parameters["@OptionValue3"].Value = OV3;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {

                    dbQty = Functions.fnDouble(objSQLReader["QtyOnHand"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dbQty;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable FetchMatrixOptionData(int PID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select Option1Name,Option2Name,Option3Name from MatrixOptions where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = PID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ON1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ON2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ON3", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["Option1Name"].ToString(),
                                                objSQLReader["Option2Name"].ToString(),
                                                objSQLReader["Option3Name"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        private void AdjustItemGridRecordsForSuspend(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    string colID = "";
                    string colPRICEA = "";
                    string colPRICEB = "";
                    string colPRICEC = "";
                    string colPRICEOVERRIDE = "";
                    string colNEWPRICE = "";
                    string colDISCOUNTLEVEL = "";
                    string colGIFTCERTID = "";
                    string colONSALE = "";

                    string colCOST = "";
                    string colQTY = "";

                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";

                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";

                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";

                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";

                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    string colGRATE = "";
                    string colGPRICE = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["PRICEA"].ToString() != "")
                    {
                        colPRICEA = dr["PRICEA"].ToString();
                    }
                    else
                    {
                        colPRICEA = "0.00";
                    }

                    if (dr["PRICEB"].ToString() != "")
                    {
                        colPRICEB = dr["PRICEB"].ToString();
                    }
                    else
                    {
                        colPRICEB = "0.00";
                    }

                    if (dr["PRICEC"].ToString() != "")
                    {
                        colPRICEC = dr["PRICEC"].ToString();
                    }
                    else
                    {
                        colPRICEC = "0.00";
                    }

                    if (dr["PRICEOVERRIDE"].ToString() != "")
                    {
                        colPRICEOVERRIDE = dr["PRICEOVERRIDE"].ToString();
                    }
                    else
                    {
                        colPRICEOVERRIDE = "0.00";
                    }

                    if (dr["NEWPRICE"].ToString() != "")
                    {
                        colNEWPRICE = dr["NEWPRICE"].ToString();
                    }
                    else
                    {
                        colNEWPRICE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }
                    strItemUOM = dr["UOM"].ToString();
                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);
                    
                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    colGIFTCERTID = dr["GIFTCERTID"].ToString();
                    colONSALE = dr["ONSALE"].ToString();
                    colDISCOUNTLEVEL = dr["DISCOUNTLEVEL"].ToString();

                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();
                    strInvNotes = dr["NOTES"].ToString();
                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemPriceA = Functions.fnDouble(colPRICEA);
                    dblItemPriceB = Functions.fnDouble(colPRICEB);
                    dblItemPriceC = Functions.fnDouble(colPRICEC);
                    dblItemPriceOverride = Functions.fnDouble(colPRICEOVERRIDE);
                    dblItemNewPrice = Functions.fnDouble(colNEWPRICE);
                    intItemGiftCertID = colGIFTCERTID;

                    strItemDiscountLevel = colDISCOUNTLEVEL;
                    strItemOnSale = colONSALE;

                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    strMixMatchFlag = dr["MIXMATCHFLAG"].ToString();
                    strMixMatchLast = dr["MIXMATCHLAST"].ToString();
                    strMixMatchType = dr["MIXMATCHTYPE"].ToString();
                    dblMixMatchValue = Functions.fnDouble(dr["MIXMATCHVALUE"].ToString());
                    intMixMatchID = Functions.fnInt32(dr["MIXMATCHID"].ToString());
                    intMixMatchUnique = Functions.fnInt32(dr["MIXMATCHUNIQUE"].ToString());
                    intMixMatchQty = Functions.fnInt32(dr["MIXMATCHQTY"].ToString());

                    intSalePriceID = Functions.fnInt32(dr["SALEPRICEID"].ToString());

                    intDTxID = Functions.fnInt32(dr["DTXID"].ToString());
                    intDTxType = Functions.fnInt32(dr["DTXTYPE"].ToString());
                    dblDTxRate = Functions.fnDouble(dr["DTXRATE"].ToString());
                    dblDTx = Functions.fnDouble(dr["DTX"].ToString());

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    iBuyGetFreeHeader = Functions.fnInt32(dr["BUYNGETFREEHEADERID"].ToString());
                    sBuyGetFreeCat = dr["BUYNGETFREECATEGORY"].ToString();
                    sBuyGetFreePromotionTxt = dr["BUYNGETFREENAME"].ToString();

                    iAge = Functions.fnInt32(dr["AGE"].ToString());

                    iQtyDecimalLength = Functions.GetDecimalLength(colQTY);

                    InsertSuspendItemDetails(objSQlComm);

                    if (colPRODUCTTYPE == "E")
                    {
                        UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intSuspendInvoiceNo, "S", "0");
                    }

                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustItemGridRecordsForWorkOrder(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    string colID = "";
                    string colPRICEA = "";
                    string colPRICEB = "";
                    string colPRICEC = "";
                    string colPRICEOVERRIDE = "";
                    string colNEWPRICE = "";
                    string colDISCOUNTLEVEL = "";
                    string colONSALE = "";
                    string colCOST = "";
                    string colQTY = "";
                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";
                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";
                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";
                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["PRICEA"].ToString() != "")
                    {
                        colPRICEA = dr["PRICEA"].ToString();
                    }
                    else
                    {
                        colPRICEA = "0.00";
                    }

                    if (dr["PRICEB"].ToString() != "")
                    {
                        colPRICEB = dr["PRICEB"].ToString();
                    }
                    else
                    {
                        colPRICEB = "0.00";
                    }

                    if (dr["PRICEC"].ToString() != "")
                    {
                        colPRICEC = dr["PRICEC"].ToString();
                    }
                    else
                    {
                        colPRICEC = "0.00";
                    }

                    if (dr["PRICEOVERRIDE"].ToString() != "")
                    {
                        colPRICEOVERRIDE = dr["PRICEOVERRIDE"].ToString();
                    }
                    else
                    {
                        colPRICEOVERRIDE = "0.00";
                    }

                    if (dr["NEWPRICE"].ToString() != "")
                    {
                        colNEWPRICE = dr["NEWPRICE"].ToString();
                    }
                    else
                    {
                        colNEWPRICE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    string colGRATE = "";
                    string colGPRICE = "";



                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }
                    strItemUOM = dr["UOM"].ToString();
                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();
                    
                    colONSALE = dr["ONSALE"].ToString();
                    colDISCOUNTLEVEL = dr["DISCOUNTLEVEL"].ToString();

                    intFeesID = Functions.fnInt32(dr["FEESID"].ToString());
                    dblFeesValue = Functions.fnDouble(dr["FEESVALUE"].ToString());
                    dblFees = Functions.fnDouble(dr["FEES"].ToString());
                    dblFeesTaxRate = Functions.fnDouble(dr["FEESTAXRATE"].ToString());
                    dblFeesTax = Functions.fnDouble(dr["FEESTAX"].ToString());
                    strFeesLogic = dr["FEESLOGIC"].ToString();
                    strFeesText = dr["FEESTEXT"].ToString();
                    strFeesQty = dr["FEESQTY"].ToString();

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemPriceA = Functions.fnDouble(colPRICEA);
                    dblItemPriceB = Functions.fnDouble(colPRICEB);
                    dblItemPriceC = Functions.fnDouble(colPRICEC);
                    dblItemPriceOverride = Functions.fnDouble(colPRICEOVERRIDE);
                    dblItemNewPrice = Functions.fnDouble(colNEWPRICE);

                    strItemDiscountLevel = colDISCOUNTLEVEL;
                    strItemOnSale = colONSALE;

                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    strMixMatchFlag = dr["MIXMATCHFLAG"].ToString();
                    strMixMatchLast = dr["MIXMATCHLAST"].ToString();
                    strMixMatchType = dr["MIXMATCHTYPE"].ToString();
                    dblMixMatchValue = Functions.fnDouble(dr["MIXMATCHVALUE"].ToString());
                    intMixMatchID = Functions.fnInt32(dr["MIXMATCHID"].ToString());
                    intMixMatchUnique = Functions.fnInt32(dr["MIXMATCHUNIQUE"].ToString());
                    intMixMatchQty = Functions.fnInt32(dr["MIXMATCHQTY"].ToString());

                    intSalePriceID = Functions.fnInt32(dr["SALEPRICEID"].ToString());

                    intDTxID = Functions.fnInt32(dr["DTXID"].ToString());
                    intDTxType = Functions.fnInt32(dr["DTXTYPE"].ToString());
                    dblDTxRate = Functions.fnDouble(dr["DTXRATE"].ToString());
                    dblDTx = Functions.fnDouble(dr["DTX"].ToString());

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";


                    iBuyGetFreeHeader = Functions.fnInt32(dr["BUYNGETFREEHEADERID"].ToString());
                    sBuyGetFreeCat = dr["BUYNGETFREECATEGORY"].ToString();
                    sBuyGetFreePromotionTxt = dr["BUYNGETFREENAME"].ToString();

                    iAge = Functions.fnInt32(dr["AGE"].ToString());

                    InsertWorkOrderItemDetails(objSQlComm);

                    int intJ = 0;

                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "H")))
                    {
                        if (!(colPRODUCTTYPE == "U"))
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Work Order", "N", intItemID, intLoginUserID,
                                        dblItemQty, dblItemCost, intID.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");
                            
                            if (colPRODUCTTYPE == "K") // kit
                            {
                                dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                AdjustKitGridRecords(objSQlComm, dblItemQty);
                            }
                            if (colPRODUCTTYPE == "M") // matrix
                            {
                                Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, -dblItemQty, intLoginUserID);
                            }

                            if (colPRODUCTTYPE == "E")
                            {
                                UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intSuspendInvoiceNo, "W", "0");
                            }
                        }
                        else
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Work Order", "N", intItemID, intLoginUserID,
                                        dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");                            
                        }
                    }

                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustItemGridRecordsForWorkOrderPayment(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblWorkOrder1 == null) return;
                foreach (DataRow dr in dtblWorkOrder1.Rows)
                {
                    string colID = "";
                    string colPRICEA = "";
                    string colPRICEB = "";
                    string colPRICEC = "";
                    string colPRICEOVERRIDE = "";
                    string colNEWPRICE = "";
                    string colDISCOUNTLEVEL = "";
                    string colONSALE = "";
                    string colCOST = "";
                    string colQTY = "";
                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";
                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";
                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";
                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["PRICEA"].ToString() != "")
                    {
                        colPRICEA = dr["PRICEA"].ToString();
                    }
                    else
                    {
                        colPRICEA = "0.00";
                    }

                    if (dr["PRICEB"].ToString() != "")
                    {
                        colPRICEB = dr["PRICEB"].ToString();
                    }
                    else
                    {
                        colPRICEB = "0.00";
                    }

                    if (dr["PRICEC"].ToString() != "")
                    {
                        colPRICEC = dr["PRICEC"].ToString();
                    }
                    else
                    {
                        colPRICEC = "0.00";
                    }

                    if (dr["PRICEOVERRIDE"].ToString() != "")
                    {
                        colPRICEOVERRIDE = dr["PRICEOVERRIDE"].ToString();
                    }
                    else
                    {
                        colPRICEOVERRIDE = "0.00";
                    }

                    if (dr["NEWPRICE"].ToString() != "")
                    {
                        colNEWPRICE = dr["NEWPRICE"].ToString();
                    }
                    else
                    {
                        colNEWPRICE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();


                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    colONSALE = dr["ONSALE"].ToString();
                    colDISCOUNTLEVEL = dr["DISCOUNTLEVEL"].ToString();

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemPriceA = Functions.fnDouble(colPRICEA);
                    dblItemPriceB = Functions.fnDouble(colPRICEB);
                    dblItemPriceC = Functions.fnDouble(colPRICEC);
                    dblItemPriceOverride = Functions.fnDouble(colPRICEOVERRIDE);
                    dblItemNewPrice = Functions.fnDouble(colNEWPRICE);

                    strItemDiscountLevel = colDISCOUNTLEVEL;
                    strItemOnSale = colONSALE;

                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    strMixMatchFlag = dr["MIXMATCHFLAG"].ToString();
                    strMixMatchLast = dr["MIXMATCHLAST"].ToString();
                    strMixMatchType = dr["MIXMATCHTYPE"].ToString();
                    dblMixMatchValue = Functions.fnDouble(dr["MIXMATCHVALUE"].ToString());
                    intMixMatchID = Functions.fnInt32(dr["MIXMATCHID"].ToString());
                    intMixMatchUnique = Functions.fnInt32(dr["MIXMATCHUNIQUE"].ToString());
                    intMixMatchQty = Functions.fnInt32(dr["MIXMATCHQTY"].ToString());

                    intDTxID = Functions.fnInt32(dr["DTXID"].ToString());
                    intDTxType = Functions.fnInt32(dr["DTXTYPE"].ToString());
                    dblDTxRate = Functions.fnDouble(dr["DTXRATE"].ToString());
                    dblDTx = Functions.fnDouble(dr["DTX"].ToString());

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";


                    iBuyGetFreeHeader = Functions.fnInt32(dr["BUYNGETFREEHEADERID"].ToString());
                    sBuyGetFreeCat = dr["BUYNGETFREECATEGORY"].ToString();
                    sBuyGetFreePromotionTxt = dr["BUYNGETFREENAME"].ToString();

                    iAge = Functions.fnInt32(dr["AGE"].ToString());

                    InsertWorkOrderItemDetails(objSQlComm);

                    int intJ = 0;

                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "H")))
                    {
                        if (!(colPRODUCTTYPE == "U"))
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Work Order", "N", intItemID, intLoginUserID,
                                        dblItemQty, dblItemCost, intID.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");

                            if (colPRODUCTTYPE == "K") // kit
                            {
                                dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                AdjustKitGridRecords(objSQlComm, dblItemQty);
                            }
                            if (colPRODUCTTYPE == "M") // matrix
                            {
                                Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, -dblItemQty, intLoginUserID);
                            }

                            if (colPRODUCTTYPE == "E")
                            {
                                UpdateSerializedSold(objSQlComm, Functions.fnInt32(dblItemUOMCount), intSuspendInvoiceNo, "I", "0");
                            }
                        }
                        else
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty * dblItemUOMCount, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Work Order", "N", intItemID, intLoginUserID,
                                        dblItemQty * dblItemUOMCount, dblItemCost, intID.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");
                        }
                    }

                }
                dtblWorkOrder1.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustItemGridRecordsForRepairBeforeDelete(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblWorkOrder == null) return;
                foreach (DataRow dr in dtblWorkOrder.Rows)
                {
                    string colID = "";
                    string colQTY = "";
                    string colPRODUCTTYPE = "";

                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";

                    if (dr["ProductID"].ToString() == "") continue;

                    if (dr["ProductID"].ToString() != "")
                    {
                        colID = dr["ProductID"].ToString();
                    }


                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }


                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();

                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemProductType = colPRODUCTTYPE;

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    int intJ = 0;

                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "H")))
                    {
                        if (!(colPRODUCTTYPE == "U"))
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, dblItemQty, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Adjust-Repair", "N", intItemID, intLoginUserID,
                                        dblItemQty, dblItemCost, intIssueRepairInvNo.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");

                            if (colPRODUCTTYPE == "K") // kit
                            {
                                dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                AdjustKitGridRecords(objSQlComm, dblItemQty);
                            }
                            if (colPRODUCTTYPE == "M") // matrix
                            {
                                Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, dblItemQty, intLoginUserID);
                            }
                        }
                        else
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, dblItemQty * dblItemUOMCount, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Adjust-Repair", "N", intItemID, intLoginUserID,
                                        dblItemQty * dblItemUOMCount, dblItemCost, intIssueRepairInvNo.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");

                        }
                    }

                }
                dtblWorkOrder.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustItemGridRecordsForWorkOrderBeforeDelete(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblWorkOrder == null) return;
                foreach (DataRow dr in dtblWorkOrder.Rows)
                {
                    string colID = "";
                    string colQTY = "";
                    string colPRODUCTTYPE = "";
                    
                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";

                    if (dr["ProductID"].ToString() == "") continue;

                    if (dr["ProductID"].ToString() != "")
                    {
                        colID = dr["ProductID"].ToString();
                    }


                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }


                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                   
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemProductType = colPRODUCTTYPE;

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;
                    
                    int intJ = 0;

                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "O") || (colPRODUCTTYPE == "H")))
                    {
                        if (!(colPRODUCTTYPE == "U"))
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, dblItemQty, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm,"Stock In","Adjustment-WO","N",intItemID, intLoginUserID,
                                        dblItemQty, dblItemCost, intSuspendInvoiceNo.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");

                            if (colPRODUCTTYPE == "K") // kit
                            {
                                dtblKitDataTable = FetchKitRecord(objSQlComm, intItemID);
                                AdjustKitGridRecords(objSQlComm, dblItemQty);
                            }
                            if (colPRODUCTTYPE == "M") // matrix
                            {
                                Functions.UpdateMatrixItemStock(objSQlComm, intMatrixOptionID, strMatrixOptionValue1, strMatrixOptionValue2,
                                strMatrixOptionValue3, dblItemQty, intLoginUserID);
                            }
                        }
                        else
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intItemID, dblItemQty * dblItemUOMCount, intLoginUserID);
                            intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Adjustment-WO", "N", intItemID, intLoginUserID,
                                        dblItemQty * dblItemUOMCount, dblItemCost, intSuspendInvoiceNo.ToString(), strTerminalName, DateTime.Now, DateTime.Now, "");

                        }
                    }

                }
                dtblWorkOrder.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        public bool InsertSuspendItemDetails(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into Suspnded ( InvoiceNo,ProductID,PriceA,PriceB,PriceC,Cost,Qty, "
                                  + " PriceOverride,NewPrice,DateTimeSuspended,GiftCertID,OnSale,DiscountLevel, "
                                  + " CustomerID,MatrixOptionID,OptionValue1,OptionValue2,OptionValue3,"
                                  + " SKU,Description,ProductType,DepartmentID,CategoryID,TaxID1,TaxID2,TaxID3,"
                                  + " Taxable1,Taxable2,Taxable3,TaxRate1,TaxRate2,TaxRate3,UOMCount,UOMPrice,UOMDesc,"
                                  + " CloseoutID,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,"
                                  + " ItemIndex,Discount,DiscountID,DiscountText,DiscLogic,DiscValue,"
                                  + " TaxType1,TaxType2,TaxType3,TaxTotal1,TaxTotal2,TaxTotal3, "
                                  + " MixMatchID,MixMatchType,MixMatchValue,MixMatchQty,MixMatchFlag,MixMatchUnique,MixMatchLast,"
                                  + " FeesID,FeesLogic,FeesValue,Fees,FeesTaxRate,FeesTax,FeesText,FeesQty,"
                                  + " SalePriceID,DTaxID,DTaxType,DTaxRate,DTax,EditFlag,Notes, QtyDecimal,PromptPrice,"
                                  + " BuyNGetFreeHeaderID,BuyNGetFreeCategory,BuyNGetFreeName,Age,TaxIncludeRate,TaxIncludePrice,UOM ) "
                                  + " values (@InvoiceNo,@ProductID,@PriceA,@PriceB,@PriceC,@Cost,@Qty, "
                                  + " @PriceOverride,@NewPrice,@DateTimeSuspended,@GiftCertID,@OnSale,@DiscountLevel, "
                                  + " @CustomerID,@MatrixOptionID,@OptionValue1,@OptionValue2,@OptionValue3,"
                                  + " @SKU,@Description,@ProductType,@DepartmentID,@CategoryID,@TaxID1,@TaxID2,@TaxID3,"
                                  + " @Taxable1,@Taxable2,@Taxable3,@TaxRate1,@TaxRate2,@TaxRate3,@UOMCount,@UOMPrice,"
                                  + " @UOMDesc,@CloseoutID,@CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn, "
                                  + " @ItemIndex,@Discount,@DiscountID,@DiscountText,@DiscLogic,@DiscValue, "
                                  + " @TaxType1,@TaxType2,@TaxType3,@TaxTotal1,@TaxTotal2,@TaxTotal3, "
                                  + " @MixMatchID,@MixMatchType,@MixMatchValue,@MixMatchQty,@MixMatchFlag,@MixMatchUnique,@MixMatchLast,"
                                  + " @FeesID,@FeesLogic,@FeesValue,@Fees,@FeesTaxRate,@FeesTax,@FeesText,@FeesQty,"
                                  + " @SalePriceID,@DTaxID,@DTaxType,@DTaxRate,@DTax,@EditFlag,@Notes, @QtyDecimal,@PromptPrice,"
                                  + " @BuyNGetFreeHeaderID,@BuyNGetFreeCategory,@BuyNGetFreeName,@Age,@TaxIncludeRate,@TaxIncludePrice,@UOM ) "
                                  + " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceA", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceB", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceC", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceOverride", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@NewPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DateTimeSuspended", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@GiftCertID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@OnSale", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountLevel", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MatrixOptionID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue1", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue2", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue3", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@Cost", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Qty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@SKU", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DepartmentID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable1", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable2", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable3", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate3", System.Data.SqlDbType.Float));
                
                objSQlComm.Parameters.Add(new SqlParameter("@UOMCount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMDesc", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@CloseoutID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ItemIndex", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscValue", System.Data.SqlDbType.Float));
                
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchQty", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchUnique", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchLast", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesQty", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@SalePriceID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@DTaxID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTaxType", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@EditFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Notes", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludeRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludeRate"].Value = dblItemGRate;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludePrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludePrice"].Value = dblItemGPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@UOM", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@UOM"].Value = strItemUOM;

                objSQlComm.Parameters["@DTaxID"].Value = intDTxID;
                objSQlComm.Parameters["@DTaxType"].Value = intDTxType;
                objSQlComm.Parameters["@DTaxRate"].Value = dblDTxRate;
                objSQlComm.Parameters["@DTax"].Value = dblDTx;

                objSQlComm.Parameters["@FeesID"].Value = intFeesID;
                objSQlComm.Parameters["@FeesLogic"].Value = strFeesLogic;
                objSQlComm.Parameters["@FeesValue"].Value = dblFeesValue;
                objSQlComm.Parameters["@Fees"].Value = dblFees;
                objSQlComm.Parameters["@FeesTaxRate"].Value = dblFeesTaxRate;
                objSQlComm.Parameters["@FeesTax"].Value = dblFeesTax;
                objSQlComm.Parameters["@FeesText"].Value = strFeesText;
                objSQlComm.Parameters["@FeesQty"].Value = strFeesQty;

                objSQlComm.Parameters["@MixMatchID"].Value = intMixMatchID;
                objSQlComm.Parameters["@MixMatchType"].Value = strMixMatchType;
                objSQlComm.Parameters["@MixMatchValue"].Value = dblMixMatchValue;
                objSQlComm.Parameters["@MixMatchQty"].Value = intMixMatchQty;
                objSQlComm.Parameters["@MixMatchFlag"].Value = strMixMatchFlag;
                objSQlComm.Parameters["@MixMatchUnique"].Value = intMixMatchUnique;
                objSQlComm.Parameters["@MixMatchLast"].Value = strMixMatchLast;

                objSQlComm.Parameters["@InvoiceNo"].Value = intSuspendInvoiceNo;
                objSQlComm.Parameters["@ProductID"].Value = intItemID;
                objSQlComm.Parameters["@PriceA"].Value = dblItemPriceA;
                objSQlComm.Parameters["@PriceB"].Value = dblItemPriceB;
                objSQlComm.Parameters["@PriceC"].Value = dblItemPriceC;
                objSQlComm.Parameters["@PriceOverride"].Value = dblItemPriceOverride;
                objSQlComm.Parameters["@NewPrice"].Value = dblItemNewPrice;
                objSQlComm.Parameters["@DateTimeSuspended"].Value = DateTime.Now;
                objSQlComm.Parameters["@GiftCertID"].Value = intItemGiftCertID;
                objSQlComm.Parameters["@OnSale"].Value = strItemOnSale;
                objSQlComm.Parameters["@DiscountLevel"].Value = strItemDiscountLevel;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@MatrixOptionID"].Value = intMatrixOptionID;
                objSQlComm.Parameters["@OptionValue1"].Value = strMatrixOptionValue1;
                objSQlComm.Parameters["@OptionValue2"].Value = strMatrixOptionValue2;
                objSQlComm.Parameters["@OptionValue3"].Value = strMatrixOptionValue3;
                objSQlComm.Parameters["@Cost"].Value = dblItemCost;
                objSQlComm.Parameters["@Qty"].Value = dblItemQty;

                objSQlComm.Parameters["@SKU"].Value = strItemSKU;
                objSQlComm.Parameters["@Description"].Value = strItemDescription.Replace("\n", "");
                objSQlComm.Parameters["@ProductType"].Value = strItemProductType;
                objSQlComm.Parameters["@DepartmentID"].Value = intItemDepartmentID;
                objSQlComm.Parameters["@CategoryID"].Value = intItemCategoryID;

                objSQlComm.Parameters["@TaxID1"].Value = intItemTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intItemTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intItemTaxID3;
                objSQlComm.Parameters["@Taxable1"].Value = strItemTaxable1;
                objSQlComm.Parameters["@Taxable2"].Value = strItemTaxable2;
                objSQlComm.Parameters["@Taxable3"].Value = strItemTaxable3;
                objSQlComm.Parameters["@TaxRate1"].Value = dblItemTaxRate1;
                objSQlComm.Parameters["@TaxRate2"].Value = dblItemTaxRate2;
                objSQlComm.Parameters["@TaxRate3"].Value = dblItemTaxRate3;
                

                objSQlComm.Parameters["@UOMCount"].Value = dblItemUOMCount;
                objSQlComm.Parameters["@UOMPrice"].Value = dblItemUOMPrice;
                objSQlComm.Parameters["@UOMDesc"].Value = strItemUOMDesc;

                objSQlComm.Parameters["@CloseoutID"].Value = intCloseoutID;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ItemIndex"].Value = intItemIndex;
                objSQlComm.Parameters["@DiscountID"].Value = intItemDiscountID;
                objSQlComm.Parameters["@DiscountText"].Value = strItemDiscountText;
                objSQlComm.Parameters["@DiscLogic"].Value = strItemDiscLogic;
                objSQlComm.Parameters["@Discount"].Value = dblItemDiscount;
                objSQlComm.Parameters["@DiscValue"].Value = dblItemDiscValue;

                objSQlComm.Parameters["@TaxType1"].Value = intItemTaxType1;
                objSQlComm.Parameters["@TaxType2"].Value = intItemTaxType2;
                objSQlComm.Parameters["@TaxType3"].Value = intItemTaxType3;

                objSQlComm.Parameters["@TaxTotal1"].Value = dblItemTaxTotal1;
                objSQlComm.Parameters["@TaxTotal2"].Value = dblItemTaxTotal2;
                objSQlComm.Parameters["@TaxTotal3"].Value = dblItemTaxTotal3;

                objSQlComm.Parameters["@SalePriceID"].Value = intSalePriceID;
                objSQlComm.Parameters["@EditFlag"].Value = sEditFlag;
                objSQlComm.Parameters["@Notes"].Value = strInvNotes;

                objSQlComm.Parameters.Add(new SqlParameter("@QtyDecimal", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@QtyDecimal"].Value = iQtyDecimalLength;

                objSQlComm.Parameters.Add(new SqlParameter("@PromptPrice", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@PromptPrice"].Value = sPromptPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeHeaderID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@BuyNGetFreeHeaderID"].Value = iBuyGetFreeHeader;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeCategory", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@BuyNGetFreeCategory"].Value = sBuyGetFreeCat;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@BuyNGetFreeName"].Value = sBuyGetFreePromotionTxt;

                objSQlComm.Parameters.Add(new SqlParameter("@Age", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@Age"].Value = iAge;


                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intReturnItemID = Functions.fnInt32(sqlDataReader["ID"]);

                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool DeleteRepairItemDetails(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " delete from item where invoiceno = @prm";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }
        
        public bool DeleteSuspendItemDetails(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " delete from Suspnded Where InvoiceNo = @InvoiceNo";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvoiceNo"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool DeleteWorkOrderItemDetails(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " delete from WorkOrder where WorkorderNo = @WorkorderNo";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@WorkorderNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@WorkorderNo"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool UpdateSerialisedItemTagForRepair(SqlCommand objSQlComm,int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update serialdetail set ItemID = 0,SoldType = 'I' where itemID in ( select ID from item i "
                                  + " where invoiceno = @itemID) and SoldType = 'R' ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@itemID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@itemID"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool UpdateSerialisedItemTagForWorkorder(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update serialdetail set ItemID = 0,SoldType = 'I' where itemID = @itemID and SoldType = 'W' ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@itemID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@itemID"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool UpdateSerialisedItemTagForSuspend(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update serialdetail set ItemID = 0,SoldType = 'I' where itemID = @itemID and SoldType = 'S' ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@itemID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@itemID"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool InsertWorkOrderItemDetails(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm =   " insert into WorkOrder( WorkOrderNo,ProductID,PriceA,PriceB,PriceC,Cost,Qty, "
                                    + " PriceOverride,NewPrice,OnSale,DiscountLevel,CustomerID,MatrixOptionID,"
                                    + " OptionValue1,OptionValue2,OptionValue3,SKU,Description,ProductType,"
                                    + " DepartmentID,CategoryID,TaxID1,TaxID2,TaxID3,Taxable1,Taxable2,Taxable3,"
                                    + " TaxRate1,TaxRate2,TaxRate3,UOMCount,UOMPrice,UOMDesc,CloseoutID,"
                                    + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,TotalAmount,TaxAmount,"
                                    + " ItemIndex,Discount,DiscountID,DiscountText,DiscLogic,DiscValue,"
                                    + " TaxType1,TaxType2,TaxType3,TaxTotal1,TaxTotal2,TaxTotal3,"
                                    + " MixMatchID,MixMatchType,MixMatchValue,MixMatchQty,MixMatchFlag,MixMatchUnique,MixMatchLast,"
                                    + " FeesID,FeesLogic,FeesValue,Fees,FeesTaxRate,FeesTax,FeesText,FeesQty,"
                                    + " SalePriceID,DTaxID,DTaxType,DTaxRate,DTax,EditFlag,PromptPrice,"
                                    + " BuyNGetFreeHeaderID,BuyNGetFreeCategory,BuyNGetFreeName,Age,TaxIncludeRate,TaxIncludePrice,UOM) "
                                    + " values (@InvoiceNo,@ProductID,@PriceA,@PriceB,@PriceC,@Cost,@Qty, "
                                    + " @PriceOverride,@NewPrice,@OnSale,@DiscountLevel, "
                                    + " @CustomerID,@MatrixOptionID,@OptionValue1,@OptionValue2,@OptionValue3,"
                                    + " @SKU,@Description,@ProductType,@DepartmentID,@CategoryID,"
                                    + " @TaxID1,@TaxID2,@TaxID3,@Taxable1,@Taxable2,@Taxable3,@TaxRate1,@TaxRate2,@TaxRate3,"
                                    + " @UOMCount,@UOMPrice,@UOMDesc,@CloseoutID, "
                                    + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn,@TotalAmount,@TaxAmount,"
                                    + " @ItemIndex,@Discount,@DiscountID,@DiscountText,@DiscLogic,@DiscValue,"
                                    + " @TaxType1,@TaxType2,@TaxType3,@TaxTotal1,@TaxTotal2,@TaxTotal3,"
                                    + " @MixMatchID,@MixMatchType,@MixMatchValue,@MixMatchQty,@MixMatchFlag,@MixMatchUnique,@MixMatchLast,"
                                    + " @FeesID,@FeesLogic,@FeesValue,@Fees,@FeesTaxRate,@FeesTax,@FeesText,@FeesQty,"
                                    + " @SalePriceID,@DTaxID,@DTaxType,@DTaxRate,@DTax,@EditFlag,@PromptPrice,"
                                    + " @BuyNGetFreeHeaderID,@BuyNGetFreeCategory,@BuyNGetFreeName,@Age,@TaxIncludeRate,@TaxIncludePrice,@UOM) "
                                    + " select @@IDENTITY as ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceA", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceB", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceC", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@PriceOverride", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@NewPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@OnSale", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountLevel", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MatrixOptionID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue1", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue2", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@OptionValue3", System.Data.SqlDbType.NVarChar));


                objSQlComm.Parameters.Add(new SqlParameter("@Cost", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Qty", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@SKU", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Description", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@ProductType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@DepartmentID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CategoryID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxID3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable1", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable2", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Taxable3", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@UOMCount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMPrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@UOMDesc", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@CloseoutID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@TotalAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@ItemIndex", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscountText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DiscValue", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@TaxType1", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType2", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxType3", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TaxTotal3", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchType", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchQty", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchUnique", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MixMatchLast", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@FeesID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesLogic", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesValue", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesText", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesQty", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@SalePriceID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@DTaxID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTaxType", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@DTaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@DTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@EditFlag", System.Data.SqlDbType.Char));

                objSQlComm.Parameters.Add(new SqlParameter("@PromptPrice", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@PromptPrice"].Value = sPromptPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeHeaderID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@BuyNGetFreeHeaderID"].Value = iBuyGetFreeHeader;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeCategory", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@BuyNGetFreeCategory"].Value = sBuyGetFreeCat;

                objSQlComm.Parameters.Add(new SqlParameter("@BuyNGetFreeName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@BuyNGetFreeName"].Value = sBuyGetFreePromotionTxt;

                objSQlComm.Parameters.Add(new SqlParameter("@Age", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@Age"].Value = iAge;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludeRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludeRate"].Value = dblItemGRate;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxIncludePrice", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxIncludePrice"].Value = dblItemGPrice;

                objSQlComm.Parameters.Add(new SqlParameter("@UOM", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@UOM"].Value = strItemUOM;

                objSQlComm.Parameters["@DTaxID"].Value = intDTxID;
                objSQlComm.Parameters["@DTaxType"].Value = intDTxType;
                objSQlComm.Parameters["@DTaxRate"].Value = dblDTxRate;
                objSQlComm.Parameters["@DTax"].Value = dblDTx;
                objSQlComm.Parameters["@EditFlag"].Value = sEditFlag;
                
                objSQlComm.Parameters["@FeesID"].Value = intFeesID;
                objSQlComm.Parameters["@FeesLogic"].Value = strFeesLogic;
                objSQlComm.Parameters["@FeesValue"].Value = dblFeesValue;
                objSQlComm.Parameters["@Fees"].Value = dblFees;
                objSQlComm.Parameters["@FeesTaxRate"].Value = dblFeesTaxRate;
                objSQlComm.Parameters["@FeesTax"].Value = dblFeesTax;
                objSQlComm.Parameters["@FeesText"].Value = strFeesText;
                objSQlComm.Parameters["@FeesQty"].Value = strFeesQty;

                objSQlComm.Parameters["@MixMatchID"].Value = intMixMatchID;
                objSQlComm.Parameters["@MixMatchType"].Value = strMixMatchType;
                objSQlComm.Parameters["@MixMatchValue"].Value = dblMixMatchValue;
                objSQlComm.Parameters["@MixMatchQty"].Value = intMixMatchQty;
                objSQlComm.Parameters["@MixMatchFlag"].Value = strMixMatchFlag;
                objSQlComm.Parameters["@MixMatchUnique"].Value = intMixMatchUnique;
                objSQlComm.Parameters["@MixMatchLast"].Value = strMixMatchLast;

                objSQlComm.Parameters["@InvoiceNo"].Value = intSuspendInvoiceNo;
                objSQlComm.Parameters["@ProductID"].Value = intItemID;
                objSQlComm.Parameters["@PriceA"].Value = dblItemPriceA;
                objSQlComm.Parameters["@PriceB"].Value = dblItemPriceB;
                objSQlComm.Parameters["@PriceC"].Value = dblItemPriceC;
                objSQlComm.Parameters["@PriceOverride"].Value = dblItemPriceOverride;
                objSQlComm.Parameters["@NewPrice"].Value = dblItemNewPrice;
                objSQlComm.Parameters["@OnSale"].Value = strItemOnSale;
                objSQlComm.Parameters["@DiscountLevel"].Value = strItemDiscountLevel;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@MatrixOptionID"].Value = intMatrixOptionID;
                objSQlComm.Parameters["@OptionValue1"].Value = strMatrixOptionValue1;
                objSQlComm.Parameters["@OptionValue2"].Value = strMatrixOptionValue2;
                objSQlComm.Parameters["@OptionValue3"].Value = strMatrixOptionValue3;
                objSQlComm.Parameters["@Cost"].Value = dblItemCost;
                objSQlComm.Parameters["@Qty"].Value = dblItemQty;

                objSQlComm.Parameters["@SKU"].Value = strItemSKU;
                objSQlComm.Parameters["@Description"].Value = strItemDescription.Replace("\n", "");
                objSQlComm.Parameters["@ProductType"].Value = strItemProductType;
                objSQlComm.Parameters["@DepartmentID"].Value = intItemDepartmentID;
                objSQlComm.Parameters["@CategoryID"].Value = intItemCategoryID;

                objSQlComm.Parameters["@TaxID1"].Value = intItemTaxID1;
                objSQlComm.Parameters["@TaxID2"].Value = intItemTaxID2;
                objSQlComm.Parameters["@TaxID3"].Value = intItemTaxID3;
                objSQlComm.Parameters["@Taxable1"].Value = strItemTaxable1;
                objSQlComm.Parameters["@Taxable2"].Value = strItemTaxable2;
                objSQlComm.Parameters["@Taxable3"].Value = strItemTaxable3;
                objSQlComm.Parameters["@TaxRate1"].Value = dblItemTaxRate1;
                objSQlComm.Parameters["@TaxRate2"].Value = dblItemTaxRate2;
                objSQlComm.Parameters["@TaxRate3"].Value = dblItemTaxRate3;


                objSQlComm.Parameters["@UOMCount"].Value = dblItemUOMCount;
                objSQlComm.Parameters["@UOMPrice"].Value = dblItemUOMPrice;
                objSQlComm.Parameters["@UOMDesc"].Value = strItemUOMDesc;

                objSQlComm.Parameters["@CloseoutID"].Value = intCloseoutID;

                objSQlComm.Parameters["@TotalAmount"].Value = dblTotalSale;
                objSQlComm.Parameters["@TaxAmount"].Value = dblTax;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                if (dtWorkOrder != Convert.ToDateTime(null))
                {
                    objSQlComm.Parameters["@CreatedOn"].Value = dtWorkOrder;
                }
                else
                {
                    objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                }
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@ItemIndex"].Value = intItemIndex;
                objSQlComm.Parameters["@DiscountID"].Value = intItemDiscountID;
                objSQlComm.Parameters["@DiscountText"].Value = strItemDiscountText;
                objSQlComm.Parameters["@DiscLogic"].Value = strItemDiscLogic;
                objSQlComm.Parameters["@Discount"].Value = dblItemDiscount;
                objSQlComm.Parameters["@DiscValue"].Value = dblItemDiscValue;

                objSQlComm.Parameters["@TaxType1"].Value = intItemTaxType1;
                objSQlComm.Parameters["@TaxType2"].Value = intItemTaxType2;
                objSQlComm.Parameters["@TaxType3"].Value = intItemTaxType3;

                objSQlComm.Parameters["@TaxTotal1"].Value = dblItemTaxTotal1;
                objSQlComm.Parameters["@TaxTotal2"].Value = dblItemTaxTotal2;
                objSQlComm.Parameters["@TaxTotal3"].Value = dblItemTaxTotal3;
                objSQlComm.Parameters["@SalePriceID"].Value = intSalePriceID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intReturnItemID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public DataTable FetchSuspendedData()
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,s.DateTimeSuspended, "
                              + " s.CustomerID,c.LastName + ', ' + c.FirstName AS Customer, i.CustomerDOB from Invoice as i "
                              + " left outer join suspnded as s on i.ID = s.InvoiceNo left outer join "
                              + " Customer as c on c.ID = s.CustomerID where (i.Status = 2) order by i.ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("DateTimeSuspended", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerDOB", System.Type.GetType("System.String"));
                string  strPrevInv = "";
                string strCustName = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustomerID"].ToString() != "0")
                        strCustName = objSQLReader["Customer"].ToString();
                    else strCustName = "";

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["InvoiceNo"].ToString(),
                                                Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                objSQLReader["DateTimeSuspended"].ToString(),
                                                strCustName,objSQLReader["CustomerDOB"].ToString()});
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchSuspendedData_Specific(int pInvNo)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,s.DateTimeSuspended, "
                              + " s.CustomerID,c.LastName + ', ' + c.FirstName AS Customer from Invoice as i "
                              + " left outer join suspnded as s on i.ID = s.InvoiceNo left outer join "
                              + " Customer as c on c.ID = s.CustomerID where (i.Status = 2) and  s.InvoiceNo = @InvoiceNo order by i.ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("DateTimeSuspended", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));

                string strPrevInv = "";
                string strCustName = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustomerID"].ToString() != "0")
                        strCustName = objSQLReader["Customer"].ToString();
                    else strCustName = "";

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["InvoiceNo"].ToString(),
                                                Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                objSQLReader["DateTimeSuspended"].ToString(),
                                                strCustName});
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchSuspendedRecord(int pInvNo)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select * from suspnded where InvoiceNo = @InvoiceNo ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DepartmentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CategoryID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceA", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceB", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceC", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceOverride", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NewPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountLevel", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GiftCertID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemIndex", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("MixMatchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchUnique", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchLast", System.Type.GetType("System.String"));

                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));

                dtbl.Columns.Add("SalePriceID", System.Type.GetType("System.String"));

                dtbl.Columns.Add("DTaxID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyDecimal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Age", System.Type.GetType("System.String"));

                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOM", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["DepartmentID"].ToString(),
                                                objSQLReader["CategoryID"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["PriceA"].ToString(),
                                                objSQLReader["PriceB"].ToString(),
                                                objSQLReader["PriceC"].ToString(),
                                                objSQLReader["PriceOverride"].ToString(),
                                                objSQLReader["NewPrice"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                objSQLReader["CustomerID"].ToString(),
                                                objSQLReader["DiscountLevel"].ToString().Trim(),
                                                objSQLReader["GiftCertID"].ToString(),
                                                objSQLReader["UOMCount"].ToString(),
                                                objSQLReader["UOMPrice"].ToString(),
                                                objSQLReader["UOMDesc"].ToString(),
                                                objSQLReader["MatrixOptionID"].ToString(),
                                                objSQLReader["OptionValue1"].ToString(),
                                                objSQLReader["OptionValue2"].ToString(),
                                                objSQLReader["OptionValue3"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),
                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["ItemIndex"].ToString(),
                                                objSQLReader["TaxType1"].ToString(),
                                                objSQLReader["TaxType2"].ToString(),
                                                objSQLReader["TaxType3"].ToString(),
                                                objSQLReader["TaxTotal1"].ToString(),
                                                objSQLReader["TaxTotal2"].ToString(),
                                                objSQLReader["TaxTotal3"].ToString(),
                                                objSQLReader["MixMatchID"].ToString(),
                                                objSQLReader["MixMatchType"].ToString(),
                                                objSQLReader["MixMatchValue"].ToString(),
                                                objSQLReader["MixMatchQty"].ToString(),
                                                objSQLReader["MixMatchFlag"].ToString(),
                                                objSQLReader["MixMatchUnique"].ToString(),
                                                objSQLReader["MixMatchLast"].ToString(),
                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesLogic"].ToString(),
                                                objSQLReader["FeesValue"].ToString(),
                                                objSQLReader["FeesTaxRate"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),
                                                objSQLReader["SalePriceID"].ToString(),
                                                objSQLReader["DTaxID"].ToString(),
                                                objSQLReader["DTaxType"].ToString(),
                                                objSQLReader["DTaxRate"].ToString(),
                                                objSQLReader["DTax"].ToString(),
                                                objSQLReader["EditFlag"].ToString(),
                                                objSQLReader["QtyDecimal"].ToString(),
                                                objSQLReader["PromptPrice"].ToString(),
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString(),
                                                objSQLReader["Age"].ToString(),
                                                objSQLReader["TaxIncludeRate"].ToString(),
                                                objSQLReader["TaxIncludePrice"].ToString(),
                                                objSQLReader["UOM"].ToString()
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchWorkOrderRecord(int pInvNo)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select * from WorkOrder where workorderno = @InvoiceNo ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DepartmentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CategoryID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceA", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceB", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceC", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceOverride", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NewPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountLevel", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemIndex", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchUnique", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchLast", System.Type.GetType("System.String"));

                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SalePriceID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOM", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["DepartmentID"].ToString(),
                                                objSQLReader["CategoryID"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["PriceA"].ToString(),
                                                objSQLReader["PriceB"].ToString(),
                                                objSQLReader["PriceC"].ToString(),
                                                objSQLReader["PriceOverride"].ToString(),
                                                objSQLReader["NewPrice"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                objSQLReader["CustomerID"].ToString(),
                                                objSQLReader["DiscountLevel"].ToString(),
                                                objSQLReader["PaymentDate"].ToString(),
                                                objSQLReader["UOMCount"].ToString(),
                                                objSQLReader["UOMPrice"].ToString(),
                                                objSQLReader["UOMDesc"].ToString(),
                                                objSQLReader["MatrixOptionID"].ToString(),
                                                objSQLReader["OptionValue1"].ToString(),
                                                objSQLReader["OptionValue2"].ToString(),
                                                objSQLReader["OptionValue3"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),
                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["ItemIndex"].ToString(),
                                                objSQLReader["MixMatchID"].ToString(),
                                                objSQLReader["MixMatchType"].ToString(),
                                                objSQLReader["MixMatchValue"].ToString(),
                                                objSQLReader["MixMatchQty"].ToString(),
                                                objSQLReader["MixMatchFlag"].ToString(),
                                                objSQLReader["MixMatchUnique"].ToString(),
                                                objSQLReader["MixMatchLast"].ToString(),

                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesLogic"].ToString(),
                                                objSQLReader["FeesValue"].ToString(),
                                                objSQLReader["FeesTaxRate"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),
                                                objSQLReader["SalePriceID"].ToString(),
                                                objSQLReader["DTaxID"].ToString(),
                                                objSQLReader["DTaxType"].ToString(),
                                                objSQLReader["DTaxRate"].ToString(),
                                                objSQLReader["DTax"].ToString(),
                                                objSQLReader["EditFlag"].ToString(),
                                                objSQLReader["PromptPrice"].ToString(),
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString(),
                                                objSQLReader["TaxIncludeRate"].ToString(),
                                                objSQLReader["TaxIncludePrice"].ToString(),
                                                objSQLReader["UOM"].ToString()
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchWorkOrderPreviousRecord(SqlCommand objSQlComm, int pInvNo)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select * from WorkOrder where workorderno = @InvoiceNo ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

                sqlDataReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MATRIXOID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOV1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOV2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOV3", System.Type.GetType("System.String"));
                
                while (sqlDataReader.Read())
                {
                    dtbl.Rows.Add(new object[] {sqlDataReader["ID"].ToString(),
                                                sqlDataReader["ProductID"].ToString(),
                                                sqlDataReader["ProductType"].ToString(),
                                                sqlDataReader["Qty"].ToString(),
                                                sqlDataReader["UOMCount"].ToString(),
                                                sqlDataReader["UOMPrice"].ToString(),
                                                sqlDataReader["UOMDesc"].ToString(),
                                                sqlDataReader["MatrixOptionID"].ToString(),
                                                sqlDataReader["OptionValue1"].ToString(),
                                                sqlDataReader["OptionValue2"].ToString(),
                                                sqlDataReader["OptionValue3"].ToString()});
                }
                sqlDataReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return dtbl;
            }
        }

        public DataTable FetchRepairPreviousRecord(SqlCommand objSQlComm, int pInvNo)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select i.*,im.MatrixOptionID,im.OptionValue1,im.OptionValue2,im.OptionValue3 "
                           + " from item i left outer join itemmatrixoptions im on im.ItemID = i.ID where i.invoiceno = @InvoiceNo ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

                sqlDataReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MATRIXOID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOV1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOV2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOV3", System.Type.GetType("System.String"));

                while (sqlDataReader.Read())
                {
                    dtbl.Rows.Add(new object[] {sqlDataReader["ID"].ToString(),
                                                sqlDataReader["ProductID"].ToString(),
                                                sqlDataReader["ProductType"].ToString(),
                                                sqlDataReader["Qty"].ToString(),
                                                sqlDataReader["UOMCount"].ToString(),
                                                sqlDataReader["UOMPrice"].ToString(),
                                                sqlDataReader["UOMDesc"].ToString(),
                                                sqlDataReader["MatrixOptionID"].ToString(),
                                                sqlDataReader["OptionValue1"].ToString(),
                                                sqlDataReader["OptionValue2"].ToString(),
                                                sqlDataReader["OptionValue3"].ToString()});
                }
                sqlDataReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return dtbl;
            }
        }

        public DataTable FetchWorkOrderData(int WOTYPE, int CID,int DID, DateTime FDT, DateTime TDT,string StoreCd)
        {
            DataTable dtbl = new DataTable();
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;
            string strSQLType = "";
            string strSQLCustomer = "";
            string strSQLDate = "";

            if (WOTYPE == 0)
            {
                strSQLType = " and s.PaymentDate is null ";
            }
            if (WOTYPE == 1)
            {
                strSQLType = " and s.PaymentDate is not null ";
            }
            if (CID != 0)
            {
                strSQLCustomer = " and c.ID = @CID and c.IssueStore='" + StoreCd + "' ";
            }

            if (DID == 1)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                strSQLDate = " and s.CreatedOn > @DT1";
            }
            if (DID == 2)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 23, 59, 59);
                strSQLDate = " and s.CreatedOn < @DT1";
            }

            if (DID == 3)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                FormatEndDate = new DateTime(TDT.Year, TDT.Month, TDT.Day, 23, 59, 59);
                strSQLDate = " and s.CreatedOn between @DT1 and @DT2 ";
            }

            string strSQLComm = " select s.WorkOrderNo,isnull(s.InvoiceNo,0) as InvoiceNo,s.CreatedOn, s.PaymentDate, "
                              + " s.CustomerID, c.LastName + ', ' + c.FirstName as Customer,s.TotalAmount,"
                              + " isnull(i.TotalSale,0) as TotalSale from WorkOrder s left outer join Customer as c "
                              + " on c.ID = s.CustomerID  left outer join invoice as i on i.ID = s.InvoiceNo where (1 = 1) "
                              + strSQLType + strSQLCustomer + strSQLDate + " order by s.WorkOrderNo desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (CID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CID"].Value = CID;
            }

            if ((DID == 1) || (DID == 2))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
            }

            if (DID == 3)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
                objSQlComm.Parameters.Add(new SqlParameter("@DT2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT2"].Value = FormatEndDate;
            }

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CreatedOn", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));

                string strPrevInv = "";
                string strCustName = "";
                string strAmt = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustomerID"].ToString() != "0") strCustName = objSQLReader["Customer"].ToString();
                    else strCustName = "";

                    if (objSQLReader["InvoiceNo"].ToString() == "0") strAmt = objSQLReader["TotalAmount"].ToString();
                    else strAmt = objSQLReader["TotalSale"].ToString(); ;   

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["WorkOrderNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["WorkOrderNo"].ToString(),
                                                Functions.fnDouble(strAmt),
                                                objSQLReader["CreatedOn"].ToString(),
                                                objSQLReader["PaymentDate"].ToString(),
                                                strCustName});
                    }
                    strPrevInv = objSQLReader["WorkOrderNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchWorkOrderData_Specific(int WOID)
        {
            DataTable dtbl = new DataTable();
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;
            string strSQLType = "";
            string strSQLCustomer = "";
            string strSQLDate = "";
           

            string strSQLComm = " select s.WorkOrderNo,isnull(s.InvoiceNo,0) as InvoiceNo,s.CreatedOn, s.PaymentDate, "
                              + " s.CustomerID, c.LastName + ', ' + c.FirstName as Customer,s.TotalAmount,"
                              + " isnull(i.TotalSale,0) as TotalSale from WorkOrder s left outer join Customer as c "
                              + " on c.ID = s.CustomerID  left outer join invoice as i on i.ID = s.InvoiceNo where (1 = 1) and s.WorkOrderNo = @WO "
                              + " order by s.WorkOrderNo desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@WO", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@WO"].Value = WOID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CreatedOn", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));

                string strPrevInv = "";
                string strCustName = "";
                string strAmt = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustomerID"].ToString() != "0") strCustName = objSQLReader["Customer"].ToString();
                    else strCustName = "";

                    if (objSQLReader["InvoiceNo"].ToString() == "0") strAmt = objSQLReader["TotalAmount"].ToString();
                    else strAmt = objSQLReader["TotalSale"].ToString(); ;

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["WorkOrderNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["WorkOrderNo"].ToString(),
                                                Functions.fnDouble(strAmt),
                                                objSQLReader["CreatedOn"].ToString(),
                                                objSQLReader["PaymentDate"].ToString(),
                                                strCustName});
                    }
                    strPrevInv = objSQLReader["WorkOrderNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchReprintData(  int Category, int PID, int CID,int DID, DateTime FDT, DateTime TDT,
                                            int AID, double FAmt, double TAmt, int CURCID, string StoreC, int EID)
        {
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;
            
            DataTable dtbl = new DataTable();
            string SKUfilter1 = "";
            string SKUfilter2 = "";
            string Customerfilter = "";
            string Employeefilter = "";
            string CategoryFilter = "";
            string strSQLComm = "";
            string Datefilter1 = "";
            string Amtfilter1 = "";

            if (Category == 0) // Invoice
            {
                CategoryFilter = " and i.Status in (3,4) and i.LayawayNo = 0 ";
            }
            if (Category == 1) // Layaway
            {
                CategoryFilter = " and i.LayawayNo > 0 ";
            }
            if (CID > 0)
            {
                Customerfilter = " and c.ID = @CID ";
            }

            if (PID > 0)
            {
                SKUfilter1 = " left outer join item it on it.InvoiceNo = i.ID ";
                SKUfilter2 = " and it.ProductID = @PID and it.Tagged <> 'X' ";
            }

            if (DID == 0)
            {
                FormatStartDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, DateTime.Today.Day, 0, 0, 1);
                FormatEndDate = new DateTime(DateTime.Today.Year, DateTime.Today.Month, DateTime.Today.Day, 23, 59, 59);
                Datefilter1 = " and i.CreatedOn between @DT1 and @DT2 ";
            }

            if (DID == 1)
            {
                FormatStartDate =  new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                FormatEndDate = new DateTime(TDT.Year, TDT.Month, TDT.Day, 23, 59, 59);
                Datefilter1 = " and i.CreatedOn between @DT1 and @DT2 ";
            }
           

            if (AID == 1)
            {
                if (Category == 0) 
                    Amtfilter1 = " and i.TotalSale > @AT1";
                else 
                    Amtfilter1 = " having sum(i.TotalSale) > @AT1";
            }
            if (AID == 2)
            {
                if (Category == 0) 
                    Amtfilter1 = " and i.TotalSale < @AT1";
                else 
                    Amtfilter1 = " having sum(i.TotalSale) < @AT1";
            }

            if (AID == 3)
            {
                if (Category == 0) 
                    Amtfilter1 = " and i.TotalSale between @AT1 and  @AT2 ";
                else 
                    Amtfilter1 = " having sum(i.TotalSale) between @AT1 and  @AT2 ";
            }

            if (EID != 9999)
            {
                Employeefilter = " and i.CreatedBy = @EMP ";
            }
            
            if (Category == 0)
            {
                strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,i.CustomerID as CID, i.Coupon,"
                           + " isnull(c.CustomerID, '') as CustID,c.LastName + ', ' + c.FirstName as Customer, "
                           + " isnull(c.Company, '') as CustCompany, isnull(v.InvoiceNo,0) as VoidNo, t.CloseoutID, i.CustomerDOB, isnull(GiftAidFlag,'N') as GA from "
                           + " Trans t Left outer Join  Invoice AS i on t.ID=i.TransactionNo left outer join "
                           + " Customer as c on c.ID = i.CustomerID " + SKUfilter1
                           + " left outer join VoidInv v on v.InvoiceNo = i.ID "
                           + " where (1 = 1) and i.ServiceType = 'Sales' " //and c.issuestore = '" + StoreC + "' "
                           + CategoryFilter + SKUfilter2 + Customerfilter + Datefilter1 + Amtfilter1 + Employeefilter
                           + " order by i.ID desc ";
            }

            if (Category == 1)
            {
                strSQLComm = " select distinct i.LayawayNo as InvoiceNo,sum(i.TotalSale) as Amount,i.CustomerID as CID,i.Coupon,"
                            + " isnull(c.CustomerID, '') as CustID, c.LastName + ', ' + c.FirstName as Customer, "
                            + " isnull(c.Company, '') as CustCompany, 0 as VoidNo, i.CustomerDOB, isnull(GiftAidFlag,'N') as GA from Invoice AS i left outer join "
                            + " Customer AS c ON c.ID = i.CustomerID " + SKUfilter1
                            + " where (1 = 1) and i.ServiceType = 'Sales' " // and c.issuestore = '" + StoreC + "' "
                            + CategoryFilter + SKUfilter2 + Customerfilter + Datefilter1 + Employeefilter
                            + " group by i.LayawayNo,i.CustomerID,c.CustomerID,c.LastName,c.FirstName, c.Company,i.Coupon,i.CustomerDOB, isnull(GiftAidFlag,'N') " + Amtfilter1
                            + " order by i.LayawayNo desc ";
            }
            
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (CID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CID"].Value = CID;
            }

            if (PID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@PID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@PID"].Value = PID;
            }

            if (EID != 9999)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@EMP", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@EMP"].Value = EID;
            }


            if ((DID == 0) || (DID == 1))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
                objSQlComm.Parameters.Add(new SqlParameter("@DT2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT2"].Value = FormatEndDate;
            }

            if ((AID == 1) || (AID == 2))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@AT1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@AT1"].Value = FAmt;
            }

            if (AID == 3)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@AT1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@AT1"].Value = FAmt;
                objSQlComm.Parameters.Add(new SqlParameter("@AT2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@AT2"].Value = TAmt;
            }

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("VoidNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Coupon", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerDOB", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GA", System.Type.GetType("System.String"));
                string strPrevInv = "";
                string strCustID = "";
                string strCustName = "";
                string strCustCompany = "";
                string strVoid = "Y";
                string strVoidNo = "0";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["CID"].ToString() != "0")
                    {
                        strCustID = objSQLReader["CustID"].ToString();
                        strCustName = objSQLReader["Customer"].ToString();
                        strCustCompany = objSQLReader["CustCompany"].ToString();
                    }
                    else
                    {
                        strCustID = "";
                        strCustName = "";
                        strCustCompany = "";
                    }

                    strVoid = "Y";
                    strVoidNo = "0";
                    if (Category == 0)
                    {
                        strVoidNo = objSQLReader["VoidNo"].ToString();
                        if (CURCID == Functions.fnInt32(objSQLReader["CloseoutID"].ToString())) strVoid = "Y";
                        else strVoid = "N";
                        if (strVoidNo != "0") strVoid = "N";
                    }
                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["InvoiceNo"].ToString(),
                                                Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                objSQLReader["CID"].ToString(),
                                                strCustID,
                                                strCustName,strCustCompany,strVoidNo,strVoid,
                                                Functions.fnDouble(objSQLReader["Coupon"].ToString()),
                                                objSQLReader["CustomerDOB"].ToString(),
                                                objSQLReader["GA"].ToString()});
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchReprintData_Specific(int Category, int CURCID, int PID)
        {
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;

            DataTable dtbl = new DataTable();
            string SKUfilter1 = "";
            string SKUfilter2 = "";
            string Customerfilter = "";
            string Employeefilter = "";
            string CategoryFilter = "";
            string strSQLComm = "";
            string Datefilter1 = "";
            string Amtfilter1 = "";

            if (Category == 0) // Invoice
            {
                CategoryFilter = " and i.Status in (3,4) and i.LayawayNo = 0 ";
            }
            if (Category == 1) // Layaway
            {
                CategoryFilter = " and i.LayawayNo > 0 ";
            }
            

            if (Category == 0)
            {
                strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,i.CustomerID as CID, i.Coupon,"
                           + " isnull(c.CustomerID, '') as CustID,c.LastName + ', ' + c.FirstName as Customer, "
                           + " isnull(c.Company, '') as CustCompany, isnull(v.InvoiceNo,0) as VoidNo, t.CloseoutID from "
                           + " Trans t Left outer Join  Invoice AS i on t.ID=i.TransactionNo left outer join "
                           + " Customer as c on c.ID = i.CustomerID "
                           + " left outer join VoidInv v on v.InvoiceNo = i.ID "
                           + " where (1 = 1) and i.ServiceType = 'Sales' "
                           + CategoryFilter 
                           + " and i.ID = @prm order by i.ID desc ";
            }

            if (Category == 1)
            {
                strSQLComm =  " select distinct i.LayawayNo as InvoiceNo,sum(i.TotalSale) as Amount,i.CustomerID as CID,i.Coupon,"
                            + " isnull(c.CustomerID, '') as CustID, c.LastName + ', ' + c.FirstName as Customer, "
                            + " isnull(c.Company, '') as CustCompany, 0 as VoidNo from Invoice AS i left outer join "
                            + " Customer AS c ON c.ID = i.CustomerID " + SKUfilter1
                            + " where (1 = 1) and i.ServiceType = 'Sales' and i.LayawayNo = @prm  " 
                            + CategoryFilter 
                            + " group by i.LayawayNo,i.CustomerID,c.CustomerID,c.LastName,c.FirstName, c.Company,i.Coupon "
                            + " order by i.LayawayNo desc ";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@prm"].Value = PID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("VoidNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Coupon", System.Type.GetType("System.String"));

                string strPrevInv = "";
                string strCustID = "";
                string strCustName = "";
                string strCustCompany = "";
                string strVoid = "Y";
                string strVoidNo = "0";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["CID"].ToString() != "0")
                    {
                        strCustID = objSQLReader["CustID"].ToString();
                        strCustName = objSQLReader["Customer"].ToString();
                        strCustCompany = objSQLReader["CustCompany"].ToString();
                    }
                    else
                    {
                        strCustID = "";
                        strCustName = "";
                        strCustCompany = "";
                    }

                    strVoid = "Y";
                    strVoidNo = "0";
                    if (Category == 0)
                    {
                        strVoidNo = objSQLReader["VoidNo"].ToString();
                        if (CURCID == Functions.fnInt32(objSQLReader["CloseoutID"].ToString())) strVoid = "Y";
                        else strVoid = "N";
                        if (strVoidNo != "0") strVoid = "N";
                    }
                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {objSQLReader["InvoiceNo"].ToString(),
                                                Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                objSQLReader["CID"].ToString(),
                                                strCustID,
                                                strCustName,strCustCompany,strVoidNo,strVoid,
                                                Functions.fnDouble(objSQLReader["Coupon"].ToString()) });
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchReprintRecord(int pInvNo, int Category)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            if (Category == 0) // Invoice
            {
                strSQLComm = " select * from Item where InvoiceNo = @InvoiceNo and tagged <> 'X' and producttype not in ('C','Z','H') ";
            }

            if (Category == 1) // Layaway
            {
                strSQLComm = " select i.* from Item i left outer join Invoice v on i.InvoiceNo = v.ID "
                           + " where v.LayawayNo = @InvoiceNo and i.Tagged <> 'X' and producttype not in ('C','Z','H') "
                           + " and (v.Status = 1 or v.status=3) and v.LayawayNo > 0 ";   //  this check is added to stop showing already returned/refunded layaways
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("ReturnedItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnedItemCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CheckReturned", System.Type.GetType("System.Boolean"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("MixMatchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));

                dtbl.Columns.Add("DTaxID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("QtyDecimal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Age", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOM", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["InvoiceNo"].ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                Functions.fnDouble(objSQLReader["Qty"].ToString()) - Functions.fnDouble(objSQLReader["ReturnedItemCnt"].ToString()),
                                                objSQLReader["ReturnedItemID"].ToString(),
                                                objSQLReader["ReturnedItemCnt"].ToString(),true,
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["TaxType1"].ToString(),
                                                objSQLReader["TaxType2"].ToString(),
                                                objSQLReader["TaxType3"].ToString(),
                                                objSQLReader["TaxTotal1"].ToString(),
                                                objSQLReader["TaxTotal2"].ToString(),
                                                objSQLReader["TaxTotal3"].ToString(),

                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),

                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),

                                                objSQLReader["MixMatchID"].ToString(),

                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesLogic"].ToString(),
                                                objSQLReader["FeesValue"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTaxRate"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),

                                                objSQLReader["DTaxID"].ToString(),
                                                objSQLReader["DTaxType"].ToString(),
                                                objSQLReader["DTaxRate"].ToString(),
                                                objSQLReader["DTax"].ToString(),
                                                objSQLReader["EditFlag"].ToString(),
                                                objSQLReader["QtyDecimal"].ToString(),
                                                objSQLReader["PromptPrice"].ToString(),
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString(),
                                                objSQLReader["Age"].ToString(),
                                                objSQLReader["TaxIncludeRate"].ToString(),
                                                objSQLReader["TaxIncludePrice"].ToString(),
                                                objSQLReader["UOM"].ToString()
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchGCReceiptRecord(int pInvNo)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from Item where InvoiceNo = @InvoiceNo and tagged <> 'X' and producttype not in ('C','Z','H') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("ReturnedItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnedItemCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CheckReturned", System.Type.GetType("System.Boolean"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MixMatchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PrintChecked", System.Type.GetType("System.Boolean"));

                int cnt = 0;
                while (objSQLReader.Read())
                {
                    cnt++;
                    bool f = false;
                    if (cnt == 1) f = true;

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                Functions.fnDouble(objSQLReader["Qty"].ToString()) - Functions.fnDouble(objSQLReader["ReturnedItemCnt"].ToString()),
                                                objSQLReader["ReturnedItemID"].ToString(),
                                                objSQLReader["ReturnedItemCnt"].ToString(),false,
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["TaxType1"].ToString(),
                                                objSQLReader["TaxType2"].ToString(),
                                                objSQLReader["TaxType3"].ToString(),
                                                objSQLReader["TaxTotal1"].ToString(),
                                                objSQLReader["TaxTotal2"].ToString(),
                                                objSQLReader["TaxTotal3"].ToString(),
                                                objSQLReader["MixMatchID"].ToString(),
                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesLogic"].ToString(),
                                                objSQLReader["FeesValue"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTaxRate"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),
                                                f
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRentHeaderData(int PID, int CID, int DID, DateTime FDT, DateTime TDT,
            int AID, double FAmt, double TAmt, int CURCID, int InvFilter, string StoreCd)
        {
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;

            DataTable dtbl = new DataTable();
            string SKUfilter1 = "";
            string SKUfilter2 = "";
            string Customerfilter = "";
            string strSQLComm = "";
            string Datefilter1 = "";
            string Amtfilter1 = "";

            string sqlInvFilter = "";

            if (InvFilter == 0)
            {
                sqlInvFilter = " and i.Status = 15 and i.RentReturnFlag = 'N' ";
            }
            
            if (CID > 0)
            {
                Customerfilter = " and c.ID = @CID ";
            }

            if (PID > 0)
            {
                SKUfilter1 = " left outer join item it on it.InvoiceNo = i.ID ";
                SKUfilter2 = " and it.ProductID = @PID and it.Tagged <> 'X' ";
            }

            if (DID == 1)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                Datefilter1 = " and i.CreatedOn > @DT1";
            }
            if (DID == 2)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 23, 59, 59);
                Datefilter1 = " and i.CreatedOn < @DT1";
            }

            if (DID == 3)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                FormatEndDate = new DateTime(TDT.Year, TDT.Month, TDT.Day, 23, 59, 59);
                Datefilter1 = " and i.CreatedOn between @DT1 and @DT2 ";
            }

            if (AID == 1)
            {
                Amtfilter1 = " and i.TotalSale > @AT1";
            }
            if (AID == 2)
            {
                Amtfilter1 = " and i.TotalSale < @AT1";
            }

            if (AID == 3)
            {
                Amtfilter1 = " and i.TotalSale between @AT1 and  @AT2 ";
            }

            strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,i.CustomerID as CID,isnull(c.CustomerID, '') as CustID, "
                       + " c.LastName + ', ' + c.FirstName AS Customer,isnull(c.Company, '') as CustCompany, "
                       + " isnull(v.InvoiceNo,0) as VoidNo,t.CloseoutID,i.Status as RentStatus,i.RentDeposit,i.RentReturnDeposit, "
                       + " i.RentDeposit - i.RentReturnDeposit as ReturnDeposit,i.RentReturnFlag,t.TransDate,i.IsRentCalculated from trans t "
                       + " left outer join invoice as i on t.ID = i.TransactionNo left outer join customer as c on c.ID = i.CustomerID and c.issuestore='" + StoreCd + "' "
                       + SKUfilter1 + " left outer join voidinv v on v.InvoiceNo = i.ID where (1 = 1) "
                       + " and i.ServiceType = 'Rent' "
                       + SKUfilter2 + Customerfilter + Datefilter1 + Amtfilter1 + sqlInvFilter + " order by i.ID desc ";
            
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (CID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CID"].Value = CID;
            }

            if (PID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@PID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@PID"].Value = PID;
            }

            if ((DID == 1) || (DID == 2))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
            }

            if (DID == 3)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
                objSQlComm.Parameters.Add(new SqlParameter("@DT2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT2"].Value = FormatEndDate;
            }

            if ((AID == 1) || (AID == 2))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@AT1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@AT1"].Value = FAmt;
            }

            if (AID == 3)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@AT1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@AT1"].Value = FAmt;
                objSQlComm.Parameters.Add(new SqlParameter("@AT2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@AT2"].Value = TAmt;
            }

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("VoidNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDeposit", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RentReturnDeposit", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("DepositReturn", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RentReturnFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo4", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsRentCalculated", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CanVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));

                string strPrevInv = "";
                string strCustID = "";
                string strCustName = "";
                string strCustCompany = "";
                string strVoid = "Y";
                string strVoidNo = "0";
                string voidflg = "Y";

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CID"].ToString() != "0")
                    {
                        strCustID = objSQLReader["CustID"].ToString();
                        strCustName = objSQLReader["Customer"].ToString();
                        strCustCompany = objSQLReader["CustCompany"].ToString();
                    }
                    else
                    {
                        strCustID = "";
                        strCustName = "";
                        strCustCompany = "";
                    }

                    string info1 = "";
                    string info2 = "";
                    string info4 = "";
                    voidflg = "Y";
                    strVoid = "Y";
                    strVoidNo = "0";
                    strVoidNo = objSQLReader["VoidNo"].ToString();
                    if (CURCID == Functions.fnInt32(objSQLReader["CloseoutID"].ToString())) strVoid = "Y";
                    else strVoid = "N";
                    if (strVoidNo != "0") strVoid = "N";

                    if (Functions.fnInt32(objSQLReader["InvoiceNo"].ToString()) == Functions.fnInt32(objSQLReader["VoidNo"].ToString()))
                    {
                        info4 = "void";
                        voidflg = "N";
                    }

                    info1 = "Inv # " + objSQLReader["InvoiceNo"].ToString();



                    if (Functions.fnInt32(objSQLReader["CID"].ToString()) > 0)
                    {
                        info2 = "Customer : " + strCustName;
                    }



                    if (Functions.fnInt32(objSQLReader["RentStatus"].ToString()) == 15)
                    {
                        if (objSQLReader["IsRentCalculated"].ToString() == "N")
                        {
                            if (info2 == "") 
                                info2 = "Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                            else 
                                info2 = info2 + "\n" + "Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                        }

                        if (Functions.fnDouble(objSQLReader["RentDeposit"].ToString()) > 0)
                        {
                            if (info2 == "") 
                                info2 = "Deposit " + Functions.fnDouble(objSQLReader["RentDeposit"].ToString()).ToString("f");
                            else 
                                info2 = info2 + "\n" + "Deposit " + Functions.fnDouble(objSQLReader["RentDeposit"].ToString()).ToString("f");
                        }
                        if (objSQLReader["RentReturnFlag"].ToString() == "Y")
                        {
                            info4 = "closed";
                            voidflg = "N";
                        }
                        else
                        {
                            if (Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()) > 0)
                            {
                                if (info2 == "") 
                                    info2 = "Return Deposit " + Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()).ToString("f");
                                else 
                                    info2 = info2 + "\n" + "Return Deposit " + Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()).ToString("f");
                            }
                        }
                    }

                    if (Functions.fnInt32(objSQLReader["RentStatus"].ToString()) == 16)
                    {
                        voidflg = "N";
                        info4 = "returned";
                        if (Functions.fnDouble(objSQLReader["RentDeposit"].ToString()) < 0)
                        {
                            if (info2 == "") 
                                info2 = "Return Deposit " + (-Functions.fnDouble(objSQLReader["RentDeposit"].ToString())).ToString("f");
                            else 
                                info2 = info2 + "\n" + "Return Deposit " + (-Functions.fnDouble(objSQLReader["RentDeposit"].ToString())).ToString("f");
                        }
                    }

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {
                                                        objSQLReader["InvoiceNo"].ToString(),
                                                        Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                        objSQLReader["CID"].ToString(),
                                                        strCustID,strCustName,strCustCompany,strVoidNo,strVoid,
                                                        objSQLReader["RentStatus"].ToString(),
                                                        Functions.fnDouble(objSQLReader["RentDeposit"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()),
                                                        Functions.fnDouble(objSQLReader["ReturnDeposit"].ToString()),
                                                        objSQLReader["RentReturnFlag"].ToString(),info1,info2,
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("d") + "\n" +
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("t"),
                                                        info4,objSQLReader["IsRentCalculated"].ToString(),voidflg,
                                                        objSQLReader["TransDate"].ToString()
                                                });
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRentHeaderData_Specific(int PID,int CURCID, int InvFilter, string StoreCd)
        {
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;

            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            string sqlInvFilter = "";

            if (InvFilter == 0)
            {
                sqlInvFilter = " and i.Status = 15 and i.RentReturnFlag = 'N' ";
            }

            strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,i.CustomerID as CID,isnull(c.CustomerID, '') as CustID, "
                       + " c.LastName + ', ' + c.FirstName AS Customer,isnull(c.Company, '') as CustCompany, "
                       + " isnull(v.InvoiceNo,0) as VoidNo,t.CloseoutID,i.Status as RentStatus,i.RentDeposit,i.RentReturnDeposit, "
                       + " i.RentDeposit - i.RentReturnDeposit as ReturnDeposit,i.RentReturnFlag,t.TransDate,i.IsRentCalculated from trans t "
                       + " left outer join invoice as i on t.ID = i.TransactionNo left outer join customer as c on c.ID = i.CustomerID and c.issuestore='" + StoreCd + "' "
                       + " left outer join voidinv v on v.InvoiceNo = i.ID where (1 = 1) "
                       + " and i.ServiceType = 'Rent' and i.ID = @PID "
                       + sqlInvFilter + " order by i.ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@PID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@PID"].Value = PID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("VoidNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDeposit", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RentReturnDeposit", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("DepositReturn", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RentReturnFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentInfo4", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsRentCalculated", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CanVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));

                string strPrevInv = "";
                string strCustID = "";
                string strCustName = "";
                string strCustCompany = "";
                string strVoid = "Y";
                string strVoidNo = "0";
                string voidflg = "Y";

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CID"].ToString() != "0")
                    {
                        strCustID = objSQLReader["CustID"].ToString();
                        strCustName = objSQLReader["Customer"].ToString();
                        strCustCompany = objSQLReader["CustCompany"].ToString();
                    }
                    else
                    {
                        strCustID = "";
                        strCustName = "";
                        strCustCompany = "";
                    }

                    string info1 = "";
                    string info2 = "";
                    string info4 = "";
                    voidflg = "Y";
                    strVoid = "Y";
                    strVoidNo = "0";
                    strVoidNo = objSQLReader["VoidNo"].ToString();
                    if (CURCID == Functions.fnInt32(objSQLReader["CloseoutID"].ToString())) strVoid = "Y";
                    else strVoid = "N";
                    if (strVoidNo != "0") strVoid = "N";

                    if (Functions.fnInt32(objSQLReader["InvoiceNo"].ToString()) == Functions.fnInt32(objSQLReader["VoidNo"].ToString()))
                    {
                        info4 = "void";
                        voidflg = "N";
                    }

                    info1 = "Inv # " + objSQLReader["InvoiceNo"].ToString();



                    if (Functions.fnInt32(objSQLReader["CID"].ToString()) > 0)
                    {
                        info2 = "Customer : " + strCustName;
                    }



                    if (Functions.fnInt32(objSQLReader["RentStatus"].ToString()) == 15)
                    {
                        if (objSQLReader["IsRentCalculated"].ToString() == "N")
                        {
                            if (info2 == "")
                                info2 = "Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                            else
                                info2 = info2 + "\n" + "Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                        }

                        if (Functions.fnDouble(objSQLReader["RentDeposit"].ToString()) > 0)
                        {
                            if (info2 == "")
                                info2 = "Deposit " + Functions.fnDouble(objSQLReader["RentDeposit"].ToString()).ToString("f");
                            else
                                info2 = info2 + "\n" + "Deposit " + Functions.fnDouble(objSQLReader["RentDeposit"].ToString()).ToString("f");
                        }
                        if (objSQLReader["RentReturnFlag"].ToString() == "Y")
                        {
                            info4 = "closed";
                            voidflg = "N";
                        }
                        else
                        {
                            if (Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()) > 0)
                            {
                                if (info2 == "")
                                    info2 = "Return Deposit " + Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()).ToString("f");
                                else
                                    info2 = info2 + "\n" + "Return Deposit " + Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()).ToString("f");
                            }
                        }
                    }

                    if (Functions.fnInt32(objSQLReader["RentStatus"].ToString()) == 16)
                    {
                        voidflg = "N";
                        info4 = "returned";
                        if (Functions.fnDouble(objSQLReader["RentDeposit"].ToString()) < 0)
                        {
                            if (info2 == "")
                                info2 = "Return Deposit " + (-Functions.fnDouble(objSQLReader["RentDeposit"].ToString())).ToString("f");
                            else
                                info2 = info2 + "\n" + "Return Deposit " + (-Functions.fnDouble(objSQLReader["RentDeposit"].ToString())).ToString("f");
                        }
                    }

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {
                                                        objSQLReader["InvoiceNo"].ToString(),
                                                        Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                        objSQLReader["CID"].ToString(),
                                                        strCustID,strCustName,strCustCompany,strVoidNo,strVoid,
                                                        objSQLReader["RentStatus"].ToString(),
                                                        Functions.fnDouble(objSQLReader["RentDeposit"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RentReturnDeposit"].ToString()),
                                                        Functions.fnDouble(objSQLReader["ReturnDeposit"].ToString()),
                                                        objSQLReader["RentReturnFlag"].ToString(),info1,info2,
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("d") + "\n" +
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("t"),
                                                        info4,objSQLReader["IsRentCalculated"].ToString(),voidflg,
                                                        objSQLReader["TransDate"].ToString()
                                                });
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRentDetailData(int pInvNo,string pCalc, string returnflag)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            if (returnflag == "N")
            {
                strSQLComm = " select * from item where InvoiceNo = @InvoiceNo and tagged <> 'X' and producttype not in ('C','Z','H') "
                           + " and ServiceType = 'Rent' and qty - ReturnedItemCnt <> 0 ";
            }
            if (returnflag == "Y")
            {
                strSQLComm = " select * from item where InvoiceNo = @InvoiceNo and tagged <> 'X' and producttype not in ('C','Z','H') "
                           + " and ServiceType = 'Rent' and RentReturnFlag = 'N' ";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentQty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("ReturnedItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnedItemCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnCheck", System.Type.GetType("System.Boolean"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDuration", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDeposit", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentDurationDisplay", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditFlag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PromptPrice", System.Type.GetType("System.String"));

                double rentperiod = 0;
                while (objSQLReader.Read())
                {
                    string displaystr = "NA";
                    string rntapp = objSQLReader["RentApplicable"].ToString();
                    if (pCalc == "Y")
                    {
                        DateTime dt = Functions.fnDate(objSQLReader["RentEffectiveFrom"].ToString());
                        TimeSpan ts = DateTime.Now.Subtract(dt);
                        double dy = Math.Ceiling(ts.TotalDays);
                        double hr = Math.Ceiling(ts.TotalHours);
                        double mi = Math.Ceiling(ts.TotalMinutes);
                        if (rntapp == "MI")
                        {
                            rentperiod = mi;
                            int v = 0;
                            if (int.TryParse(mi.ToString(), out v)) displaystr = v.ToString() + " min.";
                            else displaystr = rentperiod.ToString("f") + " min.";
                        }

                        if (rntapp == "HR")
                        {
                            rentperiod = hr;
                            int v = 0;
                            if (int.TryParse(hr.ToString(), out v)) displaystr = v.ToString() + " hr.";
                            else displaystr = rentperiod.ToString("f") + " hr.";
                        }

                        if (rntapp == "HD")
                        {
                            rentperiod = Math.Ceiling(hr / 12);
                            //if (hr >= 12) rentperiod = rentperiod + 1;
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " half day(s)";
                            else displaystr = rentperiod.ToString("f") + " half day(s)";
                        }

                        if (rntapp == "DY")
                        {
                            rentperiod = dy;
                            int v = 0;
                            if (int.TryParse(dy.ToString(), out v)) displaystr = v.ToString() + " day(s)";
                            else displaystr = rentperiod.ToString("f") + " day(s)";
                        }

                        if (rntapp == "WK")
                        {
                            rentperiod = Math.Ceiling(dy / 7);
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " week(s)";
                            else displaystr = rentperiod.ToString("f") + " week(s)";
                        }

                        if (rntapp == "MN")
                        {
                            rentperiod = Math.Ceiling(dy / 30);
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " month(s)";
                            else displaystr = rentperiod.ToString("f") + " wmontheek(s)";
                        }
                    }

                    else
                    {

                        rentperiod = Math.Ceiling(Functions.fnDouble(objSQLReader["RentDuration"].ToString()));


                        if (rntapp == "MI")
                        {
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " min.";
                            else displaystr = rentperiod.ToString("f") + " min.";
                        }

                        if (rntapp == "HR")
                        {
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " hr.";
                            else displaystr = rentperiod.ToString("f") + " hr.";
                        }

                        if (rntapp == "HD")
                        {
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " half day(s)";
                            else displaystr = rentperiod.ToString("f") + " half day(s)";
                        }

                        if (rntapp == "DY")
                        {
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " day(s)";
                            else displaystr = rentperiod.ToString("f") + " day(s)";
                        }

                        if (rntapp == "WK")
                        {
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " week(s)";
                            else displaystr = rentperiod.ToString("f") + " week(s)";
                        }

                        if (rntapp == "MN")
                        {
                            int v = 0;
                            if (int.TryParse(rentperiod.ToString(), out v)) displaystr = v.ToString() + " month(s)";
                            else displaystr = rentperiod.ToString("f") + " wmontheek(s)";
                        }

                    }


                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                Functions.fnDouble(objSQLReader["Qty"].ToString()),
                                                Functions.fnDouble(objSQLReader["Qty"].ToString()) - Functions.fnDouble(objSQLReader["ReturnedItemCnt"].ToString()),
                                                objSQLReader["ReturnedItemID"].ToString(),
                                                objSQLReader["ReturnedItemCnt"].ToString(),false,
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["RentApplicable"].ToString(),
                                                rentperiod.ToString("f"),
                                                objSQLReader["RentDeposit"].ToString(),
                                                displaystr,
                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),
                                                objSQLReader["TaxType1"].ToString(),
                                                objSQLReader["TaxType2"].ToString(),
                                                objSQLReader["TaxType3"].ToString(),
                                                objSQLReader["TaxTotal1"].ToString(),
                                                objSQLReader["TaxTotal2"].ToString(),
                                                objSQLReader["TaxTotal3"].ToString(),
                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesLogic"].ToString(),
                                                objSQLReader["FeesValue"].ToString(),
                                                objSQLReader["FeesTaxRate"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),
                                                objSQLReader["EditFlag"].ToString(),
                                                objSQLReader["PromptPrice"].ToString()
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRepairHeaderData(int PID,int CID,int DID,DateTime FDT,DateTime TDT,int RNO, string RITM,
                                               int CURCID,int InvFilter,string StoreCd)
        {
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;

            DataTable dtbl = new DataTable();
            string SKUfilter1 = "";
            string SKUfilter2 = "";
            string Customerfilter = "";
            string strSQLComm = "";
            string Datefilter1 = "";
            string RepairNoFilter = "";
            string RepairItemFilter = "";
            string sqlInvFilter = "";

            if (InvFilter == 0)
            {
                sqlInvFilter = " and i.Status = 17 and i.RepairStatus = 'In' ";
            }
            if (InvFilter == 1)
            {
                sqlInvFilter = " and (i.Status = 17 or i.Status = 4 )";
            }
            
            if (RNO > 0)
            {
                RepairNoFilter = " and i.ID = " + RNO.ToString();
            }

            if (RITM != "")
            {
                RepairItemFilter = " and i.RepairItemName like '%" + RITM.ToString()+ "%'" ;
            }

            if (CID > 0)
            {
                Customerfilter = " and c.ID = @CID ";
            }

            if (PID > 0)
            {
                SKUfilter1 = " left outer join item it on it.InvoiceNo = i.ID ";
                SKUfilter2 = " and it.ProductID = @PID and it.Tagged <> 'X' ";
            }

            if (DID == 1)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                Datefilter1 = " and i.CreatedOn > @DT1";
            }
            if (DID == 2)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 23, 59, 59);
                Datefilter1 = " and i.CreatedOn < @DT1";
            }
            if (DID == 3)
            {
                FormatStartDate = new DateTime(FDT.Year, FDT.Month, FDT.Day, 0, 0, 1);
                FormatEndDate = new DateTime(TDT.Year, TDT.Month, TDT.Day, 23, 59, 59);
                Datefilter1 = " and i.CreatedOn between @DT1 and @DT2 ";
            }

            strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,i.CustomerID as CID,isnull(c.CustomerID, '') as CustID,"
                       + " c.LastName + ', ' + c.FirstName AS Customer,isnull(c.Company, '') as CustCompany,"
                       + " isnull(v.InvoiceNo,0) as VoidNo,t.CloseoutID,i.Status as Status,i.RepairAmount,i.RepairAdvanceAmount,"
                       + " i.RepairDueAmount,i.RepairStatus,isnull(i.RepairDeliveryDate,'') as ExpectedDeliveryDate, "
                       + " isnull(i.RepairNotifiedDate,'') as NotifiedDate,t.TransDate,i.RepairParentID, "
                       + " isnull(i.RepairItemName,'') as RItem,isnull(i.RepairItemSlNo,'') as RSl from trans t left outer join invoice as i "
                       + " on t.ID = i.TransactionNo left outer join customer as c on c.ID = i.CustomerID "
                       + SKUfilter1 + " left outer join voidinv v on v.InvoiceNo = i.ID where (1 = 1) and i.ServiceType = 'Repair' and c.issuestore='" + StoreCd + "' "
                       + SKUfilter2 + Customerfilter + Datefilter1 + RepairNoFilter + RepairItemFilter + sqlInvFilter
                       + " order by i.ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (CID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CID"].Value = CID;
            }

            if (PID > 0)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@PID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@PID"].Value = PID;
            }

            if ((DID == 1) || (DID == 2))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
            }

            if (DID == 3)
            {
                objSQlComm.Parameters.Add(new SqlParameter("@DT1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT1"].Value = FormatStartDate;
                objSQlComm.Parameters.Add(new SqlParameter("@DT2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@DT2"].Value = FormatEndDate;
            }

            

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("VoidNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Status", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairAdvanceAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairDueAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo4", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo5", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditMode", System.Type.GetType("System.Boolean"));
                string strPrevInv = "";
                string strCustID = "";
                string strCustName = "";
                string strCustCompany = "";
                string strVoid = "Y";
                string strVoidNo = "0";

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CID"].ToString() != "0")
                    {
                        strCustID = objSQLReader["CustID"].ToString();
                        strCustName = objSQLReader["Customer"].ToString();
                        strCustCompany = objSQLReader["CustCompany"].ToString();
                    }
                    else
                    {
                        strCustID = "";
                        strCustName = "";
                        strCustCompany = "";
                    }
                    string info1 = "";
                    string info2 = "";
                    string info4 = "";
                    string info5 = "";
                    strVoid = "Y";
                    strVoidNo = "0";
                    strVoidNo = objSQLReader["VoidNo"].ToString();
                    if (strVoidNo != "0") strVoid = "N";

                    if (Functions.fnInt32(objSQLReader["Status"].ToString()) == 17)
                    {
                        info1 = "Repair #: " + objSQLReader["InvoiceNo"].ToString();
                    }
                    else
                    {
                        info1 = "Invoice #: " + objSQLReader["InvoiceNo"].ToString();
                    }

                    if (Functions.fnInt32(objSQLReader["CID"].ToString()) > 0)
                    {
                        info2 = "Customer : " + strCustName;
                    }
                    if (Functions.fnInt32(objSQLReader["Status"].ToString()) == 17)
                    {
                        /*if (Functions.fnDouble(objSQLReader["Amount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                        }*/

                        if (Functions.fnDouble(objSQLReader["RepairAmount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Repair Amt. " + Functions.fnDouble(objSQLReader["RepairAmount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Repair Amt. " + Functions.fnDouble(objSQLReader["RepairAmount"].ToString()).ToString("f");
                        }

                        if (Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Deposit " + Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Deposit " + Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()).ToString("f");
                        }
                        info4 = objSQLReader["RepairStatus"].ToString();

                        if (objSQLReader["RItem"].ToString() != "")
                        {
                            info5 = "Item : " + objSQLReader["RItem"].ToString();
                        }

                        if (objSQLReader["RSl"].ToString() != "")
                        {
                            if (info5 == "") info5 = "Serial # " + objSQLReader["RSl"].ToString();
                            else info5 = info5 + "\n" + "Serial # " + objSQLReader["RSl"].ToString();
                        }
                        
                        /*if (objSQLReader["RepairStatus"].ToString() != "Delivered")
                        {
                            if (Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()) > 0)
                            {
                                if (info2 == "") info2 = "Due " + Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()).ToString("f");
                                else info2 = info2 + "\n" + "Due " + Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()).ToString("f");
                            }
                        }*/
                    }

                    if (Functions.fnInt32(objSQLReader["Status"].ToString()) == 18)
                    {
                        info4 = objSQLReader["RepairStatus"].ToString();

                        /*if (Functions.fnDouble(objSQLReader["Amount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                        }*/
                    }

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {
                                                        objSQLReader["InvoiceNo"].ToString(),
                                                        Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                        objSQLReader["CID"].ToString(),
                                                        strCustID,
                                                        strCustName,
                                                        strCustCompany,
                                                        strVoidNo,
                                                        strVoid,
                                                        objSQLReader["Status"].ToString(),
                                                        Functions.fnDouble(objSQLReader["RepairAmount"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()),
                                                        objSQLReader["RepairStatus"].ToString(),
                                                        info1,info2,
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("d") + "\n" +
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("t"),
                                                        info4,info5, objSQLReader["RepairParentID"].ToString(),
                                                        strVoid == "N" ? false : true
                                                });
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRepairHeaderData_Specific(int PID, int InvFilter, string StoreCd)
        {
            DateTime FormatStartDate = DateTime.Now;
            DateTime FormatEndDate = DateTime.Now;

            DataTable dtbl = new DataTable();
            string SKUfilter1 = "";
            string SKUfilter2 = "";
            string Customerfilter = "";
            string strSQLComm = "";
            string Datefilter1 = "";
            string RepairNoFilter = "";
            string RepairItemFilter = "";
            string sqlInvFilter = "";

            if (InvFilter == 0)
            {
                sqlInvFilter = " and i.Status = 17 and i.RepairStatus = 'In' ";
            }
            if (InvFilter == 1)
            {
                sqlInvFilter = " and (i.Status = 17 or i.Status = 4 )";
            }

            
            strSQLComm = " select i.ID as InvoiceNo,i.TotalSale as Amount,i.CustomerID as CID,isnull(c.CustomerID, '') as CustID,"
                       + " c.LastName + ', ' + c.FirstName AS Customer,isnull(c.Company, '') as CustCompany,"
                       + " isnull(v.InvoiceNo,0) as VoidNo,t.CloseoutID,i.Status as Status,i.RepairAmount,i.RepairAdvanceAmount,"
                       + " i.RepairDueAmount,i.RepairStatus,isnull(i.RepairDeliveryDate,'') as ExpectedDeliveryDate, "
                       + " isnull(i.RepairNotifiedDate,'') as NotifiedDate,t.TransDate,i.RepairParentID, "
                       + " isnull(i.RepairItemName,'') as RItem,isnull(i.RepairItemSlNo,'') as RSl from trans t left outer join invoice as i "
                       + " on t.ID = i.TransactionNo left outer join customer as c on c.ID = i.CustomerID "
                       + SKUfilter1 + " left outer join voidinv v on v.InvoiceNo = i.ID where (1 = 1) and i.ID = @PID and i.ServiceType = 'Repair' and c.issuestore='" + StoreCd + "' "
                       + sqlInvFilter
                       + " order by i.ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@PID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@PID"].Value = PID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Company", System.Type.GetType("System.String"));
                dtbl.Columns.Add("VoidNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsVoid", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Status", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairAdvanceAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairDueAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo4", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RprInfo5", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ParentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EditMode", System.Type.GetType("System.Boolean"));
                string strPrevInv = "";
                string strCustID = "";
                string strCustName = "";
                string strCustCompany = "";
                string strVoid = "Y";
                string strVoidNo = "0";

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CID"].ToString() != "0")
                    {
                        strCustID = objSQLReader["CustID"].ToString();
                        strCustName = objSQLReader["Customer"].ToString();
                        strCustCompany = objSQLReader["CustCompany"].ToString();
                    }
                    else
                    {
                        strCustID = "";
                        strCustName = "";
                        strCustCompany = "";
                    }
                    string info1 = "";
                    string info2 = "";
                    string info4 = "";
                    string info5 = "";
                    strVoid = "Y";
                    strVoidNo = "0";
                    strVoidNo = objSQLReader["VoidNo"].ToString();
                    if (strVoidNo != "0") strVoid = "N";

                    if (Functions.fnInt32(objSQLReader["Status"].ToString()) == 17)
                    {
                        info1 = "Repair #: " + objSQLReader["InvoiceNo"].ToString();
                    }
                    else
                    {
                        info1 = "Invoice #: " + objSQLReader["InvoiceNo"].ToString();
                    }

                    if (Functions.fnInt32(objSQLReader["CID"].ToString()) > 0)
                    {
                        info2 = "Customer : " + strCustName;
                    }
                    if (Functions.fnInt32(objSQLReader["Status"].ToString()) == 17)
                    {
                        /*if (Functions.fnDouble(objSQLReader["Amount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                        }*/

                        if (Functions.fnDouble(objSQLReader["RepairAmount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Repair Amt. " + Functions.fnDouble(objSQLReader["RepairAmount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Repair Amt. " + Functions.fnDouble(objSQLReader["RepairAmount"].ToString()).ToString("f");
                        }

                        if (Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Deposit " + Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Deposit " + Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()).ToString("f");
                        }
                        info4 = objSQLReader["RepairStatus"].ToString();

                        if (objSQLReader["RItem"].ToString() != "")
                        {
                            info5 = "Item : " + objSQLReader["RItem"].ToString();
                        }

                        if (objSQLReader["RSl"].ToString() != "")
                        {
                            if (info5 == "") info5 = "Serial # " + objSQLReader["RSl"].ToString();
                            else info5 = info5 + "\n" + "Serial # " + objSQLReader["RSl"].ToString();
                        }

                        /*if (objSQLReader["RepairStatus"].ToString() != "Delivered")
                        {
                            if (Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()) > 0)
                            {
                                if (info2 == "") info2 = "Due " + Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()).ToString("f");
                                else info2 = info2 + "\n" + "Due " + Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()).ToString("f");
                            }
                        }*/
                    }

                    if (Functions.fnInt32(objSQLReader["Status"].ToString()) == 18)
                    {
                        info4 = objSQLReader["RepairStatus"].ToString();

                        /*if (Functions.fnDouble(objSQLReader["Amount"].ToString()) > 0)
                        {
                            if (info2 == "") info2 = "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                            else info2 = info2 + "\n" + "Tran Amt. " + Functions.fnDouble(objSQLReader["Amount"].ToString()).ToString("f");
                        }*/
                    }

                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {
                                                        objSQLReader["InvoiceNo"].ToString(),
                                                        Functions.fnDouble(objSQLReader["Amount"].ToString()),
                                                        objSQLReader["CID"].ToString(),
                                                        strCustID,
                                                        strCustName,
                                                        strCustCompany,
                                                        strVoidNo,
                                                        strVoid,
                                                        objSQLReader["Status"].ToString(),
                                                        Functions.fnDouble(objSQLReader["RepairAmount"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()),
                                                        objSQLReader["RepairStatus"].ToString(),
                                                        info1,info2,
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("d") + "\n" +
                                                        Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString("t"),
                                                        info4,info5, objSQLReader["RepairParentID"].ToString(),
                                                        strVoid == "N" ? false : true
                                                });
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRepairDetailData(int pInvNo, string returnflag)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            if ((returnflag == "In") || (returnflag == "Partly Delivered"))
            {
                strSQLComm = " select * from item where InvoiceNo = @InvoiceNo and tagged <> 'X' and producttype not in ('C','Z','H') "
                           + " and ServiceType = 'Repair' and RepairItemDeliveryDate is null ";
            }
            if (returnflag == "Delivered")
            {
                strSQLComm = " select * from item where InvoiceNo = @InvoiceNo and tagged <> 'X' and producttype not in ('C','Z','H') "
                           + " and ServiceType = 'Repair' and RepairItemDeliveryDate is not null ";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RentQty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("ReturnedItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnedItemCnt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnCheck", System.Type.GetType("System.Boolean"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemTag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSLNO", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemPurchaseDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemDeliveryDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemInfo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTaxRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {
                    string iteminfo = "";
                    
                    string displaystr1 = "";
                    if (objSQLReader["RepairItemPurchaseDate"].ToString() != "") displaystr1 = Functions.fnDate(objSQLReader["RepairItemPurchaseDate"].ToString()).ToString("d");
                    string displaystr2 = "";
                    if (objSQLReader["RepairItemDeliveryDate"].ToString() != "") displaystr2 = Functions.fnDate(objSQLReader["RepairItemDeliveryDate"].ToString()).ToString("d");

                    iteminfo = objSQLReader["Description"].ToString() + "  (SKU: " + objSQLReader["SKU"].ToString() + ")";
                    if (objSQLReader["RepairItemSLNO"].ToString() != "") iteminfo = iteminfo + "\n" + "sl. # " + objSQLReader["RepairItemSLNO"].ToString();
                    if (objSQLReader["RepairItemTag"].ToString() != "") iteminfo = iteminfo + "\n" + "Tag # " + objSQLReader["RepairItemTag"].ToString();

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                Functions.fnDouble(objSQLReader["Qty"].ToString()),
                                                Functions.fnDouble(objSQLReader["Qty"].ToString()) - Functions.fnDouble(objSQLReader["ReturnedItemCnt"].ToString()),
                                                objSQLReader["ReturnedItemID"].ToString(),
                                                objSQLReader["ReturnedItemCnt"].ToString(),false,
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["RepairItemTag"].ToString(),
                                                objSQLReader["RepairItemSLNO"].ToString(),
                                                displaystr1,displaystr2,iteminfo,
                                                objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesLogic"].ToString(),
                                                objSQLReader["FeesValue"].ToString(),
                                                objSQLReader["FeesTaxRate"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int FetchRepairParentOrder(int INVNO)
        {
            int intWNO = 0;
            string strSQLComm = " select repairparentid from invoice where id = @invoiceno ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intWNO = Functions.fnInt32(objSQLReader["repairparentid"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intWNO;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #region Update Receipt No

        public string UpdateReceiptCount(int INV, int CAT)
        {
            string strSQLComm = "";
            if (CAT == 0) // Invoice
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " update Invoice set ReceiptCnt=ReceiptCnt + 1, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn "
                               + " Where ID = @ID";
                }
                else
                {
                    strSQLComm = " update Invoice set ReceiptCnt=ReceiptCnt + 1, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn, "
                               + " ChangedByAdmin=@ChangedByAdmin,ChangedOnAdmin=@ChangedOnAdmin Where ID = @ID";
                }
            }

            if (CAT == 1) // Layaway
            {
                if (blFunctionButtonAccess)
                {
                    strSQLComm = " update Invoice set ReceiptCnt=ReceiptCnt + 1, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn "
                               + " Where LayawayNo = @ID";
                }
                else
                {
                    strSQLComm = " update Invoice set ReceiptCnt=ReceiptCnt + 1, "
                               + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn, "
                               + " ChangedByAdmin=@ChangedByAdmin,ChangedOnAdmin=@ChangedOnAdmin Where LayawayNo = @ID";
                }
            }
            

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = INV;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                if (!blFunctionButtonAccess)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedByAdmin", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters.Add(new SqlParameter("@ChangedOnAdmin", System.Data.SqlDbType.DateTime));
                    objSQlComm.Parameters["@ChangedByAdmin"].Value = intChangedByAdmin;
                    objSQlComm.Parameters["@ChangedOnAdmin"].Value = DateTime.Now;
                }

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        #endregion

        public int GetReceiptCount(int INV)
        {
            int intCount = 0;
            string strSQLComm = " select ReceiptCnt from Invoice where ID=@ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = INV;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        intCount = Functions.fnInt32(objsqlReader["ReceiptCnt"].ToString());
                    }
                    catch { objsqlReader.Close(); }
                    
                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intCount;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return intCount;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public DataTable FetchItemDetails(int pItemID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select i.*, isnull(m.ItemID,'0') as ItemID,isnull(m.MatrixOptionID,'0') as MatrixOptionID, "
                              + " isnull(m.OptionValue1,'') as OV1,isnull(m.OptionValue2,'') as OV2,isnull(m.OptionValue3,'') as OV3 "
                              + " from Item i left outer join itemmatrixoptions m on i.ID = m.ItemID where i.ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = pItemID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NormalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DepartmentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CategoryID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GPrice", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Price"].ToString(),
                                                objSQLReader["NormalPrice"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                objSQLReader["DepartmentID"].ToString(),
                                                objSQLReader["CategoryID"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),
                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),
                                                objSQLReader["UOMCount"].ToString(),
                                                objSQLReader["UOMPrice"].ToString(),
                                                objSQLReader["UOMDesc"].ToString(),
                                                objSQLReader["MatrixOptionID"].ToString(),
                                                objSQLReader["OV1"].ToString(),
                                                objSQLReader["OV2"].ToString(),
                                                objSQLReader["OV3"].ToString(),
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString(),
                                                objSQLReader["TaxIncludeRate"].ToString(),
                                                objSQLReader["TaxIncludePrice"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #region Layaway

        public DataTable FetchLayawayHeaderLayID(int LAYid,bool IncludeStatus )
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = @"select i.ID as InvoiceNo, i.TotalSale, i.LayawayNo, l.DateDue,  t.SKU, t.ID as ItemID, t.Description, t.Qty,t.Cost, t.ProductID, t.ProductType, 
                            isnull(m.MatrixOptionID,'0') as MatrixOptionID,  isnull(m.OptionValue1,'') as OV1, isnull(m.OptionValue2,'') as OV2,  isnull(m.OptionValue3,'') as OV3,
                            i.CustomerID
                            from Layaway l 
                            left outer join invoice i on l.ID = i.LayawayNo 
                            left outer join Item t on t.InvoiceNo = i.ID
                            left outer join itemmatrixoptions m on m.ItemID = t.ID  
                            where i.LayawayNo = @LayawayNo and
                            t.Tagged <> 'X' and producttype not in ('C','Z','H')
                            and(i.Status = 1 or i.status = 3)
                           ";
            if (IncludeStatus)
            {
              //  strSQLComm += " and(i.Status = 1 or i.status = 3)";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@LayawayNo"].Value = LAYid;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("LayawayNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateDue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalSale", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));


                while (objSQLReader.Read())
                {
                    string strDateTime = "";
                    if (objSQLReader["DateDue"].ToString() != "")
                    {
                        strDateTime = objSQLReader["DateDue"].ToString();
                        int inIndex = strDateTime.IndexOf(" ");
                        if (inIndex > 0)
                        {
                            strDateTime = strDateTime.Substring(0, inIndex).Trim();
                        }
                    }
                    else
                    {
                        strDateTime = objSQLReader["DateDue"].ToString();
                    }

                    dtbl.Rows.Add(new object[] {objSQLReader["LayawayNo"].ToString(),
                                                objSQLReader["InvoiceNo"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                strDateTime,
                                                objSQLReader["TotalSale"].ToString(),
                                                objSQLReader["ItemID"].ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["MatrixOptionID"].ToString(),
                                                objSQLReader["OV1"].ToString(),
                                                objSQLReader["OV2"].ToString(),
                                                objSQLReader["OV3"].ToString(),
                                                objSQLReader["CustomerID"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }
        public DataTable FetchLayawayHeader(int CID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select i.ID as InvoiceNo, i.TotalSale, i.LayawayNo, l.DateDue, "
                                + " t.SKU, t.ID as ItemID, t.Description, t.Qty,t.Cost, t.ProductID, t.ProductType,  "
                                + " isnull(m.MatrixOptionID,'0') as MatrixOptionID, "
                                + " isnull(m.OptionValue1,'') as OV1, isnull(m.OptionValue2,'') as OV2, "
                                + " isnull(m.OptionValue3,'') as OV3 "
                                + " from Layaway l left outer join invoice i on l.ID = i.LayawayNo "
                                + " left outer join item t on t.InvoiceNo = i.ID "
                                + " left outer join itemmatrixoptions m on m.ItemID = t.ID "
                                + " where i.LayawayNo > 0 and i.Status = 1 "
                                + " and i.CustomerID = @CID and t.Tagged <> 'X' order by i.ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@CID"].Value = CID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("LayawayNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DateDue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalSale", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue3", System.Type.GetType("System.String"));


                while (objSQLReader.Read())
                {
                    string strDateTime = "";
                    if (objSQLReader["DateDue"].ToString() != "")
                    {
                        strDateTime = objSQLReader["DateDue"].ToString();
                        int inIndex = strDateTime.IndexOf(" ");
                        if (inIndex > 0)
                        {
                            strDateTime = strDateTime.Substring(0, inIndex).Trim();
                        }
                    }
                    else
                    {
                        strDateTime = objSQLReader["DateDue"].ToString();
                    }

                    dtbl.Rows.Add(new object[] {objSQLReader["LayawayNo"].ToString(),
                                                objSQLReader["InvoiceNo"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                strDateTime,
                                                objSQLReader["TotalSale"].ToString(),
                                                objSQLReader["ItemID"].ToString(),
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["MatrixOptionID"].ToString(),
                                                objSQLReader["OV1"].ToString(),
                                                objSQLReader["OV2"].ToString(),
                                                objSQLReader["OV3"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public double FetchLayawayPayment(int INV)
        {
            double dblResult = 0;
            string strSQLComm = " select Sum(Payment) as Payment from Laypmts where InvoiceNo = @InvoiceNo ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvoiceNo"].Value = INV;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dblResult = Functions.fnDouble(objSQLReader["Payment"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblResult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double FetchLayawayTotalSale(int LAY)
        {
            double dblResult = 0;
            string strSQLComm = " select Sum(TotalSale) as TS from Invoice where LayawayNo = @LayawayNo and status in ('1','3') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@LayawayNo"].Value = LAY;

                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    if (objSQLReader["TS"].ToString() == "") 
                        dblResult = 0;
                    else 
                        dblResult = Functions.fnDouble(objSQLReader["TS"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblResult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double FetchLayawayTotalPayment(int LAY)
        {
            double dblResult = 0;
            string strSQLComm = " select Sum(l.Payment) as TP from laypmts l "
                              + " left outer join invoice i on l.invoiceno = i.ID "
                              + " where i.LayawayNo = @LayawayNo and i.status in ('1','3') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@LayawayNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@LayawayNo"].Value = LAY;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    if (objSQLReader["TP"].ToString() == "") dblResult = 0;
                    else 
                        dblResult = Functions.fnDouble(objSQLReader["TP"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblResult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #endregion

        public int FetchMaxInvoiceNo()
        {
            int intInvNo = 1;

            string strSQLComm = " select isnull(Max(ID),0) + 1 as MaxInvoice From Invoice ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    intInvNo = Functions.fnInt32(objSQLReader["MaxInvoice"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intInvNo;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 1;
            }
        }

        #region Insert Card Transaction For Payment gateway

        public string InsertCardTrans()
        {
            string strSQLComm =   " insert into CardTrans( CustomerID, EmployeeID, CardType,CardAmount, "
                                + " CreatedBy, CreatedOn, LastChangedBy, LastChangedOn,IsDebitCard,PaymentGateway,TerminalName,LogFileName ) "
                                + " values ( @CustomerID, @EmployeeID, @CardType,@CardAmount, "
                                + " @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn,@IsDebitCard,@PaymentGateway,@TerminalName,@LogFileName ) "
                                + " select @@IDENTITY as ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CardType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@CardAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@IsDebitCard", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@PaymentGateway", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@LogFileName", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CardType"].Value = strCardType;
                objSQlComm.Parameters["@CardAmount"].Value = dblCardAmount;
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                if (strCardType == "Debit Card")
                    objSQlComm.Parameters["@IsDebitCard"].Value = "Y";
                else
                    objSQlComm.Parameters["@IsDebitCard"].Value = "N";
                objSQlComm.Parameters["@PaymentGateway"].Value = intPaymentGateway;
                objSQlComm.Parameters["@TerminalName"].Value = strTerminalName;
                objSQlComm.Parameters["@LogFileName"].Value = strLogFileName;
                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        intCardTranID = Functions.fnInt32(objsqlReader["ID"]);
                    }
                    catch
                    {
                    }
                    objsqlReader.Close();
                }
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public string InsertCardTrans1()
        {
            string strSQLComm = " insert into CardTrans( CustomerID,EmployeeID,CardType,CardAmount,AuthCode,Reference,MercuryAcqRef,MercuryToken, "
                              + " MercuryInvoiceNo,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,IsDebitCard,PaymentGateway, "
                              + " MercuryProcessData,MercuryPurchaseAmount,MercuryTranCode,RefCardAct,RefCardMerchID,"
                              + " RefCardLogo,RefCardEntry,RefCardAuthID,RefCardTranID,RefCardAuthAmount,TransactionType, "
                              + " MercuryResponseOrigin,MercuryRecordNo,MercuryResponseReturnCode,MercuryTextResponse,AdjustFlag,TerminalName,LogFileName,IsComplete ) "
                              + " values (@CustomerID,@EmployeeID,@CardType,@CardAmount,@AuthCode,@Reference,@AcqRef,@Token, "
                              + " @MercuryInvoiceNo,@CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn,@IsDebitCard,@PaymentGateway, "
                              + " @MercuryProcessData,@MercuryPurchaseAmount,@MercuryTranCode,@RefCardAct,@RefCardMerchID, "
                              + " @RefCardLogo,@RefCardEntry,@RefCardAuthID,@RefCardTranID,@RefCardAuthAmount,@TranType, "
                              + " @MercuryResponseOrigin,@MercuryRecordNo,@MercuryResponseReturnCode,@MercuryTextResponse,'Y',@TerminalName,@LogFileName,'Y' ) "
                              + " select @@IDENTITY as ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CardType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@CardAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@IsDebitCard", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@PaymentGateway", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@AuthCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Reference", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@AcqRef", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Token", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryInvoiceNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryProcessData", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryTranCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryPurchaseAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@MercuryResponseOrigin", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryRecordNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryResponseReturnCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryTextResponse", System.Data.SqlDbType.VarChar));


                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAct", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardMerchID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardLogo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardEntry", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardTranID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TranType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@LogFileName", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CardType"].Value = strCardType;
                objSQlComm.Parameters["@CardAmount"].Value = dblCardAmount;
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@IsDebitCard"].Value = strIsDebit;
                objSQlComm.Parameters["@PaymentGateway"].Value = intPaymentGateway;
                objSQlComm.Parameters["@AuthCode"].Value = strAuthCode;
                objSQlComm.Parameters["@Reference"].Value = strReference;
                objSQlComm.Parameters["@AcqRef"].Value = strAcqRefData;
                objSQlComm.Parameters["@Token"].Value = strTokenData;
                objSQlComm.Parameters["@MercuryInvoiceNo"].Value = strMercuryInvNo;
                objSQlComm.Parameters["@MercuryProcessData"].Value = strMercuryProcessData;
                objSQlComm.Parameters["@MercuryTranCode"].Value = strMercuryTranCode;
                objSQlComm.Parameters["@MercuryPurchaseAmount"].Value = dblMercuryPurchaseAmount;

                objSQlComm.Parameters["@RefCardAct"].Value = strRefCardAct;
                objSQlComm.Parameters["@RefCardMerchID"].Value = strRefCardMerchID;
                objSQlComm.Parameters["@RefCardLogo"].Value = strRefCardLogo;
                objSQlComm.Parameters["@RefCardEntry"].Value = strRefCardEntry;
                objSQlComm.Parameters["@RefCardAuthID"].Value = strRefCardAuthID;
                objSQlComm.Parameters["@RefCardTranID"].Value = strRefCardTranID;
                objSQlComm.Parameters["@RefCardAuthAmount"].Value = dblRefCardAuthAmount;
                objSQlComm.Parameters["@TranType"].Value = strCardTranType;

                objSQlComm.Parameters["@MercuryResponseOrigin"].Value = strMercuryResponseOrigin;
                objSQlComm.Parameters["@MercuryRecordNo"].Value = strMercuryRecordNo;
                objSQlComm.Parameters["@MercuryResponseReturnCode"].Value = strMercuryResponseReturnCode;
                objSQlComm.Parameters["@MercuryTextResponse"].Value = strMercuryTextResponse;
                objSQlComm.Parameters["@TerminalName"].Value = strTerminalName;
                objSQlComm.Parameters["@LogFileName"].Value = strLogFileName;
                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        intCardTranID = Functions.fnInt32(objsqlReader["ID"]);
                    }
                    catch
                    {
                    }
                    objsqlReader.Close();
                }
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public string InsertCardTransAuth()
        {
            string strSQLComm = " insert into CardTrans( CustomerID,EmployeeID,CardType,CardAmount,AuthCode,Reference,MercuryAcqRef,MercuryToken, "
                              + " MercuryInvoiceNo,CreatedBy,CreatedOn,LastChangedBy,LastChangedOn,IsDebitCard,PaymentGateway, "
                              + " MercuryProcessData,MercuryPurchaseAmount,MercuryTranCode,RefCardAct,RefCardMerchID,"
                              + " RefCardLogo,RefCardEntry,RefCardAuthID,RefCardTranID,RefCardAuthAmount,TransactionType, "
                              + " MercuryResponseOrigin,MercuryRecordNo,MercuryResponseReturnCode,MercuryTextResponse,AdjustFlag,TransactionNo) "
                              + " values (@CustomerID,@EmployeeID,@CardType,@CardAmount,@AuthCode,@Reference,@AcqRef,@Token, "
                              + " @MercuryInvoiceNo,@CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn,@IsDebitCard,@PaymentGateway, "
                              + " @MercuryProcessData,@MercuryPurchaseAmount,@MercuryTranCode,@RefCardAct,@RefCardMerchID, "
                              + " @RefCardLogo,@RefCardEntry,@RefCardAuthID,@RefCardTranID,@RefCardAuthAmount,@TranType, "
                              + " @MercuryResponseOrigin,@MercuryRecordNo,@MercuryResponseReturnCode,@MercuryTextResponse,@AdjustFlag,@TransactionNo) "
                              + " select @@IDENTITY as ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CardType", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@CardAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@IsDebitCard", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@PaymentGateway", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@AuthCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Reference", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@AcqRef", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Token", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryInvoiceNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryProcessData", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryTranCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryPurchaseAmount", System.Data.SqlDbType.Float));

                objSQlComm.Parameters.Add(new SqlParameter("@MercuryResponseOrigin", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryRecordNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryResponseReturnCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryTextResponse", System.Data.SqlDbType.VarChar));


                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAct", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardMerchID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardLogo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardEntry", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardTranID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TranType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@AdjustFlag", System.Data.SqlDbType.Char));

                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CardType"].Value = strCardType;
                objSQlComm.Parameters["@CardAmount"].Value = dblCardAmount;
                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@IsDebitCard"].Value = strIsDebit;
                objSQlComm.Parameters["@PaymentGateway"].Value = intPaymentGateway;
                objSQlComm.Parameters["@AuthCode"].Value = strAuthCode;
                objSQlComm.Parameters["@Reference"].Value = strReference;
                objSQlComm.Parameters["@AcqRef"].Value = strAcqRefData;
                objSQlComm.Parameters["@Token"].Value = strTokenData;
                objSQlComm.Parameters["@MercuryInvoiceNo"].Value = strMercuryInvNo;
                objSQlComm.Parameters["@MercuryProcessData"].Value = strMercuryProcessData;
                objSQlComm.Parameters["@MercuryTranCode"].Value = strMercuryTranCode;
                objSQlComm.Parameters["@MercuryPurchaseAmount"].Value = dblMercuryPurchaseAmount;

                objSQlComm.Parameters["@RefCardAct"].Value = strRefCardAct;
                objSQlComm.Parameters["@RefCardMerchID"].Value = strRefCardMerchID;
                objSQlComm.Parameters["@RefCardLogo"].Value = strRefCardLogo;
                objSQlComm.Parameters["@RefCardEntry"].Value = strRefCardEntry;
                objSQlComm.Parameters["@RefCardAuthID"].Value = strRefCardAuthID;
                objSQlComm.Parameters["@RefCardTranID"].Value = strRefCardTranID;
                objSQlComm.Parameters["@RefCardAuthAmount"].Value = dblRefCardAuthAmount;
                objSQlComm.Parameters["@TranType"].Value = strCardTranType;

                objSQlComm.Parameters["@MercuryResponseOrigin"].Value = strMercuryResponseOrigin;
                objSQlComm.Parameters["@MercuryRecordNo"].Value = strMercuryRecordNo;
                objSQlComm.Parameters["@MercuryResponseReturnCode"].Value = strMercuryResponseReturnCode;
                objSQlComm.Parameters["@MercuryTextResponse"].Value = strMercuryTextResponse;

                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                objSQlComm.Parameters["@AdjustFlag"].Value = strAdjustFlag;

                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        intCardTranID = Functions.fnInt32(objsqlReader["ID"]);
                    }
                    catch
                    {
                    }
                    objsqlReader.Close();
                }
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        #endregion

        public void UpdateFSTender(SqlCommand objSQlComm)
        {
            if (dtblCardID == null) return;
            else
            {
                objSQlComm.Parameters.Clear();
                try
                {
                    string strSQLComm = " update item set FSTender = 'Y' where producttype in ('P','S','M','U','K','E','W') "
                                      + " and productid in ( select id from product where FoodStampEligible = 'Y') "
                                      + " and invoiceno in (select id  from invoice where TransactionNo=@TransactionNo) ";
                    
                    objSQlComm.CommandText = strSQLComm;

                    objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;

                    objSQlComm.ExecuteNonQuery();
                }
                catch (SqlException SQLDBException)
                {
                    strErrorMsg = SQLDBException.ToString();
                    SaveTran.Rollback();
                    objSQlComm.Dispose();
                }
            }
        }

        #region Update Card Transaction For Payment gateway

        public void UpdateCardTrans(SqlCommand objSQlComm)
        {
            if (dtblCardID == null) return;
            else
            {
                foreach (DataRow dr in dtblCardID.Rows)
                {
                    int prm = Functions.fnInt32(dr["CardID"].ToString());
                    objSQlComm.Parameters.Clear();
                    try
                    {
                        string strSQLComm = " update cardtrans set TransactionNo=@TransactionNo,LastChangedBy=@LastChangedBy,"
                                          + " LastChangedOn=@LastChangedOn,IsComplete='Y' where ID = @ID ";
                        
                        //,IsComplete='Y'
                        objSQlComm.CommandText = strSQLComm;

                        objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                        objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                        objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                        objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                        objSQlComm.Parameters["@ID"].Value = prm;
                        objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                        objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                        objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                        objSQlComm.ExecuteNonQuery();
                    }
                    catch (SqlException SQLDBException)
                    {
                        strErrorMsg = SQLDBException.ToString();
                        SaveTran.Rollback();
                        objSQlComm.Dispose();
                    }
                }
            }
        }

        public void UpdateMGCCardTrans(SqlCommand objSQlComm)
        {
            if (dtblMGCCardID == null) return;
            else
            {
                foreach (DataRow dr in dtblMGCCardID.Rows)
                {
                    int prm = Functions.fnInt32(dr["CardID"].ToString());
                    objSQlComm.Parameters.Clear();
                    try
                    {
                        string strSQLComm = " update cardtrans set TransactionNo=@TransactionNo,LastChangedBy=@LastChangedBy,"
                                          + " LastChangedOn=@LastChangedOn where ID = @ID ";

                        //,IsComplete='Y'
                        objSQlComm.CommandText = strSQLComm;

                        objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                        objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));
                        objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                        objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                        objSQlComm.Parameters["@ID"].Value = prm;
                        objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;
                        objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                        objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                        objSQlComm.ExecuteNonQuery();
                    }
                    catch (SqlException SQLDBException)
                    {
                        strErrorMsg = SQLDBException.ToString();
                        SaveTran.Rollback();
                        objSQlComm.Dispose();
                    }
                }
            }
        }

        public void UpdateCardTransForMercuryGC(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " update cardtrans set TransactionNo=@TransactionNo,IsComplete='Y' where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TransactionNo", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = intMercuryGCIssueCardID;
                objSQlComm.Parameters["@TransactionNo"].Value = intTransactionNo;

                objSQlComm.ExecuteNonQuery();
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
            }
        }

        public string UpdateCardResponse()
        {
            string strSQLComm = " update CardTrans set AuthCode=@AuthCode,Reference=@Reference,MercuryAcqRef=@AcqRef,MercuryToken=@Token,"
                              + " MercuryInvoiceNo=@MercuryInvoiceNo,LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn,"
                              + " MercuryProcessData=@MercuryProcessData,MercuryPurchaseAmount=@MercuryPurchaseAmount, "
                              + " CardAmount=@CardAmount, MercuryTranCode=@MercuryTranCode, AdjustFlag=@AdjustFlag, "
                              + " RefCardAct=@RefCardAct,RefCardMerchID=@RefCardMerchID,RefCardLogo=@RefCardLogo,RefCardEntry=@RefCardEntry,"
                              + " RefCardAuthID=@RefCardAuthID,RefCardTranID=@RefCardTranID,RefCardAuthAmount=@RefCardAuthAmount, "
                              + " TransactionType=@TranType,MercuryResponseOrigin=@MercuryResponseOrigin,MercuryRecordNo=@MercuryRecordNo, "
                              + " MercuryResponseReturnCode = @MercuryResponseReturnCode, MercuryTextResponse= @MercuryTextResponse,IsComplete='Y', "
                              + " RefCardBalance = @CardBalance where ID = @ID "; //, PrintXml = @PrintXml

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@AuthCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Reference", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@AcqRef", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Token", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryInvoiceNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryProcessData", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryTranCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryPurchaseAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CardAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TranType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@MercuryResponseOrigin", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryRecordNo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryResponseReturnCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@MercuryTextResponse", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAct", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardMerchID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardLogo", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardEntry", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardTranID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@AdjustFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@CardBalance", System.Data.SqlDbType.Float));

                

                objSQlComm.Parameters["@AuthCode"].Value = strAuthCode;
                objSQlComm.Parameters["@Reference"].Value = strReference;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@ID"].Value = intCardTranID;
                objSQlComm.Parameters["@AcqRef"].Value = strAcqRefData;
                objSQlComm.Parameters["@Token"].Value = strTokenData;
                objSQlComm.Parameters["@MercuryInvoiceNo"].Value = strMercuryInvNo;
                objSQlComm.Parameters["@MercuryProcessData"].Value = strMercuryProcessData;
                objSQlComm.Parameters["@MercuryTranCode"].Value = strMercuryTranCode;
                objSQlComm.Parameters["@MercuryPurchaseAmount"].Value = dblMercuryPurchaseAmount;
                objSQlComm.Parameters["@CardAmount"].Value = dblCardAmount;
                objSQlComm.Parameters["@TranType"].Value = strCardTranType;

                objSQlComm.Parameters["@RefCardAct"].Value = strRefCardAct;
                objSQlComm.Parameters["@RefCardMerchID"].Value = strRefCardMerchID;
                objSQlComm.Parameters["@RefCardLogo"].Value = strRefCardLogo;
                objSQlComm.Parameters["@RefCardEntry"].Value = strRefCardEntry;
                objSQlComm.Parameters["@RefCardAuthID"].Value = strRefCardAuthID;
                objSQlComm.Parameters["@RefCardTranID"].Value = strRefCardTranID;
                objSQlComm.Parameters["@RefCardAuthAmount"].Value = dblRefCardAuthAmount;

                objSQlComm.Parameters["@MercuryResponseOrigin"].Value = strMercuryResponseOrigin;
                objSQlComm.Parameters["@MercuryRecordNo"].Value = strMercuryRecordNo;
                objSQlComm.Parameters["@MercuryResponseReturnCode"].Value = strMercuryResponseReturnCode;
                objSQlComm.Parameters["@MercuryTextResponse"].Value = strMercuryTextResponse;
                objSQlComm.Parameters["@AdjustFlag"].Value = strAdjustFlag;
                objSQlComm.Parameters["@CardBalance"].Value = dblRefCardBalAmount;
                
                /*objSQlComm.Parameters.Add(new SqlParameter("@PrintXml", System.Data.SqlDbType.Text));
                objSQlComm.Parameters["@PrintXml"].Value = strPrintXml;*/

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        #endregion

        public int ValidCustomerID(string CCode, string SCode)
        {
            int intCID = 0;

            string strSQLComm = " select count(ID) as CustID from customer where CustomerID=@CustomerID and IssueStore=@IssueStore and ActiveStatus = 'Y' ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@CustomerID"].Value = CCode;
                objSQlComm.Parameters.Add(new SqlParameter("@IssueStore", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@IssueStore"].Value = SCode;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    { intCID = Functions.fnInt32(objsqlReader["CustID"].ToString()); }
                    catch 
                    { objsqlReader.Close(); }
                    
                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intCID;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return intCID;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                
            }
        }

        public int GetCustomerID(string CCode, string SCode)
        {
            int intCID = 0;
            string strSQLComm = " select ID as CustID from Customer where CustomerID=@CustomerID and IssueStore=@IssueStore ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@CustomerID"].Value = CCode;
                objSQlComm.Parameters.Add(new SqlParameter("@IssueStore", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@IssueStore"].Value = SCode;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try { intCID = Functions.fnInt32(objsqlReader["CustID"].ToString()); }
                    catch { objsqlReader.Close(); }
                    
                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intCID;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return intCID;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        public bool IsActiveCustomer(int pID)
        {
            string val = "";
            string strSQLComm = " select ActiveStatus from customer where ID=@CustomerID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CustomerID"].Value = pID;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        val = objsqlReader["ActiveStatus"].ToString();
                    }
                    catch
                    {
                        objsqlReader.Close();
                    }
                }

                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return (val == "Y");
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        public string GetCustomerDOB(int pID)
        {
            string val = "";
            string strSQLComm = " select isnull(DateOfBirth,'') as DOB from customer where ID = @CustomerID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CustomerID"].Value = pID;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        val = objsqlReader["DOB"].ToString(); 
                    }
                    catch
                    { 
                        objsqlReader.Close(); 
                    }
                }

                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return "";
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        #region Update Close Out Transction Count

        public void UpdateCloseoutTransaction(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            
            string strSQLComm = "sp_UpdateCloseoutTranCnt";

            try
            {
                
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@CloseoutID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CloseoutID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@CloseoutID"].Value = intCloseoutID;

                objSQlComm.Parameters.Add(new SqlParameter("@User", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@User"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@User"].Value = intLoginUserID;

                objSQlComm.ExecuteNonQuery();
                objSQlComm.Dispose();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQlComm.Dispose();
            }
            finally
            {
                objSQlComm.Dispose();
            }
        }

        #endregion

        public string GetPriceLevelApplicableDate()
        {
            string dtReturn = "";
            
            string strSQLComm = " select PriceLevelApplicableDate from Setup ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        dtReturn = objsqlReader["PriceLevelApplicableDate"].ToString();
                    }
                    catch { objsqlReader.Close(); }
                    
                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtReturn;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return dtReturn;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        #region Update PriceLevelApplicableDate

        public string UpdatePriceLevelApplicableDate()
        {
            string strSQLComm = " update setup set PriceLevelApplicableDate=@PriceLevelApplicableDate, UsePriceLevel=0, "
                                + " LastChangedBy=@LastChangedBy, LastChangedOn=@LastChangedOn   ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@PriceLevelApplicableDate", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@PriceLevelApplicableDate"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        #endregion

        public int GetInvoiceFormItem(SqlCommand objSQlComm, int PID)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select invoiceno from item where ID=@ID";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["invoiceno"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public int GetProductPoints(SqlCommand objSQlComm, int PID)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select points from product where ID=@ID";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = PID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["points"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public DataTable FetchKitRecord(SqlCommand objSQlComm, int pKitID)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            string strSQLComm = " select k.*,isnull(p.Cost,'0') as Cost from kit k left outer join product p on "
                              + " k.KitID=p.ID where k.kitID = @kitID ";
            
            objSQlComm.Parameters.Add(new SqlParameter("@kitID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@kitID"].Value = pKitID;
            objSQlComm.CommandText = strSQLComm;
            objSQlComm.CommandType = CommandType.Text;
            SqlDataReader objSQLReader = null;

            try
            {
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("ItemID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ItemID"].ToString(),
                                                objSQLReader["ItemCount"].ToString(),
                                                objSQLReader["Cost"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                //sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                //sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        private void AdjustKitGridRecords(SqlCommand objSQlComm,double Qty)
        {
            try
            {
                if (dtblKitDataTable == null) return;
                foreach (DataRow dr in dtblKitDataTable.Rows)
                {
                    string colItemID = "";
                    string colItemCount = "";
                    string colItemCost = "";

                    if (dr["ItemID"].ToString() == "") continue;

                    if (dr["ItemID"].ToString() != "")
                    {
                        colItemID = dr["ItemID"].ToString();
                    }

                    if (dr["ItemCount"].ToString() != "")
                    {
                        colItemCount = dr["ItemCount"].ToString();
                    }
                    else
                    {
                        colItemCount = "0";
                    }

                    if (dr["Cost"].ToString() != "")
                    {
                        colItemCost = dr["Cost"].ToString();
                    }
                    else
                    {
                        colItemCost = "0";
                    }

                    intKitItemID = Functions.fnInt32(colItemID);
                    intKitItemCount = Functions.fnInt32(colItemCount);
                    dblKitItemCost = Functions.fnDouble(colItemCost);

                    int intJ = 0;
                        if (!NewLayaway)
                        {
                            Functions.UpdateItemStockBalance(objSQlComm, intKitItemID, -Qty * intKitItemCount, intLoginUserID);
                            if (!blReturn)
                            {
                                if (Qty >= 0)
                                {
                                    intJ = Functions.AddStockJournal(objSQlComm, "Stock Out", "Sale", "N", intKitItemID, intLoginUserID,
                                        Qty * intKitItemCount, dblKitItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                }
                                else
                                {
                                    intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intKitItemID, intLoginUserID,
                                        -Qty * intKitItemCount, dblKitItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");
                                }
                                                                
                            }
                            else
                            {
                                intJ = Functions.AddStockJournal(objSQlComm, "Stock In", "Return", "N", intKitItemID, intLoginUserID,
                                    -Qty * intKitItemCount, dblItemCost, intID.ToString(), strTerminalName, dtTransDate, DateTime.Now, "");                    
                            }
                        }                                     
                }
                dtblKitDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        private void AdjustKitGridRecordsForLayaway(SqlCommand objSQlComm, double Qty)
        {
            try
            {
                if (dtblKitDataTable == null) return;
                foreach (DataRow dr in dtblKitDataTable.Rows)
                {
                    string colItemID = "";
                    string colItemCount = "";
                    string colItemCost = "";


                    if (dr["ItemID"].ToString() == "") continue;

                    if (dr["ItemID"].ToString() != "")
                    {
                        colItemID = dr["ItemID"].ToString();
                    }

                    if (dr["ItemCount"].ToString() != "")
                    {
                        colItemCount = dr["ItemCount"].ToString();
                    }
                    else
                    {
                        colItemCount = "0";
                    }

                    if (dr["Cost"].ToString() != "")
                    {
                        colItemCost = dr["Cost"].ToString();
                    }
                    else
                    {
                        colItemCost = "0";
                    }

                    intKitItemID = Functions.fnInt32(colItemID);
                    intKitItemCount = Functions.fnInt32(colItemCount);
                    dblKitItemCost = Functions.fnDouble(colItemCost);

                    UpdateLayawayQtyOnHand(objSQlComm, intKitItemID, Qty * intKitItemCount);

                    
                }
                dtblKitDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        public DataTable GetGiftCertNumber(SqlCommand objSQlComm, int InvID)
        {
            DataTable dtblGC = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select distinct g.GiftCertID,g.IssueStore from giftcert g left outer join tender t on "
                             + " g.TenderNo = t.ID left outer join invoice i on i.TransactionNo = t.TransactionNo "
                             + " where i.ID=@INV group by g.GiftCertID,g.IssueStore order by g.IssueStore ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@INV", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@INV"].Value = InvID;

                sqlDataReader = objSQlComm.ExecuteReader();
                dtblGC.Columns.Add("GC", System.Type.GetType("System.String"));
                dtblGC.Columns.Add("STORE", System.Type.GetType("System.String"));
                while (sqlDataReader.Read())
                {
                    dtblGC.Rows.Add(new object[] { sqlDataReader["GiftCertID"].ToString(), sqlDataReader["IssueStore"].ToString() });
                }
                sqlDataReader.Close();
                return dtblGC;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return dtblGC;
            }
        }

        public double GetGiftCertAmount(SqlCommand objSQlComm, string GID, string GStore,string CentralFlag)
        {
            double dblAmount = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                if (CentralFlag == "Y")
                    strSQLComm = " select isnull(sum(amount),0) as samt from giftcert where giftcertid=@giftcertid and issuestore=@store and tenderno=0";
                if (CentralFlag == "N")
                    strSQLComm = " select isnull(sum(amount),0) as samt from giftcert where giftcertid=@giftcertid and tenderno=0";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@giftcertid", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@giftcertid"].Value = GID;
                if (CentralFlag == "Y")
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@store", System.Data.SqlDbType.NVarChar));
                    objSQlComm.Parameters["@store"].Value = GStore.Trim();
                }

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    dblAmount = Functions.fnDouble(sqlDataReader["samt"].ToString());
                }
                sqlDataReader.Close();
                return dblAmount;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return dblAmount;
            }
        }

        public double GetGiftCertTranAmount(SqlCommand objSQlComm, string GID, string GStore, string CentralFlag)
        {
            double dblAmount = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                if (CentralFlag == "Y") 
                    strSQLComm = " select isnull(sum(amount),0) as samt from giftcert where giftcertid=@giftcertid and issuestore=@store and tenderno <> 0 ";
                if (CentralFlag == "N")
                    strSQLComm = " select isnull(sum(amount),0) as samt from giftcert where giftcertid=@giftcertid and tenderno <> 0 ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@giftcertid", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@giftcertid"].Value = GID;
                
                if (CentralFlag == "Y")
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@store", System.Data.SqlDbType.NVarChar));
                    objSQlComm.Parameters["@store"].Value = GStore.Trim();
                }

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    dblAmount = Functions.fnDouble(sqlDataReader["samt"].ToString());
                }
                sqlDataReader.Close();
                return dblAmount;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return dblAmount;
            }
        }

        #region list of active Gift Certificate 

        public DataTable ActiveGiftCert(int CID, string CentralFlag,string StoreC)
        {
            DataTable dtblGC = new DataTable();
            
            SaveTran = null;
            SaveCon = this.sqlConn;
            if (SaveCon.State == System.Data.ConnectionState.Open) SaveCon.Close();
            SaveCon.Open();
            SaveTran = SaveCon.BeginTransaction();
            SaveComm = new SqlCommand("", this.Connection);
            SaveComm.Transaction = this.SaveTran;
            int intresult = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                dtblGC.Columns.Add("GC", System.Type.GetType("System.String"));
                dtblGC.Columns.Add("GCSTORE", System.Type.GetType("System.String"));
                dtblGC.Columns.Add("GCAMT", System.Type.GetType("System.String"));
                DataTable dtblGC1 = GetGiftCertNumber(SaveComm, CID);
                foreach (DataRow dr in dtblGC1.Rows)
                {
                    double IssueAmount = GetGiftCertAmount(SaveComm, dr["GC"].ToString(), dr["STORE"].ToString(), CentralFlag);
                    double TranAmount = GetGiftCertTranAmount(SaveComm, dr["GC"].ToString(), dr["STORE"].ToString(), CentralFlag);

                    if ((IssueAmount - TranAmount) > 0)
                    {
                        if (CentralFlag == "N") 
                            dtblGC.Rows.Add(new object[] { dr["GC"].ToString(), dr["STORE"].ToString(), Convert.ToString(IssueAmount - TranAmount) });

                        if (CentralFlag == "Y")
                        {
                            if (StoreC == dr["STORE"].ToString()) dtblGC.Rows.Add(new object[] { dr["GC"].ToString(), dr["STORE"].ToString(), Convert.ToString(IssueAmount - TranAmount) });
                            if (StoreC != dr["STORE"].ToString()) dtblGC.Rows.Add(new object[] { dr["GC"].ToString() + "  (store: " + dr["STORE"].ToString() + ")", dr["STORE"].ToString(), Convert.ToString(IssueAmount - TranAmount) });
                        }
                    }
                }

                SaveTran.Commit();
                SaveTran.Dispose();
                return dtblGC;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                SaveTran.Commit();
                SaveTran.Dispose();
                return dtblGC;
            }
        }

        #endregion

        public double GiftCertBalance(string pGC, string pGCStore, string CentralFlag)
        {
            SaveTran = null;
            SaveCon = this.sqlConn;
            if (SaveCon.State == System.Data.ConnectionState.Open) SaveCon.Close();
            SaveCon.Open();
            SaveTran = SaveCon.BeginTransaction();
            SaveComm = new SqlCommand("", this.Connection);
            SaveComm.Transaction = this.SaveTran;
            double intresult = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                double IssueAmount = GetGiftCertAmount(SaveComm, pGC, pGCStore, CentralFlag);
                double TranAmount = GetGiftCertTranAmount(SaveComm, pGC, pGCStore, CentralFlag);
                                
                intresult = IssueAmount - TranAmount;

                SaveTran.Commit();
                SaveTran.Dispose();
                return intresult;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                SaveTran.Commit();
                SaveTran.Dispose();
                return 0;
            }
        }

        public int GetCashTenderID(SqlCommand objSQlComm)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select ID from tendertypes Where Name= @Name ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@Name", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@Name"].Value = "Cash";

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["ID"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public bool DeleteSuspendInvoiceDetails(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " delete from Invoice Where ID = @InvoiceNo and status = 2 ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvoiceNo"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool ContinueWithDemoInvNo(int MaxINV)
        {
            int intInvNo = 0;
            bool blContinue = true;
            SqlCommand objSQlComm = null;

            string strSQLComm = " select count( distinct isnull(ID,0)) as MaxInvoice from Invoice ";

            objSQlComm = new SqlCommand(strSQLComm, Connection);

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                SqlDataReader objsqlReader = null;
                objsqlReader = objSQlComm.ExecuteReader();

                while (objsqlReader.Read())
                {
                    intInvNo = Functions.fnInt32(objsqlReader["MaxInvoice"].ToString());
                }

                objsqlReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (intInvNo < MaxINV) blContinue = true;
                else blContinue = false;
                return blContinue;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQlComm.Dispose();
                return blContinue;
            }
        }

        public int GetWorkOrderNo(SqlCommand objSQlComm)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select isnull(max(workorderno),0) + 1 as WNO from workorder ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    intPoints = Functions.fnInt32(sqlDataReader["WNO"].ToString());
                }
                sqlDataReader.Close();
                return intPoints;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return intPoints;
            }
        }

        public DateTime GetWorkOrderDate(SqlCommand objSQlComm, int WONo)
        {
            DateTime dtWO = DateTime.Now;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select CreatedOn from workorder where workorderno = @WO ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@WO", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@WO"].Value = WONo;
                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                     dtWO = Functions.fnDate(sqlDataReader["CreatedOn"].ToString());
                }
                sqlDataReader.Close();
                return dtWO;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return dtWO;
            }
        }

        public bool UpdateWorkOrderPayment(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update WorkOrder set InvoiceNo = @InvoiceNo,PaymentDate = @PaymentDate, "
                           + " LastChangedBy=@LastChangedBy, LastChangedOn=LastChangedOn where WorkOrderNo=@ID ";
                
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@PaymentDate", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intSuspendInvoiceNo;
                objSQlComm.Parameters["@InvoiceNo"].Value = intID;
                objSQlComm.Parameters["@PaymentDate"].Value = dtTransDate;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateWorkOrderDate(SqlCommand objSQlComm)
        {
            int intRecvDetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " update WorkOrder set CreatedOn = @CreatedOn where WorkOrderNo=@ID ";
                           
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intSuspendInvoiceNo;
                objSQlComm.Parameters["@CreatedOn"].Value = intID;
                
                sqlDataReader = objSQlComm.ExecuteReader();
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        private void AdjustWOItemGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    string colID = "";
                    string coRATE = "";
                    string colNRATE = "";
                    string colCOST = "";
                    string colQTY = "";

                    string colPRODUCT = "";
                    string colPRODUCTTYPE = "";
                    string colSKU = "";
                    string colDEPT = "";
                    string colCAT = "";

                    string colTAXID1 = "";
                    string colTAXID2 = "";
                    string colTAXID3 = "";

                    string colTAXABLE1 = "";
                    string colTAXABLE2 = "";
                    string colTAXABLE3 = "";

                    string colTAXRATE1 = "";
                    string colTAXRATE2 = "";
                    string colTAXRATE3 = "";

                    string colUOMCOUNT = "";
                    string colUOMPRICE = "";
                    string colUOMDESC = "";
                    string colMATRIXOID = "";
                    string colMATRIXOV1 = "";
                    string colMATRIXOV2 = "";
                    string colMATRIXOV3 = "";
                    string colITEMID = "";

                    string colNOTES = "";

                    string colDISCLOGIC = "";
                    string colDISCVALUE = "";
                    string colITEMDISCOUNT = "";
                    string colDISCOUNTID = "";
                    string colDISCOUNTTEXT = "";
                    string colITEMINDEX = "";

                    string colTAXTYPE1 = "";
                    string colTAXTYPE2 = "";
                    string colTAXTYPE3 = "";
                    string colTAXTOTAL1 = "";
                    string colTAXTOTAL2 = "";
                    string colTAXTOTAL3 = "";

                    if (dr["ID"].ToString() == "") continue;

                    if (dr["ID"].ToString() != "")
                    {
                        colID = dr["ID"].ToString();
                    }

                    if (dr["RATE"].ToString() != "")
                    {
                        coRATE = dr["RATE"].ToString();
                    }
                    else
                    {
                        coRATE = "0.00";
                    }

                    if (dr["NRATE"].ToString() != "")
                    {
                        colNRATE = dr["NRATE"].ToString();
                    }
                    else
                    {
                        colNRATE = "0.00";
                    }

                    if (dr["COST"].ToString() != "")
                    {
                        colCOST = dr["COST"].ToString();
                    }
                    else
                    {
                        colCOST = "0.00";
                    }

                    if (dr["QTY"].ToString() != "")
                    {
                        colQTY = dr["QTY"].ToString();
                    }
                    else
                    {
                        colQTY = "0.00";
                    }

                    if (dr["DEPT"].ToString() != "")
                    {
                        colDEPT = dr["DEPT"].ToString();
                    }
                    else
                    {
                        colDEPT = "0";
                    }

                    if (dr["CAT"].ToString() != "")
                    {
                        colCAT = dr["CAT"].ToString();
                    }
                    else
                    {
                        colCAT = "0";
                    }

                    if (dr["UOMCOUNT"].ToString() != "")
                    {
                        colUOMCOUNT = dr["UOMCOUNT"].ToString();
                    }
                    else
                    {
                        colUOMCOUNT = "0.0";
                    }

                    if (dr["UOMPRICE"].ToString() != "")
                    {
                        colUOMPRICE = dr["UOMPRICE"].ToString();
                    }
                    else
                    {
                        colUOMPRICE = "0.0";
                    }

                    if (dr["MATRIXOID"].ToString() != "")
                    {
                        colMATRIXOID = dr["MATRIXOID"].ToString();
                    }
                    else
                    {
                        colMATRIXOID = "0";
                    }

                    if (dr["ITEMID"].ToString() != "")
                    {
                        colITEMID = dr["ITEMID"].ToString();
                    }
                    else
                    {
                        colITEMID = "0";
                    }

                    if (dr["DISCVALUE"].ToString() != "")
                    {
                        colDISCVALUE = dr["DISCVALUE"].ToString();
                    }
                    else
                    {
                        colDISCVALUE = "0";
                    }

                    if (dr["ITEMDISCOUNT"].ToString() != "")
                    {
                        colITEMDISCOUNT = dr["ITEMDISCOUNT"].ToString();
                    }
                    else
                    {
                        colITEMDISCOUNT = "0";
                    }

                    if (dr["DISCOUNTID"].ToString() != "")
                    {
                        colDISCOUNTID = dr["DISCOUNTID"].ToString();
                    }
                    else
                    {
                        colDISCOUNTID = "0";
                    }

                    if (dr["ITEMINDEX"].ToString() != "")
                    {
                        colITEMINDEX = dr["ITEMINDEX"].ToString();
                    }
                    else
                    {
                        colITEMINDEX = "0";
                    }

                    string colGRATE = "";
                    string colGPRICE = "";



                    if (dr["GRATE"].ToString() != "")
                    {
                        colGRATE = dr["GRATE"].ToString();
                    }
                    else
                    {
                        colGRATE = "0.00";
                    }

                    if (dr["GPRICE"].ToString() != "")
                    {
                        colGPRICE = dr["GPRICE"].ToString();
                    }
                    else
                    {
                        colGPRICE = "0.00";
                    }
                    strItemUOM = dr["UOM"].ToString();
                    dblItemGRate = Functions.fnDouble(colGRATE);
                    dblItemGPrice = Functions.fnDouble(colGPRICE);

                    colDISCLOGIC = dr["DISCLOGIC"].ToString();
                    colDISCOUNTTEXT = dr["DISCOUNTTEXT"].ToString();
                    
                    colUOMDESC = dr["UOMDESC"].ToString();
                    colMATRIXOV1 = dr["MATRIXOV1"].ToString();
                    colMATRIXOV2 = dr["MATRIXOV2"].ToString();
                    colMATRIXOV3 = dr["MATRIXOV3"].ToString();

                    colPRODUCT = dr["PRODUCT"].ToString();
                    colPRODUCTTYPE = dr["PRODUCTTYPE"].ToString();
                    colSKU = dr["SKU"].ToString();

                    colTAXID1 = dr["TAXID1"].ToString();
                    colTAXID2 = dr["TAXID2"].ToString();
                    colTAXID3 = dr["TAXID3"].ToString();

                    colTAXABLE1 = dr["TAXABLE1"].ToString();
                    colTAXABLE2 = dr["TAXABLE2"].ToString();
                    colTAXABLE3 = dr["TAXABLE3"].ToString();

                    colTAXRATE1 = dr["TAXRATE1"].ToString();
                    colTAXRATE2 = dr["TAXRATE2"].ToString();
                    colTAXRATE3 = dr["TAXRATE3"].ToString();

                    colNOTES = dr["NOTES"].ToString();

                    colTAXTYPE1 = dr["TX1TYPE"].ToString();
                    colTAXTYPE2 = dr["TX2TYPE"].ToString();
                    colTAXTYPE3 = dr["TX3TYPE"].ToString();

                    colTAXTOTAL1 = dr["TX1"].ToString();
                    colTAXTOTAL2 = dr["TX2"].ToString();
                    colTAXTOTAL3 = dr["TX3"].ToString();

                    dblItemCost = Functions.fnDouble(colCOST);
                    dblItemNPrice = Functions.fnDouble(colNRATE);
                    dblItemPrice = Functions.fnDouble(coRATE);
                    intItemID = Functions.fnInt32(colID);
                    dblItemQty = Functions.fnDouble(colQTY);

                    strItemDescription = colPRODUCT;
                    strItemProductType = colPRODUCTTYPE;
                    strItemSKU = colSKU;
                    intItemDepartmentID = Functions.fnInt32(colDEPT);
                    intItemCategoryID = Functions.fnInt32(colCAT);

                    intItemTaxID1 = Functions.fnInt32(colTAXID1);
                    intItemTaxID2 = Functions.fnInt32(colTAXID2);
                    intItemTaxID3 = Functions.fnInt32(colTAXID3);

                    strItemTaxable1 = colTAXABLE1;
                    strItemTaxable2 = colTAXABLE2;
                    strItemTaxable3 = colTAXABLE3;

                    dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                    dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                    dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                    strItemUOMDesc = colUOMDESC;
                    dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                    dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                    intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                    strMatrixOptionValue1 = colMATRIXOV1;
                    strMatrixOptionValue2 = colMATRIXOV2;
                    strMatrixOptionValue3 = colMATRIXOV3;

                    strInvNotes = colNOTES;

                    strItemDiscLogic = colDISCLOGIC;
                    strItemDiscountText = colDISCOUNTTEXT;
                    dblItemDiscount = Functions.fnDouble(colITEMDISCOUNT);
                    dblItemDiscValue = Functions.fnDouble(colDISCVALUE);
                    intItemIndex = Functions.fnInt32(colITEMINDEX);
                    intItemDiscountID = Functions.fnInt32(colDISCOUNTID);

                    intItemTaxType1 = Functions.fnInt32(colTAXTYPE1);
                    intItemTaxType2 = Functions.fnInt32(colTAXTYPE2);
                    intItemTaxType3 = Functions.fnInt32(colTAXTYPE3);

                    dblItemTaxTotal1 = Functions.fnDouble(colTAXTOTAL1);
                    dblItemTaxTotal2 = Functions.fnDouble(colTAXTOTAL2);
                    dblItemTaxTotal3 = Functions.fnDouble(colTAXTOTAL3);

                    intMixMatchID = Functions.fnInt32(dr["MIXMATCHID"].ToString());

                    intDTxID = Functions.fnInt32(dr["DTXID"].ToString());
                    intDTxType = Functions.fnInt32(dr["DTXTYPE"].ToString());
                    dblDTxRate = Functions.fnDouble(dr["DTXRATE"].ToString());
                    dblDTx = Functions.fnDouble(dr["DTX"].ToString());

                    sEditFlag = dr["EDITF"].ToString();
                    if (sEditFlag == "") sEditFlag = "N";

                    sPromptPrice = dr["PROMPTPRICE"].ToString();
                    if (sPromptPrice == "") sPromptPrice = "N";

                    iBuyGetFreeHeader = Functions.fnInt32(dr["BUYNGETFREEHEADERID"].ToString());
                    sBuyGetFreeCat = dr["BUYNGETFREECATEGORY"].ToString();
                    sBuyGetFreePromotionTxt = dr["BUYNGETFREENAME"].ToString();

                    iAge = Functions.fnInt32(dr["AGE"].ToString());

                    int intJ = 0;

                    intPreviousItemID = Functions.fnInt32(colITEMID);
                    
                    if (!((colPRODUCTTYPE == "G") || (colPRODUCTTYPE == "A") || (colPRODUCTTYPE == "B") || (colPRODUCTTYPE == "C")
                        || (colPRODUCTTYPE == "X") || (colPRODUCTTYPE == "Z") || (colPRODUCTTYPE == "H") || (colPRODUCTTYPE == "O")))
                    {
                        if (!NewLayaway)
                        {
                            if (colPRODUCTTYPE != "U")
                            {
                                //Functions.UpdateItemStockBalance(objSQlComm, intItemID, -dblItemQty, intLoginUserID);
                                if (!blReturn)
                                {
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                    }
                                }
                                else
                                {
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty)), intLoginUserID, strOperateStore);
                                    }
                                }
                            }
                            else
                            {

                                if (!blReturn)
                                {
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                    }

                                }
                                else
                                {
                                    if (intCustomerID > 0)
                                    {
                                        int p = GetProductPoints(objSQlComm, intItemID);
                                        Functions.UpdateCustomerPointRecord(objSQlComm, intCustomerID, Functions.fnInt32(Math.Round(p * dblItemQty * dblItemUOMCount)), intLoginUserID, strOperateStore);
                                    }

                                }

                            }
                        }

                    }

                    int intDescID = 0;

                    //if (colPRODUCTTYPE == "G" ) intDescID = GetDescID(objSQlComm,"GC#:"+colID);

                    strTagged = "N";

                    InsertItemDetails(objSQlComm, intID, intDescID);

                    if (!blNewLayaway)
                    {
                        if (colPRODUCTTYPE == "M")
                        {
                            InsertMatrixOption(objSQlComm);
                        }

                        if (colPRODUCTTYPE == "T")
                        {
                            DataTable dtbl1 = new DataTable();
                            dtbl1 = FetchTaggedItem(objSQlComm, intItemID);
                            int tagval = intReturnItemID;
                            foreach (DataRow dr1 in dtbl1.Rows)
                            {

                                colID = "";
                                coRATE = "";
                                colNRATE = "";
                                colCOST = "";
                                colQTY = "";

                                colPRODUCT = "";
                                colPRODUCTTYPE = "";
                                colSKU = "";
                                colDEPT = "";
                                colCAT = "";

                                if (dr1["TID"].ToString() == "") continue;

                                if (dr1["TID"].ToString() != "")
                                {
                                    colID = dr1["TID"].ToString();
                                }

                                if (dr1["TPRICE"].ToString() != "")
                                {
                                    coRATE = dr1["TPRICE"].ToString();
                                }
                                else
                                {
                                    coRATE = "0.00";
                                }

                                if (dr1["TPRICE"].ToString() != "")
                                {
                                    colNRATE = dr1["TPRICE"].ToString();
                                }
                                else
                                {
                                    colNRATE = "0.00";
                                }

                                if (dr1["TQTY"].ToString() != "")
                                {
                                    colQTY = dr1["TQTY"].ToString();
                                }
                                else
                                {
                                    colQTY = "0.00";
                                }

                                if (dr1["TDEPT"].ToString() != "")
                                {
                                    colDEPT = dr1["TDEPT"].ToString();
                                }
                                else
                                {
                                    colDEPT = "0";
                                }

                                if (dr1["TCAT"].ToString() != "")
                                {
                                    colCAT = dr1["TCAT"].ToString();
                                }
                                else
                                {
                                    colCAT = "0";
                                }

                                colPRODUCT = dr1["TDESC"].ToString();
                                colPRODUCTTYPE = dr1["TTYPE"].ToString();
                                colSKU = dr1["TSKU"].ToString();


                                dblItemNPrice = Functions.fnDouble(colNRATE);
                                dblItemPrice = Functions.fnDouble(coRATE);
                                intItemID = Functions.fnInt32(colID);
                                dblItemQty = Functions.fnDouble(colQTY) * dblItemQty;

                                strItemDescription = colPRODUCT;
                                strItemProductType = colPRODUCTTYPE;
                                strItemSKU = colSKU;
                                intItemDepartmentID = Functions.fnInt32(colDEPT);
                                intItemCategoryID = Functions.fnInt32(colCAT);

                                intItemTaxID1 = Functions.fnInt32(colTAXID1);
                                intItemTaxID2 = Functions.fnInt32(colTAXID2);
                                intItemTaxID3 = Functions.fnInt32(colTAXID3);

                                strItemTaxable1 = colTAXABLE1;
                                strItemTaxable2 = colTAXABLE2;
                                strItemTaxable3 = colTAXABLE3;

                                dblItemTaxRate1 = Functions.fnDouble(colTAXRATE1);
                                dblItemTaxRate2 = Functions.fnDouble(colTAXRATE2);
                                dblItemTaxRate3 = Functions.fnDouble(colTAXRATE3);

                                strItemUOMDesc = colUOMDESC;
                                dblItemUOMCount = Functions.fnDouble(colUOMCOUNT);
                                dblItemUOMPrice = Functions.fnDouble(colUOMPRICE);

                                intMatrixOptionID = Functions.fnInt32(colMATRIXOID);
                                strMatrixOptionValue1 = colMATRIXOV1;
                                strMatrixOptionValue2 = colMATRIXOV2;
                                strMatrixOptionValue3 = colMATRIXOV3;

                                strInvNotes = colNOTES;
                                strTagged = "X";

                                strItemDiscLogic = "";
                                strItemDiscountText = "";
                                dblItemDiscount = 0;
                                dblItemDiscValue = 0;
                                intItemIndex = 1;
                                intItemDiscountID = 0;
                                intMixMatchID = 0;
                                iBuyGetFreeHeader = 0;
                                sBuyGetFreeCat = "";
                                sBuyGetFreePromotionTxt = "";
                                iAge = 0;
                                dblItemGRate = 0;
                                dblItemGPrice = 0;
                                strItemUOM = "";
                                InsertItemDetails(objSQlComm, intID, tagval);

                            }
                            dtbl1.Dispose();
                        }
                    }
                    
                    

                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
                strErrorMsg = e.Message;
            }
        }

        public int FetchWorkOrderNo(int INVNO)
        {
            int intWNO = 0;
            string strSQLComm = " select distinct workorderno from workorder where invoiceno = @invoiceno ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intWNO = Functions.fnInt32(objSQLReader["workorderno"].ToString());
                                                
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intWNO;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public string FetchWorkOrderDate(int INVNO)
        {
            string intWNO = "";
            string strSQLComm = " select distinct createdon from workorder where invoiceno = @invoiceno ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intWNO = objSQLReader["createdon"].ToString();

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intWNO;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return "";
            }
        }

        #region Fetch WorkOrder Record Header

        public DataTable FetchWorkOrderHeader(int intWID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select distinct w.WorkOrderNo,w.CreatedOn, isnull(c.ID,0) as CID, "
                                + " isnull(c.CustomerID,'') as CustID, isnull(c.LastName,'') as CustLast,  "
                                + " isnull(c.FirstName,'') as CustFirst, isnull(c.Company,'') as CustCom, "
                                + " isnull(e.EmployeeID,0) as EmpID, w.TotalAmount, w.TaxAmount "
                                + " from workorder w left outer join Customer c on w.CustomerID = c.ID "
                                + " left outer join Employee e on w.LastChangedBy = e.ID "
                                + " where w.WorkOrderNo = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intWID;
            SqlDataReader objSQLReader = null;

            string pName = "";

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("WorkOrderNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("WorkOrderDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustCompany", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmpID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Total", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if (objSQLReader["CustID"].ToString() != "") pName = objSQLReader["CustLast"].ToString() + ", " +
                                objSQLReader["CustFirst"].ToString();

                    dtbl.Rows.Add(new object[] {objSQLReader["WorkOrderNo"].ToString(),
												objSQLReader["CreatedOn"].ToString(),
                                                objSQLReader["CID"].ToString(),
                                                objSQLReader["CustID"].ToString(),
                                                pName,
                                                objSQLReader["CustCom"].ToString(),
                                                objSQLReader["EmpID"].ToString(),
                                                objSQLReader["TotalAmount"].ToString(),
                                                objSQLReader["TaxAmount"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        #region Fetch WorkOrder Record Details

        public DataTable FetchWorkOrderDetails(int intWID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm =   " select a.ID, a.ProductType, a.Description,a.SKU,a.PriceA,a.PriceB,a.PriceC,a.Qty,a.NewPrice,"
                                + " a.DiscountLevel,isnull(a.OptionValue1,'') as OV1,isnull(a.OptionValue2,'') as OV2,"
                                + " isnull(a.OptionValue3,'') as OV3,isnull(m.Option1Name,'') as ON1, "
                                + " isnull(m.Option2Name,'') as ON2,isnull(m.Option3Name,'') as ON3, "
                                + " isnull(p.DecimalPlace,'2') as DP, a.UOMPrice,a.DiscountID,a.DiscountText,a.Discount,a.ItemIndex,"
                                + " a.Fees,a.FeesTax,a.FeesText,a.FeesQty, a.BuyNGetFreeHeaderID, a.BuyNGetFreeCategory, a.BuyNGetFreeName from workorder a "
                                + " left outer join product p on a.ProductID = p.ID "
                                + " left outer join MatrixOptions m on a.MatrixOptionID = m.ID "
                                + " where a.workorderno = @ID order by a.ItemIndex";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intWID;
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TotalPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MOP3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DP", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemIndex", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesQty", System.Type.GetType("System.String"));

                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));

                string sM1 = "";
                string sM2 = "";
                string sM3 = "";
                string strPr = "";

                while (objSQLReader.Read())
                {
                    if (objSQLReader["ProductType"].ToString() == "M")
                    {
                        if ((objSQLReader["ON1"].ToString() != "") || (objSQLReader["OV1"].ToString() != ""))
                            sM1 = objSQLReader["ON1"].ToString() + ": " + objSQLReader["OV1"].ToString();
                        if ((objSQLReader["ON2"].ToString() != "") || (objSQLReader["OV2"].ToString() != ""))
                            sM2 = objSQLReader["ON2"].ToString() + ": " + objSQLReader["OV2"].ToString();
                        if ((objSQLReader["ON3"].ToString() != "") || (objSQLReader["OV3"].ToString() != ""))
                            sM3 = objSQLReader["ON3"].ToString() + ": " + objSQLReader["OV3"].ToString();
                    }
                    TP = 0;
                    /*if (objSQLReader["DiscountLevel"].ToString() == "A")
                    {
                        strPr = objSQLReader["PriceA"].ToString();
                        TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["PriceA"].ToString());
                    }
                    if (objSQLReader["DiscountLevel"].ToString() == "B")
                    {
                        strPr = objSQLReader["PriceB"].ToString();
                        TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["PriceB"].ToString());
                    }
                    if (objSQLReader["DiscountLevel"].ToString() == "C")
                    {
                        strPr = objSQLReader["PriceC"].ToString();
                        TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["PriceC"].ToString());
                    }*/

                    strPr = objSQLReader["NewPrice"].ToString();
                    TP = Functions.fnDouble(objSQLReader["Qty"].ToString()) * Functions.fnDouble(objSQLReader["NewPrice"].ToString()) - Functions.fnDouble(objSQLReader["Discount"].ToString());

                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
												objSQLReader["ProductType"].ToString(),
                                                objSQLReader["Description"].ToString(),
												objSQLReader["SKU"].ToString(),
                                                strPr,
                                                objSQLReader["Qty"].ToString(),
                                                TP.ToString(),sM1,sM2,sM3,objSQLReader["DP"].ToString(),
                                                objSQLReader["UOMPrice"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["ItemIndex"].ToString(),
                                                objSQLReader["Fees"].ToString(),
                                                objSQLReader["FeesTax"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["FeesQty"].ToString(),
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        public int FetchINVNoFromWONo(int WNO)
        {
            int intWNO = 0;
            string strSQLComm = " select distinct invoiceno from workorder where workorderno = @workorderno ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@workorderno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@workorderno"].Value = WNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intWNO = Functions.fnInt32(objSQLReader["invoiceno"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intWNO;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }
        
        public DataTable FetchSuspendedRecordForPrint(int pInvNo)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm =   " select s.*,s.Fees as F, s.FeesTax as FTx,isnull(c.ID,0) as CID,isnull(c.CustomerID,'') as CustID,isnull(c.LastName,'') as CustLast, "
                                + " isnull(c.FirstName,'') as CustFirst, isnull(c.Company,'') as CustCom, isnull(e.EmployeeID,0) as EmpID, "
                                + " isnull(tx1.TaxName,'') as TaxNM1,isnull(tx2.TaxName,'') as TaxNM2,isnull(tx3.TaxName,'') as TaxNM3, "
                                + " isnull(p.DecimalPlace,'2') as DP, isnull(inv.CouponPerc,0) as cperc, isnull(s.Notes,'') as nts, inv.CustomerDOB from Suspnded s "
                                + " left outer join Invoice inv on s.InvoiceNo = inv.ID left outer join Customer c on s.CustomerID = c.ID "
                                + " left outer join Employee e on s.CreatedBy = e.ID Left outer join TaxHeader tx1 on s.TaxID1=tx1.ID "
                                + " Left outer join TaxHeader tx2 on s.TaxID2=tx2.ID Left outer join TaxHeader tx3 on s.TaxID3=tx3.ID "
                                + " Left outer join Product p on s.ProductID=p.ID where s.InvoiceNo = @InvoiceNo order by s.ItemIndex ";
           
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@InvoiceNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@InvoiceNo"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ProductType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DepartmentID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CategoryID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceA", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceB", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceC", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PriceOverride", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NewPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountLevel", System.Type.GetType("System.String"));
                dtbl.Columns.Add("GiftCertID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMCount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMPrice", System.Type.GetType("System.String"));
                dtbl.Columns.Add("UOMDesc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OptionValue3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxNM3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustCompany", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmpID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DP", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SDateTime", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemIndex", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CouponPerc", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Fees", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Notes", System.Type.GetType("System.String"));

                dtbl.Columns.Add("BuyNGetFreeHeaderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BuyNGetFreeName", System.Type.GetType("System.String"));

                dtbl.Columns.Add("CustomerDOB", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    string pName = "";

                    if (objSQLReader["CustID"].ToString() != "") pName = objSQLReader["CustLast"].ToString() + ", " + objSQLReader["CustFirst"].ToString();

                    dtbl.Rows.Add(new object[] {objSQLReader["ProductID"].ToString(),
                                                objSQLReader["ProductType"].ToString(),
                                                objSQLReader["DepartmentID"].ToString(),
                                                objSQLReader["CategoryID"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["PriceA"].ToString(),
                                                objSQLReader["PriceB"].ToString(),
                                                objSQLReader["PriceC"].ToString(),
                                                objSQLReader["PriceOverride"].ToString(),
                                                objSQLReader["NewPrice"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["Cost"].ToString(),
                                                objSQLReader["CustomerID"].ToString(),
                                                objSQLReader["DiscountLevel"].ToString(),
                                                objSQLReader["GiftCertID"].ToString(),
                                                objSQLReader["UOMCount"].ToString(),
                                                objSQLReader["UOMPrice"].ToString(),
                                                objSQLReader["UOMDesc"].ToString(),
                                                objSQLReader["MatrixOptionID"].ToString(),
                                                objSQLReader["OptionValue1"].ToString(),
                                                objSQLReader["OptionValue2"].ToString(),
                                                objSQLReader["OptionValue3"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),
                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),
                                                objSQLReader["TaxNM1"].ToString(),
                                                objSQLReader["TaxNM2"].ToString(),
                                                objSQLReader["TaxNM3"].ToString(),
                                                objSQLReader["CID"].ToString(),
                                                objSQLReader["CustID"].ToString(),
                                                pName,
                                                objSQLReader["CustCom"].ToString(),
                                                objSQLReader["EmpID"].ToString(),
                                                objSQLReader["DP"].ToString(),
                                                objSQLReader["DateTimeSuspended"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["ItemIndex"].ToString(),
                                                objSQLReader["cperc"].ToString(),
                                                objSQLReader["F"].ToString(),
                                                objSQLReader["FTx"].ToString(),
                                                objSQLReader["FeesText"].ToString(),
                                                objSQLReader["nts"].ToString(),
                                                objSQLReader["BuyNGetFreeHeaderID"].ToString(),
                                                objSQLReader["BuyNGetFreeCategory"].ToString(),
                                                objSQLReader["BuyNGetFreeName"].ToString(),
                                                objSQLReader["CustomerDOB"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #region  Void Transaction

        public bool IfExistsStoreCreditTenderingVoid(int INVNO)
        {
            int intcnt = 0;
            string strSQLComm = " select count(*) as RecCount from tender t left outer join invoice i on i.transactionno = t.transactionno "
                              + " left outer join tendertypes tt on tt.ID = t.tendertype where i.ID = @invoiceno  and tt.name = 'Store Credit' ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intcnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (intcnt == 0) return false;
                else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IfExistsHouseAccountTenderingVoid(int INVNO)
        {
            int intcnt = 0;
            string strSQLComm = " select count(*) as RecCount from tender t left outer join invoice i on i.transactionno = t.transactionno "
                              + " left outer join tendertypes tt on tt.ID = t.tendertype where i.ID = @invoiceno  and tt.name = 'House Account' ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intcnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (intcnt == 0) return false;
                else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IfExistsGiftCertVoid(int INVNO)
        {
            int intcnt = 0;
            string strSQLComm = " select count(*) as RecCount from item t left outer join invoice i on i.id = t.invoiceno "
                              + " and t.producttype = 'G' where i.ID = @invoiceno ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intcnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (intcnt == 0) return false;
                else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IfExistsHouseAccountPaymentVoid(int INVNO)
        {
            int intcnt = 0;
            string strSQLComm = " select count(*) as RecCount from item t left outer join invoice i on i.id = t.invoiceno "
                              + " and t.producttype = 'A' where i.ID = @invoiceno ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@invoiceno", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@invoiceno"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intcnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (intcnt == 0) return false;
                else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }
        
        public int VoidTransaction(int pID, string pterml)
        {
            int intReturn = -1;

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_void";

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@InvNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvNo"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@InvNo"].Value = pID;

                objSQlComm.Parameters.Add(new SqlParameter("@User", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@User"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@User"].Value = intLoginUserID;

                objSQlComm.Parameters.Add(new SqlParameter("@terml", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@terml"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@terml"].Value = pterml;

                objSQlComm.Parameters.Add(new SqlParameter("@dt", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@dt"].Value = DateTime.Now;

                /*objSQlComm.Parameters.Add(new SqlParameter("@CardID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CardID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@CardID"].Value = crd;*/

                objSQlComm.ExecuteNonQuery();
                intReturn = 0;
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intReturn;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return intReturn;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public int VoidRepair(int pID, string pterml)
        {
            int intReturn = -1;

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_void_repair";

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@InvNo", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@InvNo"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@InvNo"].Value = pID;

                objSQlComm.Parameters.Add(new SqlParameter("@User", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@User"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@User"].Value = intLoginUserID;

                objSQlComm.Parameters.Add(new SqlParameter("@terml", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@terml"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@terml"].Value = pterml;

                objSQlComm.Parameters.Add(new SqlParameter("@dt", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@dt"].Value = DateTime.Now;

                objSQlComm.Parameters.Add(new SqlParameter("@returnid", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@returnid"].Direction = ParameterDirection.Output;
                objSQlComm.ExecuteNonQuery();
                intReturn = Functions.fnInt32(objSQlComm.Parameters["@returnid"].Value);
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intReturn;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return intReturn;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        #endregion

        public bool IfExistsTaggedItem(int INVNO)
        {
            int intcnt = 0;
            string strSQLComm = " select count(*) as RecCount from item where invoiceno = @INV and tagged = 'X' and qty - returneditemcnt > 0 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@INV", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@INV"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intcnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (intcnt == 0) return false;
                else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public double GetMaxReturnedTagQty(int INVNO)
        {
            double intcnt = 0;
            string strSQLComm = " select isnull(Max(ReturnedItemCnt),0) as MRTag from item where DescID = @INV and tagged = 'X' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@INV", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@INV"].Value = INVNO;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    intcnt = Functions.fnDouble(objSQLReader["MRTag"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return intcnt;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public bool IsRestrictedDiscount(int intTranNo)
        {
            string cnt = "";
            string strSQLComm = " select ChkRestrictedItems from DiscountMaster where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = objSQLReader["ChkRestrictedItems"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt == "Y") return true; else return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public void IsApplicableForRestrictedDiscount(int PID, int DID, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_restrictdiscountapplied";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@DID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@DID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@DID"].Value = DID;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.Char, 1));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void IsApplicableForRestrictedFees(int PID, int DID, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_restrictfeesapplied";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@FID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@FID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@FID"].Value = DID;

                objSQlComm.Parameters.Add(new SqlParameter("@AppFee", System.Data.SqlDbType.Char, 1));
                objSQlComm.Parameters["@AppFee"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppFee"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetLineTax(int PID, ref double TX, ref string AT)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_linetax";

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxRate"].Direction = ParameterDirection.Output;

                objSQlComm.Parameters.Add(new SqlParameter("@AppTax", System.Data.SqlDbType.VarChar, 30));
                objSQlComm.Parameters["@AppTax"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                TX = Functions.fnDouble(objSQlComm.Parameters["@TaxRate"].Value.ToString());
                AT = objSQlComm.Parameters["@AppTax"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetItemDiscount(int PID, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getitemdiscount";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;


                objSQlComm.ExecuteNonQuery();


                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetItemDiscount_Cust(int PID,int CID,DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getitemdiscount_cust";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@CUSTID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CUSTID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@CUSTID"].Value = CID;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;


                objSQlComm.ExecuteNonQuery();


                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetTicketDiscount(string Term, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getticketdiscount";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar, 200));
                objSQlComm.Parameters["@TerminalName"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@TerminalName"].Value = Term;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetTicketDiscountCust(int CID, string Term, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getticketdiscount_cust";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@CUSTID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CUSTID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@CUSTID"].Value = CID;

                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar, 200));
                objSQlComm.Parameters["@TerminalName"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@TerminalName"].Value = Term;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetAutoItemDiscount(int PID, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getautoitemdiscount";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;
                
                objSQlComm.ExecuteNonQuery();
                
                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetAutoItemDiscount_Cust(int PID,int CID, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getautoitemdiscount_cust";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@CUSTID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CUSTID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@CUSTID"].Value = CID;
                
                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetAutoTicketDiscount(string Term, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getautoticketdiscount";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar, 200));
                objSQlComm.Parameters["@TerminalName"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@TerminalName"].Value = Term;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetAutoTicketDiscount_Cust(int CID, string Term, DateTime ODT, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getautoticketdiscount_cust";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@CUSTID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CUSTID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@CUSTID"].Value = CID;

                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar, 200));
                objSQlComm.Parameters["@TerminalName"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@TerminalName"].Value = Term;

                objSQlComm.Parameters.Add(new SqlParameter("@OrderTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@OrderTime"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@OrderTime"].Value = ODT;

                objSQlComm.Parameters.Add(new SqlParameter("@AppDisc", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppDisc"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppDisc"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetAutoFeesNCharges(int PID, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getfeesncharges_auto";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@AppFee", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppFee"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppFee"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetAutoTicketFeesNCharges(string T, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getfeesncharges_ticket_auto";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@TerminalName"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@TerminalName"].Value = T;

                objSQlComm.Parameters.Add(new SqlParameter("@AppFee", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppFee"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppFee"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetTicketFeesNCharges(string Term, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getfeesncharges_ticket";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar, 200));
                objSQlComm.Parameters["@TerminalName"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@TerminalName"].Value = Term;

                objSQlComm.Parameters.Add(new SqlParameter("@AppFee", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppFee"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppFee"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetFeesNCharges(int PID, ref string AD)
        {
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_getfeesncharges";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@AppFee", System.Data.SqlDbType.VarChar, 200));
                objSQlComm.Parameters["@AppFee"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                AD = objSQlComm.Parameters["@AppFee"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetFeesTax(int PID, ref double TX, ref string AT)
        {

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_feestax";

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = PID;

                objSQlComm.Parameters.Add(new SqlParameter("@TaxRate", System.Data.SqlDbType.Float));
                objSQlComm.Parameters["@TaxRate"].Direction = ParameterDirection.Output;

                objSQlComm.Parameters.Add(new SqlParameter("@AppTax", System.Data.SqlDbType.VarChar, 30));
                objSQlComm.Parameters["@AppTax"].Direction = ParameterDirection.Output;

                objSQlComm.ExecuteNonQuery();

                TX = Functions.fnDouble(objSQlComm.Parameters["@TaxRate"].Value.ToString());
                AT = objSQlComm.Parameters["@AppTax"].Value.ToString();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public DataTable FetchDiscounts(string RType)
        {
            DataTable dtbl = new DataTable();

            string SQLFilter = " and ID in (" + RType + ") ";

            string strSQLComm = " select ID,DiscountName,DiscountType,DiscountAmount,DiscountPercentage "
                              + " from DiscountMaster where DiscountStatus = 'Y' " + SQLFilter
                              + " order by DiscountName ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            //objSQlComm.Parameters.Add(new SqlParameter("@Type", System.Data.SqlDbType.Char));
            //objSQlComm.Parameters["@Type"].Value = RType;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Type", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));

                string chk1 = "";
                string chk2 = "";
                string chk3 = "";
                string val = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["DiscountType"].ToString() == "P")
                        val = objSQLReader["DiscountPercentage"].ToString();
                    else
                        val = objSQLReader["DiscountAmount"].ToString();
                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
                                                   objSQLReader["DiscountName"].ToString(), 
												   objSQLReader["DiscountType"].ToString(), val });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchFees(string RType)
        {
            DataTable dtbl = new DataTable();

            string SQLFilter = " and ID in (" + RType + ") ";

            string strSQLComm = " select ID,FeesName,FeesType,FeesAmount,FeesPercentage,ChkDiscount,ChkTax,ChkItemQty "
                              + " from FeesMaster where FeesStatus = 'Y' " +  SQLFilter  + " order by FeesName ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            //objSQlComm.Parameters.Add(new SqlParameter("@Type", System.Data.SqlDbType.Char));
            //objSQlComm.Parameters["@Type"].Value = RType;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Type", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CheckDiscount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CheckTax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CheckQty", System.Type.GetType("System.String"));

                string val = "";
                while (objSQLReader.Read())
                {
                    if (objSQLReader["FeesType"].ToString() == "P")
                        val = objSQLReader["FeesPercentage"].ToString();
                    else
                        val = objSQLReader["FeesAmount"].ToString();
                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
                                                   objSQLReader["FeesName"].ToString(), 
												   objSQLReader["FeesType"].ToString(),
                                                   val,
                                                   objSQLReader["ChkDiscount"].ToString(),
                                                   objSQLReader["ChkTax"].ToString(),
                                                   objSQLReader["ChkItemQty"].ToString() });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public string DeleteRecordFromTempDiscount(string TName)
        {
            string strSQLComm = " delete from TempDiscountID where TerminalName = @TName ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@TName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters["@TName"].Value = TName;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public string InsertDataIntoTempDiscount(string TName, int DID)
        {
            string strSQLComm = " insert into TempDiscountID(ID,TerminalName) values( @ID,@TerminalName) ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@TerminalName", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters["@ID"].Value = DID;
                objSQlComm.Parameters["@TerminalName"].Value = TName;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public DataTable FetchInvoiceCoupons(int intINV)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select Description,Discount from item where InvoiceNo = @ID and producttype in ('C','Z','H') and Discount > 0 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intINV;
            
            SqlDataReader objSQLReader = null;

            double TP = 0;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["Description"].ToString(),
												objSQLReader["Discount"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public void GetRepairHeaderFieldValues(SqlCommand objSQlComm,int RprID)
        {
            DateTime val = DateTime.Now;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select RepairItemName,RepairItemSlNo from invoice where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = RprID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    strRepairItemName = sqlDataReader["RepairItemName"].ToString();
                    strRepairItemSL = sqlDataReader["RepairItemSlNo"].ToString();
                }
                sqlDataReader.Close();
                return;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return;
            }
        }

        public double GetStoreCreditAmountOfCustomer(SqlCommand objSQlComm)
        {
            double val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select StoreCredit from Customer where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = intCustomerID;
                sqlDataReader = objSQlComm.ExecuteReader();


                if (sqlDataReader.Read())
                {
                    val = Functions.fnDouble(sqlDataReader["StoreCredit"]);
                }
                sqlDataReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return 0;
            }
        }

        public int GetStoreCreditTenderID(SqlCommand objSQlComm)
        {
            int val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select isnull(ID,0) as TenderID from tendertypes where Name = 'Store Credit' ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    val = Functions.fnInt32(sqlDataReader["TenderID"]);
                }
                sqlDataReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return 0;
            }
        }

        public DateTime GetTranDate(SqlCommand objSQlComm)
        {
            DateTime val = DateTime.Now;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select transdate from trans where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = intTransactionNo;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    val = Functions.fnDate(sqlDataReader["transdate"]);
                }
                sqlDataReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return DateTime.Now;
            }
        }

        public string GetCustomerIssueStore(SqlCommand objSQlComm)
        {
            string val = "";
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select isnull(issuestore,'') as custstore from customer where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = intCustomerID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    val = sqlDataReader["custstore"].ToString();
                }
                sqlDataReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return "";
            }
        }
        
        # region Appointments

        public bool CancelAppointment()
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                DeleteApptHeader(SaveComm);
                DeleteApptServiceMapping(SaveComm, intID);

                return true;
            }
            catch (SqlException SQLDBException)
            {
                return false;
            }
        }

        public bool AddAppointment()
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                if (intID == 0)
                {
                    InsertAppointmentData(SaveComm);
                }
                else
                {
                    UpdateAppointmentData(SaveComm);
                }
                DeleteApptServiceMapping(SaveComm, intID);
                AdjustApptServiceGridRecords(SaveComm);

                return true;
            }
            catch (SqlException SQLDBException)
            {
                return false;
            }
        }

        public int FetchApptCustomer(int mID)
        {
            int val = 0;
            string strSQLComm = " select CustomerID from appointments where ID = @ID ";


            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = mID;

                objSQLReader = objSQlComm.ExecuteReader();


                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["CustomerID"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }


        public bool InsertAppointmentData(SqlCommand objSQlComm)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            SqlDataReader sqlDataReader = null;
            try
            {
                strSQLComm = " Insert Into Appointments ( CustomerID,EmployeeID,ScheduleTime,ServiceTime,ApptRemarks,"
                           + " CreatedBy,CreatedOn,LastChangedBy,LastChangedOn )"
                           + " Values ( @CustomerID,@EmployeeID,@ScheduleTime,@ServiceTime,@ApptRemarks,"
                           + " @CreatedBy,@CreatedOn,@LastChangedBy,@LastChangedOn )"
                           + " select @@IDENTITY AS ID ";
                
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ScheduleTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ServiceTime", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ApptRemarks", System.Data.SqlDbType.NVarChar));
                
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@ScheduleTime"].Value = dtScheduleTime;
                objSQlComm.Parameters["@ServiceTime"].Value = intApptServiceTime;
                objSQlComm.Parameters["@ApptRemarks"].Value = strApptRemarks;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();

                if (sqlDataReader.Read()) intID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public bool UpdateAppointmentData(SqlCommand objSQlComm)
        {
            string strSQLComm = "";
            objSQlComm.Parameters.Clear();

            try
            {
                strSQLComm = " update Appointments set CustomerID=@CustomerID,EmployeeID=@EmployeeID,"
                           + " ScheduleTime=@ScheduleTime,ServiceTime=@ServiceTime,ApptRemarks=@ApptRemarks,"
                           + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn,BookingExpFlag=@BookingExpFlag where ID = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@EmployeeID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CustomerID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ScheduleTime", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ServiceTime", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@ApptRemarks", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intID;
                objSQlComm.Parameters["@EmployeeID"].Value = intEmployeeID;
                objSQlComm.Parameters["@CustomerID"].Value = intCustomerID;
                objSQlComm.Parameters["@ScheduleTime"].Value = dtScheduleTime;
                objSQlComm.Parameters["@ServiceTime"].Value = intApptServiceTime;
                objSQlComm.Parameters["@ApptRemarks"].Value = strApptRemarks;

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters.Add(new SqlParameter("@BookingExpFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@BookingExpFlag"].Value = strBookingExpFlag;

                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        private void AdjustApptServiceGridRecords(SqlCommand objSQlComm)
        {
            try
            {
                if (dtblItemDataTable == null) return;
                foreach (DataRow dr in dtblItemDataTable.Rows)
                {
                    string colServiceID = "";
                    if (dr["SKU"].ToString() == "") continue;
                    colServiceID = dr["ID"].ToString();
                    InsertApptServiceMapping(objSQlComm, Functions.fnInt32(colServiceID));
                }
                dtblItemDataTable.Dispose();
            }
            catch (Exception e)
            {
            }
        }

        public bool DeleteApptHeader(SqlCommand objSQlComm)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " delete from appointments where ID = @MID";

                objSQlComm.CommandText = strSQLComm;

                objSQlComm.Parameters.Add(new SqlParameter("@MID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@MID"].Value = intID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool DeleteApptServiceMapping(SqlCommand objSQlComm, int intRefID)
        {
            objSQlComm.Parameters.Clear();
            try
            {
                string strSQLComm = " delete from servicemapping where mappingtype = 'Appt' and MappingID = @MID";

                objSQlComm.CommandText = strSQLComm;

                objSQlComm.Parameters.Add(new SqlParameter("@MID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@MID"].Value = intRefID;
                objSQlComm.ExecuteNonQuery();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool InsertApptServiceMapping(SqlCommand objSQlComm, int srvid)
        {
            int intPODetailID = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            try
            {
                string strSQLComm = " insert into servicemapping (ServiceID,MappingID,MappingType, "
                                  + " CreatedBy, CreatedOn, LastChangedBy, LastChangedOn) "
                                  + " values( @ServiceID,@MappingID,@MappingType, "
                                  + " @CreatedBy, @CreatedOn, @LastChangedBy, @LastChangedOn) "
                                  + " select @@IDENTITY AS ID ";

                objSQlComm.CommandText = strSQLComm;

                objSQlComm.Parameters.Add(new SqlParameter("@ServiceID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MappingID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@MappingType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@CreatedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CreatedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ServiceID"].Value = srvid;
                objSQlComm.Parameters["@MappingID"].Value = intID;
                objSQlComm.Parameters["@MappingType"].Value = "Appt";

                objSQlComm.Parameters["@CreatedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CreatedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read()) intPODetailID = Functions.fnInt32(sqlDataReader["ID"]);
                sqlDataReader.Close();
                return true;
            }
            catch (SqlException SQLDBException)
            {
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return false;
            }
        }

        public DataTable FetchApptHeaderData(DateTime dtF, DateTime dtT, int EmpID, string configDateFormat)
        {
            DateTime FormatStartDate = new DateTime(dtF.Year, dtF.Month, dtF.Day, 0, 0, 1);
            DateTime FormatEndDate = new DateTime(dtT.Year, dtT.Month, dtT.Day, 23, 59, 59);

            string filtersql = "";
            if (EmpID != 0) filtersql = " and a.EmployeeID = @EMP ";

            DataTable dtbl = new DataTable();
            string strSQLComm = " select a.ID,a.ScheduleTime as ApptStart,dateadd(mi,a.servicetime,a.scheduletime) as ApptEnd,a.CustomerID, "
                              + " c.firstname + ' ' + c.lastname as Client,a.EmployeeID,e.firstname + ' ' + e.lastname as Staff, e.FirstName as ShortName, "
                              + " a.ApptStatus,a.CreatedOn as BookingDate,a.ApptRemarks from appointments a left outer join customer c on c.ID = a.CustomerID "
                              + " left outer join employee e on e.ID = a.EmployeeID where a.ScheduleTime between @SDT and @EDT and a.ApptStatus = 'New'" 
                              + filtersql + " order by a.ScheduleTime ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@SDT", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@SDT"].Value = FormatStartDate;
                objSQlComm.Parameters.Add(new SqlParameter("@EDT", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@EDT"].Value = FormatEndDate;
                if (EmpID != 0)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@EMP", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@EMP"].Value = EmpID;
                }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptSubject", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptDetail", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptStart", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptEnd", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmployeeID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Employee", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ShortName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BookingDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Remarks", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptStartD", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptEndD", System.Type.GetType("System.String"));


                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
												objSQLReader["ID"].ToString(),
                                                "","",
                                                Functions.fnDate(objSQLReader["ApptStart"].ToString()).ToString(configDateFormat + " hh:mm:ss tt"),
                                                Functions.fnDate(objSQLReader["ApptEnd"].ToString()).ToString(configDateFormat + " hh:mm:ss tt"),
                                                objSQLReader["ApptStatus"].ToString(),
                                                objSQLReader["CustomerID"].ToString(),
                                                objSQLReader["Client"].ToString(),
                                                objSQLReader["EmployeeID"].ToString(),
                                                objSQLReader["Staff"].ToString(),
                                                objSQLReader["ShortName"].ToString(),
                                                Functions.fnDate(objSQLReader["BookingDate"].ToString()).ToString(configDateFormat + " hh:mm:ss tt"),
                                                objSQLReader["ApptRemarks"].ToString(),
                                                Functions.fnDate(objSQLReader["ApptStart"].ToString()).ToString(),
                                                Functions.fnDate(objSQLReader["ApptEnd"].ToString()).ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchApptMappingData(int mID)
        {
            DataTable dtbl = new DataTable();
            
            string strSQLComm = " select p.Description as Service from product p left outer join servicemapping sm "
                              + " on p.ID = sm.ServiceID where p.producttype = 'S' and sm.mappingtype = 'Appt' "
                              + " and sm.MappingID = @MID order by p.Description";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@MID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@MID"].Value = mID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Service", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["Service"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchApptHeader(int mID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select ID,CustomerID,EmployeeID,ScheduleTime,ServiceTime,ApptRemarks,CreatedOn,BookingExpFlag "
                              + " from appointments where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = mID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EmployeeID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ScheduleTime", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ServiceTime", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptRemarks", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BookingTime", System.Type.GetType("System.String"));
                dtbl.Columns.Add("BookingExpFlag", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] { objSQLReader["ID"].ToString(),
                                                 objSQLReader["CustomerID"].ToString(),
                                                 objSQLReader["EmployeeID"].ToString(),
                                                 objSQLReader["ScheduleTime"].ToString(),
                                                 objSQLReader["ServiceTime"].ToString(),
                                                 objSQLReader["ApptRemarks"].ToString(),
                                                 objSQLReader["CreatedOn"].ToString(),
                                                 objSQLReader["BookingExpFlag"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchApptDetail(int mID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select p.ID, p.SKU, p.Description,p.MinimumServiceTime from product p left outer join servicemapping sm "
                              + " on p.ID = sm.ServiceID where p.producttype = 'S' and sm.mappingtype = 'Appt' "
                              + " and sm.MappingID = @MID order by p.Description";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@MID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@MID"].Value = mID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MinimumServiceTime", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] { objSQLReader["ID"].ToString(),
                                                 objSQLReader["SKU"].ToString(),
                                                 objSQLReader["Description"].ToString(),
                                                 objSQLReader["MinimumServiceTime"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public string ApptCancel()
        {
            string strSQLComm = " update appointments set apptstatus='Cancel',apptremarks=@remrks, "
                              + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn where ID = @ID";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@remrks", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = intID;
                objSQlComm.Parameters["@remrks"].Value = strApptRemarks;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void GetApptStartEnd(int mID, ref DateTime dtS, ref DateTime dtE, string configDateFormat)
        {
            string strSQLComm = " select ScheduleTime as StartTime,dateadd(mi,ServiceTime,ScheduleTime) as EndTime "
                              + " from appointments where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = mID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dtS = Functions.fnDate(Functions.fnDate(objSQLReader["StartTime"].ToString()).ToString(configDateFormat + " hh:mm:ss tt"));
                    dtE = Functions.fnDate(Functions.fnDate(objSQLReader["EndTime"].ToString()).ToString(configDateFormat + " hh:mm:ss tt"));
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
            }
        }

        public bool IsAttachedStaff(int mID,int mEmpID,DateTime dtS,DateTime dtE)
        {
            string strSQLComm = "";
            int val = 0;
            if (mID == 0) // add mode
            {
                strSQLComm = " select count(*) as reccnt from appointments where employeeid = @EID and ApptStatus = 'New' "
                           + " and ((ScheduleTime between @dt1 and @dt2) or (dateadd(mi,ServiceTime,ScheduleTime) between @dt3 and @dt4)) ";
            }

            if (mID > 0) // edit mode
            {
                strSQLComm = " select count(*) as reccnt from appointments where employeeid = @EID and ApptStatus = 'New'"
                           + " and ((ScheduleTime between @dt1 and @dt2) or (dateadd(mi,ServiceTime,ScheduleTime) between @dt3 and @dt4)) "
                           + " and ID <> @ID ";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@EID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@EID"].Value = mEmpID;

                objSQlComm.Parameters.Add(new SqlParameter("@dt1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt1"].Value = dtS;
                objSQlComm.Parameters.Add(new SqlParameter("@dt2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt2"].Value = dtE;
                objSQlComm.Parameters.Add(new SqlParameter("@dt3", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt3"].Value = dtS;
                objSQlComm.Parameters.Add(new SqlParameter("@dt4", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt4"].Value = dtE;

                if (mID > 0)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@ID"].Value = mID;
                }

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["reccnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (val == 0) return false; else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return true;
            }
        }

        public bool IsAttachedClient(int mID, int mCustID,DateTime dtS,DateTime dtE)
        {
            string strSQLComm = "";
            int val = 0;
            if (mID == 0) // add mode
            {
                strSQLComm = " select count(*) as reccnt from appointments where customerid = @EID and ApptStatus = 'New' "
                           + " and ((ScheduleTime between @dt1 and @dt2) or (dateadd(mi,ServiceTime,ScheduleTime) between @dt3 and @dt4)) ";
            }

            if (mID > 0) // edit mode
            {
                strSQLComm = " select count(*) as reccnt from appointments where customerid = @EID and ApptStatus = 'New'"
                           + " and ((ScheduleTime between @dt1 and @dt2) or (dateadd(mi,ServiceTime,ScheduleTime) between @dt3 and @dt4)) "
                           + " and ID <> @ID ";
            }

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@EID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@EID"].Value = mCustID;

                objSQlComm.Parameters.Add(new SqlParameter("@dt1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt1"].Value = dtS;
                objSQlComm.Parameters.Add(new SqlParameter("@dt2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt2"].Value = dtE;
                objSQlComm.Parameters.Add(new SqlParameter("@dt3", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt3"].Value = dtS;
                objSQlComm.Parameters.Add(new SqlParameter("@dt4", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@dt4"].Value = dtE;

                if (mID > 0)
                {
                    objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                    objSQlComm.Parameters["@ID"].Value = mID;
                }

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["reccnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (val == 0) return false; else return true;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return true;
            }
        }

        #endregion

        public DataTable FetchAddressFromCustomerData(int pCID)
        {
            DataTable dtbl = new DataTable();
            
            string strSQLComm = " select * from customer where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = pCID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FirstName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LastName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PhoneNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Address1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Address2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("City", System.Type.GetType("System.String"));
                dtbl.Columns.Add("State", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Country", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Zip", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PhoneNo1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PhoneNo2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Mobile", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Email", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {objSQLReader["CustomerID"].ToString(),
                                                objSQLReader["FirstName"].ToString(),
                                                objSQLReader["LastName"].ToString(),
                                                objSQLReader["WorkPhone"].ToString(),
                                                objSQLReader["Address1"].ToString(),
                                                objSQLReader["Address2"].ToString(),
                                                objSQLReader["City"].ToString(),
                                                objSQLReader["State"].ToString(),
                                                objSQLReader["Country"].ToString(),
                                                objSQLReader["Zip"].ToString(),
                                                objSQLReader["HomePhone"].ToString(),
                                                objSQLReader["Company"].ToString(),
                                                objSQLReader["MobilePhone"].ToString(),
                                                objSQLReader["EMail"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int GetRepairNotDeliverCount(int mID)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select count(*) as reccnt from item where invoiceno = @ID and servicetype = 'Repair' "
                       + " and repairitemdeliverydate is null ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = mID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["reccnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable FetchRepairInfo(int pID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select i.ID as InvoiceNo,i.Status as Status,i.RepairAmount,i.RepairAdvanceAmount,"
                              + " i.RepairDueAmount,i.RepairStatus,i.RepairDeliveryDate as ExpectedDeliveryDate, "
                              + " i.RepairNotifiedDate as NotifiedDate,t.TransDate,i.RepairProblem, i.RepairDateIn,"
                              + " i.RepairNotes,i.RepairRemarks,i.RepairItemName,i.RepairItemSlNo,i.RepairFindUs "
                              + " from trans t left outer join invoice as i on  "
                              + " t.ID = i.TransactionNo where (1 = 1) and i.ServiceType = 'Repair' and i.ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = pID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Status", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairAdvanceAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairDueAmount", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("RepairStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ExpectedDeliveryDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("NotifiedDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairProblem", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairNotes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairRemarks", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSlNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairDateIn", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairFindUs", System.Type.GetType("System.String"));
                string strPrevInv = "";
                
                while (objSQLReader.Read())
                {
                    
                    if ((strPrevInv == "") || (strPrevInv != objSQLReader["InvoiceNo"].ToString()))
                    {
                        dtbl.Rows.Add(new object[] {
                                                        objSQLReader["InvoiceNo"].ToString(),
                                                        objSQLReader["Status"].ToString(),
                                                        Functions.fnDouble(objSQLReader["RepairAmount"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RepairAdvanceAmount"].ToString()),
                                                        Functions.fnDouble(objSQLReader["RepairDueAmount"].ToString()),
                                                        objSQLReader["RepairStatus"].ToString(),
                                                        objSQLReader["ExpectedDeliveryDate"].ToString(),
                                                        objSQLReader["NotifiedDate"].ToString(),
                                                        objSQLReader["TransDate"].ToString(),
                                                        objSQLReader["RepairProblem"].ToString(),
                                                        objSQLReader["RepairNotes"].ToString(),
                                                        objSQLReader["RepairRemarks"].ToString(),
                                                        objSQLReader["RepairItemName"].ToString(),
                                                        objSQLReader["RepairItemSlNo"].ToString(),
                                                        objSQLReader["RepairDateIn"].ToString(),
                                                        objSQLReader["RepairFindUs"].ToString()
                                                });
                    }
                    strPrevInv = objSQLReader["InvoiceNo"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public string UpdateRepairInfo()
        {
            string strSQLComm = " update invoice set RepairDeliveryDate=@RepairDeliveryDate,RepairNotifiedDate=@RepairNotifiedDate,"
                              + " RepairProblem = @RepairProblem,RepairNotes = @RepairNotes, RepairRemarks = @RepairRemarks, "
                              + " RepairItemName=@RepairItemName,RepairItemSlNo=@RepairItemSlNo,RepairFindUs = @RepairFindUs,LastChangedBy=@LastChangedBy,"
                              + " LastChangedOn=@LastChangedOn where ID = @ID";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairDeliveryDate", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairNotifiedDate", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairProblem", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairNotes", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairRemarks", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemName", System.Data.SqlDbType.NVarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RepairItemSlNo", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RepairFindUs", System.Data.SqlDbType.NVarChar));

                objSQlComm.Parameters["@ID"].Value = intID;
                if (dtRepairDeliveryDate == Convert.ToDateTime(null)) objSQlComm.Parameters["@RepairDeliveryDate"].Value = Convert.DBNull;
                else objSQlComm.Parameters["@RepairDeliveryDate"].Value = dtRepairDeliveryDate;
                if (dtRepairNotifiedDate == Convert.ToDateTime(null)) objSQlComm.Parameters["@RepairNotifiedDate"].Value = Convert.DBNull;
                else objSQlComm.Parameters["@RepairNotifiedDate"].Value = dtRepairNotifiedDate;
                objSQlComm.Parameters["@RepairProblem"].Value = strRepairProblem;
                objSQlComm.Parameters["@RepairNotes"].Value = strRepairNotes;
                objSQlComm.Parameters["@RepairRemarks"].Value = strRepairRemarks;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;

                objSQlComm.Parameters["@RepairItemName"].Value = strRepairItemName;
                objSQlComm.Parameters["@RepairItemSlNo"].Value = strRepairItemSL;

                objSQlComm.Parameters["@RepairFindUs"].Value = strRepairFindUs;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public int GetTransactionID(SqlCommand objSQlComm, int pinvID)
        {
            int val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select TransactionNo from invoice where ID=@ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pinvID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    val = Functions.fnInt32(sqlDataReader["TransactionNo"]);
                }
                sqlDataReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return 0;
            }
        }

        public int GetTranID(int pinvID)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select TransactionNo from invoice where ID=@ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pinvID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["TransactionNo"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }
        
        public int GetTranID1(int pinvID)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select i.TransactionNo from invoice i left outer join item m on m.invoiceno = i.id where m.ID=@ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pinvID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["TransactionNo"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public bool IsCardPaymentVoid(int INV)
        {
            bool flg = false;
            string strSQLComm = " select count(c.id) as reccnt from invoice i left outer join trans t on i.transactionno = t.id "
                              + " left outer join cardtrans c on t.id = c.transactionno where i.id = @prm and c.adjustflag = 'Y' ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = INV;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    if (Functions.fnInt32(objsqlReader["reccnt"]) > 0) flg = true;
                }

                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return flg;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }
        
        public bool IsCardPayment1(int INV)
        {
            bool flg = false;
            string strSQLComm = " select count(c.id) as reccnt from invoice i left outer join trans t on i.transactionno = t.id "
                              + " left outer join cardtrans c on t.id = c.transactionno where i.id = @prm and c.adjustflag = 'N' ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = INV;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    if (Functions.fnInt32(objsqlReader["reccnt"]) > 0) flg = true;
                }

                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return flg;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public bool IsCardPayment2(int prm)
        {
            bool flg = false;
            string strSQLComm = " select count(c.id) as reccnt from trans t "
                              + " left outer join cardtrans c on t.id = c.transactionno where c.transactionno = @prm ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = prm;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    if (Functions.fnInt32(objsqlReader["reccnt"]) > 0) flg = true;

                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return flg;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        public bool IsCardPayment3(int prm)
        {
            bool flg = false;
            string strSQLComm = " select count(c.id) as reccnt from trans t "
                              + " left outer join cardtrans c on t.id = c.transactionno where c.transactionno = @prm and adjustflag = 'N' ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = prm;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    if (Functions.fnInt32(objsqlReader["reccnt"]) > 0) flg = true;

                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return flg;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        public bool IsCardPayment4(int prm)
        {
            bool flg = false;
            string strSQLComm = " select count(c.id) as reccnt from trans t "
                              + " left outer join cardtrans c on t.id = c.transactionno where c.transactionno = @prm ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = prm;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    if (Functions.fnInt32(objsqlReader["reccnt"]) > 0) flg = true;

                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return flg;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        public DataTable FetchCardTransData(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and transactiontype is not null ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AuthCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryAcqRef", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryToken", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Reference", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryInvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryProcessData", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ReturnAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["CardAmount"].ToString(),
                                                objSQLReader["AuthCode"].ToString(),
                                                objSQLReader["MercuryAcqRef"].ToString(),
                                                objSQLReader["MercuryToken"].ToString(),
                                                objSQLReader["PaymentGateway"].ToString(),
                                                objSQLReader["Reference"].ToString(),
                                                objSQLReader["MercuryInvoiceNo"].ToString(),
                                                objSQLReader["MercuryProcessData"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["TransactionType"].ToString(),
                                                objSQLReader["ReturnAmount"].ToString(),
                                                objSQLReader["RefCardAuthAmount"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchCardTransData1(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where ID = @ID  ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AuthCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryAcqRef", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryToken", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Reference", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryInvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryProcessData", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["CardAmount"].ToString(),
                                                objSQLReader["AuthCode"].ToString(),
                                                objSQLReader["MercuryAcqRef"].ToString(),
                                                objSQLReader["MercuryToken"].ToString(),
                                                objSQLReader["PaymentGateway"].ToString(),
                                                objSQLReader["Reference"].ToString(),
                                                objSQLReader["MercuryInvoiceNo"].ToString(),
                                                objSQLReader["MercuryProcessData"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["TransactionType"].ToString(),
                                                objSQLReader["RefCardAuthAmount"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int GetCardTypeID(string pcrdtype)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select ID from tendertypes where name=@nm ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@nm", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters["@nm"].Value = pcrdtype;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["ID"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public int GetTranIDFromInvoiceID(int prm)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select distinct t.ID from trans t left outer join invoice i on i.transactionno = t.id where i.id =@nm ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@nm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@nm"].Value = prm;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["ID"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable FetchMercuryGiftCardData(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and transactiontype is not null and cardtype in ('Mercury Gift Card','Precidia Gift Card','Datacap Gift Card','POSLink Gift Card') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardBalance", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["RefCardBalance"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchMercuryEBTCardData(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and transactiontype is not null and cardtype in ('Food Stamps') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardBalance", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["RefCardBalance"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchPrecidiaGiftCardData(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and transactiontype is not null and cardtype = 'Precidia Gift Card' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardBalance", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["RefCardBalance"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchVoidCardData(int pInvoiceNo)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where MercuryInvoiceNo = @ID and TransactionType = 'Void' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pInvoiceNo;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardBalance", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Reference", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["RefCardBalance"].ToString(),
                                                objSQLReader["PaymentGateway"].ToString(),
                                                objSQLReader["Reference"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchEmvPrinData(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select PrintXml from cardtrans where transactionno = @ID and transactiontype is not null ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("PrintXml", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["PrintXml"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }
        public DataTable FetchCardData(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and transactiontype is not null ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardBalance", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["RefCardBalance"].ToString(),
                                                objSQLReader["PaymentGateway"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchCardDataForAdjust(string ty, DateTime df, DateTime dt)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";
            DateTime F = new DateTime(df.Year, df.Month, df.Day, 0, 0, 1);
            DateTime T = new DateTime(dt.Year, dt.Month, dt.Day, 23, 59, 59);
            string sqlf1 = " and createdon between @f and @t ";
            //string sqlf2 = " and transactiontype=@trn ";
            strSQLComm = " select * from cardtrans where (1 = 1) " + sqlf1 
                       + " and adjustflag = 'N' and paymentgateway = 2 and AuthCode is not null order by ID, createdon desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@trn", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters["@trn"].Value = ty;

                objSQlComm.Parameters.Add(new SqlParameter("@f", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@f"].Value = F;

                objSQlComm.Parameters.Add(new SqlParameter("@t", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@t"].Value = T;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsComplete", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AuthCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Reference", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryAcqRef", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryToken", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryInvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryProcessData", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryPurchaseAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryTextResponse", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    string paygateway = "";
                    if (objSQLReader["PaymentGateway"].ToString() == "1") paygateway = "Element";
                    if (objSQLReader["PaymentGateway"].ToString() == "2") paygateway = "Mercury";
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["IsComplete"].ToString(),
                                                Functions.fnDouble(objSQLReader["CardAmount"]).ToString("#0.00"),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["TransactionType"].ToString(),
                                                objSQLReader["TransactionNo"].ToString(),
                                                objSQLReader["AuthCode"].ToString(),
                                                objSQLReader["Reference"].ToString(),
                                                paygateway,
                                                objSQLReader["MercuryAcqRef"].ToString(),
                                                objSQLReader["MercuryToken"].ToString(),
                                                objSQLReader["MercuryInvoiceNo"].ToString(),
                                                objSQLReader["MercuryProcessData"].ToString(),
                                                objSQLReader["MercuryPurchaseAmount"].ToString(),
                                                objSQLReader["MercuryTextResponse"].ToString(),
                                                objSQLReader["CustomerID"].ToString(),
                                                Functions.fnDate(objSQLReader["LastChangedOn"].ToString()).ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public string UpdateCardAdjustment()
        {
            string strSQLComm = " update CardTrans set AdjustFlag='Y',LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn where ID = @ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@ID"].Value = intCardTranID;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public string UpdateCardAdjustmentOnReturn(string flg,double totreturn)
        {
            string strSQLComm = " update CardTrans set AdjustFlag=@f,ReturnAmount=@amt,LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn where ID = @ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@f", System.Data.SqlDbType.Char));
                objSQlComm.Parameters.Add(new SqlParameter("@amt", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@ID"].Value = intCardTranID;
                objSQlComm.Parameters["@f"].Value = flg;
                objSQlComm.Parameters["@amt"].Value = totreturn;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public DataTable ShowDistinctGiftCert(DateTime pImportOn)
        {
            DataTable dtbl = new DataTable();

            string sqlfilter = "";
            
            //if (pexp == "Yes") sqlfilter1 = " and ExpFlag = 'Y'";
            //if (pexp == "No") sqlfilter1 = " and ExpFlag = 'N'";

            string strSQLComm = " select Distinct GiftCertID,IssueStore "
                              + " from GiftCert where 1 =1 " + sqlfilter + " order by IssueStore ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, Connection);
            SqlDataReader objSQLReader = null;

            try
            {
                if (Connection.State == System.Data.ConnectionState.Closed) { Connection.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("GiftCertID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IssueStore", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["GiftCertID"].ToString(),
    											objSQLReader["IssueStore"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                Connection.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable ShowGiftCertList(DateTime pImportOn, string configDateFormat)
        {
            DataTable dtbl = new DataTable();

            string sqlfilter = "";
            string sqlfilter1 = "";
            DateTime sdt = new DateTime(pImportOn.Year, pImportOn.Month, pImportOn.Day, 0, 0, 1);
            DateTime fdt = new DateTime(pImportOn.Year, pImportOn.Month, pImportOn.Day, 23, 59, 59);
            
            //sqlfilter = " and ImportOn between @sdt and @tdt ";

            string strSQLComm = " select GiftCertID,Amount,ItemID,TenderNo,CreatedOn,IssueStore,OperateStore,ImportBatch,ImportOn  "
                                + " from GiftCert where 1 = 1 " + sqlfilter + " order by ImportBatch,OperateStore ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, Connection);
            SqlDataReader objSQLReader = null;

            try
            {
                if (Connection.State == System.Data.ConnectionState.Closed) { Connection.Open(); }

                /*objSQlComm.Parameters.Add(new SqlParameter("@sdt", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@sdt"].Value = sdt;

                objSQlComm.Parameters.Add(new SqlParameter("@tdt", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@tdt"].Value = fdt;*/


                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("GiftCertID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranType", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("IssueStore", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OperateStore", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ImportBatch", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tran", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    // indian red : -3318692
                    // red : -65536
                    // coral : -32944
                    // chocolate : -2987746
                    // orange : -23296
                    // green : -16728064
                    // purple : -8388480
                    // royalblue : -12490271
                    // aquamarine : -8388652

                    string t = "";
                    int trn = 0;
                    if ((Convert.ToInt32(objSQLReader["ItemID"].ToString()) == 0) && (Convert.ToInt32(objSQLReader["TenderNo"].ToString()) > 0))
                    {
                        trn = -16728064;
                        t = "T";
                    }
                    if ((Convert.ToInt32(objSQLReader["ItemID"].ToString()) > 0) && (Convert.ToInt32(objSQLReader["TenderNo"].ToString()) == 0))
                    {
                        trn = -12490271;
                        t = "I";
                    }
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["GiftCertID"].ToString(),
												Convert.ToDouble(objSQLReader["Amount"].ToString()).ToString("#0.00"),
                                                trn,
    											objSQLReader["IssueStore"].ToString(),
                                                objSQLReader["OperateStore"].ToString(),
                                                Convert.ToInt32(objSQLReader["ImportBatch"].ToString()),
                                                Convert.ToDateTime(objSQLReader["CreatedOn"].ToString()).ToString(configDateFormat + " hh:mm:ss tt"),t});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                Connection.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public bool IsRentParentExist(int pInv)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select isnull(ID,0) as val from invoice where rentparentid=@id ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@id"].Value = pInv;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["val"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return (val > 0);
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        #region Transaction Journal
        
        public DataTable FetchTransactionJournal(DateTime dt1,DateTime dt2,string configDateFormat)
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                return FetchTrnJournalMain(SaveComm, dt1, dt2, configDateFormat);
            }
            catch (SqlException SQLDBException)
            {
                string sss = SQLDBException.ToString();
                return null;
            }
        }

        public DataTable FetchTrnJournalMain(SqlCommand objSQlComm, DateTime pdt1, DateTime pdt2, string configDateFormat)
        {
            try
            {
                DataTable dtblTrn = FetchTrnJournalTrn(objSQlComm, pdt1, pdt2, configDateFormat);
                string val6 = "";
                string val7 = "";
                string val8 = "";

                foreach (DataRow drT in dtblTrn.Rows)
                {
                   
                    val6 = "";
                    val7 = "";
                    
                    int trnid = Functions.fnInt32(drT["TranNo"].ToString());
                    string trntype = drT["TranType"].ToString();
                    
                    bool laywy = IsLayawayTransaction(objSQlComm, trnid);

                    if (trntype != "No Sale")
                    {
                        if (laywy)
                        {
                            val6 = GetLayawayNo(objSQlComm, trnid).ToString();
                            val7 = GetLayawayTotal(objSQlComm, Functions.fnInt32(val6)).ToString();
                            drT["InvNo"] = val6;
                            drT["InvAmt"] = val7;
                        }
                        else
                        {
                            DataTable dInv = FetchTrnJournalInv(objSQlComm, trnid);
                            foreach (DataRow dr in dInv.Rows)
                            {
                                string tI = dr["InvNo"].ToString();
                                double tA = 0;

                                val6 = dr["InvNo"].ToString();
                                tA = Functions.fnDouble(dr["Amt"].ToString());

                                val7 = (Functions.fnDouble(val7) + tA).ToString();
                                drT["InvNo"] = val6;
                                drT["InvAmt"] = val7;
                                if (dr["Status"].ToString() == "4") drT["TranType"] = "Void";
                                if ((dr["ServiceType"].ToString() == "Sales") && (Functions.fnDouble(dr["Amt"].ToString()) < 0)) drT["TranType"] = "Return";

                            }
                            dInv.Dispose();
                        }
                        val8 = "";
                        DataTable dTender = FetchTrnJournalTender(objSQlComm, trnid);
                        foreach (DataRow dr1 in dTender.Rows)
                        {
                            val8 = dr1["Tender"].ToString();
                        }
                        drT["Tender"] = val8;

                        dTender.Dispose();
                    }
                }
                return dtblTrn;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                return null;
            }
        }

        public bool IsLayawayTransaction(SqlCommand objSQlComm, int TrnNo)
        {
            int val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select count(*) as rcnt from laypmts where TransactionNo=@T ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();
                
                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }

                objSQLReader.Close();
                return (val > 0);
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public int GetLayawayNo(SqlCommand objSQlComm, int TrnNo)
        {
            int val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select layawayno from invoice where id in ( select invoiceno from laypmts where TransactionNo = @T) ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["layawayno"].ToString());
                }

                objSQLReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double GetLayawayTotal(SqlCommand objSQlComm, int LNo)
        {
            double val = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select sum(totalsale) as tot from invoice where LayawayNo = @T ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = LNo;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnDouble(objSQLReader["tot"].ToString());
                }

                objSQLReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable FetchTrnJournalTrn(SqlCommand objSQlComm, DateTime pdt1, DateTime pdt2, string configDateFormat)
        {
            DateTime FromDate = new DateTime(pdt1.Year, pdt1.Month, pdt1.Day, 0, 0, 0);
            DateTime ToDate = new DateTime(pdt2.Year, pdt2.Month, pdt2.Day, 23, 59, 59);

            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select t.ID,t.TransType,t.TransDate,isnull(e.EmployeeID,'ADMIN') as Emp,t.CloseoutID,t.TerminalName from trans t "
                           + " left outer join Employee e on e.ID = t.EmployeeID where t.TransDate between @F and @T order by t.TransDate ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@F", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@F"].Value = FromDate;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@T"].Value = ToDate;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TranNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Terminal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("User", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvAmt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tender", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    string val1 = "";
                    string val2 = "";
                    string val3 = "";
                    string val4 = "";
                    string val5 = "";
                    string val6 = "";
                    string val7 = "";
                    string val8 = "";

                    int trnid = Functions.fnInt32(objSQLReader["ID"].ToString());
                    val1 = trnid.ToString();
                    int trntype = Functions.fnInt32(objSQLReader["TransType"].ToString());
                    if (trntype == 1) val2 = "Sale";
                    if (trntype == 2) val2 = "New Layaway";
                    if (trntype == 4) val2 = "Layaway Payment";
                    if (trntype == 3) val2 = "Layaway Refund";
                    if (trntype == 5) val2 = "No Sale";
                    if (trntype == 6) val2 = "Paid Out";
                    if (trntype == 60) val2 = "Lotto Payout";
                    if (trntype == 15) val2 = "Rent Issued";
                    if (trntype == 16) val2 = "Rent Return";
                    if (trntype == 17) val2 = "Repair In";
                    if (trntype == 18) val2 = "Repair Return";

                    val3 = Functions.fnDate(objSQLReader["TransDate"].ToString()).ToString((configDateFormat) + " hh:mm tt");
                    val4 = objSQLReader["TerminalName"].ToString();
                    val5 = objSQLReader["Emp"].ToString();

                    dtbl.Rows.Add(new object[] { val1, val2, val3, val4, val5, val6, val7, val8 });
                }
                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchTrnJournalInv(SqlCommand objSQlComm, int TrnNo)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select ID,TotalSale,Tax1,Tax2,Tax3,Discount,Coupon,Status,ServiceType,LayawayNo from Invoice "
                           + " where TransactionNo=@T ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvNo", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("InvAmt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ServiceType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Status", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("LNo", System.Type.GetType("System.Int32"));
                while (objSQLReader.Read())
                {
                    string amt = Functions.fnDouble(objSQLReader["TotalSale"].ToString()).ToString("f");
                    string amtdetails = "";
                    if (Functions.fnDouble(objSQLReader["Tax1"].ToString()) != 0)
                        amtdetails = "  ( Tx1: " + Functions.fnDouble(objSQLReader["Tax1"].ToString()).ToString("f");
                    if (Functions.fnDouble(objSQLReader["Tax2"].ToString()) != 0)
                    {
                        if (amtdetails == "") amtdetails = "( Tx2: " + Functions.fnDouble(objSQLReader["Tax2"].ToString()).ToString("f");
                        else amtdetails = amtdetails + ",Tx2: " + Functions.fnDouble(objSQLReader["Tax2"].ToString()).ToString("f");
                    }
                    if (Functions.fnDouble(objSQLReader["Tax3"].ToString()) != 0)
                    {
                        if (amtdetails == "") amtdetails = "( Tx3: " + Functions.fnDouble(objSQLReader["Tax3"].ToString()).ToString("f");
                        else amtdetails = amtdetails + ",Tx3: " + Functions.fnDouble(objSQLReader["Tax3"].ToString()).ToString("f");
                    }
                    if (Functions.fnDouble(objSQLReader["Discount"].ToString()) != 0)
                    {
                        if (amtdetails == "") amtdetails = "( D: " + Functions.fnDouble(objSQLReader["Discount"].ToString()).ToString("f");
                        else amtdetails = amtdetails + ",Disc: " + Functions.fnDouble(objSQLReader["Discount"].ToString()).ToString("f");
                    }

                    if (Functions.fnDouble(objSQLReader["Coupon"].ToString()) != 0)
                    {
                        if (amtdetails == "") amtdetails = "( C: " + Functions.fnDouble(objSQLReader["Coupon"].ToString()).ToString("f");
                        else amtdetails = amtdetails + ",C: " + Functions.fnDouble(objSQLReader["Coupon"].ToString()).ToString("f");
                    }

                    if (amtdetails != "") amtdetails = amtdetails + " )";
                    
                    dtbl.Rows.Add(new object[] { Functions.fnInt32(objSQLReader["ID"].ToString()),
                                                 amt + amtdetails,
                                                 Functions.fnDouble(objSQLReader["TotalSale"].ToString()),
                                                 objSQLReader["ServiceType"].ToString(),
                                                 Functions.fnInt32(objSQLReader["Status"].ToString()),
                                                 Functions.fnInt32(objSQLReader["LayawayNo"].ToString())
                    });
                }

                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchTrnJournalTender(SqlCommand objSQlComm, int TrnNo )
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select isnull(tt.DisplayAs,'') as Name,isnull(t.TenderAmount,0) as Amt from Tender t left outer join TenderTypes tt "
                           + " on t.TenderType = tt.ID where t.TransactionNo=@T order by tt.DisplayAs ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Tender", System.Type.GetType("System.String"));
                string prevname = "";
                string currname = "";
                string tenderstr = "";
                while (objSQLReader.Read())
                {
                    currname = objSQLReader["Name"].ToString();
                    if (currname != prevname) 
                    {
                        if (tenderstr == "") tenderstr = currname; else tenderstr = tenderstr + "  " + currname;
                    }
                    double amt = Functions.fnDouble(objSQLReader["Amt"].ToString());
                    if (amt > 0)
                    {
                        tenderstr = tenderstr + " T:" + amt.ToString("f");
                    }
                    else
                    {
                        tenderstr = tenderstr + " R:" + amt.ToString("f");
                    }

                    dtbl.Rows.Add(new object[] { tenderstr });

                    prevname = currname;
                }

                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchTrnJournalItem(SqlCommand objSQlComm, int TrnNo)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select count(*) as rcnt from item where invoiceno = @inv ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("Tender", System.Type.GetType("System.String"));
                string prevname = "";
                string currname = "";
                string tenderstr = "";
                while (objSQLReader.Read())
                {
                    currname = objSQLReader["Name"].ToString();
                    if (currname != prevname)
                    {
                        if (tenderstr == "") tenderstr = currname; else tenderstr = tenderstr + "  " + currname;
                    }
                    double amt = Functions.fnDouble(objSQLReader["Amt"].ToString());
                    if (amt > 0)
                    {
                        tenderstr = tenderstr + " T:" + amt.ToString("f");
                    }
                    else
                    {
                        tenderstr = tenderstr + " R:" + amt.ToString("f");
                    }

                    dtbl.Rows.Add(new object[] { tenderstr });

                    prevname = currname;
                }

                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        #region MixNmatch

        public DataTable FetchActiveAmountTypeMixNMatch()
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select ID, DiscountName, AbsolutePrice, DiscountType,DiscountAmount,DiscountPercentage from MixNmatchHeader where DiscountStatus = 'Y' and BasedOn = 1 "
                       + " and ((LimitedPeriodCheck = 'N')  or  (LimitedPeriodCheck = 'Y' and getdate() between OfferStartOn and OfferEndOn)) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CutoffAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Type", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Value", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["ID"].ToString(),
                                                objSQLReader["DiscountName"].ToString(),
												objSQLReader["AbsolutePrice"].ToString(),
                                                objSQLReader["DiscountType"].ToString(),
                                                objSQLReader["DiscountType"].ToString() == "A" ? objSQLReader["DiscountAmount"].ToString() :  objSQLReader["DiscountPercentage"].ToString()
                                                });
                }

                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();

                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;

                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();

                return null;
            }
        }

        public int ActiveMixNMatch(int pItem)
        {
            string strSQLComm = "";
            int val = 0;
            strSQLComm = " select h.ID from MixNmatchHeader h left outer join MixNmatchDetails d on h.ID = d.HeaderID "
                       + " where d.ItemID = @id and h.DiscountStatus = 'Y' "
                       + " and ((h.LimitedPeriodCheck = 'N')  or  (h.LimitedPeriodCheck = 'Y' and getdate() between h.OfferStartOn and h.OfferEndOn)) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@id"].Value = pItem;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["ID"].ToString());
                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable GetMixNmatchInfo(int PID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select * from MixNmatchHeader where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = PID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("DiscountName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountDescription", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountStatus", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountPercentage", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountCategory", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountFamilyID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountPlusQty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AbsolutePrice", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["DiscountName"].ToString(),
												objSQLReader["DiscountDescription"].ToString(),
                                                objSQLReader["DiscountStatus"].ToString(),
                                                objSQLReader["DiscountType"].ToString(),
                                                objSQLReader["DiscountAmount"].ToString(),
                                                objSQLReader["DiscountPercentage"].ToString(),
                                                objSQLReader["DiscountCategory"].ToString(),
                                                objSQLReader["DiscountFamilyID"].ToString(),
                                                objSQLReader["DiscountPlusQty"].ToString(),
                                                objSQLReader["AbsolutePrice"].ToString()
                    });
                }

                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();

                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;

                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();

                return null;
            }
        }

        public int GetMixNMatchDetailCount(int pHID)
        {
            string strSQLComm = "";

            int val = 0;

            strSQLComm = " select count(*) as rcnt from MixNmatchDetails where HeaderID = @H ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@H", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@H"].Value = pHID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #endregion

        public int GetTranNoFromInv(int pID)
        {
            int val = 0;
            string strSQLComm = " select transactionno from invoice where ID = @ID ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = pID;
            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["transactionno"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable FetchCardTransData2(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and transactiontype = 'Complete Auth' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AuthCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryAcqRef", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryToken", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Reference", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryInvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryProcessData", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["CardAmount"].ToString(),
                                                objSQLReader["AuthCode"].ToString(),
                                                objSQLReader["MercuryAcqRef"].ToString(),
                                                objSQLReader["MercuryToken"].ToString(),
                                                objSQLReader["PaymentGateway"].ToString(),
                                                objSQLReader["Reference"].ToString(),
                                                objSQLReader["MercuryInvoiceNo"].ToString(),
                                                objSQLReader["MercuryProcessData"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchTipsAdjustment(int pTrnID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and MercuryTranCode = 'Adjust' and adjustflag = 'N' order by ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CreatedOn", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tip", System.Type.GetType("System.String"));
                dtbl.Columns.Add("F", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    double tipamt = Functions.fnDouble(objSQLReader["RefCardAuthAmount"].ToString()) -
                                    Functions.fnDouble(objSQLReader["MercuryPurchaseAmount"].ToString());
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["ID"].ToString(),
                                                objSQLReader["CreatedOn"].ToString(),
                                                tipamt.ToString("f"),
                                                "N"
                                            });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public double FetchCurrentTipAmount(int pTrnID)
        {
            double val = 0;
            string strSQLComm = "";

            strSQLComm = " select * from cardtrans where transactionno = @ID and ((MercuryTranCode = 'Adjust' and adjustflag = 'N') "
                       + " or (MercuryTranCode = 'PreAuthCapture')) order by ID desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = pTrnID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnDouble(objSQLReader["RefCardAuthAmount"].ToString()) - Functions.fnDouble(objSQLReader["MercuryPurchaseAmount"].ToString());
                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public string UpdateCardAuthorisationForTipAdjustment(int rID, double tipamt)
        {
            string strSQLComm = "";
            strSQLComm = " update CardAuthorisation set TipAmount=@Tip where InvoiceNo = @ID ";
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tip", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CompleteBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CompleteOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = rID;
                objSQlComm.Parameters["@Tip"].Value = tipamt;
                objSQlComm.Parameters["@CompleteBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CompleteOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public string UpdateCardAuthorisation(int rID, string strCCTranNo, double tipamt)
        {
            string strSQLComm = "";
            strSQLComm = " update CardAuthorisation set TipAmount=@Tip,CompleteTranNo=@CTran,CompleteBy=@CompleteBy,"
                       + " CompleteOn=@CompleteOn, BatchFlag = 'Y' where ID = @ID ";
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tip", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@CTran", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@CompleteBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@CompleteOn", System.Data.SqlDbType.DateTime));

                objSQlComm.Parameters["@ID"].Value = rID;
                objSQlComm.Parameters["@Tip"].Value = tipamt;
                objSQlComm.Parameters["@CTran"].Value = strCCTranNo;
                objSQlComm.Parameters["@CompleteBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@CompleteOn"].Value = DateTime.Now;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public double GetMaxMixNMatchDiscount(int pinv,int pmix)
        {
            double val = 0;
            string strSQLComm = " select max(discount) as maxval from item where invoiceno = @inv and mixmatchid = @mix and producttype <> 'Z' ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            
            objSQlComm.Parameters.Add(new SqlParameter("@inv", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@inv"].Value = pinv;

            objSQlComm.Parameters.Add(new SqlParameter("@mix", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@mix"].Value = pmix;

            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = Functions.fnDouble(objSQLReader["maxval"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable GetMaxMixNMatchDiscountDetails(int pinv, int pmix)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select * from item where invoiceno = @inv and mixmatchid = @mix and discount > 0 ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@inv", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@inv"].Value = pinv;

                objSQlComm.Parameters.Add(new SqlParameter("@mix", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@mix"].Value = pmix;


                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["DiscValue"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["TaxTotal1"].ToString(),
                                                objSQLReader["TaxTotal2"].ToString(),
                                                objSQLReader["TaxTotal3"].ToString()
                                            });

                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int GetTotalInvoiceItems(int pinv)
        {
            int val = 0;
            string strSQLComm = " select count(*) as rcnt from item where invoiceno = @inv and returneditemcnt = 0 ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@inv", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@inv"].Value = pinv;

            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public bool IsDiscounttableFees(int pfeeid)
        {
            string val = "";
            string strSQLComm = " select ChkDiscount from feesmaster where id = @id ";
           
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@id"].Value = pfeeid;

            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = objSQLReader["ChkDiscount"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val == "Y";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IsFoodStampableFees(int pfeeid)
        {
            string val = "";
            string strSQLComm = " select ChkFoodStamp from feesmaster where id = @id ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@id"].Value = pfeeid;

            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = objSQLReader["ChkFoodStamp"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val == "Y";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IsApplyToQtyFees(int pfeeid)
        {
            string val = "";
            string strSQLComm = " select ChkItemQty from feesmaster where id = @id ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@id"].Value = pfeeid;

            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = objSQLReader["ChkItemQty"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val == "Y";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public bool IsTaxableFees(int pfeeid)
        {
            string val = "";
            string strSQLComm = " select ChkTax from feesmaster where id = @id ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@id"].Value = pfeeid;

            SqlDataReader objSQLReader = null;
            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                while (objSQLReader.Read())
                {
                    val = objSQLReader["ChkTax"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val == "Y";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        #region Sale
        public void ActiveSale(int pItem, ref int rid, ref double spr)
        {
            string strSQLComm = @"
        SELECT ISNULL(SaleBatchID, 0) AS itm, ISNULL(SalePrice, 0) AS pr 
        FROM SalePriceDetails 
        WHERE (ItemID = @id1 AND ApplyFamily = 'N') 
           OR (ItemID = (SELECT BrandID FROM Product WHERE ID = @id2) AND ApplyFamily = 'Y') 
           AND SaleBatchID IN (SELECT ID FROM SalePriceHeader WHERE SaleStatus = 'Y' 
                               AND GETDATE() BETWEEN EffectiveFrom AND EffectiveTo)";

            try
            {
                if (sqlConn.State == ConnectionState.Closed)
                {
                    sqlConn.Open();
                }

                using (SqlCommand objSqlComm = new SqlCommand(strSQLComm, sqlConn))
                {
                    objSqlComm.Parameters.Add("@id1", SqlDbType.Int).Value = pItem;
                    objSqlComm.Parameters.Add("@id2", SqlDbType.Int).Value = pItem;

                    using (SqlDataReader objSQLReader = objSqlComm.ExecuteReader())
                    {
                        if (objSQLReader.Read()) // No need for `while` since we break after the first row
                        {
                            rid = objSQLReader.GetInt32(0); // Directly reading integer
                            spr = objSQLReader.GetDouble(1); // Directly reading double
                        }
                    }
                }
            }
            catch (SqlException ex)
            {
                // Log error (Recommended: Use a logging framework instead of storing in a string)
                Console.WriteLine($"SQL Error: {ex.Message}");
            }
            finally
            {
                if (sqlConn.State == ConnectionState.Open)
                {
                    sqlConn.Close();
                }
            }
        }

        //public void ActiveSale(int pItem,ref int rid,ref double spr)
        //{
        //    string strSQLComm = "";

        //    strSQLComm = " select isnull(SaleBatchID,0) as itm, isnull(SalePrice,0) as pr from SalePriceDetails where (1 = 1) "
        //               + " and ((ItemID = @id1 and ApplyFamily = 'N') or (ItemID = (select BrandID from Product where ID = @id2) and ApplyFamily = 'Y')) "
        //               + " and salebatchid in ( select id from salepriceheader where salestatus = 'Y' and getdate() between effectivefrom and effectiveto) ";

        //    SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
        //    SqlDataReader objSQLReader = null;

        //    try
        //    {
        //        if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

        //        objSQlComm.Parameters.Add(new SqlParameter("@id1", System.Data.SqlDbType.Int));
        //        objSQlComm.Parameters["@id1"].Value = pItem;
        //        objSQlComm.Parameters.Add(new SqlParameter("@id2", System.Data.SqlDbType.Int));
        //        objSQlComm.Parameters["@id2"].Value = pItem;

        //        objSQLReader = objSQlComm.ExecuteReader();

        //        while (objSQLReader.Read())
        //        {
        //            rid = Functions.fnInt32(objSQLReader["itm"].ToString());
        //            spr = Functions.fnDouble(objSQLReader["pr"].ToString());
        //            break;
        //        }
        //        objSQLReader.Close();
        //        objSQlComm.Dispose();
        //        sqlConn.Close();
        //        return;
        //    }
        //    catch (SqlException SQLDBException)
        //    {
        //        string strErrMsg = "";
        //        strErrMsg = SQLDBException.Message;
        //        sqlConn.Close();
        //        objSQLReader.Close();
        //        objSQlComm.Dispose();
        //        return;
        //    }
        //}

        #endregion

        public bool IsEBTPayment(int prm)
        {
            bool flg = false;
            string strSQLComm = " select count(c.id) as reccnt from trans t "
                              + " left outer join cardtrans c on t.id = c.transactionno where c.transactionno = @prm and CardType in ('Food Stamps','EBT Voucher') ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@prm", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@prm"].Value = prm;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    if (Functions.fnInt32(objsqlReader["reccnt"]) > 0) flg = true;

                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return flg;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return false;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

            }
        }

        public string ResetRepairAdvanceAmount(int rID)
        {
            string strSQLComm = "";
            strSQLComm = " update Invoice set RepairAdvanceAmount=0,RepairDueAmount = RepairAmount where ID = @ID ";
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters["@ID"].Value = rID;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public DataTable FetchRepairHeaderForEmail(int intInvID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select c.FirstName,c.LastName,c.MobilePhone,c.EMail,i.RepairDateIn,i.RepairDeliveryDate,i.RepairNotifiedDate,"
                              + " i.RepairAmount,i.RepairAdvanceAmount,i.RepairDueAmount,i.RepairProblem,i.RepairNotes,i.RepairRemarks,i.RepairItemName,i.RepairItemSlNo, "
                              + " i.RepairFindUs from invoice i left outer join Customer c on c.ID = i.CustomerID where i.ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("FirstName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LastName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MobilePhone", System.Type.GetType("System.String"));
                dtbl.Columns.Add("EMail", System.Type.GetType("System.String"));

                dtbl.Columns.Add("RepairDateIn", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairDeliveryDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairNotifiedDate", System.Type.GetType("System.String"));

                dtbl.Columns.Add("RepairAdvanceAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairDueAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairProblem", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairNotes", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairRemarks", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemName", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairItemSlNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RepairFindUs", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {    
                                                    objSQLReader["FirstName"].ToString(),
                                                    objSQLReader["LastName"].ToString(),
                                                    objSQLReader["MobilePhone"].ToString(),
                                                    objSQLReader["EMail"].ToString(),
                                                    objSQLReader["RepairDateIn"].ToString(),
                                                    objSQLReader["RepairDeliveryDate"].ToString(),
                                                    objSQLReader["RepairNotifiedDate"].ToString(),
                        
                                                    objSQLReader["RepairAdvanceAmount"].ToString(),
                                                    objSQLReader["RepairAmount"].ToString(),
                                                    objSQLReader["RepairDueAmount"].ToString(),
                                                    objSQLReader["RepairProblem"].ToString(),
                                                    objSQLReader["RepairNotes"].ToString(),
                                                    objSQLReader["RepairRemarks"].ToString(),
                                                    objSQLReader["RepairItemName"].ToString(),
                                                    objSQLReader["RepairItemSlNo"].ToString(),
                                                    objSQLReader["RepairFindUs"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchRepairPartsForEmail(int intInvID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select SKU,Description,RepairItemTag,RepairItemSLNO,Qty from item where invoiceno = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
                dtbl.Columns.Add("Item SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Item Name", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tag", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Serial", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Quantity", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {    
                                                    objSQLReader["SKU"].ToString(),
                                                    objSQLReader["Description"].ToString(),
                                                    objSQLReader["RepairItemTag"].ToString(),
                                                    objSQLReader["RepairItemSLNO"].ToString(),
                                                    objSQLReader["Qty"].ToString().Replace(".000","")});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public double GetCashBackAmountFromCardTransaction(int intInvID)
        {
            double dblval = 0;
            string strSQLComm = " select sum(isnull(RefCardAuthAmount,0) - isnull(CardAmount,0)) as CashBack from CardTrans where CardType in ('Debit Card','EBT Cash') and "
                              + " TransactionNo in ( select TransactionNo from Invoice where ID = @ID) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intInvID;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();
               
                while (objSQLReader.Read())
                {
                    dblval = Functions.fnDouble(objSQLReader["CashBack"].ToString());
                }

                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblval;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double GetCashBackAmountFromCardTransaction1(int intTranID, double dAmt)
        {
            double dblval = 0;
            string strSQLComm = " select isnull(RefCardAuthAmount,0) - isnull(CardAmount,0) as CashBack from CardTrans where CardType in ('Debit Card','EBT Cash') and "
                              + " TransactionNo = @TrnNo and CardAmount = @Amt ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            
            objSQlComm.Parameters.Add(new SqlParameter("@TrnNo", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@TrnNo"].Value = intTranID;

            objSQlComm.Parameters.Add(new SqlParameter("@Amt", System.Data.SqlDbType.Float));
            objSQlComm.Parameters["@Amt"].Value = dAmt;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dblval = Functions.fnDouble(objSQLReader["CashBack"].ToString());
                }

                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblval;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public double FetchHouseAccountBalanceForThisReceipt(int pInvNo, int pCID)
        {
            double val = 0;
            string strSQLComm = "";

            strSQLComm = " select isnull(sum(amount),0) as BAL from acctrecv where customerid = @CID and InvoiceNo <= @INO ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CID"].Value = pCID;

                objSQlComm.Parameters.Add(new SqlParameter("@INO", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@INO"].Value = pInvNo;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnDouble(objSQLReader["BAL"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public bool IsMercuryCreditCardPayment(int intTranNo)
        {
            bool blresult = false;
            int cnt = 0;
            string strSQLComm = " select count(a.TenderType) as RecCount from Tender a left outer join TenderTypes b on a.TenderType = b.ID "
                              + " where TransactionNo = @ID and b.Name = 'Credit Card' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = Functions.fnInt32(objSQLReader["RecCount"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt > 0)
                    return true;
                else
                    return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public double GetMercuryCreditCardPayment(int intTranNo)
        {
            double blresult = 0;
            double cnt = 0;
            string strSQLComm = " select isnull(sum(RefCardAuthAmount),0) as AuthAmount from cardtrans where TransactionNo = @ID and PaymentGateway = 2 and MercuryTranCode in ('Sale','PreAuth') and  "
                              + " cardtype = 'Credit Card' ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = Functions.fnDouble(objSQLReader["AuthAmount"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return cnt;

            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #region Customer Ordering

        public DataTable FetchActiveCustomerOrders(string orderDateFilter, string pickupDateFilter, string customerFilter,
                                        DateTime orderFDate, DateTime orderTDate, DateTime pickupFDate, DateTime pickupTDate,
                                        int customerID, string custFNM, string custLNM, string custPhone)
        {
            string sqlOrderFilter = "";
            string sqlPickupFilter = "";
            string sqlCustomerFilter = "";

            DateTime PckUpFromDate = new DateTime();
            DateTime PckUpToDate = new DateTime();

            DateTime OrdFromDate = new DateTime();
            DateTime OrdToDate = new DateTime();

            if (orderDateFilter == "Y")
            {
                OrdFromDate = new DateTime(orderFDate.Year, orderFDate.Month, orderFDate.Day, 0, 0, 0);
                OrdToDate = new DateTime(orderTDate.Year, orderTDate.Month, orderTDate.Day, 0, 0, 0);

                sqlOrderFilter = " and h.OrderDate between @orddt1 and @orddt2 ";
            }

            if (pickupDateFilter == "Y")
            {
                PckUpFromDate = new DateTime(pickupFDate.Year, pickupFDate.Month, pickupFDate.Day, 0, 0, 0);
                PckUpToDate = new DateTime(pickupTDate.Year, pickupTDate.Month, pickupTDate.Day, 0, 0, 0);

                sqlPickupFilter = " and h.PickupDate between @pkupdt1 and @pkupdt2 ";
            }

            if (customerFilter == "Y")
            {
                if (customerID == 0)
                {
                    if ((custFNM == "") && (custLNM == "") && (custPhone == ""))
                    {

                    }
                    else
                    {
                        if (custFNM != "")
                        {
                            sqlCustomerFilter = " c.FirstName like '%" + custFNM + "%' ";
                        }

                        if (custLNM != "")
                        {
                            sqlCustomerFilter = sqlCustomerFilter == "" ? " c.LastName like '%" + custLNM + "%' " : sqlCustomerFilter + " or c.LastName like '%" + custLNM + "%' ";
                        }

                        if (custPhone != "")
                        {
                            sqlCustomerFilter = sqlCustomerFilter == "" ? " c.MobilePhone like '%" + custPhone + "%' " : sqlCustomerFilter + " or c.MobilePhone like '%" + custPhone + "%' ";
                        }

                        sqlCustomerFilter = " and ( " + sqlCustomerFilter + " ) ";
                    }
                }
                else
                {
                    sqlCustomerFilter = " and h.CustomerID = @CID ";
                }
            }

            DataTable dtbl = new DataTable();

            string strSQLComm = " select h.ID, h.OrderDate,h.PickupDate,h.OrderItems, h.OrderNet, c.FirstName + ' ' + c.LastName as cname, c.MobilePhone "
                                + " from OrderHeader h left outer join Customer c on c.ID = h.CustomerID where (1 = 1) and h.OrderStatus = 'A' "
                                + sqlOrderFilter + sqlPickupFilter + sqlCustomerFilter
                                + " order by h.PickupDate, c.FirstName + ' ' + c.LastName ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            if (orderDateFilter == "Y")
            {
                objSQlComm.Parameters.Add(new SqlParameter("@orddt1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@orddt1"].Value = OrdFromDate;
                objSQlComm.Parameters.Add(new SqlParameter("@orddt2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@orddt2"].Value = OrdToDate;
            }

            if (pickupDateFilter == "Y")
            {
                objSQlComm.Parameters.Add(new SqlParameter("@pkupdt1", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@pkupdt1"].Value = PckUpFromDate;
                objSQlComm.Parameters.Add(new SqlParameter("@pkupdt2", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@pkupdt2"].Value = PckUpToDate;
            }

            if ((customerFilter == "Y") && (customerID > 0))
            {
                objSQlComm.Parameters.Add(new SqlParameter("@CID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@CID"].Value = customerID;
            }

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OrderDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PickupDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Phone", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OrderItem", System.Type.GetType("System.String"));
                dtbl.Columns.Add("OrderAmount", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    string strODateTime = "";
                    string strPDateTime = "";

                    if (objSQLReader["OrderDate"].ToString() != "")
                    {
                        strODateTime = objSQLReader["OrderDate"].ToString();
                        int inIndex = strODateTime.IndexOf(" ");
                        if (inIndex > 0)
                        {
                            strODateTime = strODateTime.Substring(0, inIndex).Trim();
                        }
                    }
                    else
                    {
                        strODateTime = objSQLReader["OrderDate"].ToString();
                    }

                    if (objSQLReader["PickupDate"].ToString() != "")
                    {
                        strPDateTime = objSQLReader["PickupDate"].ToString();
                        int inIndex = strPDateTime.IndexOf(" ");
                        if (inIndex > 0)
                        {
                            strPDateTime = strPDateTime.Substring(0, inIndex).Trim();
                        }
                    }
                    else
                    {
                        strPDateTime = objSQLReader["PickupDate"].ToString();
                    }

                    dtbl.Rows.Add(new object[] {   objSQLReader["ID"].ToString(),
                                                   strODateTime,strPDateTime,
                                                   objSQLReader["cname"].ToString(),
                                                   objSQLReader["MobilePhone"].ToString(),
                                                   objSQLReader["OrderItems"].ToString(),
                                                   Functions.fnDouble(objSQLReader["OrderNet"].ToString()).ToString("0.##")
                                                });
                }
                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {

                strErrorMsg = SQLDBException.Message;
                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();
                return null;
            }
        }

        public DataTable FetchCustomerOrderDetailRecord(int pInvNo)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select * from orderdetails where RefID = @Ref ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@Ref", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@Ref"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ProductID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ItemRate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxID3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Taxable3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxRate3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxType3", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal1", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal2", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TaxTotal3", System.Type.GetType("System.String"));

                dtbl.Columns.Add("Discount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscountText", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscLogic", System.Type.GetType("System.String"));
                dtbl.Columns.Add("DiscValue", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["ProductID"].ToString(),
                                                objSQLReader["SKU"].ToString(),
                                                objSQLReader["Description"].ToString(),
                                                objSQLReader["ItemRate"].ToString(),
                                                objSQLReader["Qty"].ToString(),
                                                objSQLReader["TaxID1"].ToString(),
                                                objSQLReader["TaxID2"].ToString(),
                                                objSQLReader["TaxID3"].ToString(),
                                                objSQLReader["Taxable1"].ToString(),
                                                objSQLReader["Taxable2"].ToString(),
                                                objSQLReader["Taxable3"].ToString(),
                                                objSQLReader["TaxRate1"].ToString(),
                                                objSQLReader["TaxRate2"].ToString(),
                                                objSQLReader["TaxRate3"].ToString(),
                                                objSQLReader["TaxType1"].ToString(),
                                                objSQLReader["TaxType2"].ToString(),
                                                objSQLReader["TaxType3"].ToString(),
                                                objSQLReader["TaxTotal1"].ToString(),
                                                objSQLReader["TaxTotal2"].ToString(),
                                                objSQLReader["TaxTotal3"].ToString(),
                                                objSQLReader["Discount"].ToString(),
                                                objSQLReader["DiscountID"].ToString(),
                                                objSQLReader["DiscountText"].ToString(),
                                                objSQLReader["DiscLogic"].ToString(),
                                                objSQLReader["DiscValue"].ToString()
                                                
                    });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable FetchCustomerOrderHeaderRecord(int pInvNo)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select * from orderheader where ID = @Ref ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@Ref", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@Ref"].Value = pInvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CDiscountLevel", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CTaxExempt", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                    objSQLReader["CustomerID"].ToString(),
                                                    objSQLReader["CDiscountLevel"].ToString(),
                                                    objSQLReader["CTaxExempt"].ToString()
                                                });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        public DataTable FetchCardTransDataForNETePay(DateTime df, DateTime dt, string pHost)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";
            DateTime F = new DateTime(df.Year, df.Month, df.Day, 0, 0, 1);
            DateTime T = new DateTime(dt.Year, dt.Month, dt.Day, 23, 59, 59);
            string sqlf1 = " and createdon between @f and @t ";
            strSQLComm = " select * from cardtrans where (1 = 1) and paymentgateway in (2,5,6) and TerminalName = @host1 " + sqlf1
                      // + " union select * from cardtrans where (1 = 1) and paymentgateway in (2,5,6) and TerminalName is null " + sqlf1
                       //+ " and transactionno in (select ID from trans where TerminalName = @host2 ) " 
                       + "  order by ID, createdon desc ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
               
                objSQlComm.Parameters.Add(new SqlParameter("@f", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@f"].Value = F;

                objSQlComm.Parameters.Add(new SqlParameter("@t", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@t"].Value = T;

                objSQlComm.Parameters.Add(new SqlParameter("@host1", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters["@host1"].Value = pHost;

                //objSQlComm.Parameters.Add(new SqlParameter("@host2", System.Data.SqlDbType.VarChar));
                //objSQlComm.Parameters["@host2"].Value = pHost;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAct", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardMerchID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardLogo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardEntry", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardTranID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("RefCardAuthAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsDebitCard", System.Type.GetType("System.String"));
                dtbl.Columns.Add("IsComplete", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TransactionNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("AuthCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Reference", System.Type.GetType("System.String"));
                dtbl.Columns.Add("PaymentGateway", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryAcqRef", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryToken", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryInvoiceNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryProcessData", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryPurchaseAmount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("MercuryTextResponse", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CustomerID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("LogFile", System.Type.GetType("System.String"));
                while (objSQLReader.Read())
                {
                    string paygateway = "";
                   
                    if (objSQLReader["PaymentGateway"].ToString() == "2") paygateway = "Mercury";
                    if (objSQLReader["PaymentGateway"].ToString() == "5") paygateway = "Datacap";
                    if (objSQLReader["PaymentGateway"].ToString() == "6") paygateway = "DatacapEMV";
                    dtbl.Rows.Add(new object[] {objSQLReader["ID"].ToString(),
                                                objSQLReader["RefCardAct"].ToString(),
                                                objSQLReader["RefCardMerchID"].ToString(),
                                                objSQLReader["RefCardLogo"].ToString(),
                                                objSQLReader["RefCardEntry"].ToString(),
                                                objSQLReader["RefCardAuthID"].ToString(),
                                                objSQLReader["RefCardTranID"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardAuthAmount"]).ToString("#0.00"),
                                                objSQLReader["IsDebitCard"].ToString(),
                                                objSQLReader["IsComplete"].ToString(),
                                                Functions.fnDouble(objSQLReader["CardAmount"]).ToString("#0.00"),
                                                objSQLReader["CardType"].ToString(),
                                                objSQLReader["TransactionType"].ToString(),
                                                objSQLReader["TransactionNo"].ToString(),
                                                objSQLReader["AuthCode"].ToString(),
                                                objSQLReader["Reference"].ToString(),
                                                paygateway,
                                                objSQLReader["MercuryAcqRef"].ToString(),
                                                objSQLReader["MercuryToken"].ToString(),
                                                objSQLReader["MercuryInvoiceNo"].ToString(),
                                                objSQLReader["MercuryProcessData"].ToString(),
                                                objSQLReader["MercuryPurchaseAmount"].ToString(),
                                                objSQLReader["MercuryTextResponse"].ToString(),
                                                objSQLReader["CustomerID"].ToString(),
                                                Functions.fnDate(objSQLReader["LastChangedOn"].ToString()).ToString(),
                                                objSQLReader["LogFileName"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }
        

        public bool IsRestrictedFees(int intTranNo)
        {
            string cnt = "";
            string strSQLComm = " select ChkRestrictedItems from FeesMaster where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = intTranNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    cnt = objSQLReader["ChkRestrictedItems"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                if (cnt == "Y") return true; else return false;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }


        public DataTable FetchFeesInInvoice(int pInvoiceID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select distinct i.FeesID, f.FeesName from item i left outer join feesmaster f on f.ID = i.FeesID where i.invoiceno = @Inv ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@Inv", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@Inv"].Value = pInvoiceID;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("FeesID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("FeesName", System.Type.GetType("System.String"));
               
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {objSQLReader["FeesID"].ToString(),
                                                objSQLReader["FeesName"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                objSQLReader.Close();
                sqlConn.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #region Buy n Get Free

        public string GetBuyNGetFreePromotionName(int pHID)
        {
            string strSQLComm = "";
            string val = "";

            strSQLComm = " select PromotionName from BuyNGetFreeHeader where ID = @id ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@id"].Value = pHID;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = objSQLReader["PromotionName"].ToString();
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return "";
            }
        }

        public DataTable IsActiveBuyNGetFree(int pItem)
        {
            string strSQLComm = "";
            DataTable dtbl = new DataTable();
            dtbl.Columns.Add("HeaderID", System.Type.GetType("System.String"));
            dtbl.Columns.Add("HeaderQty", System.Type.GetType("System.String"));

            strSQLComm = " select isnull(ID,0) as HeaderID, isnull(BuyQty,0) as ApplicableQty from BuyNGetFreeHeader "
                       + " where BuyProductID = @id and PromotionStatus = 'Y' "
                       + " and ((ForLimitedPeriod = 'N')  or  (ForLimitedPeriod = 'Y' and getdate() between PromotionStartDate and PromotionEndDate)) order by BuyQty";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@id", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@id"].Value = pItem;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] { objSQLReader["HeaderID"].ToString(), objSQLReader["ApplicableQty"].ToString() });
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable GetFreeItems(int pHeader)
        {
            string strSQLComm = "";
            DataTable dtbl = new DataTable();
            dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
            dtbl.Columns.Add("Name", System.Type.GetType("System.String"));
            dtbl.Columns.Add("Type", System.Type.GetType("System.String"));
            dtbl.Columns.Add("Qty", System.Type.GetType("System.String"));
            dtbl.Columns.Add("Price", System.Type.GetType("System.String"));
            dtbl.Columns.Add("Cost", System.Type.GetType("System.String"));
            dtbl.Columns.Add("OnHandQty", System.Type.GetType("System.String"));
            dtbl.Columns.Add("NormalQty", System.Type.GetType("System.String"));

            strSQLComm = " select f.FreeProductID,f.FreeQty, p.Description, p.ProductType, p.PriceA, p.LastCost, p.QtyOnHand, p.NormalQty from BuyNGetFreeDetails f left outer join Product p on  "
                       + " f.FreeProductID = p.ID where f.HeaderID = @HID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQlComm.Parameters.Add(new SqlParameter("@HID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@HID"].Value = pHeader;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {    objSQLReader["FreeProductID"].ToString(), 
                                                    objSQLReader["Description"].ToString(), 
                                                    objSQLReader["ProductType"].ToString(),
                                                    objSQLReader["FreeQty"].ToString(),
                                                    objSQLReader["PriceA"].ToString(),
                                                    objSQLReader["LastCost"].ToString(),
                                                    objSQLReader["QtyOnHand"].ToString(),
                                                    objSQLReader["NormalQty"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        #endregion

        public DataTable FetchEBTBalanceFromReceipt(int pInvID)
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select c.RefCardAct, c.RefCardBalance from CardTrans c left outer join Trans t on t.ID = c.TransactionNo "
                              + " left outer join invoice i on i.TransactionNo = t.ID where i.ID = @ID and c.CardType in ('EBT Cash') ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = pInvID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                dtbl.Columns.Add("CardNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("CardBalance", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
                                                objSQLReader["RefCardAct"].ToString(),
                                                Functions.fnDouble(objSQLReader["RefCardBalance"].ToString()).ToString("f2")});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public double GetCustomerStoreCreditBalance(int irefCustomer)
        {
            double dblval = 0;
            string strSQLComm = " select StoreCredit from Customer where ID = @ID ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = irefCustomer;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    dblval = Functions.fnDouble(objSQLReader["StoreCredit"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dblval;

            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        public DataTable GetAppointmentInfoToSendEMail(int ApptID)
        {
            DataTable dtbl = new DataTable();
            string strSQLComm = " select a.ID, a.ScheduleTime as ApptStart,dateadd(mi,a.servicetime,a.scheduletime) as ApptEnd, "
                              + " c.firstname + ' ' + c.lastname as Client, c.Email, e.FirstName + ' ' + e.LastName as Provider from appointments a "
                              + " left outer join customer c on c.ID = a.CustomerID "
                              + " left outer join employee e on e.ID = a.EmployeeID where a.ID = " + ApptID.ToString();

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptStart", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptEnd", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Client", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Provider", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Email", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {
												objSQLReader["ID"].ToString(),
												objSQLReader["ApptStart"].ToString(),
                                                objSQLReader["ApptEnd"].ToString(),
                                                objSQLReader["Client"].ToString(),
												objSQLReader["Provider"].ToString(),
												objSQLReader["Email"].ToString()});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public string GetAppointmentServiceName(string ApptID)
        {
            string ServiceNames = "";
            DataTable dtbl = new DataTable();
            string strSQLComm = " select p.Description as ServiceName from ServiceMapping s left outer join product p "
                              + " on s.ServiceID = p.ID where MappingType = 'Appt' and MappingID = " + ApptID;

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("ID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApptStart", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Client", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Provider", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Email", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if (ServiceNames == "")
                    {
                        ServiceNames = objSQLReader["ServiceName"].ToString();
                    }
                    else
                    {
                        ServiceNames = ServiceNames + ", " + objSQLReader["ServiceName"].ToString();
                    }


                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return ServiceNames;
            }
            catch (SqlException SQLDBException)
            {
                
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return "";
            }
        }

        public string UpdateReminderSentFlag(string strID)
        {

            string strSQLComm = "sp_AppointmentReminderSent";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                //objSQlComm.CommandTimeout = 90;
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = Convert.ToInt32(strID);

                objSQlComm.ExecuteNonQuery();

                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                
                return strErrMsg;
            }
        }

        public string UpdateEmailSentFlag(string strID)
        {

            string strSQLComm = "sp_AppointmentEmailSent";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                //objSQlComm.CommandTimeout = 90;
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@ID"].Value = Convert.ToInt32(strID);

                objSQlComm.ExecuteNonQuery();

                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();

                return strErrMsg;
            }
        }


        #region Evo

        public bool IsXeConnectTransactionRecordExist(int CID)
        {
            int val = 0;
            string strSQLComm = "";
            strSQLComm = " select count(*) as rcnt from XeConnectTransactions where InvoiceNumber = @ID  ";
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = CID;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["rcnt"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val > 0;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }

        public DataTable FetchXeConnectTransactionRecord(int InvNo)
        {

            DataTable dtbl = new DataTable();
            string strSQLComm = "";

            strSQLComm = " select TransactionId, Amount, StatusCode, ApprovalCode from XeConnectTransactions where InvoiceNumber = @ID  ORDER BY createdon DESC";


            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.CommandTimeout = 500;

            objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@ID"].Value = InvNo;

            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }


                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TransactionId", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));
                dtbl.Columns.Add("StatusCode", System.Type.GetType("System.String"));
                dtbl.Columns.Add("ApprovalCode", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] {   objSQLReader["TransactionId"].ToString(),
                                                   objSQLReader["Amount"].ToString(),
                                                   objSQLReader["StatusCode"].ToString(),
                                                   objSQLReader["ApprovalCode"].ToString()});
                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }


        public string UpdateCardTransOnEvoResponse()
        {
            string strSQLComm = " update CardTrans set AuthCode=@AuthCode,Reference=@Reference,"
                              + " LastChangedBy=@LastChangedBy,LastChangedOn=@LastChangedOn,"
                              + " CardAmount=@CardAmount,RefCardAuthID=@RefCardAuthID,RefCardTranID=@RefCardTranID,"
                              + " RefCardAuthAmount=@RefCardAuthAmount, TransactionType=@TranType, AdjustFlag = @AdjustFlag "
                              + " where ID = @ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.Parameters.Add(new SqlParameter("@AuthCode", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@Reference", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedBy", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@LastChangedOn", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));

                objSQlComm.Parameters.Add(new SqlParameter("@CardAmount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TranType", System.Data.SqlDbType.VarChar));

                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardTranID", System.Data.SqlDbType.VarChar));
                objSQlComm.Parameters.Add(new SqlParameter("@RefCardAuthAmount", System.Data.SqlDbType.Float));


                objSQlComm.Parameters["@AuthCode"].Value = strAuthCode;
                objSQlComm.Parameters["@Reference"].Value = strReference;
                objSQlComm.Parameters["@LastChangedBy"].Value = intLoginUserID;
                objSQlComm.Parameters["@LastChangedOn"].Value = DateTime.Now;
                objSQlComm.Parameters["@ID"].Value = intCardTranID;

                objSQlComm.Parameters["@CardAmount"].Value = dblCardAmount;
                objSQlComm.Parameters["@TranType"].Value = strCardTranType;


                objSQlComm.Parameters["@RefCardAuthID"].Value = strRefCardAuthID;
                objSQlComm.Parameters["@RefCardTranID"].Value = strRefCardTranID;
                objSQlComm.Parameters["@RefCardAuthAmount"].Value = dblRefCardAuthAmount;

                objSQlComm.Parameters.Add(new SqlParameter("@AdjustFlag", System.Data.SqlDbType.Char));
                objSQlComm.Parameters["@AdjustFlag"].Value = strAdjustFlag;

                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return "";
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return strErrMsg;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }


        public int GetXeConnectID()
        {
            int val = 0;
            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_get_XeConnectID";
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@ReturnVal", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ReturnVal"].Direction = ParameterDirection.Output;


                objSQlComm.ExecuteNonQuery();

                val = Functions.fnInt32(objSQlComm.Parameters["@ReturnVal"].Value.ToString());
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return 0;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public void SetInvoiceOnXeConnect(int xeId, int invNo)
        {

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            string strSQLComm = "sp_set_XeConnectInvoice";

            try
            {
                objSQlComm = new SqlCommand(strSQLComm, sqlConn);
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.StoredProcedure;

                objSQlComm.Parameters.Add(new SqlParameter("@xeid", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@xeid"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@xeid"].Value = xeId;

                objSQlComm.Parameters.Add(new SqlParameter("@invno", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@invno"].Direction = ParameterDirection.Input;
                objSQlComm.Parameters["@invno"].Value = invNo;


                objSQlComm.ExecuteNonQuery();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }

        public int FetchIdFromXeConnect(int invNo)
        {
            int val = 0;
            string strSQLComm = " select isnull(ID,0) as recID from XeConnectLog where InvoiceNo = @INV";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.Parameters.Add(new SqlParameter("@INV", System.Data.SqlDbType.Int));
            objSQlComm.Parameters["@INV"].Value = invNo;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["recID"].ToString());
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }

        #endregion


        #region MyRegion

        private DataTable GetLayAwayRefundDataTable(int LayID, out int intMaxInvNo, out double numsD, out int LawAwayRecordCustID, out string refTaxExempt, out string refStoreCr, out string refARCredit)
        {
            #region GlobalVariables
            LawAwayRecordCustID = 0;
            intMaxInvNo = 0;
            numsD=0;
            refTaxExempt = "";
            refStoreCr = "";
            refARCredit = "";


            #endregion

            #region DataTableCreation
            DataTable dtblLayaway = new DataTable();
            dtblLayaway.Columns.Add("ID", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("LayawayNo", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("InvoiceNo", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("SKU", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("Description", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("Qty", System.Type.GetType("System.Double"));
            dtblLayaway.Columns.Add("Cost", System.Type.GetType("System.Double"));
            dtblLayaway.Columns.Add("DateDue", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("TotalSale", System.Type.GetType("System.Double"));
            dtblLayaway.Columns.Add("ItemID", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("ProductID", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("ProductType", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("Payment", System.Type.GetType("System.Double"));
            dtblLayaway.Columns.Add("Balance", System.Type.GetType("System.Double"));
            dtblLayaway.Columns.Add("Deposit", System.Type.GetType("System.Double"));
            dtblLayaway.Columns.Add("MatrixOptionID", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("OptionValue1", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("OptionValue2", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("OptionValue3", System.Type.GetType("System.String"));
            dtblLayaway.Columns.Add("Image", System.Type.GetType("System.Byte[]"));
            dtblLayaway.Columns.Add("CustomerID", System.Type.GetType("System.String"));
            #endregion


            #region FetchLayAwayData
            DataTable dtbl = new DataTable();
            //PosDataObject.POS objPOS = new PosDataObject.POS();
            //objPOS.Connection = new SqlConnection(SystemVariables.ConnectionString);
            dtbl = FetchLayawayHeaderLayID(LayID,false);
            int intC = 0;
            double dblPayment = 0;
            double dblBalance = 0;

            byte[] strip = GeneralFunctions.GetImageAsByteArray();

            dtblLayaway.Rows.Clear();

            foreach (DataRow dr in dtbl.Rows)
            {
                intC++;

                if (Settings.DecimalPlace == 3)
                {
                    dblPayment = FetchLayawayPayment(GeneralFunctions.fnInt32(dr["InvoiceNo"].ToString()));
                    //dblPayment = FetchTotalPayment(GeneralFunctions.fnInt32(dr["InvoiceNo"].ToString()));
                    dblBalance = GeneralFunctions.fnDouble((GeneralFunctions.fnDouble(dr["TotalSale"].ToString()) - dblPayment).ToString("f3"));
                }
                else
                {
                    dblPayment = FetchLayawayPayment(GeneralFunctions.fnInt32(dr["InvoiceNo"].ToString()));
                    //dblPayment = FetchTotalPayment(GeneralFunctions.fnInt32(dr["InvoiceNo"].ToString()));
                    dblBalance = GeneralFunctions.fnDouble((GeneralFunctions.fnDouble(dr["TotalSale"].ToString()) - dblPayment).ToString("f"));
                }

                dtblLayaway.Rows.Add(new object[] { intC.ToString(),
                                                dr["LayawayNo"].ToString(),
                                                dr["InvoiceNo"].ToString(),
                                                dr["SKU"].ToString(),
                                                dr["Description"].ToString(),
                                                GeneralFunctions.fnDouble(dr["Qty"].ToString()),
                                                GeneralFunctions.fnDouble(dr["Cost"].ToString()),
                                                dr["DateDue"].ToString(),
                                                GeneralFunctions.fnDouble(dr["TotalSale"].ToString()),
                                                dr["ItemID"].ToString(),
                                                dr["ProductID"].ToString(),
                                                dr["ProductType"].ToString(),
                                                GeneralFunctions.fnDouble(dblPayment.ToString()),
                                                GeneralFunctions.fnDouble(dblBalance.ToString()),GeneralFunctions.fnDouble("0"),
                                                dr["MatrixOptionID"].ToString(),
                                                dr["OptionValue1"].ToString(),
                                                dr["OptionValue2"].ToString(),
                                                dr["OptionValue3"].ToString(),
                                                strip,
                                                dr["CustomerID"].ToString()});
            }
            dtbl.Dispose();
            #endregion

            #region IsValidRefund

            if (dtblLayaway.Rows.Count == 0)
                return null;

            int tempinv = 0;
            double totDeposit = 0;
            foreach (DataRow dr in dtblLayaway.Rows)
            {
                LawAwayRecordCustID = Convert.ToInt32(dr["CustomerID"].ToString());
                totDeposit = totDeposit + GeneralFunctions.fnDouble(dr["Deposit"].ToString());
                tempinv = GeneralFunctions.fnInt32(dr["InvoiceNo"].ToString());
                if (tempinv > intMaxInvNo) intMaxInvNo = tempinv;
            }

            #endregion

            #region SetIndividualDepositForRefund
            foreach (DataRow dr1 in dtblLayaway.Rows)
            {
                dr1["Deposit"] = Convert.ToString(-GeneralFunctions.fnDouble(dr1["Payment"].ToString()));
            }
            #endregion


            #region GetSelectedRowData
            double dblD = 0;
            foreach (DataRow dr in dtblLayaway.Rows)
            {
                if (Settings.DecimalPlace == 3)
                {
                    dblD = dblD + GeneralFunctions.fnDouble(dr["Deposit"].ToString());
                }
                else
                {
                    dblD = dblD + GeneralFunctions.fnDouble(dr["Deposit"].ToString());
                }
            }
            
            numsD = dblD;
            #endregion


            #region FetchCustomer
            DataTable dtblCust = FetchCustomerRecord(LawAwayRecordCustID);
            foreach (DataRow dr in dtblCust.Rows)
            {
                refTaxExempt = dr["TaxExempt"].ToString();
                refStoreCr = dr["StoreCredit"].ToString();
                refARCredit = dr["ARCreditLimit"].ToString();
                
            }
            dtblCust.Dispose();
            #endregion


            #region MyRegion4

            #endregion


            #region MyRegion5

            #endregion

            return dtblLayaway;

        }
        public void RefundStart(int LayAwayID, int intSuperUserID)
        {

            try
            {

                //  Tanzeel Work
                int intMaxInvNo = 0;
                int LawAwayRecordCustID = 0;
                double RefundAmount = 0;
                string refTaxExempt, refStoreCr, refARCredit;

                DataTable dtblLayAway = GetLayAwayRefundDataTable(LayAwayID, out intMaxInvNo, out RefundAmount, out LawAwayRecordCustID, out refTaxExempt, out refStoreCr, out refARCredit);

                if (dtblLayAway == null || dtblLayAway.Rows.Count == 0)
                    return;

               // RefundAmount = RefundAmt;
                double dblStoreCr = Convert.ToDouble(refStoreCr);
                double dblCustAcctLimit = Convert.ToDouble(refARCredit);
                double dblCustAcctBalance = FetchCustomerAcctPayBalance(LawAwayRecordCustID);

                //objpos1.TaxExempt = strTaxExempt;


                string srterrmsg = "";
                PosDataObject.POS objpos = new PosDataObject.POS();
                objpos.Connection = SystemVariables.Conn;
                objpos.EmployeeID = SystemVariables.CurrentUserID;
                objpos.LoginUserID = SystemVariables.CurrentUserID;
                objpos.CustomerID = LawAwayRecordCustID;
                objpos.Return = false;//  blReturnItem;
                objpos.NewLayaway = false;//  blNewLayaway;
                objpos.Layaway = false;//  blLayaway;
                objpos.LayawayRefund = true;
                objpos.RentReturn = false;
                objpos.ServiceType = "Sales";
                objpos.MGCIssue = false;
                objpos.MercuryGCIssueCardID = 0;
                objpos.CustomerOrdering = false;//  blCustomerOrdering;
                objpos.CustomerOrderNo = 0;//  intCustomerOrderNo;


                objpos.TransType = 2; // Layaway Payment
                objpos.Status = 5;

                objpos.RentalSecurityDeposit = 0d;
                objpos.IssueRentInvNo = intIssueRentInvNo;
                objpos.IsRentCalculated = Settings.CalculateRentLater;




                objpos.RepairFindUs = "";// strrpfind;
                objpos.RepairItemName = "";// strrpritm;
                objpos.RepairItemSL = "";// strrprsl;
                objpos.RepairDateIn = new DateTime();// rpin;
                objpos.RepairDeliveryDate = new DateTime();// rpdelvy;
                objpos.RepairNotifiedDate = new DateTime();//rpnotf;
                objpos.RepairProblem = "";// strrpnotes1;
                objpos.RepairNotes = "";//strrpnotes2;
                objpos.RepairRemarks = "";

                objpos.RepairAmount = dblRepairAmount;
                objpos.RepairAdvanceAmount = 0d;

                objpos.RepairTenderAmount = 0d;
                objpos.IssueRepairInvNo = intIssueRepairInvNo;


                objpos.TotalSale = RefundAmount;


                objpos.Tax = 0d; //  GeneralFunctions.FormatDouble(GeneralFunctions.FormatDouble(GeneralFunctions.fnDouble(numTax.Text.Substring(numTax.Text.IndexOf(" ") + 1))));



                // 00 

                objpos.Discount = 0d; // GeneralFunctions.FormatDouble(GeneralFunctions.FormatDouble(GeneralFunctions.fnDouble(numDiscount.Text.Substring(numDiscount.Text.IndexOf(" ") + 1))));
                objpos.Coupon = 0d; // GeneralFunctions.FormatDouble(GeneralFunctions.FormatDouble(GeneralFunctions.fnDouble(numCoupon.Text.Substring(numCoupon.Text.IndexOf(" ") + 1))));
                objpos.CouponPerc = dblCouponPerc;
                objpos.DiscountReason = strDiscountReason;


                objpos.TotalFees = dblFees;
                objpos.TotalFeesTax = dblFeesTax;
                objpos.TotalFeesCoupon = 0d; // dblFeesCouponAmount;
                objpos.TotalFeesCouponTax = 0d; // dblFeesCouponTaxAmount;

                objpos.DTaxID = 0; // CustDTaxID;
                objpos.DTax = 0d; // blNewLayaway ? CustDTaxValue : dblDTx;

                // data table
                objpos.ItemDataTable = dtblLayAway; // dtblLayawayPayment;   --Look




                // cash method or card
                objpos.TenderDataTable = TenderDT(RefundAmount); // grdTender.ItemsSource as DataTable; --Look
                objpos.TaxID1 = intTaxID1;
                objpos.TaxID2 = intTaxID2;
                objpos.TaxID3 = intTaxID3;
                objpos.Tax1 = GeneralFunctions.FormatDouble(dblTax1);
                objpos.Tax2 = GeneralFunctions.FormatDouble(dblTax2);
                objpos.Tax3 = GeneralFunctions.FormatDouble(dblTax3);

                objpos.ChangeAmount = 0d; // dblChange;  -- Look
                objpos.ApptDataTable = new DataTable(); // dtblApptDatatbl; --Look
                objpos.ErrorMsg = "";

                // static value
                objpos.StoreID = 1;
                objpos.RegisterID = 1;
                objpos.CloseoutID = GeneralFunctions.GetCloseOutID();
                objpos.TransNoteNo = 0;
                objpos.LayawayNo = LayAwayID;
                objpos.TransMSeconds = 0;
                // static value

                objpos.TerminalName = Settings.TerminalName;

                objpos.CardTranID = intCardTranID;

                objpos.ChangedByAdmin = intSuperUserID;
                objpos.FunctionButtonAccess = true; //  blFunctionBtnAccess; --Look


                objpos.AuthorisedTranNo = "";
                objpos.SaleTranNo = "";


                objpos.tblCardID = null; //  cardidentity; --Look

                // null 
                objpos.MercuryGiftCardDataTable = null; //  mgccardidentity; --Look


                objpos.GCCentralFlag = Settings.CentralExportImport;
                objpos.GCOPStore = Settings.StoreCode; //  GCOPSTORE;

                objpos.OperateStore = Settings.StoreCode;



                objpos.CustomerDOB = dtCustomerDOB;



                objpos.BeginTransaction();

                if (objpos.CreateInvoice())
                {
                    var vba = false;
                    //boolInvoiceCreated = true;
                    //intINV = objpos.ID;
                    //PrintOrderNo = intINV;
                    //if (blNewLayaway) intLAYNO = objpos.LayawayID;
                    //intLAYTRAN = objpos.TransactionNo;
                }
                objpos.EndTransaction();

            }
            catch (Exception er)
            {

            }


            // 21381 line number
        }

        private DataTable TenderDT(double RefAmt)
        {
            String PaymentMode = "Debit Card";
            //PopulateTenderType
            DataTable dtblTenderType = PopulateTenderType();





            DataTable dtblTender = new DataTable();
            dtblTender.Columns.Add("ID", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("TENDER", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("DISPLAY", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("AMOUNT", System.Type.GetType("System.Double"));
            dtblTender.Columns.Add("GIFTCERTIFICATE", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("NEWGC", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("OLDGC", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("OLDGCAMT", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("CCTRANNO", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("GCSTORE", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("MANUAL", System.Type.GetType("System.String"));
            dtblTender.Columns.Add("PROCESSCARD", System.Type.GetType("System.String"));



            //foreach (DataRow dr in dtblTenderType.Rows)
            //{
            //    if (dr["Name"].ToString() == PaymentMode)
            //    {
            //        dtblTender.Rows.Add(new object[] {  dr["ID"].ToString(),
            //                                            dr["Name"].ToString(),
            //                                             dr["DisplayAs"].ToString().ToUpper(),
            //                                            RefAmt,"","","","0","","",
            //                                            "N","N" });
            //    }

            //}

            //dtblTender.Rows.Add(new object[] {  iTenderID.ToString(),
            //                                            sTenderName,
            //                                            sDisplay,
            //                                            RefAmt,"","","","0","","",
            //                                            "N","N" });


            dtblTender.Rows.Add(new object[] {  3.ToString(),
                                                        "Credit Card",
                                                        "Credit Card",
                                                        RefAmt,"","","","0","","",
                                                        "N","N" });

            return dtblTender;

        }

        private DataTable PopulateTenderType()
        {
            bool blf = true;
            if (Settings.POSCardPayment == "Y") if (Settings.PaymentGateway == 1) blf = false;
            if (Settings.POSCardPayment == "Y") if (Settings.PaymentGateway == 3) if (Settings.PrecidiaUsePINPad == "N") blf = false;
            PosDataObject.TenderTypes objTender = new PosDataObject.TenderTypes();
            objTender.Connection = new SqlConnection(SystemVariables.ConnectionString);
            DataTable dtblTenderType = new DataTable();
            if (Settings.POSCardPayment == "N")
            {
                dtblTenderType = objTender.FetchPOSData(blf);
            }
            else
            {
                if (Settings.PaymentGateway == 3)
                {
                    dtblTenderType = objTender.FetchPOSDataForPrecidia(blf);
                }
                else if (Settings.PaymentGateway == 2)
                {
                    dtblTenderType = objTender.FetchPOSDataForMercury();
                }
                else if (Settings.PaymentGateway == 5)
                {
                    dtblTenderType = objTender.FetchPOSDataForDatacap();
                }
                else if (Settings.PaymentGateway == 6)
                {
                    dtblTenderType = objTender.FetchPOSDataForDatacapEMV();
                }
                else if (Settings.PaymentGateway == 7)
                {
                    dtblTenderType = objTender.FetchPOSDataForPOSLink();
                }
                else
                {
                    dtblTenderType = objTender.FetchPOSData(blf);
                }
            }

            return dtblTenderType;
            //int i = 0;
            //foreach (DataRow dr in dtblTenderType.Rows)
            //{
            //    i++;
            //    if (i <= 6)
            //    {
            //        dtblTenderTypeForDisplay.Rows.Add(new object[] { i, "Y", dr["ID"].ToString(), dr["Name"].ToString(), dr["DisplayAs"].ToString() });
            //    }
            //    else
            //    {
            //        dtblTenderTypeForDisplay.Rows.Add(new object[] { i, "", dr["ID"].ToString(), dr["Name"].ToString(), dr["DisplayAs"].ToString() });
            //    }
            //}

            //dtblTenderType.Dispose();
        }
        #endregion


        public DataTable GetTenderInfoForPartRefund(int invNo)
        {
            DataTable dtbl = new DataTable();
            string strFilter = "";
            string strFilterUser = "";

            string strSQLComm = " select t.TenderType, tt.Name as TenderName from tender t left outer join TenderTypes tt on tt.ID = t.TenderType "
                              + " where TransactionNo in (select TransactionNo from Invoice where id = " + invNo.ToString() + " ) "
                              + " and tt.Name in ('Visa','MasterCard','American Express','Discover','Diner','Debit Card','Credit Card','Card')";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TName", System.Type.GetType("System.String"));
                
                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {   objSQLReader["TenderType"].ToString(),
                                                   objSQLReader["TenderName"].ToString()});

                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public DataTable GetTenderInfoForPartRefund1(int invNo)
        {
            DataTable dtbl = new DataTable();
            string strFilter = "";
            string strFilterUser = "";

            string strSQLComm = " select t.TenderType, tt.Name as TenderName from tender t left outer join TenderTypes tt on tt.ID = t.TenderType "
                              + " where TransactionNo in (select TransactionNo from Invoice where id = " + invNo.ToString() + " ) ";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TName", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {

                    dtbl.Rows.Add(new object[] {   objSQLReader["TenderType"].ToString(),
                                                   objSQLReader["TenderName"].ToString()});

                    break;
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }

        public int GetCustomerIDForPartRefund(int invNo)
        {
            int val = 0;
            string strFilter = "";
            string strFilterUser = "";

            string strSQLComm = " select CustomerID from invoice where id = " + invNo.ToString();
         
            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();

               

                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["CustomerID"].ToString());
                   
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return 0;
            }
        }


        public void GetReturnInvoiceData(SqlCommand objSQlComm, ref double pTax, ref double pTax1, ref double pTax2, ref double pTax3,
            ref double pDiscount, ref double pCoupon, ref double pTotalSale, ref double pFees, ref double pFeesTax,
            ref double pFeesCoupon, ref double pFeesCouponTax)
        {
            int intPoints = 0;
            objSQlComm.Parameters.Clear();
            SqlDataReader sqlDataReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select Tax, Tax1, Tax2, Tax3, Discount, Coupon, TotalSale, Fees, FeesTax, FeesCoupon, FeesCouponTax from invoice Where id = @ID ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = intID;

                sqlDataReader = objSQlComm.ExecuteReader();
                if (sqlDataReader.Read())
                {
                    pTax = Functions.fnDouble(sqlDataReader["Tax"].ToString());
                    pTax1 = Functions.fnDouble(sqlDataReader["Tax1"].ToString());
                    pTax2 = Functions.fnDouble(sqlDataReader["Tax2"].ToString());
                    pTax3 = Functions.fnDouble(sqlDataReader["Tax3"].ToString());
                    pDiscount = Functions.fnDouble(sqlDataReader["Discount"].ToString());
                    pCoupon = Functions.fnDouble(sqlDataReader["Coupon"].ToString());
                    pTotalSale = Functions.fnDouble(sqlDataReader["TotalSale"].ToString());
                    pFees = Functions.fnDouble(sqlDataReader["Fees"].ToString());
                    pFeesTax = Functions.fnDouble(sqlDataReader["FeesTax"].ToString());
                    pFeesCoupon = Functions.fnDouble(sqlDataReader["FeesCoupon"].ToString());
                    pFeesCouponTax = Functions.fnDouble(sqlDataReader["FeesCouponTax"].ToString());
                }
                sqlDataReader.Close();
                return;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                sqlDataReader.Close();
                return;
            }
        }


        public bool UpdateReturnInvoiceData(SqlCommand objSQlComm, double pTax, double pTax1, double pTax2, double pTax3,
            double pDiscount, double pCoupon, double pTotalSale, double pFees, double pFeesTax,
            double pFeesCoupon, double pFeesCouponTax)
        {
            string strSQLComm = "";

            objSQlComm.Parameters.Clear();

            try
            {
                strSQLComm = " update Invoice set Tax=Tax + @Tax, Tax1= Tax1 + @Tax1, Tax2= Tax2 + @Tax2, Tax3= Tax3 + @Tax3, "
                           + " Discount = Discount + @Discount, Coupon = Coupon + @Coupon, TotalSale = TotalSale + @TotalSale, Fees = Fees + @Fees, "
                           + " FeesTax = FeesTax + @FeesTax, FeesCoupon= FeesCoupon + @FeesCoupon, FeesCouponTax = FeesCouponTax + @FeesCouponTax where ID = @ID";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax1", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax2", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Tax3", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Discount", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Coupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@TotalSale", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@Fees", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesTax", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCoupon", System.Data.SqlDbType.Float));
                objSQlComm.Parameters.Add(new SqlParameter("@FeesCouponTax", System.Data.SqlDbType.Float));

                objSQlComm.Parameters["@ID"].Value = intParentReturnInvNo;
                objSQlComm.Parameters["@Tax"].Value = pTax;
                objSQlComm.Parameters["@Tax1"].Value = pTax1;
                objSQlComm.Parameters["@Tax2"].Value = pTax2;
                objSQlComm.Parameters["@Tax3"].Value = pTax3;
                objSQlComm.Parameters["@Discount"].Value = pDiscount;
                objSQlComm.Parameters["@Coupon"].Value = pCoupon;
                objSQlComm.Parameters["@TotalSale"].Value = pTotalSale;
                objSQlComm.Parameters["@Fees"].Value = pFees;
                objSQlComm.Parameters["@FeesTax"].Value = pFeesTax;
                objSQlComm.Parameters["@FeesCoupon"].Value = pFeesCoupon;
                objSQlComm.Parameters["@FeesCouponTax"].Value = pFeesCouponTax;


                objSQlComm.ExecuteNonQuery();

                return true;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQlComm.Dispose();
                return false;
            }
        }



        #region Transaction Journal Detailed Report




        public DataTable FetchTransactionJournalD(DateTime dt1, DateTime dt2, string Till, int EmpRef, string TaxFlag, string configDateFormat)
        {
            try
            {
                SaveComm = new SqlCommand(" ", this.Connection);
                SaveComm.Transaction = this.SaveTran;
                DataTable dtbl = FetchTrnJournalMainD(SaveComm, dt1, dt2, Till, EmpRef, configDateFormat);




                return dtbl;



            }
            catch (SqlException SQLDBException)
            {
                string sss = SQLDBException.ToString();
                return null;
            }
        }




        public DataTable FetchTrnJournalMainD(SqlCommand objSQlComm, DateTime pdt1, DateTime pdt2, string Till, int EmpRef, string configDateFormat)
        {
            try
            {
                DataTable dtblTrn = FetchTrnJournalTrnD(objSQlComm, pdt1, pdt2, Till, EmpRef, configDateFormat);

                /*foreach (DataRow dr in dtblTrn.Rows)
                {
                    if (dr["TranType"].ToString() == "Sale")
                    {
                        int trnid = Functions.fnInt32(dr["TranNo"].ToString());
                        string tstatus = GetOrderStatusFromTransactionNo(objSQlComm, trnid);
                        if (tstatus == "VoidSale") dr["TranType"] = "Void";
                        else dr["TranType"] = "Sale";
                    }
                }*/

                DataTable dtblT = FetchActiveTenderTypes(objSQlComm);

                foreach (DataRow dr in dtblT.Rows)
                {
                    string colname = "T_" + dr["TenderID"].ToString();
                    DataColumn column = new DataColumn(colname);
                    column.DataType = System.Type.GetType("System.String");
                    column.Caption = colname;
                    dtblTrn.Columns.Add(column);
                }

                foreach (DataRow dr in dtblTrn.Rows)
                {
                    foreach (DataColumn dc in dtblTrn.Columns)
                    {
                        if (dc.Caption.StartsWith("T_"))
                        {
                            dr[dc] = "0";
                        }
                    }
                }

                DataTable dtblTranDummy = new DataTable();
                dtblTranDummy = dtblTrn.Clone();

                foreach (DataRow dr in dtblTrn.Rows)
                {
                    /*string openstatus = GetOrderStatusFromTransactionNo(objSQlComm, Functions.fnInt32(dr["TranNo"].ToString()));
                    if (openstatus != "Open")
                    {
                        dtblTranDummy.ImportRow(dr);
                    }*/

                    dtblTranDummy.ImportRow(dr);
                }

                dtblTrn = dtblTranDummy;

                dtblTranDummy.Dispose();

                string val6 = "";
                string val7 = "";
                string val9 = "";



                foreach (DataRow drT in dtblTrn.Rows)
                {

                    val6 = "";
                    val7 = "";

                    int trnid = Functions.fnInt32(drT["TranNo"].ToString());
                    string trntype = drT["TranType"].ToString();



                    if (trntype != "No Sale")
                    {


                        DataTable dInv = FetchTrnJournalInvD(objSQlComm, trnid);
                        foreach (DataRow dr in dInv.Rows)
                        {
                            string tI = dr["InvNo"].ToString();
                            double tA = 0;

                            val6 = dr["InvNo"].ToString();
                            tA = Functions.fnDouble(dr["Amt"].ToString());


                            drT["InvNo"] = val6;
                            drT["InvAmt"] = tA.ToString();
                            drT["Tax"] = dr["Tax"].ToString();
                           
                            

                        }
                        dInv.Dispose();

                        DataTable dTender = FetchTrnJournalTenderD(objSQlComm, trnid);


                        foreach (DataRow dr1 in dTender.Rows)
                        {
                            foreach (DataColumn dc in dtblTrn.Columns)
                            {
                                if ("T_" + dr1["TenderID"].ToString() == dc.Caption)
                                {
                                    drT[dc] = dr1["Amount"].ToString();
                                }
                            }


                        }


                        dTender.Dispose();
                    }
                }
                return dtblTrn;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                return null;
            }
        }




        public DataTable FetchTrnJournalInvD(SqlCommand objSQlComm, int TrnNo)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select ID,TotalSale,Tax from invoice where TransactionNo=@T ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("InvNo", System.Type.GetType("System.Int32"));
                dtbl.Columns.Add("Tax", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amt", System.Type.GetType("System.String"));
                

                string sts = "";
                while (objSQLReader.Read())
                {
                   
                    dtbl.Rows.Add(new object[] { Functions.fnInt32(objSQLReader["ID"].ToString()),
                                                Functions.fnDouble(objSQLReader["Tax"].ToString()),
                                                 Functions.fnDouble(objSQLReader["TotalSale"].ToString())
                    });
                }

                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }




        public DataTable FetchTrnJournalTrnD(SqlCommand objSQlComm, DateTime pdt1, DateTime pdt2, string Till, int EmpRef, string configDateFormat)
        {
            DateTime FromDate = new DateTime(pdt1.Year, pdt1.Month, pdt1.Day, pdt1.Hour, pdt1.Minute, pdt1.Second);
            DateTime ToDate = new DateTime(pdt2.Year, pdt2.Month, pdt2.Day, pdt2.Hour, pdt2.Minute, pdt2.Second);

            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";

            string sqlFilter1 = "";
            string sqlFilter2 = "";

            if (Till != "ALL-TERMINAL-6473") // All
            {
                sqlFilter1 = " and t.TerminalName = '" + Till + "'";
            }

            if (EmpRef != 0)
            {
                sqlFilter2 = " and t.EmployeeID = " + EmpRef.ToString();
            }

            try
            {
                strSQLComm = " select t.ID,t.TransType,t.LastChangedOn,isnull(e.EmployeeID,'ADMIN') as Emp, isnull(c.FirstName,'') as CF, isnull(c.LastName,'') as CL, t.TerminalName from trans t "
                           + " left outer join Employee e on e.ID = t.EmployeeID left outer join Customer c on c.ID = t.CustomerID where t.LastChangedOn between @F and @T " + sqlFilter1 + sqlFilter2 + "  order by t.LastChangedOn ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@F", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@F"].Value = FromDate;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.DateTime));
                objSQlComm.Parameters["@T"].Value = ToDate;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TranNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranType", System.Type.GetType("System.String"));
                dtbl.Columns.Add("TranDate", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Terminal", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Employee", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvNo", System.Type.GetType("System.String"));
                dtbl.Columns.Add("InvAmt", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Customer", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Tax", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    string val1 = "";
                    string val2 = "";
                    string val3 = "";
                    string val4 = "";
                    string val5 = "";
                    string val6 = "";
                    string val7 = "";
                    string val8 = "";
                    string val9 = "";

                    int trnid = Functions.fnInt32(objSQLReader["ID"].ToString());
                    val1 = trnid.ToString();
                    int trntype = Functions.fnInt32(objSQLReader["TransType"].ToString());
                    if (trntype == 1) val2 = "Sale";
                   
                    if (trntype == 2) val2 = "Layaway";
                    if (trntype == 3) val2 = "Layaway Payment";
                    if (trntype == 4) val2 = "Layaway Refund";

                    if (trntype == 5) val2 = "No Sale";

                    if (trntype == 6) val2 = "Paid Out";
                    if (trntype == 66) val2 = "Paid In";
                    if (trntype == 67) val2 = "Safe Drop";

                    if (trntype == 60) val2 = "Lotto Payout";

                    if (trntype == 91) val2 = "Cash In";
                    if (trntype == 92) val2 = "Cash Out";


                    if (trntype == 15) val2 = "Rent Issue";
                    if (trntype == 16) val2 = "Rent Return";

                    if (trntype == 17) val2 = "Repair In";
                    if (trntype == 18) val2 = "Repair Deliver";

                    if (trntype == 51) val2 = "Store Credit Issue";
                    if (trntype == 51) val2 = "Point to Store Credit";



                    val3 = Functions.fnDate(objSQLReader["LastChangedOn"].ToString()).ToString((configDateFormat) + " HH:mm");
                    val4 = objSQLReader["TerminalName"].ToString();
                    val5 = objSQLReader["Emp"].ToString();

                    if ((objSQLReader["CF"].ToString() == "") && (objSQLReader["CL"].ToString() == ""))
                    {

                    }
                    else
                    {
                        val8 = objSQLReader["CF"].ToString() + " " + objSQLReader["CL"].ToString();
                    }

                    dtbl.Rows.Add(new object[] { val1, val2, val3, val4, val5, val6, val7, val8, val9 });
                }
                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }


        public DataTable FetchActiveTenderTypes(SqlCommand objSQlComm)
        {

            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";

            try
            {
                strSQLComm = " select ID from tendertypes where enabled = 'Y' order by PaymentOrder ";
                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TenderID", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    dtbl.Rows.Add(new object[] { objSQLReader["ID"].ToString() });
                }
                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }


        public DataTable FetchTrnJournalTenderD(SqlCommand objSQlComm, int TrnNo)
        {
            DataTable dtbl = new DataTable();
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select TenderType,isnull(sum(TenderAmount),0) as Amt from Tender where TransactionNo=@T group by TenderType";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("TenderID", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Amount", System.Type.GetType("System.String"));

                while (objSQLReader.Read())
                {
                    if (objSQLReader["TenderType"].ToString() == "") continue;

                    double amt = Functions.fnDouble(objSQLReader["Amt"].ToString());

                    dtbl.Rows.Add(new object[] { objSQLReader["TenderType"].ToString(), amt.ToString("f") });

                }

                objSQLReader.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }


        public DataTable FetchTrnJournalDetail(int TranNo, string TaxIncludeFlag)
        {

            DataTable dtbl = new DataTable();
            string strSQLComm = "";



            string strSQLDate = " and t.ID = " + TranNo.ToString();

            strSQLComm = " select isnull(a.sku,'') as mID,RTrim(LTrim(a.description)) as mNM,isnull(a.Qty,0) as Qty, a.Price as Rate, a.TaxIncludeRate as RateI, isnull(a.Price*a.Qty - a.Discount,0) as Price, isnull(a.TaxIncludePrice,0) as PriceI,  "
                           + " isnull(a.Discount,0) as Discount, (isnull(a.TaxTotal1,0) + isnull(a.TaxTotal2,0) + isnull(a.TaxTotal3,0)) as Tax  "
                           + " from Trans t left outer join Invoice i on t.ID = i.TransactionNo "
                           + " left outer join item a on a.InvoiceNo = i.ID  "
                           + " where (1 = 1) and a.Qty is not null  "
                           + " and a.Producttype in ('P','K','U','M','S','W','E','F','G','T','X','B') " + strSQLDate
                           + " Order by a.ID,RTrim(LTrim(a.description)) ";



            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            objSQlComm.CommandTimeout = 500;
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }


                objSQLReader = objSQlComm.ExecuteReader();

                dtbl.Columns.Add("SKU", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Description", System.Type.GetType("System.String"));
                dtbl.Columns.Add("Qty", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("Price", System.Type.GetType("System.Double"));
                dtbl.Columns.Add("Total", System.Type.GetType("System.Double"));


                double qty = 0;
                double price = 0;
                double disc = 0;
                double total = 0;

                while (objSQLReader.Read())
                {

                    qty = Functions.fnDouble(objSQLReader["Qty"].ToString());
                    disc = Functions.fnDouble(objSQLReader["Discount"].ToString());

                    if (TaxIncludeFlag == "Y")
                    {
                        total = Functions.fnDouble(objSQLReader["PriceI"].ToString());
                        price = Functions.fnDouble(objSQLReader["RateI"].ToString());
                    }

                    if (TaxIncludeFlag == "N")
                    {
                        total = Functions.fnDouble(objSQLReader["Price"].ToString()) + Functions.fnDouble(objSQLReader["Tax"].ToString());
                        price = Functions.fnDouble(objSQLReader["Rate"].ToString());
                    }

                   
                    dtbl.Rows.Add(new object[] {   objSQLReader["mID"].ToString(),
                                                   objSQLReader["mNM"].ToString(),
                                                   qty,
                                                   price,
                                                   total});
                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return null;
            }
        }



        public string GetOrderStatusFromTransactionNo(SqlCommand objSQlComm, int TrnNo)
        {
            string val = "";
            objSQlComm.Parameters.Clear();
            SqlDataReader objSQLReader = null;
            string strSQLComm = "";
            try
            {
                strSQLComm = " select isnull(orderstatus,'NA') as sts from invoice where TransactionNo = @T ";

                objSQlComm.CommandText = strSQLComm;
                objSQlComm.CommandType = CommandType.Text;
                objSQlComm.Parameters.Add(new SqlParameter("@T", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@T"].Value = TrnNo;

                objSQLReader = objSQlComm.ExecuteReader();

                while (objSQLReader.Read())
                {
                    val = objSQLReader["sts"].ToString();
                }

                objSQLReader.Close();
                return val;
            }
            catch (SqlException SQLDBException)
            {
                strErrorMsg = SQLDBException.ToString();
                SaveTran.Rollback();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return "";
            }
        }



        public string GetTenderName(int intpID)
        {
            string strpSKU = "";
            string strSQLComm = " select DisplayAs from TenderTypes where ID=@ID ";

            SqlCommand objSQlComm = null;
            SqlTransaction objSQLTran = null;
            SqlDataReader objsqlReader = null;
            try
            {
                objSQlComm = new SqlCommand(strSQLComm, Connection);
                objSQlComm.Parameters.Add(new SqlParameter("@ID", System.Data.SqlDbType.Int));
                objSQlComm.Parameters["@ID"].Value = intpID;

                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }

                objSQLTran = Connection.BeginTransaction();
                objSQlComm.Transaction = objSQLTran;


                objsqlReader = objSQlComm.ExecuteReader();
                if (objsqlReader.Read())
                {
                    try
                    {
                        strpSKU = objsqlReader["DisplayAs"].ToString();
                    }
                    catch { objsqlReader.Close(); }

                }
                objsqlReader.Close();
                objSQLTran.Commit();
                objSQlComm.Dispose();
                sqlConn.Close();
                return strpSKU;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                objSQLTran.Rollback();
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
                strErrMsg = SQLDBException.Message;
                return "";
            }
            finally
            {
                sqlConn.Close();
                objSQlComm.Dispose();
                objSQLTran.Dispose();
            }
        }


        public DataTable FetchStoreLogo()
        {
            DataTable dtbl = new DataTable();

            string strSQLComm = " select CompanyLogo from StoreInfo";

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);


            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();


                dtbl.Columns.Add("logo", typeof(byte[]));

                while (objSQLReader.Read())
                {
                    byte[] bytLogo = null;
                    try
                    {
                        bytLogo = (byte[])objSQLReader["CompanyLogo"];
                    }
                    catch
                    {
                        bytLogo = null;
                    }

                    dtbl.Rows.Add(new object[] {
                                                   bytLogo
                                                });
                }

                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();

                return dtbl;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;

                objSQLReader.Close();
                objSQLReader.Dispose();
                objSQlComm.Dispose();
                sqlConn.Close();

                return null;
            }
        }

        #endregion


        public bool CheckIfGiftCertSaleReceipt(int invNo)
        {
            int val = 0;
            string strFilter = "";
            string strFilterUser = "";

            string strSQLComm = " select count(*) as rcnt from item where ProductType = 'G' and  InvoiceNo = " + invNo.ToString();

            SqlCommand objSQlComm = new SqlCommand(strSQLComm, sqlConn);
            SqlDataReader objSQLReader = null;

            try
            {
                if (sqlConn.State == System.Data.ConnectionState.Closed) { sqlConn.Open(); }
                objSQLReader = objSQlComm.ExecuteReader();



                while (objSQLReader.Read())
                {
                    val = Functions.fnInt32(objSQLReader["rcnt"].ToString());

                }
                objSQLReader.Close();
                objSQlComm.Dispose();
                sqlConn.Close();
                return val > 0;
            }
            catch (SqlException SQLDBException)
            {
                string strErrMsg = "";
                strErrMsg = SQLDBException.Message;
                sqlConn.Close();
                objSQLReader.Close();
                objSQlComm.Dispose();
                return false;
            }
        }
    }
}
